# 01.01 Backend Dockerfile - Detailed Execution Plan

**Project**: Learn Greek Easy - DevOps
**Task**: Create Backend Dockerfile
**Parent**: [01-docker-architecture.md](./01-docker-architecture.md)
**Created**: 2025-12-02
**Status**: Completed (2025-12-02)

---

## Table of Contents

1. [Objective](#objective)
2. [Prerequisites](#prerequisites)
3. [Technical Specifications](#technical-specifications)
4. [Implementation Steps](#implementation-steps)
5. [File Contents](#file-contents)
6. [Validation](#validation)
7. [Troubleshooting](#troubleshooting)

---

## Objective

Create a production-ready, multi-stage Dockerfile for the FastAPI backend that:
- Minimizes final image size (target: < 500MB)
- Follows security best practices (non-root user)
- Optimizes build cache for faster CI/CD
- Supports both development and production modes
- Includes health check for container orchestration

---

## Prerequisites

### Verified Project Structure

```
learn-greek-easy-backend/
├── src/
│   ├── __init__.py
│   ├── main.py              # FastAPI app entry point
│   ├── config.py            # Pydantic settings
│   ├── api/
│   ├── core/
│   ├── db/
│   ├── middleware/
│   ├── models/
│   ├── repositories/
│   ├── schemas/
│   ├── services/
│   ├── tasks/
│   └── utils/
├── alembic/
│   ├── versions/
│   └── env.py
├── alembic.ini
├── pyproject.toml
├── poetry.lock
├── .env.example
└── logs/
```

### Key Dependencies (from pyproject.toml)

| Package | Version | Purpose |
|---------|---------|---------|
| python | ^3.14 | Runtime (NOTE: Use 3.13 until 3.14 image available) |
| fastapi | ^0.115.0 | Web framework |
| uvicorn | ^0.30.0 | ASGI server |
| sqlalchemy | ^2.0.35 | ORM |
| asyncpg | ^0.30.0 | Async PostgreSQL driver |
| alembic | ^1.13.2 | Database migrations |
| pydantic | ^2.9.0 | Data validation |
| redis | ^5.0.8 | Caching |
| celery | ^5.4.0 | Background tasks |
| gunicorn | ^22.0.0 | Production WSGI server |
| python-jose | ^3.3.0 | JWT handling |
| passlib | ^1.7.4 | Password hashing |
| bcrypt | ^4.2.0 | Password hashing backend |

### System Dependencies Required

| Package | Build Stage | Runtime Stage | Purpose |
|---------|-------------|---------------|---------|
| build-essential | Yes | No | Compile Python extensions |
| libpq-dev | Yes | No | PostgreSQL client headers |
| libpq5 | No | Yes | PostgreSQL client library |
| curl | Yes | Yes | Health checks |

---

## Technical Specifications

### Image Strategy

```
┌─────────────────────────────────────────────────────────────┐
│                     Multi-Stage Build                        │
├─────────────────────────────────────────────────────────────┤
│  Stage 1: builder                                            │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ Base: python:3.13-slim                                  ││
│  │ Install: build-essential, libpq-dev, Poetry             ││
│  │ Copy: pyproject.toml, poetry.lock                       ││
│  │ Run: poetry install --only=main                         ││
│  │ Copy: src/, alembic/, alembic.ini                       ││
│  │ Size: ~1.2GB (temporary)                                ││
│  └─────────────────────────────────────────────────────────┘│
│                            │                                 │
│                            ▼                                 │
│  Stage 2: runtime                                            │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ Base: python:3.13-slim                                  ││
│  │ Install: libpq5, curl (runtime only)                    ││
│  │ Create: non-root user (appuser:1000)                    ││
│  │ Copy from builder: site-packages, app code              ││
│  │ Expose: 8000                                            ││
│  │ Healthcheck: curl /health                               ││
│  │ CMD: uvicorn src.main:app                               ││
│  │ Size: ~400-500MB (final)                                ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

### Python Version Note

- pyproject.toml specifies `python = "^3.14"`
- Docker Hub currently has up to python:3.13
- **Decision**: Use `python:3.13-slim` until 3.14 images are available
- **Action**: Update pyproject.toml to `python = "^3.13"` for compatibility

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| PYTHONPATH | /app | Python module search path |
| PYTHONDONTWRITEBYTECODE | 1 | Prevent .pyc files |
| PYTHONUNBUFFERED | 1 | Force stdout/stderr flush |
| POETRY_VERSION | 1.8.0 | Poetry version to install |
| POETRY_VIRTUALENVS_CREATE | false | Install to system Python |
| POETRY_NO_INTERACTION | 1 | Non-interactive mode |

---

## Implementation Steps

### Step 1: Create .dockerignore

**File**: `learn-greek-easy-backend/.dockerignore`

Prevents unnecessary files from being copied to build context:

```dockerignore
# Git
.git
.gitignore

# Python
__pycache__
*.py[cod]
*$py.class
*.so
.Python
*.egg-info
.eggs
dist
build
.mypy_cache
.pytest_cache
.coverage
htmlcov
coverage.xml
*.cover

# Virtual environments
.venv
venv
ENV

# IDE
.idea
.vscode
*.swp
*.swo

# Environment
.env
.env.local
.env.*.local

# Logs
logs/
*.log

# Testing
tests/
TESTING.md
.coverage

# Documentation
README.md
docs/

# Docker
Dockerfile*
docker-compose*

# Scripts (not needed in container)
scripts/

# Temp files
*.tmp
*.temp
.DS_Store
```

### Step 2: Create Production Dockerfile

**File**: `learn-greek-easy-backend/Dockerfile`

### Step 3: Create Development Dockerfile

**File**: `learn-greek-easy-backend/Dockerfile.dev`

### Step 4: Create Entrypoint Script

**File**: `learn-greek-easy-backend/docker-entrypoint.sh`

Handles startup tasks like migrations.

### Step 5: Update pyproject.toml Python Version

Change Python version from `^3.14` to `^3.13` for Docker compatibility.

### Step 6: Test Build Locally

```bash
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend

# Build production image
docker build -t learn-greek-easy-backend:latest .

# Build development image
docker build -f Dockerfile.dev -t learn-greek-easy-backend:dev .

# Check image size
docker images learn-greek-easy-backend
```

### Step 7: Test Container Run

```bash
# Test production container (requires running postgres)
docker run --rm -it \
  -p 8000:8000 \
  -e DATABASE_URL="postgresql+asyncpg://postgres:postgres@host.docker.internal:5433/learn_greek_easy" \
  learn-greek-easy-backend:latest

# Health check
curl http://localhost:8000/health
```

---

## File Contents

### .dockerignore

```dockerignore
# Git
.git
.gitignore
.github

# Python bytecode
__pycache__
*.py[cod]
*$py.class
*.so
.Python
*.egg-info
.eggs
dist
build

# Type checking / linting cache
.mypy_cache
.ruff_cache
.pytest_cache

# Coverage
.coverage
htmlcov
coverage.xml
coverage.json
*.cover

# Virtual environments
.venv
venv
ENV
env

# IDE
.idea
.vscode
*.swp
*.swo
*~

# Environment files (secrets)
.env
.env.local
.env.*.local
!.env.example

# Logs
logs/
*.log

# Testing
tests/
TESTING.md
conftest.py

# Documentation
README.md
docs/
*.md
!alembic/README

# Docker files (avoid recursion)
Dockerfile*
docker-compose*
.dockerignore

# Scripts (development only)
scripts/

# Temp/OS files
*.tmp
*.temp
.DS_Store
Thumbs.db
```

### Dockerfile (Production)

```dockerfile
# =============================================================================
# Learn Greek Easy - Backend Dockerfile
# Multi-stage build for production deployment
# =============================================================================

# -----------------------------------------------------------------------------
# Stage 1: Builder
# Install dependencies and prepare application
# -----------------------------------------------------------------------------
FROM python:3.13-slim AS builder

# Set build-time environment variables
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# Poetry configuration
ENV POETRY_VERSION=1.8.0 \
    POETRY_HOME=/opt/poetry \
    POETRY_VENV=/opt/poetry-venv \
    POETRY_NO_INTERACTION=1 \
    POETRY_VIRTUALENVS_CREATE=false

WORKDIR /app

# Install system dependencies for building
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    libpq-dev \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install Poetry in isolated virtualenv
RUN python -m venv $POETRY_VENV \
    && $POETRY_VENV/bin/pip install --upgrade pip setuptools \
    && $POETRY_VENV/bin/pip install poetry==$POETRY_VERSION

# Add Poetry to PATH
ENV PATH="${POETRY_VENV}/bin:${PATH}"

# Copy dependency files first (layer caching optimization)
COPY pyproject.toml poetry.lock ./

# Install production dependencies only (no dev dependencies)
RUN poetry install --only=main --no-root --no-directory

# Copy application source code
COPY src/ ./src/
COPY alembic/ ./alembic/
COPY alembic.ini ./

# -----------------------------------------------------------------------------
# Stage 2: Runtime
# Minimal production image
# -----------------------------------------------------------------------------
FROM python:3.13-slim AS runtime

# Labels for image metadata
LABEL maintainer="Learn Greek Easy Team" \
      version="0.1.0" \
      description="Learn Greek Easy Backend API"

# Runtime environment variables
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONPATH=/app \
    APP_HOME=/app

WORKDIR $APP_HOME

# Install runtime-only system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    libpq5 \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean \
    && apt-get autoremove -y

# Create non-root user for security
RUN groupadd --gid 1000 appgroup \
    && useradd --uid 1000 --gid appgroup --shell /bin/bash --create-home appuser

# Copy installed Python packages from builder
COPY --from=builder /usr/local/lib/python3.13/site-packages /usr/local/lib/python3.13/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin

# Copy application code from builder
COPY --from=builder /app/src ./src
COPY --from=builder /app/alembic ./alembic
COPY --from=builder /app/alembic.ini ./

# Copy entrypoint script
COPY docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

# Create logs directory and set permissions
RUN mkdir -p /app/logs \
    && chown -R appuser:appgroup /app

# Switch to non-root user
USER appuser

# Expose API port
EXPOSE 8000

# Health check for container orchestration
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl --fail --silent http://localhost:8000/health || exit 1

# Entrypoint handles startup tasks
ENTRYPOINT ["docker-entrypoint.sh"]

# Default command: run uvicorn
CMD ["uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "1"]
```

### Dockerfile.dev (Development)

```dockerfile
# =============================================================================
# Learn Greek Easy - Backend Development Dockerfile
# Includes dev dependencies, hot reload, debugging support
# =============================================================================

FROM python:3.13-slim

# Environment variables
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONPATH=/app \
    PIP_NO_CACHE_DIR=1 \
    POETRY_VERSION=1.8.0 \
    POETRY_VIRTUALENVS_CREATE=false \
    POETRY_NO_INTERACTION=1

WORKDIR /app

# Install system dependencies (including dev tools)
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    libpq-dev \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

# Install Poetry
RUN pip install poetry==$POETRY_VERSION

# Copy dependency files
COPY pyproject.toml poetry.lock ./

# Install ALL dependencies (including dev)
RUN poetry install --no-root

# Copy application code
COPY . .

# Create logs directory
RUN mkdir -p /app/logs

# Expose port
EXPOSE 8000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD curl --fail http://localhost:8000/health || exit 1

# Development command with hot reload
CMD ["uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
```

### docker-entrypoint.sh

```bash
#!/bin/bash
set -e

# =============================================================================
# Docker Entrypoint Script
# Handles startup tasks before running the main application
# =============================================================================

echo "Starting Learn Greek Easy Backend..."
echo "Environment: ${APP_ENV:-production}"

# -----------------------------------------------------------------------------
# Wait for dependencies (optional, for docker-compose)
# -----------------------------------------------------------------------------
wait_for_postgres() {
    if [ -n "$DATABASE_URL" ]; then
        echo "Waiting for PostgreSQL..."

        # Extract host and port from DATABASE_URL
        # Format: postgresql+asyncpg://user:pass@host:port/dbname
        DB_HOST=$(echo $DATABASE_URL | sed -n 's/.*@\([^:]*\):.*/\1/p')
        DB_PORT=$(echo $DATABASE_URL | sed -n 's/.*:\([0-9]*\)\/.*/\1/p')

        # Default port if not specified
        DB_PORT=${DB_PORT:-5432}

        # Wait loop
        MAX_RETRIES=30
        RETRY_COUNT=0

        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -s "http://${DB_HOST}:${DB_PORT}" > /dev/null 2>&1 || \
               python -c "import socket; socket.create_connection(('${DB_HOST}', ${DB_PORT}), timeout=2)" 2>/dev/null; then
                echo "PostgreSQL is available!"
                break
            fi

            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Waiting for PostgreSQL... ($RETRY_COUNT/$MAX_RETRIES)"
            sleep 2
        done

        if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "Warning: Could not connect to PostgreSQL, proceeding anyway..."
        fi
    fi
}

# -----------------------------------------------------------------------------
# Run database migrations (optional)
# -----------------------------------------------------------------------------
run_migrations() {
    if [ "${RUN_MIGRATIONS:-false}" = "true" ]; then
        echo "Running database migrations..."
        alembic upgrade head
        echo "Migrations completed!"
    fi
}

# -----------------------------------------------------------------------------
# Main execution
# -----------------------------------------------------------------------------

# Wait for PostgreSQL if in production mode
if [ "${APP_ENV}" = "production" ] || [ "${WAIT_FOR_DB:-false}" = "true" ]; then
    wait_for_postgres
fi

# Run migrations if enabled
run_migrations

# Execute the main command
echo "Starting application..."
exec "$@"
```

---

## Validation

### Build Validation Checklist

- [ ] `docker build -t learn-greek-easy-backend:latest .` succeeds
- [ ] `docker build -f Dockerfile.dev -t learn-greek-easy-backend:dev .` succeeds
- [ ] Production image size < 500MB
- [ ] No secrets in image layers (`docker history --no-trunc`)

### Runtime Validation Checklist

- [ ] Container starts without errors
- [ ] Health check endpoint responds (GET /health)
- [ ] Application logs visible (`docker logs`)
- [ ] Container runs as non-root user (`docker exec ... whoami`)
- [ ] Database connection works (requires postgres running)

### Security Validation Checklist

- [ ] No .env file in image
- [ ] No test files in image
- [ ] Running as UID 1000 (appuser)
- [ ] No unnecessary packages installed
- [ ] Curl available for health checks only

### Test Commands

```bash
# Build production image
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend
docker build -t learn-greek-easy-backend:latest .

# Check image size
docker images learn-greek-easy-backend:latest --format "{{.Size}}"

# Check for secrets in layers
docker history learn-greek-easy-backend:latest --no-trunc | grep -i secret

# Run container (requires postgres on port 5433)
docker run --rm -d --name test-backend \
  -p 8000:8000 \
  -e DATABASE_URL="postgresql+asyncpg://postgres:postgres@host.docker.internal:5433/learn_greek_easy" \
  -e JWT_SECRET_KEY="test-secret-key-for-local-testing" \
  learn-greek-easy-backend:latest

# Check health
sleep 5
curl http://localhost:8000/health

# Check user
docker exec test-backend whoami

# Check logs
docker logs test-backend

# Cleanup
docker stop test-backend
```

---

## Troubleshooting

### Common Issues

| Issue | Cause | Solution |
|-------|-------|----------|
| `ModuleNotFoundError: No module named 'src'` | PYTHONPATH not set | Verify `ENV PYTHONPATH=/app` |
| Build fails on `poetry install` | Network issue or Poetry version | Check network, try `--no-cache` |
| Health check failing | App not started yet | Increase `start_period` |
| Permission denied on logs | Root vs non-root | Ensure `chown appuser:appgroup /app` |
| Database connection refused | PostgreSQL not ready | Use `wait_for_postgres` in entrypoint |
| Image too large (>600MB) | Dev dependencies included | Verify `--only=main` flag |

### Debug Commands

```bash
# Shell into running container
docker exec -it <container_id> bash

# Shell into fresh container (bypass entrypoint)
docker run --rm -it --entrypoint bash learn-greek-easy-backend:latest

# Check installed packages
docker run --rm learn-greek-easy-backend:latest pip list

# Check Python path
docker run --rm learn-greek-easy-backend:latest python -c "import sys; print(sys.path)"

# Verbose build
docker build --progress=plain -t learn-greek-easy-backend:latest .
```

---

## Files to Create Summary

| File | Location | Purpose |
|------|----------|---------|
| `.dockerignore` | learn-greek-easy-backend/ | Exclude files from build context |
| `Dockerfile` | learn-greek-easy-backend/ | Production multi-stage build |
| `Dockerfile.dev` | learn-greek-easy-backend/ | Development with hot reload |
| `docker-entrypoint.sh` | learn-greek-easy-backend/ | Startup script |

---

## Next Steps After Completion

1. **Task 01.02**: Add backend service to docker-compose.yml
2. **Task 01.03**: Create docker-compose.prod.yml
3. **Task 01.04**: Add Redis service
4. **Task 01.05**: Implement enhanced health endpoint

---

**Ready for executor mode.**
