# 01.02 Add Backend to docker-compose.yml - Detailed Execution Plan

**Project**: Learn Greek Easy - DevOps
**Task**: Add Backend Service to Development Docker Compose
**Parent**: [01-docker-architecture.md](./01-docker-architecture.md)
**Created**: 2025-12-02
**Status**: Completed (2025-12-02)

---

## Table of Contents

1. [Objective](#objective)
2. [Prerequisites](#prerequisites)
3. [Technical Specifications](#technical-specifications)
4. [Implementation Steps](#implementation-steps)
5. [File Contents](#file-contents)
6. [Validation](#validation)
7. [Troubleshooting](#troubleshooting)
8. [Next Steps](#next-steps)

---

## Objective

Update the existing development `docker-compose.yml` to include the backend service, enabling:
- Single command stack startup (`docker-compose up`)
- Backend accessible at `http://localhost:8000`
- Frontend nginx reverse proxy to backend API (`/api/*` requests)
- Hot reload for development (volume mounts)
- Proper service dependency ordering (postgres -> backend -> frontend)
- Network connectivity between all services

---

## Prerequisites

### Completed Dependencies

| Task | Status | Artifacts |
|------|--------|-----------|
| 01.01 Backend Dockerfile | COMPLETED | `Dockerfile`, `Dockerfile.dev`, `docker-entrypoint.sh`, `.dockerignore` |

### Verified Files Exist

```
learn-greek-easy/
├── docker-compose.yml                    # Target file to modify
├── learn-greek-easy-backend/
│   ├── Dockerfile                        # Production (from 01.01)
│   ├── Dockerfile.dev                    # Development with hot reload (from 01.01)
│   ├── docker-entrypoint.sh              # Startup script (from 01.01)
│   ├── .dockerignore                     # Build exclusions (from 01.01)
│   ├── pyproject.toml
│   ├── poetry.lock
│   ├── src/
│   │   └── main.py                       # FastAPI app entry point
│   └── alembic/
└── learn-greek-easy-frontend/
    ├── Dockerfile
    └── nginx.conf                        # Requires update for API proxy
```

### Current docker-compose.yml State

The existing file contains:
- `frontend` service (port 80, nginx)
- `postgres` service (port 5433:5432)
- `learn-greek-network` bridge network
- `postgres_data` named volume

---

## Technical Specifications

### Backend Service Configuration

| Parameter | Value | Notes |
|-----------|-------|-------|
| Build Context | `./learn-greek-easy-backend` | Backend directory |
| Dockerfile | `Dockerfile.dev` | Development with hot reload |
| Container Name | `learn-greek-backend` | Follows naming convention |
| Port Mapping | `8000:8000` | Host:Container |
| Depends On | `postgres` (service_healthy) | Wait for database |
| Restart Policy | `unless-stopped` | Auto-restart on failure |
| Network | `learn-greek-network` | Shared with frontend/postgres |

### Environment Variables

| Variable | Development Value | Description |
|----------|-------------------|-------------|
| `ENVIRONMENT` | `development` | Application environment |
| `DATABASE_URL` | `postgresql+asyncpg://postgres:postgres@postgres:5432/learn_greek_easy` | Internal Docker network URL |
| `JWT_SECRET_KEY` | `dev-secret-key-change-in-production-32-chars` | JWT signing key |
| `JWT_ALGORITHM` | `HS256` | JWT algorithm |
| `ACCESS_TOKEN_EXPIRE_MINUTES` | `30` | Token expiration |
| `CORS_ORIGINS` | `http://localhost,http://localhost:80,http://localhost:3000,http://localhost:5173` | Allowed CORS origins |
| `API_V1_PREFIX` | `/api/v1` | API version prefix |
| `LOG_LEVEL` | `DEBUG` | Logging verbosity |

### Volume Mounts (Development)

| Host Path | Container Path | Purpose |
|-----------|----------------|---------|
| `./learn-greek-easy-backend/src` | `/app/src` | Hot reload source code |
| `./learn-greek-easy-backend/alembic` | `/app/alembic` | Migration files |
| `./learn-greek-easy-backend/logs` | `/app/logs` | Persistent logs |

### Health Check Configuration

```yaml
healthcheck:
  test: ["CMD", "curl", "--fail", "--silent", "http://localhost:8000/health"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 40s
```

### Nginx Reverse Proxy Configuration

The frontend nginx must proxy `/api/*` requests to the backend:

```
Client Request           Nginx (frontend:80)           Backend (backend:8000)
     │                          │                              │
     │  GET /api/v1/users       │                              │
     │─────────────────────────>│  proxy_pass backend:8000     │
     │                          │─────────────────────────────>│
     │                          │<─────────────────────────────│
     │<─────────────────────────│                              │
```

---

## Implementation Steps

### Step 1: Update nginx.conf for API Reverse Proxy

**File**: `learn-greek-easy-frontend/nginx.conf`

Add an `/api` location block before the SPA fallback to proxy API requests to the backend service.

**Changes**:
1. Add `upstream backend` definition
2. Add `/api` location with `proxy_pass`
3. Configure proxy headers for proper request forwarding
4. Add WebSocket support for future real-time features

### Step 2: Add Backend Service to docker-compose.yml

**File**: `docker-compose.yml` (root)

Add the backend service definition with:
- Build configuration pointing to `Dockerfile.dev`
- Environment variables for database and JWT
- Volume mounts for hot reload
- Health check configuration
- Dependency on postgres with health condition
- Network membership

### Step 3: Update Frontend Service Dependency

Modify the frontend service to depend on the backend being healthy, ensuring the API is available before the frontend starts.

### Step 4: Create logs Directory

**Location**: `learn-greek-easy-backend/logs/`

Create the logs directory with a `.gitkeep` file to ensure it exists for volume mounting.

### Step 5: Test Full Stack Startup

Run the complete stack and verify all services start correctly and communicate properly.

---

## File Contents

### nginx.conf (Updated)

```nginx
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Logging
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    access_log /var/log/nginx/access.log main;

    # Performance
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript
               application/json application/javascript application/xml+rss
               application/rss+xml font/truetype font/opentype
               application/vnd.ms-fontobject image/svg+xml;

    # ==========================================================================
    # Upstream: Backend API Server
    # ==========================================================================
    upstream backend {
        server backend:8000;
        keepalive 32;
    }

    server {
        listen 80;
        server_name _;
        root /usr/share/nginx/html;
        index index.html;

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;

        # Health check endpoint (nginx itself)
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # ======================================================================
        # API Proxy - Forward /api requests to backend
        # ======================================================================
        location /api {
            proxy_pass http://backend;
            proxy_http_version 1.1;

            # Headers for backend
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;

            # WebSocket support (for future real-time features)
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # Timeouts
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;

            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # ======================================================================
        # API Docs - Forward /docs and /openapi.json to backend
        # ======================================================================
        location /docs {
            proxy_pass http://backend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /redoc {
            proxy_pass http://backend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /openapi.json {
            proxy_pass http://backend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Static assets with caching
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        # SPA fallback - must be last
        location / {
            try_files $uri $uri/ /index.html;
        }
    }
}
```

### docker-compose.yml (Complete Updated File)

```yaml
version: '3.8'

services:
  # ==========================================================================
  # Frontend - Nginx serving React SPA + API Reverse Proxy
  # ==========================================================================
  frontend:
    build:
      context: ./learn-greek-easy-frontend
      dockerfile: Dockerfile
    image: learn-greek-easy-frontend:latest
    container_name: learn-greek-easy-frontend
    ports:
      - "80:80"
    environment:
      - NODE_ENV=production
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - learn-greek-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==========================================================================
  # Backend - FastAPI Application (Development Mode)
  # ==========================================================================
  backend:
    build:
      context: ./learn-greek-easy-backend
      dockerfile: Dockerfile.dev
    image: learn-greek-easy-backend:dev
    container_name: learn-greek-backend
    ports:
      - "8000:8000"
    environment:
      # Application
      - ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      # Database
      - DATABASE_URL=postgresql+asyncpg://postgres:postgres@postgres:5432/learn_greek_easy
      # JWT Authentication
      - JWT_SECRET_KEY=dev-secret-key-change-in-production-32-chars
      - JWT_ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_MINUTES=30
      # CORS
      - CORS_ORIGINS=http://localhost,http://localhost:80,http://localhost:3000,http://localhost:5173
      # API
      - API_V1_PREFIX=/api/v1
    volumes:
      # Mount source code for hot reload
      - ./learn-greek-easy-backend/src:/app/src
      - ./learn-greek-easy-backend/alembic:/app/alembic
      # Persist logs
      - ./learn-greek-easy-backend/logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - learn-greek-network
    healthcheck:
      test: ["CMD", "curl", "--fail", "--silent", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==========================================================================
  # PostgreSQL Database
  # ==========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: learn-greek-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: learn_greek_easy
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - learn-greek-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    command: >
      postgres
      -c shared_preload_libraries=pg_stat_statements
      -c pg_stat_statements.track=all
      -c max_connections=100
      -c shared_buffers=256MB

# =============================================================================
# Networks
# =============================================================================
networks:
  learn-greek-network:
    driver: bridge
    name: learn-greek-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres_data:
    name: learn-greek-easy-postgres-data
```

### logs/.gitkeep

Create an empty file to ensure the logs directory is tracked in git:

```
# This file ensures the logs directory exists for Docker volume mounting
# Actual log files are gitignored
```

### .gitignore Update (logs exclusion)

Ensure logs are excluded but the directory is kept:

```gitignore
# Logs
logs/*
!logs/.gitkeep
*.log
```

---

## Validation

### Pre-Flight Checklist

- [ ] Backend Dockerfile.dev exists at `learn-greek-easy-backend/Dockerfile.dev`
- [ ] Backend health endpoint exists at `/health`
- [ ] PostgreSQL container is healthy
- [ ] Frontend nginx.conf has been updated with API proxy configuration

### Build Validation

```bash
# Navigate to project root
cd /Users/samosipov/Downloads/learn-greek-easy

# Build all services
docker-compose build

# Expected: All three services build successfully
```

| Service | Expected Result |
|---------|-----------------|
| frontend | Built with updated nginx.conf |
| backend | Built from Dockerfile.dev |
| postgres | Uses official image (no build) |

### Startup Validation

```bash
# Start all services
cd /Users/samosipov/Downloads/learn-greek-easy && docker-compose up -d

# Check container status
docker-compose ps

# Expected output:
# NAME                        STATUS              PORTS
# learn-greek-backend         Up (healthy)        0.0.0.0:8000->8000/tcp
# learn-greek-easy-frontend   Up (healthy)        0.0.0.0:80->80/tcp
# learn-greek-postgres        Up (healthy)        0.0.0.0:5433->5432/tcp
```

### Health Check Validation

```bash
# Backend direct health check
curl -s http://localhost:8000/health
# Expected: JSON response with "status": "healthy" or similar

# Frontend health check
curl -s http://localhost/health
# Expected: "healthy"

# API through nginx proxy
curl -s http://localhost/api/v1/health
# Expected: Same response as direct backend call
```

### API Proxy Validation

```bash
# Test API documentation is accessible through nginx
curl -s -o /dev/null -w "%{http_code}" http://localhost/docs
# Expected: 200

curl -s -o /dev/null -w "%{http_code}" http://localhost/openapi.json
# Expected: 200
```

### Hot Reload Validation

```bash
# 1. Start services
docker-compose up -d

# 2. Make a change to a source file
# Edit learn-greek-easy-backend/src/main.py (add a comment)

# 3. Check backend logs for reload
docker-compose logs -f backend | grep -i "reload"
# Expected: "WatchFiles detected changes in 'src/main.py'. Reloading..."

# 4. Verify change is reflected (if you added a test endpoint)
curl http://localhost:8000/api/v1/test
```

### Network Connectivity Validation

```bash
# Enter backend container
docker exec -it learn-greek-backend bash

# Test connectivity to postgres
curl -v telnet://postgres:5432
# OR
python -c "import socket; s=socket.create_connection(('postgres', 5432)); print('OK'); s.close()"

# Test connectivity from frontend to backend
docker exec -it learn-greek-easy-frontend sh
wget -q -O- http://backend:8000/health
# Expected: Health check response
```

### Service Dependency Validation

```bash
# Stop all containers
docker-compose down

# Start with dependency logging
docker-compose up 2>&1 | grep -E "(Starting|Waiting|Healthy)"
# Expected order: postgres starts -> becomes healthy -> backend starts -> becomes healthy -> frontend starts
```

### Complete Validation Checklist

- [ ] `docker-compose build` succeeds for all services
- [ ] `docker-compose up -d` starts all services
- [ ] All three containers show as "healthy" in `docker-compose ps`
- [ ] Backend responds at `http://localhost:8000/health`
- [ ] Frontend responds at `http://localhost/health`
- [ ] API proxy works: `http://localhost/api/v1/...` routes to backend
- [ ] API docs accessible at `http://localhost/docs`
- [ ] Hot reload works when editing source files
- [ ] Backend can connect to postgres (check logs for successful DB connection)
- [ ] Services start in correct order (postgres -> backend -> frontend)
- [ ] Logs directory exists and receives log output

---

## Troubleshooting

### Common Issues

| Issue | Symptom | Cause | Solution |
|-------|---------|-------|----------|
| Backend fails to start | Container exits immediately | Missing dependencies or config error | Check logs: `docker-compose logs backend` |
| Database connection refused | "Connection refused" in backend logs | postgres not ready | Verify `depends_on` with `service_healthy` condition |
| Hot reload not working | Changes not reflected | Volume mount incorrect | Verify volume paths match exactly |
| API proxy 502 error | "Bad Gateway" from nginx | Backend not reachable | Check backend health, verify upstream name |
| Health check failing | Container marked unhealthy | App not started or wrong endpoint | Increase `start_period`, verify `/health` endpoint |
| nginx config syntax error | Frontend container won't start | Typo in nginx.conf | Validate: `nginx -t` inside container |
| Port already in use | "Bind: address already in use" | Another service on port | Stop conflicting service or change port |
| Volume permission denied | Can't write to mounted directory | UID mismatch | Check directory permissions (1000:1000) |

### Debug Commands

```bash
# View all logs
docker-compose logs

# View specific service logs with follow
docker-compose logs -f backend

# View last 50 lines of logs
docker-compose logs --tail=50 backend

# Check container health status
docker inspect learn-greek-backend --format='{{.State.Health.Status}}'

# Execute command in running container
docker exec -it learn-greek-backend bash

# Test nginx configuration syntax
docker exec -it learn-greek-easy-frontend nginx -t

# View effective nginx configuration
docker exec -it learn-greek-easy-frontend nginx -T

# Check network connectivity between containers
docker network inspect learn-greek-network

# Check what ports are exposed
docker-compose port backend 8000

# Force rebuild without cache
docker-compose build --no-cache backend

# Restart single service
docker-compose restart backend
```

### Log Analysis

```bash
# Check for database connection issues
docker-compose logs backend 2>&1 | grep -i "database\|postgres\|connection"

# Check for import/module errors
docker-compose logs backend 2>&1 | grep -i "import\|module\|error"

# Check nginx proxy errors
docker-compose logs frontend 2>&1 | grep -i "upstream\|proxy\|backend"

# Check health check failures
docker-compose logs backend 2>&1 | grep -i "health"
```

### Recovery Procedures

**Scenario: Backend won't start due to DB migration error**
```bash
# 1. Check migration status
docker exec -it learn-greek-backend alembic current

# 2. If migrations are broken, reset
docker exec -it learn-greek-backend alembic downgrade base
docker exec -it learn-greek-backend alembic upgrade head

# 3. If database is corrupted, recreate
docker-compose down -v  # WARNING: Deletes all data
docker-compose up -d
```

**Scenario: nginx proxy not working**
```bash
# 1. Verify backend is reachable from nginx container
docker exec -it learn-greek-easy-frontend wget -q -O- http://backend:8000/health

# 2. If DNS resolution fails, check network
docker network inspect learn-greek-network | grep -A5 "Containers"

# 3. Rebuild frontend to pick up nginx.conf changes
docker-compose build frontend
docker-compose up -d frontend
```

**Scenario: Volumes not syncing**
```bash
# 1. Check volume mounts
docker inspect learn-greek-backend --format='{{range .Mounts}}{{.Source}} -> {{.Destination}}{{println}}{{end}}'

# 2. Verify host paths exist
ls -la /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src

# 3. Check container has write access
docker exec -it learn-greek-backend touch /app/src/test_write
```

---

## Next Steps

After completing task 01.02:

1. **Task 01.03**: Create `docker-compose.prod.yml` for production deployment
2. **Task 01.04**: Add Redis service for caching/sessions
3. **Task 01.05**: Implement enhanced health endpoint with dependency checks
4. **Task 01.06**: Create `.env.example` template file
5. **Task 01.07**: Add Celery worker services for background tasks

---

## Files Modified/Created Summary

| File | Action | Purpose |
|------|--------|---------|
| `docker-compose.yml` | MODIFY | Add backend service |
| `learn-greek-easy-frontend/nginx.conf` | MODIFY | Add API reverse proxy |
| `learn-greek-easy-backend/logs/.gitkeep` | CREATE | Ensure logs directory exists |
| `learn-greek-easy-backend/.gitignore` | MODIFY | Exclude logs but keep directory |

---

## Execution Checklist for Implementer

1. [ ] Read current `docker-compose.yml` state
2. [ ] Create `logs/.gitkeep` in backend directory
3. [ ] Update `.gitignore` to exclude log files
4. [ ] Update `nginx.conf` with API proxy configuration
5. [ ] Update `docker-compose.yml` with backend service
6. [ ] Run `docker-compose build` to verify builds succeed
7. [ ] Run `docker-compose up -d` to start all services
8. [ ] Verify all health checks pass
9. [ ] Test API proxy through nginx
10. [ ] Test hot reload functionality
11. [ ] Document any issues encountered

---

**Ready for executor mode.**
