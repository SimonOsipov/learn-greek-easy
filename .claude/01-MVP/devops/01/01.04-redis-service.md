# 01.04 Add Redis Service - Detailed Execution Plan

**Project**: Learn Greek Easy - DevOps
**Task**: Add Redis Service to Docker Compose Configurations
**Parent**: [01-docker-architecture.md](./01-docker-architecture.md)
**Created**: 2025-12-02
**Status**: ✅ COMPLETED (2025-12-02)

---

## Table of Contents

1. [Objective](#objective)
2. [Prerequisites](#prerequisites)
3. [Technical Specifications](#technical-specifications)
4. [Implementation Steps](#implementation-steps)
5. [File Contents](#file-contents)
6. [Validation](#validation)
7. [Troubleshooting](#troubleshooting)
8. [Next Steps](#next-steps)

---

## Objective

Add Redis service to both development and production Docker Compose configurations to enable:
- **Session Storage**: User session management
- **Caching**: Application-level caching for improved performance
- **Celery Broker**: Message broker for background task processing
- **Rate Limiting**: API rate limiting (future feature)

---

## Prerequisites

### Completed Dependencies

| Task | Status | Artifacts |
|------|--------|-----------|
| 01.01 Backend Dockerfile | COMPLETED | `Dockerfile`, `Dockerfile.dev`, `docker-entrypoint.sh`, `.dockerignore` |
| 01.02 Docker Compose Backend | COMPLETED | Updated `docker-compose.yml`, `docker-compose.dev.yml`, nginx config |
| 01.03 Production Docker Compose | COMPLETED | `docker-compose.yml` (production) |

### Verified Files Exist

```
learn-greek-easy/
├── docker-compose.yml              # Production - Target for Redis addition
├── docker-compose.dev.yml          # Development - Target for Redis addition
└── learn-greek-easy-backend/
    ├── src/
    │   └── config.py               # Settings (will need REDIS_URL)
    └── pyproject.toml              # Already has redis dependency
```

### Backend Redis Dependency Verified

From `pyproject.toml`:
```toml
redis = "^5.0.8"
```

The backend already has the Redis Python client installed.

---

## Technical Specifications

### Redis Configuration Overview

| Parameter | Development | Production |
|-----------|-------------|------------|
| Image | `redis:7-alpine` | `redis:7-alpine` |
| Container Name | `learn-greek-redis-dev` | `learn-greek-redis` |
| Port Mapping | `6379:6379` (exposed) | None (internal only) |
| Volume | `redis_data_dev:/data` | `redis_data:/data` |
| Network | `learn-greek-network-dev` | `learn-greek-network` |
| Persistence | AOF enabled | AOF enabled |
| Memory Limit | 128MB | 128MB |
| Eviction Policy | `allkeys-lru` | `allkeys-lru` |

### Redis Command Configuration

```
redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
```

**Flag Explanation**:

| Flag | Value | Purpose |
|------|-------|---------|
| `--appendonly` | `yes` | Enable Append-Only File persistence for data durability |
| `--maxmemory` | `128mb` | Maximum memory Redis can use |
| `--maxmemory-policy` | `allkeys-lru` | When memory limit reached, evict least recently used keys |

### Environment Variables

| Variable | Development Value | Production Value | Description |
|----------|-------------------|------------------|-------------|
| `REDIS_URL` | `redis://redis:6379/0` | `redis://redis:6379/0` | Redis connection string |
| `REDIS_HOST` | `redis` | `redis` | Redis hostname (internal DNS) |
| `REDIS_PORT` | `6379` | `6379` | Redis port |
| `REDIS_DB` | `0` | `0` | Redis database number |

### Health Check Configuration

```yaml
healthcheck:
  test: ["CMD", "redis-cli", "ping"]
  interval: 10s
  timeout: 5s
  retries: 3
  start_period: 5s
```

**Health Check Details**:
- `redis-cli ping` returns `PONG` when Redis is healthy
- Short start period (5s) - Redis starts very quickly
- Fast interval (10s) - Critical service for caching/sessions

### Resource Limits (Production)

```yaml
deploy:
  resources:
    limits:
      cpus: '0.25'
      memory: 256M
    reservations:
      cpus: '0.1'
      memory: 64M
```

### Service Topology with Redis

```
                    ┌─────────────────┐
                    │   nginx:80      │
                    │   (frontend)    │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │   FastAPI:8000  │
                    │   (backend)     │
                    └────────┬────────┘
                             │
              ┌──────────────┼──────────────┐
              │              │              │
              ▼              ▼              ▼
    ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
    │ PostgreSQL  │  │    Redis    │  │   Celery    │
    │   :5432     │  │   :6379     │  │  (workers)  │
    └─────────────┘  └─────────────┘  └─────────────┘
```

---

## Implementation Steps

### Step 1: Add Redis Service to docker-compose.dev.yml

**File**: `docker-compose.dev.yml`

Add Redis service definition for development environment with:
- Port exposed for local debugging tools (Redis CLI, RedisInsight)
- Separate development network and volume
- Health check configuration

### Step 2: Add Redis Service to docker-compose.yml (Production)

**File**: `docker-compose.yml`

Add Redis service definition for production environment with:
- No port exposed (internal network only)
- Resource limits for container orchestration
- Named volume for persistence
- Health check configuration

### Step 3: Update Backend Service Dependencies

Update both development and production backend services to:
- Add `depends_on` for Redis with health condition
- Add `REDIS_URL` environment variable

### Step 4: Add redis_data Volume Definitions

Add named volumes for Redis data persistence in both environments:
- `redis_data` for production
- `redis_data_dev` for development

### Step 5: Create Redis Healthcheck Script (Optional)

For more comprehensive health checks, create a script that verifies Redis memory and connectivity.

### Step 6: Test Redis Connectivity

Verify Redis is accessible from the backend container and responds to commands.

---

## File Contents

### docker-compose.dev.yml (Updated - Redis Section)

Add the following Redis service definition to the existing `docker-compose.dev.yml`:

```yaml
  # ==========================================================================
  # Redis - Cache and Session Store (Development)
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: learn-greek-redis-dev
    command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis_data_dev:/data
    networks:
      - learn-greek-network-dev
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
```

**Backend Service Updates** (add to existing backend service):

```yaml
  backend:
    # ... existing configuration ...
    environment:
      # ... existing environment variables ...
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
```

**Volume Definition** (add to existing volumes section):

```yaml
volumes:
  postgres_data_dev:
    name: learn-greek-postgres-data-dev
  redis_data_dev:
    name: learn-greek-redis-data-dev
```

### docker-compose.yml (Updated - Redis Section)

Add the following Redis service definition to the existing production `docker-compose.yml`:

```yaml
  # ==========================================================================
  # Redis - Cache and Session Store (Production)
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: learn-greek-redis
    command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - learn-greek-network
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    restart: unless-stopped
```

**Backend Service Updates** (add to existing backend service):

```yaml
  backend:
    # ... existing configuration ...
    environment:
      # ... existing environment variables ...
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
```

**Volume Definition** (add to existing volumes section):

```yaml
volumes:
  postgres_data:
    name: learn-greek-postgres-data
  redis_data:
    name: learn-greek-redis-data
```

### Complete docker-compose.dev.yml (Full File)

```yaml
version: '3.8'

services:
  # ==========================================================================
  # Frontend - Vite Dev Server with Hot Reload
  # ==========================================================================
  frontend:
    build:
      context: ./learn-greek-easy-frontend
      dockerfile: Dockerfile
      target: builder
    image: learn-greek-frontend:latest
    container_name: learn-greek-frontend-dev
    ports:
      - "5173:5173"
    environment:
      - NODE_ENV=development
      - VITE_API_URL=http://localhost:8000
    volumes:
      - ./learn-greek-easy-frontend/src:/app/src:cached
      - ./learn-greek-easy-frontend/public:/app/public:cached
      - ./learn-greek-easy-frontend/index.html:/app/index.html:cached
      - ./learn-greek-easy-frontend/vite.config.ts:/app/vite.config.ts:cached
      - ./learn-greek-easy-frontend/tailwind.config.js:/app/tailwind.config.js:cached
      - ./learn-greek-easy-frontend/postcss.config.js:/app/postcss.config.js:cached
    command: npm run dev -- --host 0.0.0.0
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - learn-greek-network-dev

  # ==========================================================================
  # Backend - FastAPI with Hot Reload
  # ==========================================================================
  backend:
    build:
      context: ./learn-greek-easy-backend
      dockerfile: Dockerfile.dev
    image: learn-greek-backend:latest
    container_name: learn-greek-backend-dev
    ports:
      - "8000:8000"
    environment:
      - ENVIRONMENT=development
      - DEBUG=true
      - LOG_LEVEL=DEBUG
      - DATABASE_URL=postgresql+asyncpg://postgres:postgres@postgres:5432/learn_greek_easy
      - REDIS_URL=redis://redis:6379/0
      - JWT_SECRET_KEY=dev-secret-key-change-in-production-32-chars
      - JWT_ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_MINUTES=30
      - CORS_ORIGINS=["http://localhost","http://localhost:80","http://localhost:3000","http://localhost:5173"]
      - API_V1_PREFIX=/api/v1
    volumes:
      - ./learn-greek-easy-backend/src:/app/src
      - ./learn-greek-easy-backend/alembic:/app/alembic
      - ./learn-greek-easy-backend/logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - learn-greek-network-dev
    healthcheck:
      test: ["CMD", "curl", "--fail", "--silent", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==========================================================================
  # PostgreSQL Database
  # ==========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: learn-greek-postgres-dev
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: learn_greek_easy
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
    ports:
      - "5433:5432"
    volumes:
      - postgres_data_dev:/var/lib/postgresql/data
    networks:
      - learn-greek-network-dev
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================================
  # Redis - Cache and Session Store
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: learn-greek-redis-dev
    command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis_data_dev:/data
    networks:
      - learn-greek-network-dev
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

# =============================================================================
# Networks
# =============================================================================
networks:
  learn-greek-network-dev:
    driver: bridge
    name: learn-greek-network-dev

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres_data_dev:
    name: learn-greek-postgres-data-dev
  redis_data_dev:
    name: learn-greek-redis-data-dev
```

### Complete docker-compose.yml (Full File - Production)

```yaml
version: '3.8'

services:
  # ==========================================================================
  # Frontend - Nginx serving React SPA
  # ==========================================================================
  frontend:
    build:
      context: ./learn-greek-easy-frontend
      dockerfile: Dockerfile
    image: learn-greek-frontend:${IMAGE_TAG:-1.0.0}
    container_name: learn-greek-frontend
    ports:
      - "80:80"
    environment:
      - NODE_ENV=production
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - learn-greek-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==========================================================================
  # Backend - FastAPI Application
  # ==========================================================================
  backend:
    build:
      context: ./learn-greek-easy-backend
      dockerfile: Dockerfile
    image: learn-greek-backend:${IMAGE_TAG:-1.0.0}
    container_name: learn-greek-backend
    ports:
      - "8000:8000"
    environment:
      - ENVIRONMENT=production
      - DEBUG=false
      - LOG_LEVEL=INFO
      - DATABASE_URL=postgresql+asyncpg://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-learn_greek_easy}
      - REDIS_URL=redis://redis:6379/0
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
      - JWT_ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_MINUTES=30
      - CORS_ORIGINS=${CORS_ORIGINS:-["https://yourdomain.com"]}
      - API_V1_PREFIX=/api/v1
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - learn-greek-network
    healthcheck:
      test: ["CMD", "curl", "--fail", "--silent", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==========================================================================
  # PostgreSQL Database
  # ==========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: learn-greek-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-learn_greek_easy}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - learn-greek-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ==========================================================================
  # Redis - Cache and Session Store
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: learn-greek-redis
    command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - learn-greek-network
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    restart: unless-stopped

# =============================================================================
# Networks
# =============================================================================
networks:
  learn-greek-network:
    driver: bridge
    name: learn-greek-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres_data:
    name: learn-greek-postgres-data
  redis_data:
    name: learn-greek-redis-data
```

### Backend Configuration Update (Optional)

If the backend `config.py` needs updating to include Redis settings:

```python
# src/config.py (add to existing Settings class)

class Settings(BaseSettings):
    # ... existing settings ...

    # Redis
    redis_url: str = "redis://localhost:6379/0"

    # Celery (uses Redis as broker)
    celery_broker_url: str = "redis://localhost:6379/0"
    celery_result_backend: str = "redis://localhost:6379/1"

    class Config:
        env_file = ".env"
        case_sensitive = False
```

### .env.example Update

Add Redis-related environment variables to the `.env.example` template:

```bash
# =============================================================================
# Redis Configuration
# =============================================================================
REDIS_URL=redis://redis:6379/0

# Celery (if using background tasks)
CELERY_BROKER_URL=redis://redis:6379/0
CELERY_RESULT_BACKEND=redis://redis:6379/1
```

---

## Validation

### Pre-Flight Checklist

- [ ] `docker-compose.yml` exists in project root
- [ ] `docker-compose.dev.yml` exists in project root
- [ ] Backend has `redis` dependency in `pyproject.toml`
- [ ] No existing container named `learn-greek-redis` or `learn-greek-redis-dev`

### Build Validation

```bash
# Navigate to project root
cd /Users/samosipov/Downloads/learn-greek-easy

# Validate compose file syntax (development)
docker-compose -f docker-compose.dev.yml config

# Validate compose file syntax (production)
docker-compose config

# Expected: YAML output without errors
```

### Startup Validation

```bash
# Development environment
cd /Users/samosipov/Downloads/learn-greek-easy && docker-compose -f docker-compose.dev.yml up -d

# Check container status
docker-compose -f docker-compose.dev.yml ps

# Expected output:
# NAME                        STATUS              PORTS
# learn-greek-backend-dev     Up (healthy)        0.0.0.0:8000->8000/tcp
# learn-greek-frontend-dev    Up                  0.0.0.0:5173->5173/tcp
# learn-greek-postgres-dev    Up (healthy)        0.0.0.0:5433->5432/tcp
# learn-greek-redis-dev       Up (healthy)        0.0.0.0:6379->6379/tcp
```

### Redis Health Check Validation

```bash
# Check Redis container health
docker inspect learn-greek-redis-dev --format='{{.State.Health.Status}}'
# Expected: healthy

# Test Redis ping directly
docker exec learn-greek-redis-dev redis-cli ping
# Expected: PONG

# Test Redis from host (development only)
redis-cli -h localhost -p 6379 ping
# Expected: PONG
```

### Redis Connectivity from Backend

```bash
# Enter backend container
docker exec -it learn-greek-backend-dev bash

# Test Redis connection with Python
python -c "
import redis
r = redis.from_url('redis://redis:6379/0')
print('SET test:', r.set('test_key', 'hello'))
print('GET test:', r.get('test_key'))
print('DEL test:', r.delete('test_key'))
"
# Expected:
# SET test: True
# GET test: b'hello'
# DEL test: 1
```

### Redis Data Persistence Validation

```bash
# 1. Set a value in Redis
docker exec learn-greek-redis-dev redis-cli SET persistence_test "this_should_persist"

# 2. Restart Redis container
docker-compose -f docker-compose.dev.yml restart redis

# 3. Wait for container to be healthy
sleep 5

# 4. Verify value persisted
docker exec learn-greek-redis-dev redis-cli GET persistence_test
# Expected: "this_should_persist"

# 5. Cleanup
docker exec learn-greek-redis-dev redis-cli DEL persistence_test
```

### Redis Memory Configuration Validation

```bash
# Check memory configuration
docker exec learn-greek-redis-dev redis-cli CONFIG GET maxmemory
# Expected: maxmemory 134217728 (128MB in bytes)

docker exec learn-greek-redis-dev redis-cli CONFIG GET maxmemory-policy
# Expected: maxmemory-policy allkeys-lru

# Check persistence configuration
docker exec learn-greek-redis-dev redis-cli CONFIG GET appendonly
# Expected: appendonly yes
```

### Service Dependency Validation

```bash
# Stop all containers
docker-compose -f docker-compose.dev.yml down

# Start and observe startup order
docker-compose -f docker-compose.dev.yml up 2>&1 | grep -E "(Starting|Healthy|redis)"

# Expected order:
# 1. postgres and redis start simultaneously
# 2. postgres and redis become healthy
# 3. backend starts
# 4. backend becomes healthy
# 5. frontend starts
```

### Complete Validation Checklist

- [ ] `docker-compose config` validates without errors (both files)
- [ ] Redis container starts and shows as "healthy"
- [ ] `redis-cli ping` returns `PONG`
- [ ] Backend can connect to Redis (Python test)
- [ ] Redis data persists across container restarts
- [ ] Memory limit is set to 128MB
- [ ] Eviction policy is `allkeys-lru`
- [ ] AOF persistence is enabled
- [ ] Backend waits for Redis health before starting
- [ ] Volume `redis_data_dev` (or `redis_data`) is created

---

## Troubleshooting

### Common Issues

| Issue | Symptom | Cause | Solution |
|-------|---------|-------|----------|
| Redis container won't start | Exit code 1 | Invalid command flags | Check redis-server command syntax |
| Connection refused from backend | "Connection refused" error | Redis not ready or wrong hostname | Verify `depends_on` with health condition |
| Data not persisting | Data lost after restart | Volume not mounted or AOF disabled | Check volume mount and `--appendonly yes` |
| Memory errors | OOM killer terminates Redis | Memory limit too low | Increase `--maxmemory` value |
| Port already in use | "Bind: address already in use" | Another Redis instance running | Stop other Redis or change port |
| Health check failing | Container marked unhealthy | `redis-cli` not found or Redis not responding | Verify image is `redis:7-alpine` |
| Backend can't find redis host | DNS resolution failed | Different network or typo in hostname | Verify both services on same network |

### Debug Commands

```bash
# View Redis container logs
docker-compose -f docker-compose.dev.yml logs redis

# Follow Redis logs in real-time
docker-compose -f docker-compose.dev.yml logs -f redis

# View last 50 log lines
docker-compose -f docker-compose.dev.yml logs --tail=50 redis

# Check container health details
docker inspect learn-greek-redis-dev --format='{{json .State.Health}}' | jq

# Execute Redis CLI in container
docker exec -it learn-greek-redis-dev redis-cli

# View all Redis configuration
docker exec learn-greek-redis-dev redis-cli CONFIG GET "*"

# Check Redis memory usage
docker exec learn-greek-redis-dev redis-cli INFO memory

# Check Redis client connections
docker exec learn-greek-redis-dev redis-cli CLIENT LIST

# Monitor Redis commands in real-time
docker exec -it learn-greek-redis-dev redis-cli MONITOR

# Check network connectivity
docker network inspect learn-greek-network-dev

# Verify Redis is on network
docker network inspect learn-greek-network-dev | grep -A10 "redis"
```

### Recovery Procedures

**Scenario: Redis won't start due to corrupted AOF file**
```bash
# 1. Stop Redis container
docker-compose -f docker-compose.dev.yml stop redis

# 2. Check AOF file (if accessible)
docker run --rm -v learn-greek-redis-data-dev:/data redis:7-alpine ls -la /data

# 3. If corrupted, remove and recreate volume
docker-compose -f docker-compose.dev.yml down
docker volume rm learn-greek-redis-data-dev
docker-compose -f docker-compose.dev.yml up -d
```

**Scenario: Backend can't connect to Redis**
```bash
# 1. Verify Redis is healthy
docker-compose -f docker-compose.dev.yml ps redis

# 2. Test connectivity from backend container
docker exec -it learn-greek-backend-dev python -c "
import socket
try:
    s = socket.create_connection(('redis', 6379), timeout=5)
    print('Connection successful')
    s.close()
except Exception as e:
    print(f'Connection failed: {e}')
"

# 3. If DNS fails, check network
docker network inspect learn-greek-network-dev | grep -E "(Name|IPv4)"

# 4. Rebuild if necessary
docker-compose -f docker-compose.dev.yml down
docker-compose -f docker-compose.dev.yml up -d --force-recreate redis
```

**Scenario: Redis memory limit reached**
```bash
# 1. Check current memory usage
docker exec learn-greek-redis-dev redis-cli INFO memory | grep used_memory_human

# 2. Check number of keys
docker exec learn-greek-redis-dev redis-cli DBSIZE

# 3. If needed, flush database (CAUTION: Deletes all data)
docker exec learn-greek-redis-dev redis-cli FLUSHALL

# 4. Or increase memory limit by updating command in docker-compose
# Change: --maxmemory 256mb
```

---

## Security Considerations

### Production Security

| Consideration | Implementation |
|---------------|----------------|
| No external port exposure | Production Redis has no `ports` mapping |
| Network isolation | Only containers on `learn-greek-network` can access Redis |
| No authentication (internal) | Acceptable for internal-only access; add `--requirepass` for external |
| Data encryption | Not enabled (add TLS for sensitive data) |
| Memory limits | Prevents DoS via memory exhaustion |

### Future Enhancements (If External Access Needed)

```yaml
# Add password authentication
command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru --requirepass ${REDIS_PASSWORD}

# Add TLS (requires certificates)
command: redis-server --appendonly yes --maxmemory 128mb --tls-port 6379 --port 0 --tls-cert-file /certs/redis.crt --tls-key-file /certs/redis.key
```

---

## Files Modified/Created Summary

| File | Action | Purpose |
|------|--------|---------|
| `docker-compose.yml` | MODIFY | Add Redis service for production |
| `docker-compose.dev.yml` | MODIFY | Add Redis service for development |
| `.env.example` | MODIFY | Add REDIS_URL variable (optional) |

---

## Next Steps

After completing task 01.04:

1. **Task 01.05**: Implement enhanced health endpoint with Redis connectivity check
2. **Task 01.06**: Update `.env.example` with all environment variables
3. **Task 01.07**: Add Celery worker services (uses Redis as broker)
4. **Task 01.08**: Documentation update for CLAUDE.md and README

---

## Execution Checklist for Implementer

1. [ ] Read current `docker-compose.yml` state
2. [ ] Read current `docker-compose.dev.yml` state
3. [ ] Add Redis service to `docker-compose.dev.yml`
4. [ ] Add `REDIS_URL` to backend environment in `docker-compose.dev.yml`
5. [ ] Add Redis to backend `depends_on` in `docker-compose.dev.yml`
6. [ ] Add `redis_data_dev` volume definition to `docker-compose.dev.yml`
7. [ ] Add Redis service to `docker-compose.yml` (production)
8. [ ] Add `REDIS_URL` to backend environment in `docker-compose.yml`
9. [ ] Add Redis to backend `depends_on` in `docker-compose.yml`
10. [ ] Add `redis_data` volume definition to `docker-compose.yml`
11. [ ] Run `docker-compose -f docker-compose.dev.yml config` to validate
12. [ ] Run `docker-compose config` to validate production
13. [ ] Start services: `docker-compose -f docker-compose.dev.yml up -d`
14. [ ] Verify all containers are healthy
15. [ ] Test Redis connectivity from backend
16. [ ] Test Redis data persistence
17. [ ] Document any issues encountered

---

**Ready for executor mode.**
