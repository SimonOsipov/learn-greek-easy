# 05.04 Redis Connection Pooling

**Project**: Learn Greek Easy - DevOps
**Task**: Redis Connection Pool Management
**Parent**: [05-redis-configuration.md](./05-redis-configuration.md)
**Created**: 2025-12-03
**Status**: COMPLETE

---

## Table of Contents

1. [Objective](#objective)
2. [Implementation Summary](#implementation-summary)
3. [Technical Details](#technical-details)
4. [API Reference](#api-reference)
5. [Usage Examples](#usage-examples)
6. [Validation](#validation)

---

## Objective

Implement Redis connection pooling for the FastAPI backend to:
- Efficiently manage Redis connections across concurrent requests
- Provide graceful startup and shutdown
- Enable health check integration
- Support degraded mode when Redis is unavailable

---

## Implementation Summary

This task was completed as part of **Task 01.05 (Health Endpoints)** which required Redis integration. A complete connection pool management module was implemented.

### What Was Implemented

| Component | Location | Status |
|-----------|----------|--------|
| Redis client module | `src/core/redis.py` | COMPLETE |
| Connection pool initialization | `init_redis()` | COMPLETE |
| Graceful shutdown | `close_redis()` | COMPLETE |
| Client accessor | `get_redis()` | COMPLETE |
| Health check function | `check_redis_health()` | COMPLETE |
| Lifespan integration | `src/main.py` | COMPLETE |

---

## Technical Details

### Connection Pool Configuration

| Parameter | Value | Description |
|-----------|-------|-------------|
| `max_connections` | 10 | Maximum connections in pool |
| `decode_responses` | `True` | Auto-decode bytes to strings |
| `socket_timeout` | 3s (configurable) | Read/write timeout |
| `socket_connect_timeout` | 3s (configurable) | Connection timeout |

### Current Implementation

**File**: `src/core/redis.py`

```python
"""Redis client management with connection pooling."""

import asyncio
import logging
from typing import Optional, Tuple

from redis.asyncio import ConnectionPool, Redis
from redis.exceptions import ConnectionError, TimeoutError

from src.config import settings

logger = logging.getLogger(__name__)

# Global Redis client instance
_redis_client: Optional[Redis] = None
_connection_pool: Optional[ConnectionPool] = None


async def init_redis() -> None:
    """
    Initialize Redis connection pool on application startup.

    Should be called in FastAPI lifespan startup event.
    """
    global _redis_client, _connection_pool

    if _redis_client is not None:
        logger.warning("Redis client already initialized")
        return

    logger.info("Initializing Redis connection...")

    try:
        # Create connection pool
        _connection_pool = ConnectionPool.from_url(
            settings.redis_url,
            max_connections=10,
            decode_responses=True,
            socket_timeout=settings.health_check_redis_timeout,
            socket_connect_timeout=settings.health_check_redis_timeout,
        )

        # Create client with pool
        _redis_client = Redis(connection_pool=_connection_pool)

        # Test connection
        await _redis_client.ping()
        logger.info("Redis connection successful")

    except Exception as e:
        logger.warning(f"Redis connection failed: {e}. Application will run in degraded mode.")
        _redis_client = None
        _connection_pool = None


async def close_redis() -> None:
    """
    Close Redis connection on application shutdown.

    Should be called in FastAPI lifespan shutdown event.
    """
    global _redis_client, _connection_pool

    if _redis_client is None:
        return

    logger.info("Closing Redis connection...")

    try:
        await _redis_client.close()
        if _connection_pool:
            await _connection_pool.disconnect()
    except Exception as e:
        logger.error(f"Error closing Redis connection: {e}")
    finally:
        _redis_client = None
        _connection_pool = None

    logger.info("Redis connection closed")


def get_redis() -> Optional[Redis]:
    """
    Get the global Redis client instance.

    Returns:
        Redis client or None if not initialized/available
    """
    return _redis_client


async def check_redis_health(timeout: Optional[float] = None) -> Tuple[bool, float, str]:
    """
    Check Redis connection health.

    Args:
        timeout: Optional timeout override in seconds

    Returns:
        Tuple of (is_healthy, latency_ms, message)
    """
    if _redis_client is None:
        return False, 0.0, "Redis client not initialized"

    check_timeout = timeout or settings.health_check_redis_timeout

    try:
        start_time = asyncio.get_event_loop().time()

        # Use asyncio.wait_for for timeout control
        await asyncio.wait_for(
            _redis_client.ping(),
            timeout=check_timeout,
        )

        latency_ms = (asyncio.get_event_loop().time() - start_time) * 1000

        return True, latency_ms, "PONG received"

    except asyncio.TimeoutError:
        return False, 0.0, f"Connection timeout after {check_timeout}s"

    except ConnectionError as e:
        return False, 0.0, f"Connection error: {str(e)}"

    except TimeoutError as e:
        return False, 0.0, f"Timeout error: {str(e)}"

    except Exception as e:
        return False, 0.0, f"Unexpected error: {str(e)}"
```

### Lifespan Integration

**File**: `src/main.py` (relevant section)

```python
from src.core.redis import close_redis, init_redis

@asynccontextmanager
async def lifespan(app: FastAPI) -> AsyncGenerator[None, None]:
    """Application lifespan manager."""
    # Startup
    logger.info("Starting Learn Greek Easy API", extra={"version": settings.app_version})

    # Initialize database connection
    await init_db()

    # Initialize Redis connection
    await init_redis()

    yield

    # Shutdown
    logger.info("Shutting down Learn Greek Easy API")

    # Close Redis connection
    await close_redis()

    # Close database connection
    await close_db()
```

---

## API Reference

### `init_redis() -> None`

Initialize the Redis connection pool. Call during application startup.

**Behavior**:
- Creates connection pool from `REDIS_URL` environment variable
- Tests connection with PING command
- Logs success or failure
- Sets global client to `None` on failure (degraded mode)

### `close_redis() -> None`

Close the Redis connection pool. Call during application shutdown.

**Behavior**:
- Closes the Redis client
- Disconnects the connection pool
- Resets global variables
- Logs errors but doesn't raise

### `get_redis() -> Optional[Redis]`

Get the global Redis client instance.

**Returns**:
- `Redis` client if connected
- `None` if not initialized or connection failed

### `check_redis_health(timeout: float = None) -> Tuple[bool, float, str]`

Check Redis connection health.

**Parameters**:
- `timeout`: Optional timeout in seconds (defaults to `HEALTH_CHECK_REDIS_TIMEOUT`)

**Returns**:
- Tuple of `(is_healthy: bool, latency_ms: float, message: str)`

---

## Usage Examples

### Basic Usage

```python
from src.core.redis import get_redis

async def cache_user_data(user_id: str, data: dict):
    redis = get_redis()
    if redis is None:
        # Graceful degradation - skip caching
        return

    await redis.set(f"user:{user_id}", json.dumps(data), ex=3600)

async def get_cached_user(user_id: str) -> Optional[dict]:
    redis = get_redis()
    if redis is None:
        return None

    data = await redis.get(f"user:{user_id}")
    return json.loads(data) if data else None
```

### Dependency Injection Pattern

```python
from fastapi import Depends
from redis.asyncio import Redis
from src.core.redis import get_redis

def get_redis_client() -> Optional[Redis]:
    """Dependency for Redis client."""
    return get_redis()

@router.get("/cached-data")
async def get_data(redis: Optional[Redis] = Depends(get_redis_client)):
    if redis:
        cached = await redis.get("my-key")
        if cached:
            return {"source": "cache", "data": cached}

    # Fall back to database
    data = await fetch_from_database()

    if redis:
        await redis.set("my-key", data, ex=300)

    return {"source": "database", "data": data}
```

---

## Validation

### Connection Pool Verification

```bash
# Start services
cd /Users/samosipov/Downloads/learn-greek-easy && docker-compose -f docker-compose.dev.yml up -d

# Check backend logs for Redis initialization
docker logs learn-greek-backend-dev 2>&1 | grep -i redis
# Expected: "Initializing Redis connection..."
# Expected: "Redis connection successful"

# Verify via health endpoint
curl -s http://localhost:8000/health | jq '.checks.redis'
# Expected:
# {
#   "status": "healthy",
#   "latency_ms": X.XX,
#   "message": "PONG received"
# }
```

### Degraded Mode Verification

```bash
# Stop Redis
docker stop learn-greek-redis-dev

# Check health endpoint - should show degraded
curl -s http://localhost:8000/health | jq '.status, .checks.redis'
# Expected:
# "degraded"
# {
#   "status": "unhealthy",
#   "latency_ms": null,
#   "message": "..."
# }

# Application should still work (degraded mode)
curl -s http://localhost:8000/health/live
# Expected: {"status": "alive", ...}

# Restart Redis
docker start learn-greek-redis-dev
```

### Connection Pool Stress Test

```python
# Run from backend container or locally with REDIS_URL set
import asyncio
from src.core.redis import init_redis, get_redis, close_redis

async def stress_test():
    await init_redis()
    redis = get_redis()

    async def worker(n):
        for i in range(100):
            await redis.set(f"test:{n}:{i}", f"value-{i}")
            await redis.get(f"test:{n}:{i}")
            await redis.delete(f"test:{n}:{i}")

    # Run 10 concurrent workers
    await asyncio.gather(*[worker(i) for i in range(10)])

    await close_redis()
    print("Stress test completed successfully")

asyncio.run(stress_test())
```

---

## Configuration Settings

**File**: `src/config.py`

```python
class Settings(BaseSettings):
    # Redis
    redis_url: str = "redis://localhost:6379/0"

    # Health Checks
    health_check_redis_timeout: int = Field(
        default=3,
        description="Redis health check timeout in seconds",
    )
```

**Environment Variables**:

| Variable | Default | Description |
|----------|---------|-------------|
| `REDIS_URL` | `redis://localhost:6379/0` | Redis connection URL |
| `HEALTH_CHECK_REDIS_TIMEOUT` | `3` | Redis health check timeout (seconds) |

---

## Completion Checklist

- [x] Connection pool module created (`src/core/redis.py`)
- [x] `init_redis()` function implemented
- [x] `close_redis()` function implemented
- [x] `get_redis()` accessor function implemented
- [x] `check_redis_health()` function implemented
- [x] Lifespan integration in `src/main.py`
- [x] Graceful degradation when Redis unavailable
- [x] Health endpoint integration
- [x] Configuration via environment variables
- [x] Logging for all operations

---

**Status**: COMPLETE - Connection pooling is fully operational.
