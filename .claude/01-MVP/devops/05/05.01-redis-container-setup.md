# 05.01 Redis Container Setup

**Project**: Learn Greek Easy - DevOps
**Task**: Redis Docker Container Configuration
**Parent**: [05-redis-configuration.md](./05-redis-configuration.md)
**Created**: 2025-12-03
**Status**: COMPLETE

---

## Table of Contents

1. [Objective](#objective)
2. [Implementation Summary](#implementation-summary)
3. [Configuration Details](#configuration-details)
4. [Validation](#validation)
5. [Related Documentation](#related-documentation)

---

## Objective

Set up Redis container infrastructure in Docker Compose for both development and production environments to provide:
- Fast in-memory data store for session management
- Caching infrastructure for application data
- Message broker capability for future background tasks

---

## Implementation Summary

This task was completed as part of **Task 01.04 (Redis Service)** in the Docker architecture setup. The Redis container is fully configured and operational.

### What Was Implemented

| Component | Development | Production |
|-----------|-------------|------------|
| Image | `redis:7-alpine` | `redis:7-alpine` |
| Container Name | `learn-greek-redis-dev` | `learn-greek-redis` |
| Port Mapping | `6379:6379` (exposed) | Internal only |
| Volume | `redis_data_dev:/data` | `redis_data:/data` |
| Network | `learn-greek-network-dev` | `learn-greek-network` |
| Health Check | `redis-cli ping` | `redis-cli ping` |
| Persistence | AOF enabled | AOF enabled |
| Memory Limit | 128MB | 128MB |
| Eviction Policy | `allkeys-lru` | `allkeys-lru` |

---

## Configuration Details

### Development Configuration

**File**: `docker-compose.dev.yml`

```yaml
redis:
  image: redis:7-alpine
  container_name: learn-greek-redis-dev
  command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
  ports:
    - "6379:6379"
  volumes:
    - redis_data_dev:/data
  networks:
    - learn-greek-network-dev
  healthcheck:
    test: ["CMD", "redis-cli", "ping"]
    interval: 10s
    timeout: 5s
    retries: 3
    start_period: 5s
```

### Production Configuration

**File**: `docker-compose.yml`

```yaml
redis:
  image: redis:7-alpine
  container_name: learn-greek-redis
  command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
  volumes:
    - redis_data:/data
  networks:
    - learn-greek-network
  deploy:
    resources:
      limits:
        cpus: '0.25'
        memory: 256M
      reservations:
        cpus: '0.1'
        memory: 64M
  healthcheck:
    test: ["CMD", "redis-cli", "ping"]
    interval: 10s
    timeout: 5s
    retries: 3
    start_period: 5s
  restart: unless-stopped
```

### Configuration Flags Explained

| Flag | Value | Purpose |
|------|-------|---------|
| `--appendonly` | `yes` | Enable AOF persistence for data durability |
| `--maxmemory` | `128mb` | Maximum memory Redis can use before eviction |
| `--maxmemory-policy` | `allkeys-lru` | Evict least recently used keys when memory limit is reached |

### Backend Integration

The backend service depends on Redis being healthy:

```yaml
backend:
  depends_on:
    postgres:
      condition: service_healthy
    redis:
      condition: service_healthy
  environment:
    - REDIS_URL=redis://redis:6379/0
```

---

## Validation

### Verification Commands

```bash
# Start services
cd /Users/samosipov/Downloads/learn-greek-easy && docker-compose -f docker-compose.dev.yml up -d

# Check Redis container health
docker inspect learn-greek-redis-dev --format='{{.State.Health.Status}}'
# Expected: healthy

# Test Redis connectivity
docker exec learn-greek-redis-dev redis-cli ping
# Expected: PONG

# Verify memory configuration
docker exec learn-greek-redis-dev redis-cli CONFIG GET maxmemory
# Expected: maxmemory 134217728

# Verify eviction policy
docker exec learn-greek-redis-dev redis-cli CONFIG GET maxmemory-policy
# Expected: maxmemory-policy allkeys-lru

# Verify persistence
docker exec learn-greek-redis-dev redis-cli CONFIG GET appendonly
# Expected: appendonly yes

# Test from backend container
docker exec -it learn-greek-backend-dev python -c "
import redis
r = redis.from_url('redis://redis:6379/0')
print('PING:', r.ping())
print('SET:', r.set('test', 'hello'))
print('GET:', r.get('test'))
print('DEL:', r.delete('test'))
"
```

### Health Check Endpoint Verification

```bash
# The /health endpoint includes Redis status
curl -s http://localhost:8000/health | jq '.checks.redis'
# Expected:
# {
#   "status": "healthy",
#   "latency_ms": 1.1,
#   "message": "PONG received"
# }
```

---

## Related Documentation

- **Original Implementation**: [01.04-redis-service.md](../01/01.04-redis-service.md)
- **Health Check Integration**: [01.05-health-endpoints.md](../01/01.05-health-endpoints.md)
- **Parent Task**: [05-redis-configuration.md](./05-redis-configuration.md)

---

## Completion Checklist

- [x] Redis container added to `docker-compose.dev.yml`
- [x] Redis container added to `docker-compose.yml` (production)
- [x] Health checks configured
- [x] AOF persistence enabled
- [x] Memory limits configured
- [x] Backend service depends on Redis health
- [x] `REDIS_URL` environment variable configured
- [x] Named volumes for data persistence
- [x] Network connectivity verified

---

**Status**: COMPLETE - No further action required for this task.
