# 02.04 CI Linting & Formatting - Technical Design Document

**Project**: Learn Greek Easy - MVP DevOps
**Task**: Add Linting and Formatting Checks to CI Pipeline
**Created**: 2025-12-03
**Status**: ✅ DONE
**Priority**: Medium
**Depends On**: 02.02 (Fix CI Pipeline Errors), 02.03 (Pre-commit Hooks Setup)
**Estimated Time**: 1.5 hours

---

## Table of Contents

1. [Overview](#overview)
2. [Goals and Non-Goals](#goals-and-non-goals)
3. [Current State Analysis](#current-state-analysis)
4. [Target Architecture](#target-architecture)
5. [Mapping Pre-commit Hooks to CI](#mapping-pre-commit-hooks-to-ci)
6. [Implementation Approach](#implementation-approach)
7. [Job Structure Design](#job-structure-design)
8. [Caching Strategy](#caching-strategy)
9. [Error Reporting Format](#error-reporting-format)
10. [Performance Considerations](#performance-considerations)
11. [Technical Risks and Mitigations](#technical-risks-and-mitigations)
12. [Implementation Checklist](#implementation-checklist)
13. [Testing and Validation](#testing-and-validation)

---

## Overview

### Purpose

Add comprehensive linting and formatting checks to the GitHub Actions CI pipeline that **mirror the pre-commit hooks** configured in task 02.03. This ensures:

1. **Final Gatekeeper**: CI catches issues even if developers bypass pre-commit with `--no-verify`
2. **Consistent Code Quality**: All merged code meets the same standards
3. **Cross-Environment Validation**: Catches environment-specific issues (e.g., case-sensitivity on Linux CI vs macOS local)
4. **Audit Trail**: All check results are visible in PR history

### Philosophy: CI as the Single Source of Truth

```
                    PRE-COMMIT HOOKS                    CI PIPELINE
                    (Local, Optional)                   (Remote, Required)
                    ----------------                    -----------------

Developer Machine  ─────────────────────────────────>  GitHub Actions

  Can be bypassed:                                     Cannot be bypassed:
  git commit --no-verify                               Required status check

  FIRST LINE OF DEFENSE                                FINAL GATEKEEPER
  Catch issues early                                   Block bad code
  Fast feedback                                        Authoritative result
```

---

## Goals and Non-Goals

### Goals

| Goal | Description |
|------|-------------|
| **Mirror pre-commit** | Run the exact same checks as pre-commit hooks |
| **Block bad merges** | Fail the PR if any check fails |
| **Fast feedback** | Complete lint checks in < 3 minutes |
| **Clear errors** | Provide actionable error messages |
| **Efficient caching** | Minimize redundant work across runs |

### Non-Goals

| Non-Goal | Reason |
|----------|--------|
| Auto-fix in CI | CI should only validate, not modify code |
| Replace pre-commit | Pre-commit provides faster local feedback |
| Run unit tests | That's handled by separate test jobs |
| Security scanning | Out of scope for this task (future work) |

---

## Current State Analysis

### Existing CI Workflow

**File**: `.github/workflows/test.yml`

**Current Jobs**:

| Job | Status | What It Does |
|-----|--------|--------------|
| `unit-tests` | Working | Frontend type-check + lint + Vitest |
| `e2e-tests` | Working | Playwright E2E tests |
| `backend-tests` | Working | Python pytest with PostgreSQL |

**Current Linting in CI**:

| Check | Current Location | Status |
|-------|------------------|--------|
| TypeScript type-check | `unit-tests` job | Yes |
| ESLint | `unit-tests` job | Yes |
| Prettier format check | Not in CI | **Missing** |
| Black format check | Not in CI | **Missing** |
| isort check | Not in CI | **Missing** |
| Flake8 | Not in CI | **Missing** |
| MyPy | Not in CI | **Missing** |

### Pre-commit Hooks Configured (from 02.03)

**File**: `.pre-commit-config.yaml`

| Category | Hook | Auto-Fix | CI Equivalent Needed |
|----------|------|----------|---------------------|
| **General** | trailing-whitespace | Yes | Optional (low priority) |
| **General** | end-of-file-fixer | Yes | Optional (low priority) |
| **General** | check-yaml | No | Yes (validates configs) |
| **General** | check-json | No | Yes (validates configs) |
| **General** | check-added-large-files | No | Yes (block large files) |
| **General** | check-merge-conflict | No | Yes (critical) |
| **General** | detect-private-key | No | Yes (security) |
| **General** | no-commit-to-branch | No | N/A (GitHub handles this) |
| **Frontend** | ESLint | Yes | Yes (already in CI) |
| **Frontend** | Prettier | Yes | **Add format:check** |
| **Frontend** | TypeScript check | No | Yes (already in CI) |
| **Backend** | Black | Yes | **Add --check mode** |
| **Backend** | isort | Yes | **Add --check-only mode** |
| **Backend** | Flake8 | No | **Add to CI** |
| **Backend** | MyPy | No | **Add to CI** |

---

## Target Architecture

### Job Dependency Graph

```
                              ┌─────────────────────────────────────┐
                              │         PR Opened/Updated           │
                              └───────────────────┬─────────────────┘
                                                  │
                    ┌─────────────────────────────┼─────────────────────────────┐
                    │                             │                             │
                    ▼                             ▼                             ▼
         ┌──────────────────┐          ┌──────────────────┐          ┌──────────────────┐
         │  frontend-lint   │          │   backend-lint   │          │  general-checks  │
         │                  │          │                  │          │   (optional)     │
         │  - ESLint        │          │  - Black check   │          │                  │
         │  - Prettier      │          │  - isort check   │          │  - check-yaml    │
         │  - TypeScript    │          │  - Flake8        │          │  - check-json    │
         │                  │          │  - MyPy          │          │  - large files   │
         └────────┬─────────┘          └────────┬─────────┘          └────────┬─────────┘
                  │                             │                             │
                  │ needs: frontend-lint        │ needs: backend-lint         │
                  ▼                             ▼                             │
         ┌──────────────────┐          ┌──────────────────┐                   │
         │  frontend-tests  │          │   backend-tests  │                   │
         │                  │          │                  │                   │
         │  - Vitest        │          │  - Pytest        │                   │
         │  - Coverage      │          │  - PostgreSQL    │                   │
         └────────┬─────────┘          └────────┬─────────┘                   │
                  │                             │                             │
                  │ needs: frontend-tests       │                             │
                  │ needs: backend-tests        │                             │
                  ▼                             │                             │
         ┌──────────────────┐                   │                             │
         │    e2e-tests     │ ◄─────────────────┴─────────────────────────────┘
         │                  │
         │  - Playwright    │
         └──────────────────┘
```

### Why This Structure?

| Design Decision | Rationale |
|-----------------|-----------|
| Separate lint jobs | Fail fast: lint is faster than tests |
| Tests depend on lint | Don't waste compute if code doesn't compile |
| Frontend/Backend parallel | Independent codebases, run simultaneously |
| E2E after all tests | Most expensive, run only if everything else passes |

---

## Mapping Pre-commit Hooks to CI

### Frontend Checks Mapping

| Pre-commit Hook | Pre-commit Command | CI Command | Difference |
|-----------------|-------------------|------------|------------|
| `frontend-eslint` | `npm run lint:fix` | `npm run lint` | CI: check only, no fix |
| `frontend-prettier` | `npm run format` | `npm run format:check` | CI: check only, no fix |
| `frontend-typecheck` | `npm run type-check` | `npm run type-check` | Same |

**npm Scripts Used** (from `package.json`):

```json
{
  "lint": "eslint .",
  "lint:fix": "eslint . --fix",
  "format": "prettier --write \"src/**/*.{ts,tsx,css,md}\"",
  "format:check": "prettier --check \"src/**/*.{ts,tsx,css,md}\"",
  "type-check": "tsc --noEmit"
}
```

### Backend Checks Mapping

| Pre-commit Hook | Pre-commit Command | CI Command | Difference |
|-----------------|-------------------|------------|------------|
| `black` | `black` (auto-format) | `black --check src/ tests/` | CI: check only |
| `isort` | `isort` (auto-format) | `isort --check-only src/ tests/` | CI: check only |
| `flake8` | `flake8 src/` | `flake8 src/ tests/` | Same (using .flake8 config) |
| `mypy` | `mypy src/` | `mypy src/` | Same (using pyproject.toml config) |

**Config Files Used**:

| Tool | Config Location |
|------|-----------------|
| Black | `learn-greek-easy-backend/pyproject.toml` |
| isort | `learn-greek-easy-backend/pyproject.toml` |
| Flake8 | `learn-greek-easy-backend/.flake8` |
| MyPy | `learn-greek-easy-backend/pyproject.toml` |

### General Checks Mapping

| Pre-commit Hook | CI Equivalent | Implementation |
|-----------------|---------------|----------------|
| `trailing-whitespace` | Optional | Low impact, skip for now |
| `end-of-file-fixer` | Optional | Low impact, skip for now |
| `check-yaml` | Recommended | Use `yamllint` or Python script |
| `check-json` | Recommended | Use `jq` or Python script |
| `check-added-large-files` | Recommended | Custom script or action |
| `check-merge-conflict` | Built-in | GitHub blocks these automatically |
| `detect-private-key` | Future | Security scanning task |
| `no-commit-to-branch` | N/A | Branch protection handles this |

---

## Implementation Approach

### Option A: Add Checks to Existing Workflow (Recommended)

**Modify**: `.github/workflows/test.yml`

**Approach**: Add new jobs to the existing workflow file.

**Pros**:
- Single workflow file, easier to maintain
- Clear job dependencies visible in one file
- Better concurrency control with existing jobs

**Cons**:
- File gets longer

### Option B: Create Separate Lint Workflow

**Create**: `.github/workflows/lint.yml`

**Approach**: New workflow file for lint-only checks.

**Pros**:
- Separation of concerns
- Could run on different triggers (e.g., `push` events)

**Cons**:
- Two workflow files to maintain
- Complex cross-workflow status requirements

### Recommendation: Option A

Modify the existing `test.yml` to add lint jobs. The workflow is already structured for this, and the parent architecture document (02-github-cicd-architecture.md) specifies this approach.

---

## Job Structure Design

### Job 1: frontend-lint

```yaml
frontend-lint:
  name: Frontend Lint & Format
  runs-on: ubuntu-latest
  steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: learn-greek-easy-frontend/package-lock.json

    - name: Install dependencies
      working-directory: learn-greek-easy-frontend
      run: npm ci

    - name: Check TypeScript types
      working-directory: learn-greek-easy-frontend
      run: npm run type-check

    - name: Run ESLint
      working-directory: learn-greek-easy-frontend
      run: npm run lint

    - name: Check Prettier formatting
      working-directory: learn-greek-easy-frontend
      run: npm run format:check
```

**Estimated Time**: 1-2 minutes

### Job 2: backend-lint

```yaml
backend-lint:
  name: Backend Lint & Format
  runs-on: ubuntu-latest
  steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: 2.0.0
        virtualenvs-create: true
        virtualenvs-in-project: true

    - name: Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v4
      with:
        path: learn-greek-easy-backend/.venv
        key: venv-lint-${{ runner.os }}-${{ hashFiles('learn-greek-easy-backend/poetry.lock') }}
        restore-keys: |
          venv-lint-${{ runner.os }}-

    - name: Install dependencies
      if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
      working-directory: learn-greek-easy-backend
      run: poetry install --no-interaction --no-root

    - name: Check Black formatting
      working-directory: learn-greek-easy-backend
      run: poetry run black --check src/ tests/

    - name: Check isort import ordering
      working-directory: learn-greek-easy-backend
      run: poetry run isort --check-only src/ tests/

    - name: Run Flake8 linter
      working-directory: learn-greek-easy-backend
      run: poetry run flake8 src/ tests/

    - name: Run MyPy type checker
      working-directory: learn-greek-easy-backend
      run: poetry run mypy src/
```

**Estimated Time**: 1-3 minutes

### Updated Test Jobs (Add Dependencies)

```yaml
# Modify existing unit-tests job
unit-tests:
  name: Frontend Tests
  runs-on: ubuntu-latest
  needs: [frontend-lint]  # ADD THIS LINE
  steps:
    # ... existing steps unchanged ...

# Modify existing backend-tests job
backend-tests:
  name: Backend Tests
  runs-on: ubuntu-latest
  needs: [backend-lint]  # ADD THIS LINE
  # ... existing steps unchanged ...
```

### Optional: General Checks Job

```yaml
general-checks:
  name: General Code Checks
  runs-on: ubuntu-latest
  steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check YAML syntax
      run: |
        pip install yamllint
        yamllint -d relaxed .github/

    - name: Check for large files
      run: |
        # Find files larger than 1MB that are not in .gitignore
        find . -type f -size +1M \
          -not -path './.git/*' \
          -not -path '*/node_modules/*' \
          -not -path '*/.venv/*' \
          -exec echo "Large file found: {}" \; \
          -exec false \; || true

    - name: Check for merge conflict markers
      run: |
        if grep -r "<<<<<<< " --include="*.ts" --include="*.tsx" --include="*.py" --include="*.md" .; then
          echo "Merge conflict markers found!"
          exit 1
        fi
```

**Recommendation**: Skip for MVP, add later if needed. GitHub already blocks commits with merge conflicts.

---

## Caching Strategy

### Frontend Caching

```yaml
- uses: actions/setup-node@v4
  with:
    node-version: '20'
    cache: 'npm'
    cache-dependency-path: learn-greek-easy-frontend/package-lock.json
```

**Cache Key**: Based on `package-lock.json` hash
**Cache Hit Rate**: ~95% (dependencies rarely change)
**Time Saved**: 30-60 seconds per job

### Backend Caching

```yaml
- name: Load cached venv
  uses: actions/cache@v4
  with:
    path: learn-greek-easy-backend/.venv
    key: venv-lint-${{ runner.os }}-${{ hashFiles('learn-greek-easy-backend/poetry.lock') }}
    restore-keys: |
      venv-lint-${{ runner.os }}-
```

**Cache Key Strategy**:
- Primary: Exact match on `poetry.lock` hash
- Fallback: Any cache for same OS (faster than fresh install)

**Cache Size**: ~200-400 MB for Python venv
**Time Saved**: 60-120 seconds per job

### Cache Separation

| Job | Cache Key Prefix | Reason |
|-----|------------------|--------|
| `frontend-lint` | npm (built-in) | Uses setup-node caching |
| `backend-lint` | `venv-lint-` | Separate from test cache |
| `backend-tests` | `venv-` | May have different deps |

**Why Separate Caches?**

Lint jobs only need dev dependencies, test jobs need all dependencies. Separating caches avoids invalidation when only test deps change.

---

## Error Reporting Format

### Good Error Output Example (ESLint)

```
Run npm run lint
> eslint .

/home/runner/work/learn-greek-easy/learn-greek-easy-frontend/src/App.tsx
  15:7  error  'useState' is defined but never used  @typescript-eslint/no-unused-vars
  23:1  error  Expected indentation of 2 spaces      indent

2 problems (2 errors, 0 warnings)

Error: Process completed with exit code 1.
```

### Good Error Output Example (Black)

```
Run poetry run black --check src/ tests/
would reformat src/api/v1/auth.py
would reformat src/core/security.py

Oh no! 2 files would be reformatted, 45 files would be left unchanged.

Error: Process completed with exit code 1.
```

### Actionable Error Messages

Each tool provides clear feedback:

| Tool | Error Format | Developer Action |
|------|--------------|------------------|
| ESLint | File:Line:Col + Rule | Fix specific issue or disable rule |
| Prettier | Diff of changes | Run `npm run format` |
| TypeScript | TS error code + message | Fix type error |
| Black | List of files to reformat | Run `poetry run black src/ tests/` |
| isort | List of files with wrong order | Run `poetry run isort src/ tests/` |
| Flake8 | File:Line:Col + Error code | Fix issue or add ignore |
| MyPy | File:Line + Type error | Add types or ignore |

### GitHub Annotations

Many tools support GitHub Actions annotations for inline PR comments:

```yaml
- name: Run ESLint
  run: npm run lint -- --format @microsoft/eslint-formatter-sarif --output-file eslint-results.sarif
  continue-on-error: true

- name: Upload SARIF
  uses: github/codeql-action/upload-sarif@v2
  with:
    sarif_file: eslint-results.sarif
```

**Recommendation**: Skip for MVP. Direct error output is sufficient.

---

## Performance Considerations

### Estimated Job Times

| Job | Est. Time | Bottleneck |
|-----|-----------|------------|
| `frontend-lint` | 1-2 min | npm ci (cached: 30s) |
| `backend-lint` | 1-3 min | MyPy (type checking is slow) |
| `unit-tests` | 2-3 min | Vitest + coverage |
| `backend-tests` | 3-5 min | PostgreSQL service + pytest |
| `e2e-tests` | 3-5 min | Playwright browser tests |

### Total Pipeline Time

**Without lint jobs**: ~5-8 minutes (tests run in parallel)
**With lint jobs**: ~6-10 minutes (lint first, then tests)

**Impact**: +1-2 minutes for lint checks

### Optimization Opportunities

1. **Parallel Lint Checks**: Frontend and backend lint run simultaneously
2. **Early Termination**: Tests don't run if lint fails (saves compute)
3. **Aggressive Caching**: Both npm and Poetry caches enabled
4. **Skip unchanged**: Future optimization with path filters

### Path Filtering (Future Optimization)

```yaml
on:
  pull_request:
    paths:
      - 'learn-greek-easy-frontend/**'  # Only trigger frontend jobs
      - 'learn-greek-easy-backend/**'   # Only trigger backend jobs
```

**Recommendation**: Skip for MVP. Full runs ensure all checks pass.

---

## Technical Risks and Mitigations

### Risk 1: MyPy Import Errors in CI

**Risk**: MyPy may fail to resolve imports that work locally.
**Likelihood**: Medium
**Impact**: CI fails unexpectedly

**Mitigation**:
```yaml
- name: Install project (for import resolution)
  working-directory: learn-greek-easy-backend
  run: poetry install --no-interaction
```

### Risk 2: Prettier Version Mismatch

**Risk**: Different Prettier versions between pre-commit and CI.
**Likelihood**: Low
**Impact**: Code passes locally but fails in CI

**Mitigation**: Both use `npm run format:check` which uses project's Prettier version.

### Risk 3: Cache Poisoning

**Risk**: Corrupted cache causes repeated failures.
**Likelihood**: Low
**Impact**: Jobs fail until cache expires

**Mitigation**: Use specific cache keys with restore-keys fallback.

```yaml
key: venv-lint-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}
restore-keys: |
  venv-lint-${{ runner.os }}-
```

### Risk 4: Tool Version Drift

**Risk**: Pre-commit uses different tool versions than CI.
**Likelihood**: Medium
**Impact**: Different results between local and CI

**Mitigation**:
- Pre-commit: Uses pinned versions in `.pre-commit-config.yaml`
- CI: Uses versions from `poetry.lock` and `package-lock.json`
- Both should match (verify during implementation)

**Version Matrix**:

| Tool | Pre-commit Version | CI Source |
|------|-------------------|-----------|
| Black | 24.8.0 | poetry.lock |
| isort | 5.13.2 | poetry.lock |
| Flake8 | 7.1.0 | poetry.lock |
| MyPy | v1.11.0 | poetry.lock |
| ESLint | 9.36.0 | package-lock.json |
| Prettier | 3.6.2 | package-lock.json |

---

## Implementation Checklist

### Phase 1: Preparation

- [ ] Read current `.github/workflows/test.yml` to understand structure
- [ ] Verify all npm scripts exist in `package.json`
- [ ] Verify all Poetry dependencies are in `pyproject.toml`
- [ ] Check pre-commit hook versions match locked versions

### Phase 2: Frontend Lint Job

- [ ] Add `frontend-lint` job to `test.yml`
- [ ] Add `npm run type-check` step
- [ ] Add `npm run lint` step
- [ ] Add `npm run format:check` step
- [ ] Test locally with `act` or push to branch

### Phase 3: Backend Lint Job

- [ ] Add `backend-lint` job to `test.yml`
- [ ] Add Poetry installation and caching
- [ ] Add `black --check` step
- [ ] Add `isort --check-only` step
- [ ] Add `flake8` step
- [ ] Add `mypy` step
- [ ] Test locally or push to branch

### Phase 4: Job Dependencies

- [ ] Add `needs: [frontend-lint]` to frontend test jobs
- [ ] Add `needs: [backend-lint]` to backend test jobs
- [ ] Verify e2e-tests depends on both test jobs

### Phase 5: Validation

- [ ] Create test PR with intentional violations
- [ ] Verify lint jobs fail correctly
- [ ] Verify test jobs don't run when lint fails
- [ ] Verify test jobs run when lint passes
- [ ] Check job timing is acceptable (< 10 minutes total)

### Phase 6: Documentation

- [ ] Update `02-github-cicd-architecture.md` status
- [ ] Update this plan with actual implementation details
- [ ] Document any deviations from plan

---

## Testing and Validation

### Test Case 1: Frontend Lint Failure

**Setup**: Create a file with ESLint error

```typescript
// learn-greek-easy-frontend/src/test-lint-error.ts
const unused = "this will cause error";
```

**Expected Result**:
- `frontend-lint` job fails
- `unit-tests` job is skipped (due to `needs` dependency)
- Error message shows unused variable warning

### Test Case 2: Backend Format Failure

**Setup**: Create a file with Black formatting violation

```python
# learn-greek-easy-backend/src/test_format_error.py
def foo(x,y,z):return x+y+z  # Black would format this differently
```

**Expected Result**:
- `backend-lint` job fails at Black step
- `backend-tests` job is skipped
- Error shows "would reformat" message

### Test Case 3: All Checks Pass

**Setup**: Ensure all code is properly formatted

**Expected Result**:
- All lint jobs pass
- All test jobs run
- E2E tests run
- Merge is allowed

### Test Case 4: Verify Caching

**Setup**: Run pipeline twice without changing dependencies

**Expected Result**:
- Second run shows "Cache hit" for npm and venv
- Second run is significantly faster

---

## Appendix: Complete Workflow File

See the modified `.github/workflows/test.yml` in the implementation phase. The structure follows this document's design.

---

## References

- [Parent Architecture Doc](./02-github-cicd-architecture.md)
- [Pre-commit Setup Plan](./02.03-pre-commit-hooks-setup.md)
- [GitHub Actions Workflow Syntax](https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions)
- [actions/cache Documentation](https://github.com/actions/cache)
- [snok/install-poetry](https://github.com/snok/install-poetry)

---

**Status**: DONE - PR #3 created
**Next Step**: Merge PR after CI passes
