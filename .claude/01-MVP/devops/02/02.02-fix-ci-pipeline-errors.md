# 02.02 Fix CI Pipeline Errors

**Project**: Learn Greek Easy - MVP DevOps
**Task**: Fix GitHub Actions CI Pipeline Errors
**Created**: 2025-12-02
**Status**: Pending
**Priority**: High - Blocking all PRs

---

## Table of Contents

1. [Problem Summary](#problem-summary)
2. [Failure Analysis](#failure-analysis)
3. [Root Causes](#root-causes)
4. [Implementation Plan](#implementation-plan)
5. [Verification Steps](#verification-steps)

---

## Problem Summary

All 3 CI jobs are failing on every PR and push to main:

| Job | Status | Primary Failure |
|-----|--------|-----------------|
| Unit & Integration Tests | FAILED | ESLint linting build output (`html/`) |
| E2E Tests (Playwright) | FAILED | Node 18 incompatible with Vite 7.x |
| Backend Tests (Python) | FAILED | `cache: 'pip'` can't find requirements.txt |

**Evidence**: Last 9 runs all failed (checked via `gh run list`)

---

## Failure Analysis

### Job 1: Unit & Integration Tests

**Failure Point**: Step "Run linter" (`npm run lint`)

**Error Messages**:
```
X 'fetch' is not defined
  learn-greek-easy-frontend/html/assets/index-B6hUSIXg.js#1

X 'document' is not defined
  learn-greek-easy-frontend/html/assets/index-B6hUSIXg.js#1

X Replace `**//*! #__NO_SIDE_EFFECTS__ */function hh(e)...
  learn-greek-easy-frontend/html/assets/index-B6hUSIXg.js#5
```

**Analysis**:
- The `html/` folder contains **built/bundled production assets**
- This folder should NOT be:
  1. Committed to the repository
  2. Linted by ESLint
- Currently ESLint ignores include `dist/**` and `build/**` but NOT `html/**`
- The folder appears to be from a previous static HTML export/build

**Secondary Issues** (warnings, not blocking):
- `@typescript-eslint/no-explicit-any` warnings in chart components
- These are warnings only and don't fail the build

---

### Job 2: E2E Tests (Playwright)

**Failure Point**: Step "Run E2E tests" (`npm run test:e2e`)

**Error Messages**:
```
npm warn EBADENGINE Unsupported engine {
npm warn EBADENGINE   package: 'vite@7.1.12',
npm warn EBADENGINE   required: { node: '^20.19.0 || >=22.12.0' },
npm warn EBADENGINE   current: { node: 'v18.20.8', npm: '10.8.2' }
npm warn EBADENGINE }
```

**Analysis**:
- CI workflow uses Node 18: `node-version: '18'`
- Package requirements:
  | Package | Required Node |
  |---------|---------------|
  | `vite@7.1.12` | `^20.19.0 \|\| >=22.12.0` |
  | `@vitejs/plugin-react@5.1.0` | `^20.19.0 \|\| >=22.12.0` |
  | `prettier-plugin-tailwindcss@0.7.1` | `>=20.19` |
- The `package.json` has outdated engine requirement: `"node": ">=18.0.0"`

---

### Job 3: Backend Tests (Python)

**Failure Point**: Step "Set up Python 3.13"

**Error Messages**:
```
X No file in /home/runner/work/learn-greek-easy/learn-greek-easy matched to
  [**/requirements.txt or **/pyproject.toml], make sure you have checked out
  the target repository
```

**Analysis**:
- The `setup-python@v5` action with `cache: 'pip'` looks for `requirements.txt`
- Our project uses **Poetry** with `pyproject.toml`
- The action CAN cache Poetry, but needs correct configuration
- Current workflow:
  ```yaml
  - name: Set up Python 3.13
    uses: actions/setup-python@v5
    with:
      python-version: '3.13'
      cache: 'pip'  # <-- WRONG for Poetry projects
  ```

---

## Root Causes

### RC-1: Build Output Committed to Repository

**Severity**: High
**Impact**: Fails lint step

The `learn-greek-easy-frontend/html/` directory contains bundled production assets that were accidentally committed.

**Files in html/**:
```
html/
├── assets/
│   ├── index-B6hUSIXg.js    # Bundled JS (causes lint errors)
│   └── index-BOa2vf5V.css   # Bundled CSS
├── bg.png
├── favicon.ico
├── favicon.svg
├── html.meta.json.gz
└── index.html
```

---

### RC-2: Node Version Mismatch

**Severity**: High
**Impact**: Fails E2E tests, npm warnings

CI uses Node 18, but dependencies require Node 20.19+.

**Version Matrix**:
| Environment | Node Version | Status |
|-------------|--------------|--------|
| CI (GitHub Actions) | 18.20.8 | Incompatible |
| Local Development | varies | Should match CI |
| Required by Vite 7.x | 20.19.0+ | Must upgrade |

---

### RC-3: Python Cache Misconfiguration

**Severity**: High
**Impact**: Fails before tests run

The `setup-python` action is configured for pip-based projects, not Poetry.

**Current Configuration**:
```yaml
cache: 'pip'  # Looks for requirements.txt
```

**Required Configuration**:
```yaml
cache: 'poetry'  # Or remove cache entirely and let Poetry action handle it
```

---

## Implementation Plan

### Step 1: Remove Build Output from Repository

**Files to delete**:
```bash
git rm -rf learn-greek-easy-frontend/html/
```

**Update .gitignore** (add to `learn-greek-easy-frontend/.gitignore`):
```gitignore
# Build outputs
dist
dist-ssr
html
```

**Update ESLint ignores** (add to `eslint.config.js` ignores array):
```javascript
ignores: [
  'dist/**',
  'build/**',
  'html/**',  // Add this
  // ... rest
],
```

---

### Step 2: Update Node Version to 20

**Update `.github/workflows/test.yml`**:

For all jobs (unit-tests, e2e-tests):
```yaml
- name: Setup Node.js
  uses: actions/setup-node@v4
  with:
    node-version: '20'  # Changed from '18'
    cache: 'npm'
    cache-dependency-path: learn-greek-easy-frontend/package-lock.json
```

**Update `package.json` engines**:
```json
{
  "engines": {
    "node": ">=20.19.0",
    "npm": ">=10.0.0"
  }
}
```

---

### Step 3: Fix Python Setup for Poetry

**Option A: Remove cache from setup-python (Recommended)**

```yaml
- name: Set up Python 3.13
  uses: actions/setup-python@v5
  with:
    python-version: '3.13'
    # Remove 'cache: pip' - let Poetry action handle caching
```

The `snok/install-poetry@v1` action and our existing cache step handle caching.

**Option B: Use Poetry cache in setup-python**

```yaml
- name: Set up Python 3.13
  uses: actions/setup-python@v5
  with:
    python-version: '3.13'
    cache: 'poetry'
```

Note: This requires Poetry to be installed first, which creates a chicken-and-egg problem. Option A is simpler.

---

### Step 4: Fix ESLint any Warnings (Optional)

These are warnings, not errors. Can be addressed separately.

**Affected files**:
- `src/components/charts/StageDistributionChart.tsx:92`
- `src/components/charts/ProgressLineChart.tsx:50`
- `src/components/charts/DeckPerformanceChart.tsx:52`
- `src/components/charts/AccuracyAreaChart.tsx:52`
- `src/components/auth/__tests__/ProtectedRoute.integration.test.tsx:51`
- `src/components/auth/PublicRoute.tsx:36`
- `src/components/analytics/RetentionWidget.tsx:56,59,66,67`

**Fix pattern**:
```typescript
// Before
const handleClick = (data: any) => { ... }

// After
interface ChartDataPoint {
  name: string;
  value: number;
}
const handleClick = (data: ChartDataPoint) => { ... }
```

---

## Complete Updated Workflow

```yaml
name: Test Suite

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize]

jobs:
  # Job 1: Unit & Integration Tests
  unit-tests:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # CHANGED from '18'
          cache: 'npm'
          cache-dependency-path: learn-greek-easy-frontend/package-lock.json

      - name: Install dependencies
        working-directory: learn-greek-easy-frontend
        run: npm ci

      - name: Run type check
        working-directory: learn-greek-easy-frontend
        run: npm run type-check

      - name: Run linter
        working-directory: learn-greek-easy-frontend
        run: npm run lint

      - name: Run unit tests
        working-directory: learn-greek-easy-frontend
        run: npm run test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: learn-greek-easy-frontend/coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # Job 2: E2E Tests
  e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # CHANGED from '18'
          cache: 'npm'
          cache-dependency-path: learn-greek-easy-frontend/package-lock.json

      - name: Install dependencies
        working-directory: learn-greek-easy-frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: learn-greek-easy-frontend
        run: npx playwright install --with-deps

      - name: Run E2E tests
        working-directory: learn-greek-easy-frontend
        run: npm run test:e2e

      - name: Upload Playwright report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: learn-greek-easy-frontend/playwright-report/
          retention-days: 7

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-results
          path: learn-greek-easy-frontend/test-results/
          retention-days: 7

  # Job 3: Backend Tests (Python)
  backend-tests:
    name: Backend Tests (Python)
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_learn_greek
        ports:
          - 5433:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          # REMOVED: cache: 'pip' - Poetry handles its own caching

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 2.0.0
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: learn-greek-easy-backend/.venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        working-directory: learn-greek-easy-backend
        run: poetry install --no-interaction --no-root

      - name: Install project
        working-directory: learn-greek-easy-backend
        run: poetry install --no-interaction

      - name: Create test database extensions
        run: |
          PGPASSWORD=postgres psql -h localhost -p 5433 -U postgres -d test_learn_greek -c "CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";"

      - name: Run tests with coverage
        working-directory: learn-greek-easy-backend
        env:
          TEST_DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5433/test_learn_greek
        run: |
          rm -f .coverage .coverage.*
          poetry run pytest tests/ \
            -n auto \
            --dist loadscope \
            --cov=src \
            --cov-report=xml:coverage.xml \
            --cov-report=term-missing \
            --cov-branch \
            --cov-fail-under=90 \
            -v \
            --tb=short

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: learn-greek-easy-backend/coverage.xml
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-report
          path: learn-greek-easy-backend/htmlcov/
          retention-days: 7
```

---

## Verification Steps

### Pre-PR Verification (Local)

```bash
# 1. Verify html/ is deleted
ls learn-greek-easy-frontend/html/
# Should return: ls: cannot access 'learn-greek-easy-frontend/html/': No such file or directory

# 2. Verify ESLint passes locally
cd learn-greek-easy-frontend && npm run lint
# Should pass (or only show warnings)

# 3. Verify Node version locally
node --version
# Should be v20.x.x
```

### Post-PR Verification (CI)

After creating PR, verify:

1. **Unit & Integration Tests**:
   - [ ] "Run linter" step passes
   - [ ] "Run unit tests" step passes
   - [ ] No ESLint errors on html/ folder

2. **E2E Tests**:
   - [ ] "Setup Node.js" shows Node 20.x
   - [ ] No EBADENGINE warnings
   - [ ] Playwright tests run

3. **Backend Tests**:
   - [ ] "Set up Python 3.13" passes
   - [ ] No "requirements.txt not found" error
   - [ ] Tests execute successfully

---

## Risk Assessment

| Change | Risk | Mitigation |
|--------|------|------------|
| Remove html/ folder | Low | It's build output, easily regenerated |
| Upgrade Node 18 → 20 | Medium | Test locally first, Node 20 is LTS |
| Remove pip cache | Low | Poetry caching still works |

---

## Execution Checklist

- [ ] Delete `learn-greek-easy-frontend/html/` directory
- [ ] Add `html` to `.gitignore`
- [ ] Add `html/**` to ESLint ignores
- [ ] Update Node version to 20 in all CI jobs
- [ ] Update `package.json` engines field
- [ ] Remove `cache: 'pip'` from Python setup
- [ ] Create branch `fix/ci-pipeline-errors`
- [ ] Push and create PR
- [ ] Verify all CI jobs pass
- [ ] Merge PR

---

## References

- GitHub Actions Run: `gh run view 19837293370`
- [setup-python caching docs](https://github.com/actions/setup-python#caching-packages-dependencies)
- [Node.js LTS Schedule](https://nodejs.org/en/about/releases/)
- [ESLint flat config ignores](https://eslint.org/docs/latest/use/configure/configuration-files-new#ignoring-files)

---

**Status**: Ready for implementation
**Estimated Time**: 30 minutes
**Assignee**: TBD
