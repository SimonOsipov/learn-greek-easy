# 02.04.1 Fix Pre-commit Hook Issues - Technical Plan

**Project**: Learn Greek Easy - MVP DevOps
**Task**: Fix All Flake8 and MyPy Errors Blocking Pre-commit
**Created**: 2025-12-03
**Status**: PLANNING
**Priority**: High (blocks commits)
**Branch**: feature/ci-linting-formatting

---

## Overview

Pre-commit hooks are failing due to **51 flake8 errors** and **17 mypy errors**. This plan details how to fix each category of error.

---

## Error Summary

| Tool | Error Count | Categories |
|------|-------------|------------|
| Flake8 | 51 | F401 (40), E402 (5), E712 (2), F541 (1), F841 (2), C901 (1) |
| MyPy | 17 | no-any-return (5), attr-defined (6), arg-type (1), return-value (1), union-attr (2), valid-type (1) |

---

## Part 1: Flake8 Fixes

### 1.1 F401 - Unused Imports (40 instances)

#### 1.1.1 Alembic Imports (SPECIAL CASE - Keep with noqa)

**File**: `learn-greek-easy-backend/alembic/env.py:17`

These imports ARE needed - they ensure models are loaded for Alembic autogenerate. Add `# noqa: F401` comment.

**Current**:
```python
from src.db.models import (
    Card, CardDifficulty, CardStatistics, CardStatus,
    Deck, DeckLevel, RefreshToken, Review, ReviewRating,
    User, UserDeckProgress, UserSettings
)
```

**Fix**: Add noqa comment to the import line to tell flake8 this is intentional:
```python
from src.db.models import (  # noqa: F401
    Card, CardDifficulty, CardStatistics, CardStatus,
    Deck, DeckLevel, RefreshToken, Review, ReviewRating,
    User, UserDeckProgress, UserSettings,
)
```

#### 1.1.2 Source Code Unused Imports (Remove)

| File | Line | Import | Action |
|------|------|--------|--------|
| `src/api/v1/auth.py` | 22 | `UserResponse` | Remove |
| `src/core/security.py` | 28 | `fastapi.status` | Remove |
| `src/db/base.py` | 4 | `typing.Any` | Remove |
| `src/repositories/base.py` | 7 | `sqlalchemy.Select` | Remove |
| `src/services/auth_service.py` | 35 | `UserResponse` | Remove |

#### 1.1.3 Test File Unused Imports (Remove)

| File | Line | Imports to Remove |
|------|------|-------------------|
| `tests/fixtures/database.py` | 371 | `time` |
| `tests/fixtures/deck.py` | 27, 29 | `uuid4`, `pytest` |
| `tests/fixtures/progress.py` | 47, 63 | `pytest`, `AuthenticatedUser` |
| `tests/unit/core/test_dependencies.py` | 9 | `timedelta` |
| `tests/unit/services/test_auth_service.py` | 4, 11 | `call`, `RefreshToken`, `User`, `UserSettings` |
| `tests/unit/services/test_auth_service_login_fixed.py` | 14 | `PropertyMock` |
| `tests/unit/test_base_classes.py` | 16 | `Card`, `Deck` |
| `tests/unit/test_factories.py` | 11, 13, 16 | `timedelta`, `pytest`, multiple models |

---

### 1.2 E402 - Module Level Import Not at Top (5 instances)

**File**: `learn-greek-easy-backend/src/services/auth_service.py`

**Issue**: Imports on lines 18, 20, 27, 34, 35 are after module-level code.

**Analysis**: Need to examine the file to understand why imports are not at top. Usually caused by:
- Conditional imports
- Circular import avoidance
- TYPE_CHECKING blocks

**Fix Options**:
1. **Restructure imports** to be at top of file
2. **Add `# noqa: E402`** if there's a good reason (circular imports)
3. **Use `TYPE_CHECKING`** for type-only imports

---

### 1.3 E712 - Comparison to True (2 instances)

**File**: `learn-greek-easy-backend/src/repositories/deck.py`

| Line | Current | Fix |
|------|---------|-----|
| 39 | `== True` | Change to `is True` or use direct truthiness |
| 111 | `== True` | Change to `is True` or use direct truthiness |

**Example Fix**:
```python
# Before
if some_condition == True:

# After (option 1 - preferred for boolean flags)
if some_condition is True:

# After (option 2 - preferred for general truthiness)
if some_condition:
```

---

### 1.4 F541 - f-string Missing Placeholders (1 instance)

**File**: `learn-greek-easy-backend/tests/fixtures/database.py:191`

**Fix**: Either add placeholders or change to regular string:
```python
# Before
f"Some string without placeholders"

# After
"Some string without placeholders"
```

---

### 1.5 F841 - Unused Local Variable (2 instances)

| File | Line | Variable | Fix |
|------|------|----------|-----|
| `src/api/v1/auth.py` | 176 | `e` | Use `_` or remove |
| `tests/factories/content.py` | 123 | `level` | Use `_` or remove |

**Example Fix**:
```python
# Before
except SomeError as e:
    pass

# After
except SomeError:
    pass
# Or if you need to catch it but not use it:
except SomeError as _:
    pass
```

---

### 1.6 C901 - Function Too Complex (1 instance)

**File**: `learn-greek-easy-backend/src/core/security.py:152`
**Function**: `validate_password_strength`
**Complexity**: 11 (max allowed: 10)

**Fix Options**:
1. **Refactor** into smaller helper functions
2. **Add `# noqa: C901`** if complexity is justified
3. **Simplify logic** using early returns or data structures

**Recommended Approach**: Refactor using a list of validation checks:
```python
def validate_password_strength(password: str) -> tuple[bool, list[str]]:
    errors = []

    checks = [
        (len(password) >= 8, "Password must be at least 8 characters"),
        (re.search(r"[A-Z]", password), "Password must contain uppercase"),
        (re.search(r"[a-z]", password), "Password must contain lowercase"),
        (re.search(r"\d", password), "Password must contain a digit"),
        (re.search(r"[!@#$%^&*]", password), "Password must contain special char"),
    ]

    for condition, message in checks:
        if not condition:
            errors.append(message)

    return len(errors) == 0, errors
```

---

## Part 2: MyPy Fixes

### 2.1 no-any-return Errors (5 instances)

These occur when a function returns `Any` but is typed to return something specific.

| File | Line | Issue | Fix |
|------|------|-------|-----|
| `src/config.py` | 120 | Returns Any, expects list[str] | Add explicit cast or type annotation |
| `src/core/security.py` | 521 | Returns Any, expects str | Add explicit type or cast |
| `src/repositories/user.py` | 181, 198, 216 | Returns Any, expects int | Cast result properly |

**Example Fix**:
```python
# Before
def get_items() -> list[str]:
    return json.loads(data)  # json.loads returns Any

# After
def get_items() -> list[str]:
    result = json.loads(data)
    return list(result)  # Or use cast(list[str], result)
```

---

### 2.2 attr-defined Errors (6 instances)

These occur when accessing attributes that MyPy doesn't recognize.

| File | Line | Issue | Fix |
|------|------|-------|-----|
| `src/core/redis.py` | 71 | `aclose` not found | Use `close()` instead |
| `src/services/auth_service.py` | 304 | `is_active` not on RefreshToken | Check model definition |
| `src/services/auth_service.py` | 310, 333 | `email` not on RefreshToken | Check model/fix logic |
| `src/repositories/user.py` | 181, 198, 216 | `rowcount` not on Result | Use proper Result API |

**Redis Fix**:
```python
# Before
await redis.aclose()

# After
await redis.close()
```

**RefreshToken Fix**: Need to examine the model to understand what attributes exist and fix the logic.

**Result rowcount Fix**:
```python
# Before
result = await session.execute(stmt)
return result.rowcount

# After
result = await session.execute(stmt)
return result.rowcount or 0  # With proper typing
# Or use:
cursor_result = await session.execute(stmt)
return cursor_result.rowcount  # type: ignore[return-value]
```

---

### 2.3 valid-type Error (1 instance)

**File**: `src/repositories/base.py:198`
**Issue**: Function used as type annotation

**Fix**: Use proper type annotation:
```python
# Before (likely)
def some_method(self) -> list:  # Using function 'list' as type

# After
def some_method(self) -> List[T]:  # Or list[T] in Python 3.9+
```

---

### 2.4 union-attr Errors (2 instances)

**File**: `src/services/health_service.py:191, 194`
**Issue**: Accessing `.status` on `ComponentHealth | BaseException`

**Fix**: Add type narrowing:
```python
# Before
result = await some_task
status = result.status  # Error: BaseException has no .status

# After
result = await some_task
if isinstance(result, BaseException):
    # Handle exception case
    status = "error"
else:
    status = result.status
```

---

### 2.5 arg-type Error (1 instance)

**File**: `src/services/auth_service.py:178`
**Issue**: `str | None` passed where `str` expected

**Fix**: Add None check:
```python
# Before
verify_password(plain_password, user.password_hash)  # password_hash could be None

# After
if user.password_hash is None:
    raise ValueError("User has no password hash")
verify_password(plain_password, user.password_hash)
```

---

### 2.6 return-value Error (1 instance)

**File**: `src/services/auth_service.py:336`
**Issue**: Returns `tuple[str, str, RefreshToken]` but expected `tuple[str, str, User]`

**Fix**: Return correct type - likely need to fetch User instead of RefreshToken.

---

## Implementation Order

Execute in this order to minimize conflicts:

### Phase 1: Quick Wins (10 min)
1. Remove unused imports from source files
2. Fix E712 comparisons
3. Fix F541 f-string
4. Fix F841 unused variables

### Phase 2: Alembic (2 min)
5. Add noqa comment to alembic/env.py imports

### Phase 3: Test Files (10 min)
6. Remove unused imports from all test files

### Phase 4: Auth Service Structure (15 min)
7. Fix E402 import ordering in auth_service.py
8. Fix auth_service.py mypy errors

### Phase 5: Repository Fixes (10 min)
9. Fix user.py rowcount issues
10. Fix base.py valid-type error
11. Fix deck.py E712 issues

### Phase 6: Other MyPy (10 min)
12. Fix redis.py aclose -> close
13. Fix config.py no-any-return
14. Fix security.py no-any-return
15. Fix health_service.py union-attr

### Phase 7: Complex Function (10 min)
16. Refactor validate_password_strength or add noqa

---

## Verification

After fixes, run:

```bash
# Run pre-commit on all files
pre-commit run --all-files

# Or run individual checks
cd learn-greek-easy-backend
poetry run flake8 src/ tests/
poetry run mypy src/
```

---

## Files to Modify

| File | Changes |
|------|---------|
| `alembic/env.py` | Add noqa comment |
| `src/api/v1/auth.py` | Remove unused import, fix F841 |
| `src/config.py` | Fix no-any-return |
| `src/core/redis.py` | Fix aclose -> close |
| `src/core/security.py` | Remove unused import, fix no-any-return, fix C901 |
| `src/db/base.py` | Remove unused import |
| `src/repositories/base.py` | Remove unused import, fix valid-type |
| `src/repositories/deck.py` | Fix E712 comparisons |
| `src/repositories/user.py` | Fix rowcount issues |
| `src/services/auth_service.py` | Fix E402, F401, arg-type, attr-defined, return-value |
| `src/services/health_service.py` | Fix union-attr |
| `tests/fixtures/database.py` | Remove unused import, fix F541 |
| `tests/fixtures/deck.py` | Remove unused imports |
| `tests/fixtures/progress.py` | Remove unused imports |
| `tests/factories/content.py` | Fix F841 |
| `tests/unit/core/test_dependencies.py` | Remove unused import |
| `tests/unit/services/test_auth_service.py` | Remove unused imports |
| `tests/unit/services/test_auth_service_login_fixed.py` | Remove unused import |
| `tests/unit/test_base_classes.py` | Remove unused imports |
| `tests/unit/test_factories.py` | Remove unused imports |

**Total**: 20 files to modify

---

## Success Criteria

- [ ] `pre-commit run --all-files` passes all checks
- [ ] All flake8 errors resolved (0 errors)
- [ ] All mypy errors resolved (0 errors)
- [ ] Existing tests still pass
- [ ] No functionality changes (only code quality fixes)
