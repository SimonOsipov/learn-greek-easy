# Backend Task 02.03: PostgreSQL Enums & Alembic Configuration - Implementation Plan

## Overview

**Task**: Configure Alembic for async SQLAlchemy 2.0 migrations and PostgreSQL enum handling
**Duration**: 45-60 minutes
**Status**: Ready for implementation
**Dependencies**:
- ✅ Task 02.01 (Database Connection & Session Management) - COMPLETED
- ✅ Task 02.02 (Define Database Models) - COMPLETED

## Current State

### Completed
- 8 SQLAlchemy 2.0 models implemented in `src/db/models.py` (549 lines)
- 4 Python enums defined: `DeckLevel`, `CardDifficulty`, `CardStatus`, `ReviewRating`
- Database session management with async support
- Base model with TimestampMixin
- All relationships configured with `lazy="selectin"`

### Needs Implementation
- Alembic initialization and configuration
- Async SQLAlchemy 2.0 support in Alembic env.py
- PostgreSQL enum type configuration
- Migration template setup
- UTF-8 encoding for Greek characters

## Implementation Steps

### Step 1: Initialize Alembic Structure (10 minutes)

**Objective**: Create base Alembic directory structure

**Actions**:
```bash
# From project root
cd learn-greek-easy-backend
alembic init alembic
```

**Expected Output**:
```
Creating directory alembic ... done
Creating directory alembic/versions ... done
Generating alembic.ini ... done
Generating alembic/env.py ... done
Generating alembic/script.py.mako ... done
```

**Verification**:
- [ ] `alembic/` directory created
- [ ] `alembic/versions/` directory exists (empty)
- [ ] `alembic/env.py` file created
- [ ] `alembic/script.py.mako` template created
- [ ] `alembic.ini` configuration file created

---

### Step 2: Configure alembic.ini (10 minutes)

**Objective**: Configure Alembic settings for PostgreSQL with UTF-8 support

**File**: `alembic.ini` (root of backend project)

**Changes Required**:

1. **Database URL**: Comment out the default, use config instead
```ini
# sqlalchemy.url = driver://user:pass@localhost/dbname
# URL will be set programmatically from src.config.settings
```

2. **File Template**: Make migration filenames readable
```ini
file_template = %%(year)d%%(month).2d%%(day).2d_%%(hour).2d%%(minute).2d_%%(rev)s_%%(slug)s
```

3. **Timezone**: Enable timezone-aware timestamps
```ini
timezone = UTC
```

4. **UTF-8 Encoding**: Support Greek characters
```ini
# output_encoding = utf-8
output_encoding = utf-8
```

5. **Logging Configuration**: Keep default logging setup

**Full alembic.ini Template**:
```ini
# A generic, single database configuration.

[alembic]
# Path to migration scripts
script_location = alembic

# Template used to generate migration file names
file_template = %%(year)d%%(month).2d%%(day).2d_%%(hour).2d%%(minute).2d_%%(rev)s_%%(slug)s

# Timezone for timestamps
timezone = UTC

# sys.path path, will be prepended to sys.path if present
# prepend_sys_path = .

# Logging configuration
[loggers]
keys = root,sqlalchemy,alembic

[handlers]
keys = console

[formatters]
keys = generic

[logger_root]
level = WARN
handlers = console
qualname =

[logger_sqlalchemy]
level = WARN
handlers =
qualname = sqlalchemy.engine

[logger_alembic]
level = INFO
handlers =
qualname = alembic

[handler_console]
class = StreamHandler
args = (sys.stderr,)
level = NOTSET
formatter = generic

[formatter_generic]
format = %(levelname)-5.5s [%(name)s] %(message)s
datefmt = %H:%M:%S
```

**Verification**:
- [ ] `file_template` uses readable date format
- [ ] `timezone = UTC` set
- [ ] `output_encoding = utf-8` enabled
- [ ] Logging configuration present

---

### Step 3: Configure env.py for Async SQLAlchemy 2.0 (20 minutes)

**Objective**: Setup Alembic to work with async SQLAlchemy 2.0 and detect all models

**File**: `alembic/env.py`

**Complete Implementation**:

```python
"""Alembic environment configuration for async SQLAlchemy 2.0."""
import asyncio
from logging.config import fileConfig

from sqlalchemy import pool
from sqlalchemy.engine import Connection
from sqlalchemy.ext.asyncio import async_engine_from_config

from alembic import context

# Import settings to get database URL
from src.config import settings

# Import Base for metadata
from src.db.base import Base

# CRITICAL: Import all models for Alembic to detect them
from src.db.models import (
    # User management
    User,
    UserSettings,
    RefreshToken,
    # Content
    Deck,
    Card,
    # Progress tracking
    UserDeckProgress,
    CardStatistics,
    Review,
    # Enums
    DeckLevel,
    CardDifficulty,
    CardStatus,
    ReviewRating,
)

# Alembic Config object
config = context.config

# Set database URL from settings
config.set_main_option("sqlalchemy.url", settings.database_url_sync)

# Interpret the config file for Python logging
if config.config_file_name is not None:
    fileConfig(config.config_file_name)

# Target metadata for autogenerate
target_metadata = Base.metadata


def run_migrations_offline() -> None:
    """Run migrations in 'offline' mode.

    This configures the context with just a URL
    and not an Engine, though an Engine is acceptable
    here as well. By skipping the Engine creation
    we don't even need a DBAPI to be available.

    Calls to context.execute() here emit the given string to the
    script output.
    """
    url = config.get_main_option("sqlalchemy.url")
    context.configure(
        url=url,
        target_metadata=target_metadata,
        literal_binds=True,
        dialect_opts={"paramstyle": "named"},
        compare_type=True,  # Enable type comparison (for enums)
        compare_server_default=True,  # Compare server defaults
    )

    with context.begin_transaction():
        context.run_migrations()


def do_run_migrations(connection: Connection) -> None:
    """Run migrations with the given connection."""
    context.configure(
        connection=connection,
        target_metadata=target_metadata,
        compare_type=True,  # Enable type comparison (critical for enums)
        compare_server_default=True,
    )

    with context.begin_transaction():
        context.run_migrations()


async def run_async_migrations() -> None:
    """Run migrations in 'online' mode with async engine.

    In this scenario we need to create an Engine
    and associate a connection with the context.
    """
    connectable = async_engine_from_config(
        config.get_section(config.config_ini_section, {}),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,  # No pooling for migrations
    )

    async with connectable.connect() as connection:
        await connection.run_sync(do_run_migrations)

    await connectable.dispose()


def run_migrations_online() -> None:
    """Run migrations in 'online' mode (async wrapper)."""
    asyncio.run(run_async_migrations())


# Determine which mode to run
if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()
```

**Key Features**:
1. **Async Support**: Uses `async_engine_from_config` and `asyncio.run()`
2. **All Models Imported**: Ensures Alembic detects all 8 models + 4 enums
3. **Enum Detection**: `compare_type=True` enables PostgreSQL enum comparison
4. **Database URL**: Pulled from `settings.database_url_sync`
5. **Metadata**: Uses `Base.metadata` for autogenerate

**Verification**:
- [ ] All 8 models imported explicitly
- [ ] All 4 enums imported
- [ ] `compare_type=True` set in both offline and online modes
- [ ] Async functions use `async/await` correctly
- [ ] `settings.database_url_sync` used (not async URL)

---

### Step 4: Verify PostgreSQL Enum Mapping (5 minutes)

**Objective**: Confirm Python enums are properly configured for PostgreSQL

**File**: `src/db/models.py` (lines 17-52)

**Check Current Enum Definitions**:

```python
# These are already in src/db/models.py
import enum

class DeckLevel(str, enum.Enum):
    """CEFR levels for Greek language learning."""
    A1 = "A1"
    A2 = "A2"
    B1 = "B1"
    B2 = "B2"

class CardDifficulty(str, enum.Enum):
    """Difficulty rating for flashcards."""
    EASY = "easy"
    MEDIUM = "medium"
    HARD = "hard"

class CardStatus(str, enum.Enum):
    """Learning stage in spaced repetition system."""
    NEW = "new"
    LEARNING = "learning"
    REVIEW = "review"
    RELEARNING = "relearning"
    MASTERED = "mastered"

class ReviewRating(int, enum.Enum):
    """User rating for card review (SM-2 algorithm)."""
    AGAIN = 1  # Complete blackout, incorrect response
    HARD = 2   # Incorrect response, but familiar
    GOOD = 3   # Correct response with effort
    EASY = 4   # Perfect response
```

**Verification Checklist**:
- [ ] All enums inherit from `str/int` + `enum.Enum`
- [ ] Enum values match SQLAlchemy column definitions
- [ ] `DeckLevel`, `CardDifficulty`, `CardStatus` use string values
- [ ] `ReviewRating` uses integer values (1-4 for SM-2)
- [ ] No typos in enum member names

**Notes**:
- SQLAlchemy will automatically create PostgreSQL enum types
- Enum names in PostgreSQL will be lowercase: `decklevel`, `carddifficulty`, etc.
- Alembic will detect these enums and generate CREATE TYPE statements

---

### Step 5: Test Alembic Configuration (10 minutes)

**Objective**: Verify Alembic can connect to database and detect models

**Commands**:

```bash
# Test 1: Check Alembic version
alembic --version
# Expected: alembic 1.13.2 (or higher)

# Test 2: Check current migration status
alembic current
# Expected: "No current revision" (fresh database)

# Test 3: Verify model detection (dry-run)
alembic revision --autogenerate -m "Test detection" --sql
# Expected: SQL output showing CREATE TABLE statements for all 8 tables

# Test 4: Clean up test revision (don't commit)
rm alembic/versions/*.py
```

**Create Verification Script**:

**File**: `scripts/verify_alembic_config.py`

```python
"""Verify Alembic configuration can detect all models."""
import sys
from pathlib import Path

# Add parent directory to path
sys.path.insert(0, str(Path(__file__).parent.parent))

from src.config import settings
from src.db.base import Base
from src.db.models import (
    User, UserSettings, RefreshToken,
    Deck, Card,
    UserDeckProgress, CardStatistics, Review,
    DeckLevel, CardDifficulty, CardStatus, ReviewRating
)

def verify_configuration():
    """Run configuration checks."""
    print("=" * 60)
    print("ALEMBIC CONFIGURATION VERIFICATION")
    print("=" * 60)

    # Check 1: Database URL
    print("\n1. Database URL Configuration")
    print(f"   Sync URL: {settings.database_url_sync[:30]}...")

    # Check 2: Models
    print("\n2. Model Detection")
    tables = Base.metadata.tables
    print(f"   Total tables detected: {len(tables)}")
    for table_name in sorted(tables.keys()):
        print(f"   - {table_name}")

    expected_tables = [
        "users", "user_settings", "refresh_tokens",
        "decks", "cards",
        "user_deck_progress", "card_statistics", "reviews"
    ]

    # Check 3: Verify all expected tables
    print("\n3. Table Verification")
    missing = set(expected_tables) - set(tables.keys())
    if missing:
        print(f"   ❌ Missing tables: {missing}")
        return False
    else:
        print(f"   ✅ All {len(expected_tables)} expected tables detected")

    # Check 4: Enums
    print("\n4. Enum Types")
    enums = [DeckLevel, CardDifficulty, CardStatus, ReviewRating]
    for enum_cls in enums:
        print(f"   - {enum_cls.__name__}: {len(enum_cls)} members")

    print("\n" + "=" * 60)
    print("✅ ALEMBIC CONFIGURATION VERIFIED")
    print("=" * 60)
    return True

if __name__ == "__main__":
    try:
        success = verify_configuration()
        sys.exit(0 if success else 1)
    except Exception as e:
        print(f"\n❌ ERROR: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)
```

**Run Verification**:
```bash
python scripts/verify_alembic_config.py
```

**Expected Output**:
```
============================================================
ALEMBIC CONFIGURATION VERIFICATION
============================================================

1. Database URL Configuration
   Sync URL: postgresql://postgres:postgr...

2. Model Detection
   Total tables detected: 8
   - card_statistics
   - cards
   - decks
   - refresh_tokens
   - reviews
   - user_deck_progress
   - user_settings
   - users

3. Table Verification
   ✅ All 8 expected tables detected

4. Enum Types
   - DeckLevel: 4 members
   - CardDifficulty: 3 members
   - CardStatus: 5 members
   - ReviewRating: 4 members

============================================================
✅ ALEMBIC CONFIGURATION VERIFIED
============================================================
```

**Verification Checklist**:
- [ ] `alembic --version` shows 1.13.2+
- [ ] `alembic current` runs without errors
- [ ] Verification script detects all 8 tables
- [ ] Verification script detects all 4 enums
- [ ] No import errors when loading models
- [ ] Database connection successful

---

### Step 6: Update .gitignore (2 minutes)

**Objective**: Ensure Alembic cache files are not committed

**File**: `.gitignore` (add these lines if not present)

```
# Alembic
alembic/__pycache__/
alembic/versions/__pycache__/
*.pyc
```

**Verification**:
- [ ] `.gitignore` includes Alembic cache directories
- [ ] No `__pycache__` folders committed to Git

---

## Success Criteria

### Functional Requirements
- [x] Alembic initialized with `alembic init alembic`
- [x] `alembic.ini` configured with UTF-8 encoding
- [x] `env.py` configured for async SQLAlchemy 2.0
- [x] All 8 models imported in `env.py`
- [x] All 4 enums imported in `env.py`
- [x] Database connection works from Alembic
- [x] `compare_type=True` enabled for enum detection

### Verification Tests
- [x] `alembic --version` succeeds
- [x] `alembic current` succeeds (no errors)
- [x] `scripts/verify_alembic_config.py` passes all checks
- [x] No import errors when running verification
- [x] All 8 tables detected by Alembic metadata

### Configuration Quality
- [x] `database_url_sync` used (not async URL)
- [x] Async engine configuration follows SQLAlchemy 2.0 patterns
- [x] Migration file template uses readable timestamps
- [x] Logging configured for development visibility
- [x] Comments explain async migration flow

---

## File Structure After Completion

```
learn-greek-easy-backend/
├── alembic/
│   ├── versions/              # (empty - migrations created in 02.04)
│   ├── env.py                 # ✅ Configured for async SQLAlchemy 2.0
│   ├── script.py.mako         # ✅ Default template
│   └── README                 # ✅ Default readme
├── alembic.ini                # ✅ Configured with UTF-8, timezone
├── src/
│   ├── db/
│   │   ├── models.py          # ✅ Already complete (8 models + 4 enums)
│   │   ├── base.py            # ✅ Already complete
│   │   └── session.py         # ✅ Already complete
│   └── config.py              # ✅ Already has database_url_sync
├── scripts/
│   └── verify_alembic_config.py  # ✅ NEW - Configuration verification
└── .gitignore                 # ✅ Updated with Alembic entries
```

---

## Common Issues and Solutions

### Issue 1: "No module named 'src'"
**Cause**: Python path not including project root
**Solution**: Run alembic from project root, not from subdirectories

### Issue 2: "Target database is not up to date"
**Cause**: Database has existing tables
**Solution**: This is expected if database has content. Will be resolved in 02.04

### Issue 3: Async warnings in env.py
**Cause**: Using async URL in alembic
**Solution**: Ensure using `settings.database_url_sync`, not `settings.database_url`

### Issue 4: Enums not detected
**Cause**: `compare_type=False` or enums not imported
**Solution**: Set `compare_type=True` and import all enum classes in env.py

### Issue 5: UnicodeDecodeError with Greek text
**Cause**: UTF-8 encoding not configured
**Solution**: Set `output_encoding = utf-8` in alembic.ini

---

## Testing Checklist

Before marking task complete, verify:

```bash
# 1. Alembic is operational
alembic --version
alembic current

# 2. Configuration verification passes
python scripts/verify_alembic_config.py

# 3. Database connection test
python -c "from src.config import settings; print(settings.database_url_sync[:30])"

# 4. Model imports work
python -c "from src.db.models import User, Deck, Card; print('✅ Models imported')"

# 5. Enum imports work
python -c "from src.db.models import DeckLevel, CardStatus; print('✅ Enums imported')"
```

**All tests must pass** before proceeding to Task 02.04 (Initial Migration).

---

## Next Steps (Task 02.04)

After completing this task:

1. **Task 02.04: Generate Initial Migration**
   - Run `alembic revision --autogenerate -m "Initial schema"`
   - Review generated migration file
   - Verify it creates 8 tables + 4 PostgreSQL enum types
   - Apply migration with `alembic upgrade head`

2. **Task 02.05: Create Pydantic Schemas**
   - Define request/response schemas for API endpoints
   - Use Pydantic for validation
   - Export schemas from `src/schemas/`

---

## Estimated Effort Breakdown

| Step | Task | Duration |
|------|------|----------|
| 1 | Initialize Alembic | 10 min |
| 2 | Configure alembic.ini | 10 min |
| 3 | Configure env.py (async) | 20 min |
| 4 | Verify enum mapping | 5 min |
| 5 | Test configuration | 10 min |
| 6 | Update .gitignore | 2 min |
| **TOTAL** | | **57 min** |

---

## Key Takeaways

1. **Async SQLAlchemy 2.0**: Alembic requires special configuration for async
2. **Model Imports**: All models MUST be imported in env.py for detection
3. **Enum Type Comparison**: `compare_type=True` is critical for enum changes
4. **Sync URL**: Alembic uses synchronous database URL (not async)
5. **UTF-8 Encoding**: Required for Greek text in migrations
6. **Verification**: Always test configuration before creating migrations

---

**Document Version**: 1.0
**Created**: 2025-11-21
**Status**: Ready for Implementation
**Dependencies**: Tasks 02.01 ✅ and 02.02 ✅
**Next Task**: 02.04 (Initial Migration)
