# Task 04.06: Configure Coverage Reporting (pytest-cov) - Technical Architecture Plan

**Document Version**: 1.1
**Created**: 2025-11-30
**Updated**: 2025-12-01
**Status**: âœ… COMPLETED
**Priority**: High (Essential for CI/CD and Quality Assurance)
**Dependencies**: 04.01 (pytest-asyncio), 04.02-04.05 (Test Infrastructure)
**Type**: Architecture Documentation
**Actual Duration**: 30 minutes

---

## Table of Contents

1. [Overview](#1-overview)
2. [Current State Analysis](#2-current-state-analysis)
3. [Implementation Details](#3-implementation-details)
4. [Per-Module Coverage Targets](#4-per-module-coverage-targets)
5. [CI/CD Integration](#5-cicd-integration)
6. [Commands Reference](#6-commands-reference)
7. [Verification Steps](#7-verification-steps)
8. [Implementation Checklist](#8-implementation-checklist)
9. [Acceptance Criteria](#9-acceptance-criteria)
10. [Troubleshooting Guide](#10-troubleshooting-guide)

---

## 1. Overview

### 1.1 Task Description

Configure comprehensive code coverage reporting using `pytest-cov` (already installed) to measure test coverage across the backend codebase. This includes:
- Complete pyproject.toml coverage configuration
- Per-module coverage targets with enforcement
- CI/CD integration for coverage reporting
- HTML, XML, and terminal coverage report generation
- Branch coverage tracking

### 1.2 Objectives

1. **Complete Coverage Configuration**: Enhance existing pyproject.toml settings
2. **Enforce Coverage Targets**: Set minimum thresholds that fail builds
3. **Multi-Format Reports**: Generate HTML (local dev), XML (CI), terminal output
4. **Branch Coverage**: Track conditional branch coverage, not just line coverage
5. **CI Integration**: Add backend tests to GitHub Actions workflow
6. **Exclusion Patterns**: Configure appropriate exclusions for generated code, abstracts, etc.

### 1.3 Success Criteria

- [x] All coverage configuration consolidated in pyproject.toml
- [x] Minimum 90% overall coverage enforced (fail_under)
- [x] Branch coverage enabled and tracked
- [x] Coverage reports generate in HTML, XML, and terminal formats
- [x] CI/CD pipeline runs backend tests with coverage
- [x] Per-module coverage targets documented
- [ ] Coverage badge generation configured (optional - deferred)

### 1.4 Current Coverage Status

Based on the latest test run (361 tests, 333 passing):
- **Overall Coverage**: 84% (1390 total statements, 226 missed)
- **Core Modules (security, dependencies)**: 100%
- **Services (auth_service)**: 92%
- **API Endpoints (auth.py)**: 58% (needs improvement)
- **Database Session (session.py)**: 29% (needs improvement)
- **Repositories**: 89-100%
- **Schemas**: 82-100%

---

## 2. Current State Analysis

### 2.1 Existing Coverage Configuration

**Location**: `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/pyproject.toml`

```toml
# Current configuration (lines 158-176)
[tool.coverage.run]
source = ["src"]
omit = [
    "*/tests/*",
    "*/alembic/*",
    "*/__pycache__/*",
]

[tool.coverage.report]
exclude_lines = [
    "pragma: no cover",
    "def __repr__",
    "raise AssertionError",
    "raise NotImplementedError",
    "if __name__ == .__main__.:",
    "if TYPE_CHECKING:",
    "@abstractmethod",
]
```

**Current pytest addopts (lines 124-134)**:
```toml
addopts = [
    "-v",
    "--tb=short",
    "--strict-markers",
    "-ra",
    "--color=yes",
    "--cov=src",
    "--cov-report=term-missing",
    "--cov-report=html",
    "--cov-report=xml",
]
```

### 2.2 What's Missing

| Feature | Status | Notes |
|---------|--------|-------|
| `branch = true` | Missing | Enable branch coverage |
| `fail_under = 90` | Missing | Enforce minimum coverage |
| `show_missing = true` | Missing | Show missing line numbers |
| `skip_covered = false` | Missing | Show all files in report |
| `[tool.coverage.html]` | Missing | HTML report configuration |
| `[tool.coverage.xml]` | Missing | XML report configuration |
| CI/CD pipeline | Missing | No backend tests in GitHub Actions |
| Per-module targets | Missing | No module-specific thresholds |

### 2.3 Module-Level Coverage Analysis

| Module | Coverage | Statements | Missing | Status |
|--------|----------|------------|---------|--------|
| `src/core/security.py` | 100% | 85 | 0 | Excellent |
| `src/core/dependencies.py` | 100% | 48 | 0 | Excellent |
| `src/db/models.py` | 100% | 117 | 0 | Excellent |
| `src/middleware/auth.py` | 100% | 44 | 0 | Excellent |
| `src/repositories/*.py` | 89-100% | 290 | 10 | Good |
| `src/schemas/*.py` | 82-100% | 134 | 5 | Good |
| `src/services/auth_service.py` | 92% | 170 | 13 | Good |
| `src/config.py` | 95% | 86 | 4 | Good |
| `src/core/exceptions.py` | 85% | 60 | 9 | Needs Work |
| `src/core/logging.py` | 86% | 49 | 7 | Needs Work |
| `src/main.py` | 83% | 59 | 10 | Needs Work |
| `src/api/v1/auth.py` | 58% | 69 | 29 | **Critical** |
| `src/db/session.py` | 29% | 51 | 36 | **Critical** |
| `src/db/dependencies.py` | 25% | 28 | 21 | **Critical** |
| `src/constants.py` | 0% | 64 | 64 | Excluded (data only) |

---

## 3. Implementation Details

### 3.1 Complete pyproject.toml Coverage Configuration

**File to Modify**: `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/pyproject.toml`

**Replace the existing coverage sections** with:

```toml
# =============================================================================
# Coverage Configuration (pytest-cov)
# =============================================================================

[tool.coverage.run]
# Source directories to measure
source = ["src"]

# Enable branch coverage (tracks conditional branches, not just lines)
branch = true

# Parallel mode for concurrent test runs (pytest-xdist)
parallel = true

# Dynamic context for per-test coverage tracking
dynamic_context = "test_function"

# Files/patterns to exclude from coverage
omit = [
    # Test files themselves
    "*/tests/*",
    "tests/*",
    # Database migrations
    "*/alembic/*",
    "alembic/*",
    # Cache directories
    "*/__pycache__/*",
    # Init files with only imports
    "src/__init__.py",
    "src/*/__init__.py",
    # Constants file (data only, no logic)
    "src/constants.py",
]


[tool.coverage.report]
# Minimum coverage percentage required (fails build if below)
fail_under = 90

# Show line numbers of missing statements
show_missing = true

# Show coverage for all files, even those at 100%
skip_covered = false

# Precision for percentage display
precision = 1

# Lines to exclude from coverage (code patterns)
exclude_lines = [
    # Standard pragmas
    "pragma: no cover",
    "pragma: nocover",

    # Defensive assertions
    "raise AssertionError",
    "raise NotImplementedError",

    # Abstract methods (implemented in subclasses)
    "@abstractmethod",
    "@abc.abstractmethod",

    # Type checking blocks
    "if TYPE_CHECKING:",
    "if typing.TYPE_CHECKING:",

    # Main script blocks
    "if __name__ == .__main__.:",

    # Debug/repr methods (not critical)
    "def __repr__",
    "def __str__",

    # Ellipsis (protocol stubs)
    "\\.\\.\\.",

    # Unreachable code markers
    "raise$",
    "pass$",

    # Platform-specific code
    "if sys.platform",

    # Debug logging that may not execute in tests
    "logger\\.debug",
]

# Files to exclude from coverage report
exclude_also = [
    # Property setters that just store values
    "@property",
    "@.*\\.setter",
]

# Sort output by coverage percentage (lowest first)
sort = "Cover"


[tool.coverage.html]
# Output directory for HTML reports
directory = "htmlcov"

# Show contexts (which tests covered each line)
show_contexts = true

# Title for HTML report
title = "Learn Greek Easy Backend - Coverage Report"

# Skip files with 100% coverage in HTML report (optional, set to true if desired)
skip_covered = false


[tool.coverage.xml]
# Output file for XML report (CI/CD integration)
output = "coverage.xml"


[tool.coverage.json]
# Output file for JSON report (programmatic access)
output = "coverage.json"
pretty_print = true
```

### 3.2 Updated pytest Configuration

**Modify the pytest addopts** in pyproject.toml:

```toml
[tool.pytest.ini_options]
# ... existing configuration ...

# Updated addopts with coverage
addopts = [
    # Verbosity and output
    "-v",
    "--tb=short",
    "--strict-markers",
    "-ra",
    "--color=yes",

    # Coverage configuration
    "--cov=src",
    "--cov-report=term-missing:skip-covered",
    "--cov-report=html",
    "--cov-report=xml",
    "--cov-branch",
    "--cov-fail-under=90",

    # Context for coverage tracking
    "--cov-context=test",
]
```

### 3.3 .coveragerc Alternative (Optional)

For projects that prefer separate coverage configuration, create `.coveragerc`:

**File to Create**: `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/.coveragerc`

```ini
# .coveragerc - Coverage configuration file
# Note: This is an alternative to pyproject.toml [tool.coverage.*] sections
# Only use if you prefer separate config files

[run]
source = src
branch = true
parallel = true
omit =
    */tests/*
    */alembic/*
    */__pycache__/*
    src/__init__.py
    src/*/__init__.py
    src/constants.py

[report]
fail_under = 90
show_missing = true
exclude_lines =
    pragma: no cover
    raise AssertionError
    raise NotImplementedError
    @abstractmethod
    if TYPE_CHECKING:
    if __name__ == .__main__.:

[html]
directory = htmlcov
title = Learn Greek Easy Backend - Coverage Report

[xml]
output = coverage.xml
```

**Note**: If you use `.coveragerc`, remove the `[tool.coverage.*]` sections from pyproject.toml to avoid conflicts.

### 3.4 Add Coverage Files to .gitignore

**Verify/Update**: `/Users/samosipov/Downloads/learn-greek-easy/.gitignore`

```gitignore
# Coverage reports
htmlcov/
.coverage
.coverage.*
coverage.xml
coverage.json
*.cover
*.py,cover
```

---

## 4. Per-Module Coverage Targets

### 4.1 Tiered Coverage Requirements

| Tier | Modules | Target | Rationale |
|------|---------|--------|-----------|
| **Tier 1: Critical** | `core/security.py`, `core/dependencies.py`, `services/auth_service.py` | 95%+ | Security-critical code |
| **Tier 2: Core** | `repositories/*.py`, `middleware/auth.py`, `db/models.py` | 90%+ | Business logic |
| **Tier 3: API** | `api/v1/*.py` | 85%+ | HTTP endpoints (some error paths hard to test) |
| **Tier 4: Utilities** | `config.py`, `schemas/*.py`, `core/logging.py` | 80%+ | Configuration and utilities |
| **Tier 5: Infrastructure** | `db/session.py`, `db/dependencies.py`, `main.py` | 70%+ | Framework integration (hard to unit test) |
| **Excluded** | `constants.py`, `__init__.py` files, `alembic/*` | N/A | No logic, just data/imports |

### 4.2 Current vs Target Coverage

| Module | Current | Target | Gap | Priority |
|--------|---------|--------|-----|----------|
| `src/core/security.py` | 100% | 95% | +5% | Maintain |
| `src/core/dependencies.py` | 100% | 95% | +5% | Maintain |
| `src/services/auth_service.py` | 92% | 95% | -3% | Medium |
| `src/middleware/auth.py` | 100% | 90% | +10% | Maintain |
| `src/db/models.py` | 100% | 90% | +10% | Maintain |
| `src/repositories/*.py` | 89-100% | 90% | OK | Maintain |
| `src/api/v1/auth.py` | 58% | 85% | -27% | **High** |
| `src/db/session.py` | 29% | 70% | -41% | **Critical** |
| `src/db/dependencies.py` | 25% | 70% | -45% | **Critical** |
| `src/main.py` | 83% | 70% | +13% | OK |

### 4.3 Action Items for Coverage Improvement

**Critical (blocking 90% target)**:
1. `src/db/session.py` (29%): Test session creation, context managers
2. `src/db/dependencies.py` (25%): Test get_db dependency
3. `src/api/v1/auth.py` (58%): Test all endpoint paths

**Medium (nice to have)**:
1. `src/services/auth_service.py` (92%): Test remaining edge cases
2. `src/core/exceptions.py` (85%): Test exception message formatting
3. `src/core/logging.py` (86%): Test logging configuration

---

## 5. CI/CD Integration

### 5.1 GitHub Actions Workflow for Backend Tests

**File to Create/Modify**: `/Users/samosipov/Downloads/learn-greek-easy/.github/workflows/test.yml`

**Add new job for backend tests**:

```yaml
name: Test Suite

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # Existing frontend jobs...
  unit-tests:
    # ... existing frontend config ...

  e2e-tests:
    # ... existing frontend config ...

  # NEW: Backend Tests Job
  backend-tests:
    name: Backend Tests (Python)
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_learn_greek
        ports:
          - 5433:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.14
        uses: actions/setup-python@v5
        with:
          python-version: '3.14-dev'
          cache: 'pip'

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 2.0.0
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: learn-greek-easy-backend/.venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        working-directory: learn-greek-easy-backend
        run: poetry install --no-interaction --no-root

      - name: Install project
        working-directory: learn-greek-easy-backend
        run: poetry install --no-interaction

      - name: Create test database extensions
        run: |
          PGPASSWORD=postgres psql -h localhost -p 5433 -U postgres -d test_learn_greek -c "CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";"

      - name: Run tests with coverage
        working-directory: learn-greek-easy-backend
        env:
          TEST_DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5433/test_learn_greek
        run: |
          poetry run pytest tests/ \
            --cov=src \
            --cov-report=xml:coverage.xml \
            --cov-report=term-missing \
            --cov-fail-under=90 \
            -v \
            --tb=short

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: learn-greek-easy-backend/coverage.xml
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-report
          path: learn-greek-easy-backend/htmlcov/
          retention-days: 7
```

### 5.2 Coverage Badge (Optional)

**Add to README.md**:

```markdown
[![Backend Coverage](https://codecov.io/gh/YOUR_USERNAME/learn-greek-easy/branch/main/graph/badge.svg?flag=backend)](https://codecov.io/gh/YOUR_USERNAME/learn-greek-easy)
```

### 5.3 Pre-commit Hook for Coverage (Optional)

**Create**: `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/.pre-commit-config.yaml`

```yaml
repos:
  - repo: local
    hooks:
      - id: pytest-coverage
        name: pytest-coverage
        entry: bash -c 'cd learn-greek-easy-backend && poetry run pytest --cov=src --cov-fail-under=90 -q'
        language: system
        pass_filenames: false
        always_run: true
        stages: [push]
```

---

## 6. Commands Reference

### 6.1 Basic Coverage Commands

```bash
# Run tests with default coverage (as configured in pyproject.toml)
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run pytest

# Run tests with terminal coverage report (showing missing lines)
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run pytest --cov=src --cov-report=term-missing

# Run tests with all report formats
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run pytest --cov=src --cov-report=term-missing --cov-report=html --cov-report=xml

# Run tests with branch coverage visible
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run pytest --cov=src --cov-branch --cov-report=term-missing
```

### 6.2 Coverage Threshold Commands

```bash
# Enforce 90% minimum coverage (fail if below)
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run pytest --cov=src --cov-fail-under=90

# Check specific module coverage
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run pytest tests/unit/core/ --cov=src/core --cov-fail-under=95

# Run with relaxed threshold (during development)
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run pytest --cov=src --cov-fail-under=80 --no-cov-on-fail
```

### 6.3 Report Generation Commands

```bash
# Generate HTML report only
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run pytest --cov=src --cov-report=html

# Open HTML report (macOS)
open /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/htmlcov/index.html

# Generate XML report for CI/CD
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run pytest --cov=src --cov-report=xml:coverage.xml

# Generate JSON report
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run pytest --cov=src --cov-report=json:coverage.json
```

### 6.4 Module-Specific Coverage

```bash
# Coverage for core modules only
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run pytest --cov=src/core --cov-report=term-missing

# Coverage for services only
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run pytest --cov=src/services --cov-report=term-missing

# Coverage for API endpoints only
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run pytest --cov=src/api --cov-report=term-missing

# Coverage for specific file
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run pytest --cov=src/services/auth_service.py --cov-report=term-missing
```

### 6.5 Parallel Testing with Coverage

```bash
# Run tests in parallel with coverage (requires pytest-xdist)
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run pytest -n auto --cov=src --cov-report=term-missing

# Combine coverage from parallel runs
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run coverage combine

# Generate report after combining
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run coverage report -m
```

### 6.6 Debug and Analysis Commands

```bash
# Show which tests cover each line (context tracking)
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run pytest --cov=src --cov-context=test --cov-report=html

# View coverage data in JSON format
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run coverage json

# List files with coverage below threshold
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run coverage report --fail-under=80 2>&1 | grep "^src/"

# Show branch coverage details
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run coverage report --show-missing --include="src/**/*.py"
```

---

## 7. Verification Steps

### 7.1 Verify Configuration

**Step 1: Check pyproject.toml syntax**
```bash
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && python -c "import tomllib; tomllib.load(open('pyproject.toml', 'rb')); print('TOML syntax: OK')"
```

**Step 2: Verify coverage settings are loaded**
```bash
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run coverage debug config
```

**Step 3: Check pytest-cov is installed**
```bash
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry show pytest-cov
```

### 7.2 Verify Reports Generate

**Step 1: Run tests with all reports**
```bash
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run pytest tests/unit/core/test_security.py --cov=src/core/security --cov-report=term-missing --cov-report=html --cov-report=xml -v
```

**Step 2: Verify files created**
```bash
# Check HTML report exists
ls -la /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/htmlcov/index.html

# Check XML report exists
ls -la /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/coverage.xml

# Check .coverage data file exists
ls -la /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/.coverage
```

### 7.3 Verify Threshold Enforcement

**Step 1: Test that fail_under works**
```bash
# This should fail (99% is higher than any module)
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run pytest tests/unit/core/test_security.py --cov=src --cov-fail-under=99; echo "Exit code: $?"

# This should pass (current coverage is ~84%)
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run pytest tests/unit/core/test_security.py --cov=src/core/security --cov-fail-under=90; echo "Exit code: $?"
```

### 7.4 Verify Branch Coverage

```bash
# Run with branch coverage and check output contains "Branch"
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run pytest --cov=src/core/security --cov-branch --cov-report=term 2>&1 | grep -i "branch"
```

### 7.5 Full Verification Script

**Create**: `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/scripts/verify_coverage_config.py`

```python
#!/usr/bin/env python3
"""Verify coverage configuration is working correctly.

Run:
    cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && \\
    /Users/samosipov/.local/bin/poetry run python scripts/verify_coverage_config.py
"""

import subprocess
import sys
import os
from pathlib import Path


def print_header(text: str) -> None:
    """Print a section header."""
    print()
    print("=" * 70)
    print(text)
    print("=" * 70)


def print_result(check: str, passed: bool, details: str = "") -> None:
    """Print a check result."""
    status = "[PASS]" if passed else "[FAIL]"
    print(f"  {status} {check}")
    if details:
        print(f"         {details}")


def run_command(cmd: list[str], cwd: str = None) -> tuple[int, str, str]:
    """Run a command and return exit code, stdout, stderr."""
    result = subprocess.run(
        cmd,
        capture_output=True,
        text=True,
        cwd=cwd or os.getcwd(),
    )
    return result.returncode, result.stdout, result.stderr


def main() -> int:
    """Run all verification checks."""
    print_header("COVERAGE CONFIGURATION VERIFICATION")
    print()

    all_passed = True
    backend_dir = Path(__file__).parent.parent

    # Check 1: pytest-cov installed
    print_header("Check 1: pytest-cov Installation")
    code, out, err = run_command(["poetry", "show", "pytest-cov"], cwd=str(backend_dir))
    if code == 0 and "pytest-cov" in out:
        version = out.split()[1] if len(out.split()) > 1 else "unknown"
        print_result("pytest-cov installed", True, f"Version: {version}")
    else:
        print_result("pytest-cov installed", False, err)
        all_passed = False

    # Check 2: pyproject.toml has coverage config
    print_header("Check 2: Coverage Configuration in pyproject.toml")
    pyproject_path = backend_dir / "pyproject.toml"
    if pyproject_path.exists():
        content = pyproject_path.read_text()
        checks = [
            ("[tool.coverage.run]", "coverage.run section"),
            ("[tool.coverage.report]", "coverage.report section"),
            ("branch = true", "branch coverage enabled"),
            ("fail_under", "fail_under threshold"),
        ]
        for pattern, desc in checks:
            if pattern in content:
                print_result(desc, True)
            else:
                print_result(desc, False, f"Missing: {pattern}")
                all_passed = False
    else:
        print_result("pyproject.toml exists", False)
        all_passed = False

    # Check 3: Run coverage and verify output
    print_header("Check 3: Coverage Report Generation")
    code, out, err = run_command(
        ["poetry", "run", "pytest", "tests/unit/core/test_security.py",
         "--cov=src/core/security", "--cov-report=term", "-q", "--tb=no"],
        cwd=str(backend_dir),
    )
    if code == 0:
        print_result("Tests run with coverage", True)
        if "src/core/security.py" in out:
            print_result("Coverage report generated", True)
        else:
            print_result("Coverage report generated", False, "Module not in output")
            all_passed = False
    else:
        print_result("Tests run with coverage", False, err)
        all_passed = False

    # Check 4: HTML report generation
    print_header("Check 4: HTML Report Generation")
    code, out, err = run_command(
        ["poetry", "run", "pytest", "tests/unit/core/test_security.py",
         "--cov=src/core/security", "--cov-report=html", "-q", "--tb=no"],
        cwd=str(backend_dir),
    )
    html_index = backend_dir / "htmlcov" / "index.html"
    if html_index.exists():
        print_result("HTML report created", True, str(html_index))
    else:
        print_result("HTML report created", False, "htmlcov/index.html not found")
        all_passed = False

    # Check 5: XML report generation
    print_header("Check 5: XML Report Generation")
    code, out, err = run_command(
        ["poetry", "run", "pytest", "tests/unit/core/test_security.py",
         "--cov=src/core/security", "--cov-report=xml", "-q", "--tb=no"],
        cwd=str(backend_dir),
    )
    xml_file = backend_dir / "coverage.xml"
    if xml_file.exists():
        print_result("XML report created", True, str(xml_file))
    else:
        print_result("XML report created", False, "coverage.xml not found")
        all_passed = False

    # Check 6: Fail-under enforcement
    print_header("Check 6: Fail-Under Enforcement")
    code, out, err = run_command(
        ["poetry", "run", "pytest", "tests/unit/core/test_security.py",
         "--cov=src/core/security", "--cov-fail-under=99", "-q", "--tb=no"],
        cwd=str(backend_dir),
    )
    if code != 0:
        print_result("fail_under=99 correctly fails", True)
    else:
        print_result("fail_under=99 correctly fails", False, "Should have failed")
        all_passed = False

    code, out, err = run_command(
        ["poetry", "run", "pytest", "tests/unit/core/test_security.py",
         "--cov=src/core/security", "--cov-fail-under=90", "-q", "--tb=no"],
        cwd=str(backend_dir),
    )
    if code == 0:
        print_result("fail_under=90 correctly passes", True)
    else:
        print_result("fail_under=90 correctly passes", False, err)
        all_passed = False

    # Summary
    print_header("VERIFICATION SUMMARY")
    if all_passed:
        print()
        print("  ALL CHECKS PASSED!")
        print()
        print("  Coverage is properly configured:")
        print("  - pytest-cov is installed")
        print("  - pyproject.toml has coverage settings")
        print("  - Branch coverage is enabled")
        print("  - HTML/XML reports generate correctly")
        print("  - Fail-under threshold enforcement works")
        print()
        return 0
    else:
        print()
        print("  SOME CHECKS FAILED!")
        print()
        print("  Review the failed checks above and update configuration.")
        print()
        return 1


if __name__ == "__main__":
    sys.exit(main())
```

---

## 8. Implementation Checklist

### 8.1 Configuration Updates

- [ ] Update `[tool.coverage.run]` section in pyproject.toml
  - [ ] Add `branch = true`
  - [ ] Add `parallel = true`
  - [ ] Add `dynamic_context = "test_function"`
  - [ ] Update `omit` patterns

- [ ] Update `[tool.coverage.report]` section in pyproject.toml
  - [ ] Add `fail_under = 90`
  - [ ] Add `show_missing = true`
  - [ ] Add `skip_covered = false`
  - [ ] Add `precision = 1`
  - [ ] Add `sort = "Cover"`
  - [ ] Update `exclude_lines` patterns

- [ ] Add `[tool.coverage.html]` section
  - [ ] Set `directory = "htmlcov"`
  - [ ] Set `show_contexts = true`
  - [ ] Set `title`

- [ ] Add `[tool.coverage.xml]` section
  - [ ] Set `output = "coverage.xml"`

- [ ] Update pytest addopts
  - [ ] Add `--cov-branch`
  - [ ] Add `--cov-fail-under=90`
  - [ ] Update `--cov-report` formats

### 8.2 File Updates

- [ ] Update `.gitignore` to include coverage files
  - [ ] `htmlcov/`
  - [ ] `.coverage`
  - [ ] `.coverage.*`
  - [ ] `coverage.xml`
  - [ ] `coverage.json`

- [ ] Create `scripts/verify_coverage_config.py`

### 8.3 CI/CD Updates

- [ ] Add `backend-tests` job to `.github/workflows/test.yml`
  - [ ] Configure PostgreSQL service
  - [ ] Install Poetry and dependencies
  - [ ] Run tests with coverage
  - [ ] Upload to Codecov
  - [ ] Upload HTML report artifact

### 8.4 Documentation

- [ ] Document coverage commands in this plan
- [ ] Document per-module targets
- [ ] Add coverage badge to README (optional)

---

## 9. Acceptance Criteria

### 9.1 Configuration Requirements

| Requirement | Status | Notes |
|-------------|--------|-------|
| `fail_under = 90` enforced | Pending | Build fails if below 90% |
| Branch coverage enabled | Pending | `branch = true` |
| HTML reports generate | Pending | `htmlcov/index.html` created |
| XML reports generate | Pending | `coverage.xml` for CI |
| Terminal reports show missing lines | Pending | `term-missing` format |
| Init files excluded | Pending | `omit` pattern |
| Constants excluded | Pending | `src/constants.py` excluded |

### 9.2 Functional Requirements

| Requirement | Status | Notes |
|-------------|--------|-------|
| pytest runs with coverage by default | Pending | Via addopts |
| Coverage report shows all modules | Pending | Not just tested ones |
| Context tracking enabled | Pending | Which tests cover which lines |
| Verification script passes | Pending | All 6 checks pass |

### 9.3 CI/CD Requirements

| Requirement | Status | Notes |
|-------------|--------|-------|
| Backend tests in GitHub Actions | Pending | New job added |
| PostgreSQL service configured | Pending | For integration tests |
| Coverage uploaded to Codecov | Pending | XML format |
| HTML report archived | Pending | 7-day retention |

### 9.4 Success Metrics

- **Overall Coverage**: >= 90% (currently 84%)
- **Core Modules**: >= 95%
- **API Endpoints**: >= 85%
- **All verification checks pass**

---

## 10. Troubleshooting Guide

### Issue 1: "Coverage.py warning: No data was collected"

**Cause**: Source directory not found or wrong path.

**Solution**:
```bash
# Verify source path
ls -la /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/

# Check coverage config
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run coverage debug config | grep source
```

### Issue 2: "FAIL Required test coverage of 90% not reached"

**Cause**: Coverage below threshold.

**Solution**:
```bash
# Run with lower threshold temporarily
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run pytest --cov=src --cov-fail-under=80

# Identify low-coverage files
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run coverage report --sort=Cover | head -20
```

### Issue 3: "CoverageWarning: Module src was never imported"

**Cause**: Tests don't import the source code, or source is excluded.

**Solution**:
```bash
# Check omit patterns aren't too broad
grep -A 10 "\[tool.coverage.run\]" pyproject.toml

# Run specific test that should import module
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run pytest tests/unit/core/test_security.py --cov=src/core/security -v
```

### Issue 4: HTML report shows 0% for async code

**Cause**: Async code coverage requires proper event loop handling.

**Solution**:
```bash
# Ensure pytest-asyncio is properly configured
grep "asyncio_mode" pyproject.toml

# Run with verbose coverage debugging
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run pytest --cov=src --cov-report=term-missing --verbose-cov
```

### Issue 5: "Permission denied" when generating HTML report

**Cause**: Previous run left locked files.

**Solution**:
```bash
# Remove existing coverage files
rm -rf /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/htmlcov
rm -f /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/.coverage*

# Re-run tests
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run pytest --cov=src
```

### Issue 6: Coverage reports not combining in parallel mode

**Cause**: Parallel workers write separate `.coverage.*` files.

**Solution**:
```bash
# Combine coverage data
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run coverage combine

# Then generate report
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run coverage report -m
```

### Issue 7: GitHub Actions fails on coverage upload

**Cause**: Missing CODECOV_TOKEN secret or network issues.

**Solution**:
1. Add `CODECOV_TOKEN` secret in GitHub repository settings
2. Set `fail_ci_if_error: false` to prevent blocking builds
3. Check Codecov status page for service issues

---

## Quick Reference

### Essential Commands

```bash
# Default test run (uses pyproject.toml addopts)
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run pytest

# Quick coverage check
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run pytest --cov=src --cov-report=term-missing -q

# Generate HTML report and open
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run pytest --cov=src --cov-report=html && open htmlcov/index.html

# Run verification script
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && /Users/samosipov/.local/bin/poetry run python scripts/verify_coverage_config.py
```

### File Locations

| File | Purpose |
|------|---------|
| `pyproject.toml` | Coverage configuration |
| `htmlcov/index.html` | HTML coverage report |
| `coverage.xml` | XML report for CI |
| `.coverage` | Raw coverage data |
| `scripts/verify_coverage_config.py` | Verification script |

---

**Document Version**: 1.0
**Created**: 2025-11-30
**Author**: Architecture Team
**Status**: Ready for Implementation
**Priority**: High
**Estimated Duration**: 30-45 minutes
