# Task 04.04.01: Fix Failing Backend Tests - Technical Architecture Plan

**Document Version**: 1.0
**Created**: 2025-12-04
**Status**: ðŸ”„ IN PROGRESS
**Priority**: High (Test Suite Stability)
**Dependencies**: 04.01-04.10 (Testing Framework Complete)
**Type**: Bug Fix / Maintenance
**Branch**: `feature/04.01-fix-failing-tests`

---

## Table of Contents

1. [Overview](#1-overview)
2. [Test Failure Analysis](#2-test-failure-analysis)
3. [Root Cause Categories](#3-root-cause-categories)
4. [Implementation Plan](#4-implementation-plan)
5. [File Changes Required](#5-file-changes-required)
6. [Verification Checklist](#6-verification-checklist)
7. [Acceptance Criteria](#7-acceptance-criteria)

---

## 1. Overview

### 1.1 Task Description

Fix all failing backend unit tests to restore the test suite to a passing state. The test failures are primarily due to API signature changes and async mocking issues.

### 1.2 Test Results Summary

```
Total Tests:   452
Passed:        402 (89%)
Failed:         42 (9%)   â† Need fixing
Errors:          8 (2%)   â† Fixture errors (3-tuple issue)
Warnings:       13

Note: Database must be running for integration tests
Command: docker-compose -f docker-compose.dev.yml up -d postgres redis
```

### 1.3 Categorized Failures

| Category | Count | Root Cause |
|----------|-------|------------|
| JWT Token Tests | 7 | `create_refresh_token` API changed from 2 to 3 return values |
| Base Class Fixtures | 8 | Same 3-tuple issue in `test_user_tokens` fixture |
| Session Repository Tests | 4 | Async context manager mocking incorrect |
| Auth Service Tests | ~15 | Multiple async mocking issues |
| Auth Service Logging Tests | 5 | Log message assertions don't match actual output |
| Integration Tests | ~8 | Response format, timing assertions |

---

## 2. Test Failure Analysis

### 2.1 JWT Token Tests (8 failures)

**Location**: `tests/unit/test_jwt_tokens.py`

**Failing Tests**:
1. `TestRefreshTokenGeneration::test_create_refresh_token_returns_tuple`
2. `TestRefreshTokenGeneration::test_refresh_token_is_valid_jwt`
3. `TestRefreshTokenGeneration::test_refresh_token_expiry_is_30_days`
4. `TestRefreshTokenGeneration::test_refresh_token_contains_correct_payload`
5. `TestRefreshTokenGeneration::test_refresh_token_different_from_access_token`
6. `TestTokenVerification::test_verify_refresh_token_returns_user_id`
7. `TestTokenIntegration::test_refresh_token_cannot_be_used_as_access_token`
8. One additional test with tuple unpacking error

**Root Cause**:
The `create_refresh_token` function signature changed:

```python
# OLD (2 values)
def create_refresh_token(user_id: UUID) -> tuple[str, datetime]:
    return token, expires_at

# NEW (3 values)
def create_refresh_token(user_id: UUID, token_id: str | None = None) -> tuple[str, datetime, str]:
    return token, expires_at, jti
```

**Evidence**:
```
AssertionError: assert 3 == 2
ValueError: too many values to unpack (expected 2, got 3)
```

### 2.2 Session Repository Tests (4 failures)

**Location**: `tests/unit/repositories/test_session_repository.py`

**Failing Tests**:
1. `TestCreateSession::test_create_session_success`
2. `TestDeleteSession::test_delete_session_success`
3. `TestRotateSession::test_rotate_session_success`
4. `TestRevokeAllUserSessions::test_revoke_all_sessions_success`

**Root Cause**:
Async context manager mocking for Redis pipeline is incorrect:

```python
# Current (incorrect)
mock_pipeline = AsyncMock()
mock_redis.pipeline.return_value.__aenter__.return_value = mock_pipeline

# Problem: mock_redis.pipeline() returns a regular Mock, not supporting async context manager
```

**Evidence**:
```
assert False is True
assert 0 == 3
```

### 2.3 Auth Service Tests (12+ failures)

**Location**: `tests/unit/services/test_auth_service.py`, `test_auth_service_login_enhanced.py`, `test_auth_service_login_fixed.py`

**Failing Tests** (sample):
1. `test_register_user_success` - EmailAlreadyExistsException raised unexpectedly
2. `test_register_user_handles_race_condition` - rollback not called
3. `test_login_user_success` - `'coroutine' object has no attribute 'password_hash'`
4. `test_login_user_invalid_email` - coroutine not awaited
5. `test_login_user_wrong_password` - coroutine not awaited
6. Multiple `test_login_*` variants with same issue

**Root Cause**:
Mocking issues with async database operations:

```python
# Current (incorrect) - returns coroutine, not result
mock_result = AsyncMock()
mock_result.scalar_one_or_none.return_value = mock_user  # This is not awaited properly
mock_db.execute.return_value = mock_result

# When code does:
result = await self.db.execute(...)  # Returns AsyncMock, not mock_result
return result.scalar_one_or_none()   # Returns coroutine, not mock_user
```

**Evidence**:
```
AttributeError: 'coroutine' object has no attribute 'password_hash'
AttributeError: 'coroutine' object has no attribute 'email'
```

### 2.4 Base Class Fixture Tests (8 errors)

**Location**: `tests/unit/test_base_classes.py`

**Failing Tests**:
1. `TestAuthFixturesTokenCreation::test_test_user_tokens_fixture`
2. `TestAuthFixturesTokenCreation::test_access_token_is_valid`
3. `TestAuthFixturesTokenCreation::test_superuser_tokens_fixture`
4. `TestAuthFixturesHeaders::test_auth_headers_fixture`
5. `TestAuthFixturesHeaders::test_superuser_auth_headers_fixture`
6. `TestAuthFixturesBundles::test_authenticated_user_bundle`
7. `TestAuthFixturesBundles::test_authenticated_superuser_bundle`
8. `TestAuthenticatedHTTPRequests::test_authenticated_get_request`

**Root Cause**:
The `test_user_tokens` fixture in `tests/fixtures/auth.py` unpacks 2 values but `create_refresh_token` now returns 3.

**Evidence**:
```
ValueError: too many values to unpack (expected 2, got 3)
```

### 2.5 Integration Tests (8 failures)

**Location**: `tests/integration/api/test_auth.py`, `tests/integration/test_redis_sessions.py`

**Failing Tests**:
1. `test_register_endpoint_success` - `assert 1799 == 1800` (timing off by 1 second)
2. `test_register_duplicate_email` - `KeyError: 'detail'`
3. `test_register_no_digit_in_password` - `TypeError: Object of type ValueError is not JSON serializable`
4. `test_login_success` - `assert 1799 == 1800` (timing)
5. `test_login_invalid_email` - `KeyError: 'detail'`
6. `test_login_wrong_password` - `KeyError: 'detail'`
7. `test_login_falls_back_to_postgres_when_redis_unavailable` - `assert 0 >= 1`
8. `test_get_user_sessions_includes_both_sources` - `assert 1 == 2`

**Root Causes**:
1. **Timing assertions**: Tests use exact equality for `expires_in` which can be off by 1 second
2. **Error response format**: Tests expect `detail` key but response may use different format
3. **Redis fallback**: PostgreSQL fallback behavior changed or not working

### 2.6 Auth Service Logging Tests (5 failures)

**Location**: `tests/unit/services/test_auth_service_login_fixed.py`

**Failing Tests**:
1. `test_login_logs_success` - user_id not in log output
2. `test_login_logs_failure_user_not_found` - email not in log output
3. `test_login_logs_failure_wrong_password` - user_id not in log output
4. `test_login_logs_failure_inactive_account` - user_id not in log output
5. `test_login_success_with_tracking` - add() not called

**Root Cause**:
Log message format in `auth_service.py` doesn't include user_id/email in the message string, but tests assert it should be present.

**Evidence**:
```
AssertionError: assert 'be4c4117-1d51...' in 'INFO ... Successful login\n'
AssertionError: assert 'notfound@example.com' in 'WARNING ... Failed login attempt\n'
```

---

## 3. Root Cause Categories

### 3.1 API Signature Changes

| Function | Old Signature | New Signature |
|----------|---------------|---------------|
| `create_refresh_token` | `(UUID) -> tuple[str, datetime]` | `(UUID, str\|None) -> tuple[str, datetime, str]` |

### 3.2 Async Mocking Patterns

**Pattern 1: Awaitable Mock Return**

```python
# WRONG
mock_result.scalar_one_or_none.return_value = value

# CORRECT
mock_result.scalar_one_or_none = MagicMock(return_value=value)
# OR for truly async
mock_db.execute = AsyncMock(return_value=mock_result)
mock_result.scalar_one_or_none = MagicMock(return_value=value)
```

**Pattern 2: Async Context Manager**

```python
# WRONG
mock_redis.pipeline.return_value.__aenter__.return_value = mock_pipeline

# CORRECT
mock_pipeline = AsyncMock()
mock_ctx = AsyncMock()
mock_ctx.__aenter__ = AsyncMock(return_value=mock_pipeline)
mock_ctx.__aexit__ = AsyncMock(return_value=None)
mock_redis.pipeline = MagicMock(return_value=mock_ctx)
```

### 3.3 Logging Assertions

Current auth_service.py log format:
```python
logger.info("Successful login", extra={"user_id": str(user.id)})
logger.warning("Failed login attempt - user not found", extra={"email": email})
```

Tests expect user_id/email in the message string, but they're in `extra` which may not appear in caplog.text.

---

## 4. Implementation Plan

### 4.1 Phase 1: Fix JWT Token Tests

**Files to Modify**: `tests/unit/test_jwt_tokens.py`

**Changes Required**:
1. Update `sample_refresh_token` fixture to expect 3-tuple
2. Update all tests unpacking refresh token to handle 3 values
3. Update assertions about tuple length

**Example Fix**:
```python
# Before
token, expires_at = create_refresh_token(sample_user_id)

# After
token, expires_at, jti = create_refresh_token(sample_user_id)
```

### 4.2 Phase 2: Fix Session Repository Tests

**Files to Modify**: `tests/unit/repositories/test_session_repository.py`

**Changes Required**:
1. Fix async context manager mocking for pipeline
2. Ensure pipeline mock methods are properly configured
3. Use `AsyncMock` for `__aenter__`/`__aexit__`

**Example Fix**:
```python
# Before
mock_pipeline = AsyncMock()
mock_redis.pipeline.return_value.__aenter__.return_value = mock_pipeline

# After
mock_pipeline = AsyncMock()
mock_pipeline.setex = AsyncMock()
mock_pipeline.sadd = AsyncMock()
mock_pipeline.expire = AsyncMock()
mock_pipeline.execute = AsyncMock()

mock_ctx = MagicMock()
mock_ctx.__aenter__ = AsyncMock(return_value=mock_pipeline)
mock_ctx.__aexit__ = AsyncMock(return_value=None)
mock_redis.pipeline = MagicMock(return_value=mock_ctx)
```

### 4.3 Phase 3: Fix Auth Service Tests

**Files to Modify**:
- `tests/unit/services/test_auth_service.py`
- `tests/unit/services/test_auth_service_login_enhanced.py`
- `tests/unit/services/test_auth_service_login_fixed.py`

**Changes Required**:
1. Fix async database mock pattern
2. Ensure `scalar_one_or_none` returns value, not coroutine
3. Update register test to properly mock user check

**Example Fix**:
```python
# Before - returns coroutine
mock_result = AsyncMock()
mock_result.scalar_one_or_none.return_value = mock_user
mock_db.execute.return_value = mock_result

# After - returns value
mock_result = MagicMock()
mock_result.scalar_one_or_none = MagicMock(return_value=mock_user)
mock_db.execute = AsyncMock(return_value=mock_result)
```

### 4.4 Phase 4: Fix Logging Assertions

**Files to Modify**: `tests/unit/services/test_auth_service_login_fixed.py`

**Options**:
1. **Option A**: Update tests to check `caplog.records` for extra data
2. **Option B**: Update auth_service.py to include user_id/email in message string

**Recommended**: Option A (don't change production code for tests)

**Example Fix**:
```python
# Before
assert str(user.id) in caplog.text

# After
log_record = next(r for r in caplog.records if r.message == "Successful login")
assert str(user.id) == log_record.__dict__["user_id"]
```

---

## 5. File Changes Required

### 5.1 Test Files to Modify

| File | Changes |
|------|---------|
| `tests/unit/test_jwt_tokens.py` | Update 8 tests for 3-tuple return |
| `tests/unit/repositories/test_session_repository.py` | Fix 4 tests for async context manager |
| `tests/unit/services/test_auth_service.py` | Fix 9+ tests for async mocking |
| `tests/unit/services/test_auth_service_login_enhanced.py` | Fix 10 tests for async mocking |
| `tests/unit/services/test_auth_service_login_fixed.py` | Fix 8 tests for async mocking + logging |

### 5.2 No Production Code Changes

All fixes should be in test files only. Production code should not be modified to fix tests.

---

## 6. Verification Checklist

### 6.1 Pre-Implementation

- [ ] PostgreSQL dev container running (`docker-compose -f docker-compose.dev.yml up -d postgres`)
- [ ] Redis dev container running (`docker-compose -f docker-compose.dev.yml up -d redis`)
- [ ] Current test count documented (33 failures, 164 errors)

### 6.2 Post-Implementation

- [ ] All JWT token tests pass (8 tests)
- [ ] All session repository tests pass (4 tests)
- [ ] All auth service tests pass (21+ tests)
- [ ] No new test failures introduced
- [ ] Test coverage maintains or improves

### 6.3 Final Verification

```bash
# Run all tests
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && \
/Users/samosipov/.local/bin/poetry run pytest -v --tb=short

# Expected result: 0 failed, 0 errors (with database running)
```

---

## 7. Acceptance Criteria

### 7.1 Must Have

- [ ] All 33 failing tests are fixed and pass
- [ ] No new test failures introduced
- [ ] All fixes are in test files only (no production code changes)
- [ ] Tests pass both with and without database (unit tests don't require DB)

### 7.2 Should Have

- [ ] Test coverage maintained at current level or improved
- [ ] Code follows existing test patterns and conventions
- [ ] All changes documented in PR description

### 7.3 Nice to Have

- [ ] Add helper functions for common async mocking patterns
- [ ] Document async mocking patterns in TESTING.md
- [ ] Add test matrix for different mock configurations

---

## 8. Implementation Order

1. **Auth Fixtures** (`tests/fixtures/auth.py`) - Fix 3-tuple unpacking (unblocks 8 tests)
2. **JWT Token Tests** (`tests/unit/test_jwt_tokens.py`) - Fix 3-tuple unpacking (7 tests)
3. **Session Repository Tests** - Fix async context manager mocking (4 tests)
4. **Auth Service Tests** - Fix async database mock pattern (~15 tests)
5. **Logging Assertions** - Fix caplog assertions (5 tests)
6. **Integration Tests** - Fix timing and response format (8 tests)
7. **Verification** - Run full test suite

---

## 9. Related Documents

- [04-backend-testing-framework-plan.md](04-backend-testing-framework-plan.md)
- [04.03-base-test-classes-plan.md](04.03-base-test-classes-plan.md)
- [04.08-test-utilities-helpers-plan.md](04.08-test-utilities-helpers-plan.md)
- [TESTING.md](../../../learn-greek-easy-backend/TESTING.md)

---

**Last Updated**: 2025-12-04
**Document Status**: Ready for Implementation
