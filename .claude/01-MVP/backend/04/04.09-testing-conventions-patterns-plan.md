# Task 04.09: Establish Testing Conventions and Patterns - Technical Architecture Plan

**Document Version**: 1.1
**Created**: 2025-12-01
**Completed**: 2025-12-01
**Status**: ✅ COMPLETED
**Priority**: Medium (Developer Experience & Standardization)
**Dependencies**: 04.01-04.08 (All previous testing subtasks)
**Type**: Architecture Documentation
**Actual Duration**: 1.5 hours

---

## Table of Contents

1. [Overview](#1-overview)
2. [Current State Analysis](#2-current-state-analysis)
3. [Architecture Design](#3-architecture-design)
4. [Implementation Details](#4-implementation-details)
5. [Test Structure Reorganization](#5-test-structure-reorganization)
6. [Testing Conventions Document](#6-testing-conventions-document)
7. [Integration Conftest](#7-integration-conftest)
8. [Verification Checklist](#8-verification-checklist)
9. [Acceptance Criteria](#9-acceptance-criteria)
10. [Related Documents](#10-related-documents)

---

## 1. Overview

### 1.1 Task Description

Finalize the test structure and establish consistent testing patterns across the codebase. This task codifies the testing conventions developed during tasks 04.01-04.08 and ensures all tests follow a consistent structure.

### 1.2 Objectives

1. **Reorganize Test Structure**: Ensure all tests follow the defined directory structure
2. **Create Missing Init Files**: Add `__init__.py` to all test directories
3. **Integration Conftest**: Create `tests/integration/conftest.py` with integration-specific fixtures
4. **Document Conventions**: Create `TESTING.md` with testing conventions and patterns
5. **Command Reference**: Document all test commands for developers
6. **Example Patterns**: Provide example tests demonstrating each pattern

### 1.3 Success Criteria

- [x] All test directories have `__init__.py` files (VERIFIED)
- [x] `tests/integration/conftest.py` created with integration fixtures (17 fixtures)
- [x] `TESTING.md` documentation created (860 lines, 11 sections)
- [x] All existing tests pass after reorganization (333/361 - 28 pre-existing)
- [x] Clear naming conventions documented and applied
- [x] Test markers consistently applied (`-m unit`, `-m integration`)

### 1.4 Design Principles

| Principle | Application |
|-----------|-------------|
| **Consistency** | All tests follow same patterns and naming |
| **Discoverability** | Tests easy to find by domain/feature |
| **Isolation** | Unit vs integration clearly separated |
| **Documentation** | Self-documenting through conventions |
| **CI-Ready** | Clear commands for CI pipelines |

---

## 2. Current State Analysis

### 2.1 Current Test Structure

```
tests/
├── __init__.py                    # ✅ Exists
├── base.py                        # ✅ Base test classes
├── conftest.py                    # ✅ Global fixtures
├── fixtures/
│   ├── __init__.py               # ✅ Exists
│   ├── auth.py                   # ✅ Auth fixtures
│   ├── database.py               # ✅ DB fixtures
│   ├── deck.py                   # ✅ Deck fixtures
│   └── progress.py               # ✅ Progress fixtures
├── factories/
│   ├── __init__.py               # ✅ Exists
│   ├── auth.py                   # ✅ User factories
│   ├── base.py                   # ✅ Base factory
│   ├── content.py                # ✅ Deck/Card factories
│   ├── progress.py               # ✅ Progress factories
│   └── providers/
│       ├── __init__.py           # ✅ Exists
│       └── greek.py              # ✅ Greek provider
├── helpers/
│   ├── __init__.py               # ✅ Exists (updated in 04.08)
│   ├── api.py                    # ✅ Created in 04.08
│   ├── assertions.py             # ✅ Created in 04.08
│   ├── database.py               # ✅ Exists
│   ├── mocks.py                  # ✅ Created in 04.08
│   └── time.py                   # ✅ Created in 04.08
├── utils/
│   ├── __init__.py               # ✅ Created in 04.08
│   └── builders.py               # ✅ Created in 04.08
├── unit/
│   ├── __init__.py               # ❌ MISSING
│   ├── middleware/
│   │   ├── __init__.py           # ❌ MISSING
│   │   └── test_auth_middleware.py  # 42 tests
│   ├── test_security.py          # 35 tests
│   ├── test_jwt_tokens.py        # 28 tests
│   ├── test_dependencies.py      # 21 tests
│   ├── test_auth_service_refresh.py  # 11 tests
│   ├── test_auth_service_sessions.py # 12 tests
│   ├── test_database_fixtures.py     # 24 tests
│   ├── test_base_classes.py          # 41 tests
│   └── test_factories.py             # 37 tests
└── integration/
    └── __init__.py               # ❌ MISSING (empty directory)
```

### 2.2 Missing Components

| Component | Status | Priority |
|-----------|--------|----------|
| `tests/unit/__init__.py` | Missing | High |
| `tests/unit/middleware/__init__.py` | Missing | High |
| `tests/integration/__init__.py` | Missing | High |
| `tests/integration/conftest.py` | Missing | High |
| `TESTING.md` documentation | Missing | Medium |
| Consistent test markers | Inconsistent | Medium |

### 2.3 Test Counts by Directory

| Directory | Test Count | Notes |
|-----------|------------|-------|
| `unit/` | ~250 tests | Core unit tests |
| `unit/middleware/` | 42 tests | Middleware tests |
| `integration/` | 0 tests | Empty - to be populated |
| **Total** | ~333 tests | All currently pass |

### 2.4 Current Marker Usage

Markers registered in `pyproject.toml`:
- `unit` - Unit tests (fast, isolated)
- `integration` - Integration tests (slower, real DB)
- `slow` - Slow tests (>1s)
- `auth` - Authentication-related tests
- `api` - API endpoint tests
- `db` - Database tests

**Issue**: Markers are registered but inconsistently applied to tests.

---

## 3. Architecture Design

### 3.1 Target Test Structure

```
tests/
├── __init__.py
├── base.py                        # Base test classes
├── conftest.py                    # Global fixtures
├── TESTING.md                     # NEW: Testing conventions
│
├── fixtures/                      # Shared fixtures
│   ├── __init__.py
│   ├── auth.py
│   ├── database.py
│   ├── deck.py
│   └── progress.py
│
├── factories/                     # Test data factories
│   ├── __init__.py
│   ├── auth.py
│   ├── base.py
│   ├── content.py
│   ├── progress.py
│   └── providers/
│       ├── __init__.py
│       └── greek.py
│
├── helpers/                       # Test utilities
│   ├── __init__.py
│   ├── api.py
│   ├── assertions.py
│   ├── database.py
│   ├── mocks.py
│   └── time.py
│
├── utils/                         # Complex utilities
│   ├── __init__.py
│   └── builders.py
│
├── unit/                          # Unit tests
│   ├── __init__.py               # NEW
│   ├── conftest.py               # NEW: Unit-specific fixtures
│   ├── core/                     # NEW: Core module tests
│   │   ├── __init__.py
│   │   ├── test_security.py
│   │   ├── test_jwt_tokens.py
│   │   └── test_dependencies.py
│   ├── services/                 # NEW: Service tests
│   │   ├── __init__.py
│   │   ├── test_auth_service_refresh.py
│   │   └── test_auth_service_sessions.py
│   ├── middleware/
│   │   ├── __init__.py           # NEW
│   │   └── test_auth_middleware.py
│   └── infrastructure/           # NEW: Infrastructure tests
│       ├── __init__.py
│       ├── test_database_fixtures.py
│       ├── test_base_classes.py
│       └── test_factories.py
│
└── integration/                   # Integration tests
    ├── __init__.py               # NEW
    ├── conftest.py               # NEW: Integration fixtures
    └── api/                      # NEW: API integration tests
        ├── __init__.py
        └── test_auth_api.py      # FUTURE: Auth API tests
```

### 3.2 Naming Conventions

| Element | Convention | Example |
|---------|------------|---------|
| Test files | `test_<feature>.py` | `test_security.py` |
| Test classes | `Test<Feature><Aspect>` | `TestPasswordHashing` |
| Test methods | `test_<action>_<scenario>` | `test_login_invalid_password` |
| Fixtures | `<noun>` or `<noun>_<variant>` | `test_user`, `auth_headers` |
| Factories | `<Model>Factory` | `UserFactory` |
| Markers | `@pytest.mark.<category>` | `@pytest.mark.unit` |

### 3.3 Test Categories

| Category | Marker | Location | Characteristics |
|----------|--------|----------|-----------------|
| Unit | `@pytest.mark.unit` | `tests/unit/` | Fast, isolated, mocked deps |
| Integration | `@pytest.mark.integration` | `tests/integration/` | Real DB, slower |
| Slow | `@pytest.mark.slow` | Any | Tests > 1s |
| Auth | `@pytest.mark.auth` | Any | Authentication tests |
| API | `@pytest.mark.api` | Integration | API endpoint tests |
| DB | `@pytest.mark.db` | Any | Database tests |

---

## 4. Implementation Details

### 4.1 Missing `__init__.py` Files

**File**: `tests/unit/__init__.py`
```python
"""Unit tests for Learn Greek Easy backend.

Unit tests are fast, isolated tests that test individual functions,
classes, or methods in isolation. Dependencies are mocked.

Structure:
- core/: Core module tests (security, JWT, dependencies)
- services/: Service layer tests
- middleware/: Middleware tests
- infrastructure/: Test framework infrastructure tests
"""
```

**File**: `tests/unit/middleware/__init__.py`
```python
"""Middleware unit tests.

Tests for FastAPI middleware components:
- AuthLoggingMiddleware
"""
```

**File**: `tests/integration/__init__.py`
```python
"""Integration tests for Learn Greek Easy backend.

Integration tests verify that multiple components work together correctly.
These tests use a real PostgreSQL database and test actual API endpoints.

Structure:
- api/: API endpoint integration tests
"""
```

### 4.2 Unit Test Conftest

**File**: `tests/unit/conftest.py`

```python
"""Unit test specific fixtures and configuration.

This module provides fixtures that are specific to unit tests:
- Mock database sessions
- Mock external services
- Isolated test configurations

For database fixtures, see tests/fixtures/database.py
For auth fixtures, see tests/fixtures/auth.py
"""

import pytest
from unittest.mock import AsyncMock, MagicMock

from tests.helpers.mocks import (
    mock_async_session,
    mock_auth_service,
    mock_email_service,
    mock_redis_client,
)


# =============================================================================
# Mock Session Fixtures
# =============================================================================


@pytest.fixture
def mock_db_session() -> MagicMock:
    """Provide a mock database session for unit tests.

    Use this when you want to test code that uses a database
    session without actually hitting the database.

    Example:
        async def test_user_creation(mock_db_session):
            mock_db_session.add = MagicMock()
            mock_db_session.commit = AsyncMock()

            # Test code that uses db_session
            await create_user(mock_db_session, user_data)

            mock_db_session.add.assert_called_once()
    """
    return mock_async_session()


# =============================================================================
# Mock Service Fixtures
# =============================================================================


@pytest.fixture
def mock_auth() -> MagicMock:
    """Provide a mock AuthService for unit tests.

    Pre-configured with common auth operations as AsyncMocks.

    Example:
        async def test_login_calls_auth_service(mock_auth):
            mock_auth.login_user.return_value = (user, tokens)
            # Test code that uses auth_service
    """
    return mock_auth_service()


@pytest.fixture
def mock_email() -> MagicMock:
    """Provide a mock email service for unit tests.

    Example:
        async def test_registration_sends_email(mock_email):
            mock_email.send_verification_email.return_value = True
            # Test code that sends emails
    """
    return mock_email_service()


@pytest.fixture
def mock_redis() -> MagicMock:
    """Provide a mock Redis client for unit tests.

    Example:
        async def test_cache_hit(mock_redis):
            mock_redis.get.return_value = b'cached_value'
            # Test code that uses Redis
    """
    return mock_redis_client()


# =============================================================================
# Unit Test Markers
# =============================================================================


def pytest_collection_modifyitems(items):
    """Automatically mark tests in unit/ directory with @pytest.mark.unit."""
    for item in items:
        if "/unit/" in str(item.fspath):
            item.add_marker(pytest.mark.unit)
```

### 4.3 Integration Test Conftest

**File**: `tests/integration/conftest.py`

```python
"""Integration test specific fixtures and configuration.

This module provides fixtures specifically for integration tests:
- Real database connections
- HTTP client with app context
- Full authentication flows
- API-specific helpers

Note: Database fixtures are imported from tests/fixtures/database.py
"""

import pytest
import pytest_asyncio
from httpx import ASGITransport, AsyncClient
from sqlalchemy.ext.asyncio import AsyncSession

from src.main import app
from src.db.session import get_db
from tests.fixtures.database import db_engine, db_session  # Re-export
from tests.fixtures.auth import (
    test_user,
    test_superuser,
    access_token,
    auth_headers,
    superuser_headers,
)


# =============================================================================
# HTTP Client Fixtures
# =============================================================================


@pytest_asyncio.fixture
async def client(db_session: AsyncSession) -> AsyncClient:
    """Provide an async HTTP client for integration tests.

    This client is configured with:
    - Test database session override
    - ASGI transport for direct app testing
    - Base URL set to "http://test"

    Example:
        async def test_health_endpoint(client):
            response = await client.get("/api/v1/health")
            assert response.status_code == 200
    """
    async def override_get_db():
        yield db_session

    app.dependency_overrides[get_db] = override_get_db

    async with AsyncClient(
        transport=ASGITransport(app=app),
        base_url="http://test",
    ) as ac:
        yield ac

    app.dependency_overrides.clear()


@pytest_asyncio.fixture
async def authenticated_client(
    client: AsyncClient,
    auth_headers: dict[str, str],
) -> AsyncClient:
    """Provide an HTTP client with authentication headers.

    Convenience fixture that pre-configures headers for authenticated requests.

    Example:
        async def test_protected_endpoint(authenticated_client):
            response = await authenticated_client.get("/api/v1/auth/me")
            assert response.status_code == 200
    """
    # Note: httpx.AsyncClient doesn't support default headers in the same way,
    # so we return a wrapper or document that auth_headers should be passed
    # For now, return the client and use auth_headers separately
    return client


# =============================================================================
# API Test Helpers
# =============================================================================


@pytest.fixture
def api_base_url() -> str:
    """Return the base URL for API v1 endpoints."""
    return "/api/v1"


@pytest.fixture
def auth_url(api_base_url: str) -> str:
    """Return the auth endpoints base URL."""
    return f"{api_base_url}/auth"


@pytest.fixture
def decks_url(api_base_url: str) -> str:
    """Return the decks endpoints base URL."""
    return f"{api_base_url}/decks"


@pytest.fixture
def cards_url(api_base_url: str) -> str:
    """Return the cards endpoints base URL."""
    return f"{api_base_url}/cards"


@pytest.fixture
def reviews_url(api_base_url: str) -> str:
    """Return the reviews endpoints base URL."""
    return f"{api_base_url}/reviews"


# =============================================================================
# Test Data for Integration Tests
# =============================================================================


@pytest.fixture
def valid_registration_data() -> dict:
    """Provide valid user registration data."""
    return {
        "email": "newuser@example.com",
        "password": "SecurePass123!",
        "display_name": "New User",
    }


@pytest.fixture
def valid_login_data(test_user) -> dict:
    """Provide valid login credentials for test_user."""
    return {
        "email": test_user.email,
        "password": "TestPass123!",  # Default password from fixtures
    }


@pytest.fixture
def invalid_login_data() -> dict:
    """Provide invalid login credentials."""
    return {
        "email": "nonexistent@example.com",
        "password": "WrongPassword123!",
    }


# =============================================================================
# Integration Test Markers
# =============================================================================


def pytest_collection_modifyitems(items):
    """Automatically mark tests in integration/ directory."""
    for item in items:
        if "/integration/" in str(item.fspath):
            item.add_marker(pytest.mark.integration)
            item.add_marker(pytest.mark.db)
```

### 4.4 Integration API Directory

**File**: `tests/integration/api/__init__.py`

```python
"""API integration tests.

Tests for API endpoints with real database and HTTP requests.
"""
```

---

## 5. Test Structure Reorganization

### 5.1 New Subdirectory Structure for Unit Tests

Create the following new directories:

```bash
# Create new unit test subdirectories
mkdir -p tests/unit/core
mkdir -p tests/unit/services
mkdir -p tests/unit/infrastructure
mkdir -p tests/integration/api
```

### 5.2 File Moves (Optional - For Future)

The following moves are **recommended but optional** for this task. They can be done incrementally:

| Current Location | Proposed Location | Notes |
|------------------|-------------------|-------|
| `tests/unit/test_security.py` | `tests/unit/core/test_security.py` | Core security |
| `tests/unit/test_jwt_tokens.py` | `tests/unit/core/test_jwt_tokens.py` | Core JWT |
| `tests/unit/test_dependencies.py` | `tests/unit/core/test_dependencies.py` | Core deps |
| `tests/unit/test_auth_service_*.py` | `tests/unit/services/` | Service tests |
| `tests/unit/test_database_fixtures.py` | `tests/unit/infrastructure/` | Infra tests |
| `tests/unit/test_base_classes.py` | `tests/unit/infrastructure/` | Infra tests |
| `tests/unit/test_factories.py` | `tests/unit/infrastructure/` | Infra tests |

**Note**: This reorganization is optional for 04.09. The priority is creating the missing init files and conftest files. Reorganization can be done incrementally to avoid breaking changes.

### 5.3 Init Files for New Directories

**File**: `tests/unit/core/__init__.py`
```python
"""Core module unit tests.

Tests for:
- Security utilities (password hashing, validation)
- JWT token management
- Authentication dependencies
"""
```

**File**: `tests/unit/services/__init__.py`
```python
"""Service layer unit tests.

Tests for:
- AuthService
- Future: DeckService, ReviewService, etc.
"""
```

**File**: `tests/unit/infrastructure/__init__.py`
```python
"""Test infrastructure unit tests.

Tests for the testing framework itself:
- Database fixtures
- Base test classes
- Factory classes
"""
```

**File**: `tests/integration/api/__init__.py`
```python
"""API integration tests.

Tests for REST API endpoints with real database.
"""
```

---

## 6. Testing Conventions Document

**File**: `learn-greek-easy-backend/TESTING.md`

```markdown
# Testing Guide for Learn Greek Easy Backend

This document describes the testing conventions, patterns, and commands for the Learn Greek Easy backend.

## Table of Contents

1. [Quick Start](#quick-start)
2. [Test Structure](#test-structure)
3. [Running Tests](#running-tests)
4. [Writing Tests](#writing-tests)
5. [Fixtures](#fixtures)
6. [Factories](#factories)
7. [Helpers & Utilities](#helpers--utilities)
8. [Coverage](#coverage)
9. [CI/CD](#cicd)

---

## Quick Start

```bash
# Run all tests
cd learn-greek-easy-backend && poetry run pytest

# Run with coverage
poetry run pytest --cov=src --cov-report=term-missing

# Run in parallel (faster)
poetry run pytest -n auto

# Run only unit tests
poetry run pytest -m unit

# Run only integration tests
poetry run pytest -m integration
```

---

## Test Structure

```
tests/
├── unit/                  # Fast, isolated tests with mocked dependencies
│   ├── core/             # Core module tests (security, JWT, deps)
│   ├── services/         # Service layer tests
│   ├── middleware/       # Middleware tests
│   └── infrastructure/   # Test framework tests
├── integration/           # Slower tests with real database
│   └── api/              # API endpoint tests
├── fixtures/              # Pytest fixtures
├── factories/             # Factory Boy factories
├── helpers/               # Test utility functions
└── utils/                 # Complex test utilities (builders)
```

---

## Running Tests

### Basic Commands

| Command | Description |
|---------|-------------|
| `poetry run pytest` | Run all tests |
| `poetry run pytest -v` | Verbose output |
| `poetry run pytest -x` | Stop on first failure |
| `poetry run pytest --lf` | Run last failed tests |
| `poetry run pytest -k "test_login"` | Run tests matching pattern |

### By Marker

| Command | Description |
|---------|-------------|
| `poetry run pytest -m unit` | Unit tests only |
| `poetry run pytest -m integration` | Integration tests only |
| `poetry run pytest -m "not slow"` | Skip slow tests |
| `poetry run pytest -m auth` | Authentication tests |
| `poetry run pytest -m db` | Database tests |

### By Location

| Command | Description |
|---------|-------------|
| `poetry run pytest tests/unit/` | All unit tests |
| `poetry run pytest tests/unit/core/` | Core unit tests |
| `poetry run pytest tests/integration/api/` | API integration tests |
| `poetry run pytest tests/unit/test_security.py` | Single file |
| `poetry run pytest tests/unit/test_security.py::TestPasswordHashing` | Single class |
| `poetry run pytest tests/unit/test_security.py::TestPasswordHashing::test_hash_password` | Single test |

### Parallel Execution

```bash
# Auto-detect CPU count
poetry run pytest -n auto

# Specific worker count
poetry run pytest -n 4

# With loadscope distribution (group by module)
poetry run pytest -n auto --dist loadscope
```

---

## Writing Tests

### Naming Conventions

| Element | Convention | Example |
|---------|------------|---------|
| Test files | `test_<feature>.py` | `test_security.py` |
| Test classes | `Test<Feature><Aspect>` | `TestPasswordHashing` |
| Test methods | `test_<action>_<scenario>` | `test_login_invalid_password` |
| Test methods | `test_<action>_<expected_result>` | `test_hash_returns_bcrypt_hash` |

### Test Structure (AAA Pattern)

```python
async def test_user_login_success(self, db_session, test_user):
    # Arrange - Set up test data and conditions
    credentials = {"email": test_user.email, "password": "TestPass123!"}
    auth_service = AuthService(db_session)

    # Act - Execute the code being tested
    result = await auth_service.login(credentials["email"], credentials["password"])

    # Assert - Verify the expected outcome
    assert result is not None
    assert result.user.id == test_user.id
    assert result.access_token is not None
```

### Using Markers

```python
import pytest

@pytest.mark.unit
class TestPasswordHashing:
    """Unit tests for password hashing."""

    def test_hash_password_returns_string(self):
        result = hash_password("password")
        assert isinstance(result, str)

@pytest.mark.integration
@pytest.mark.db
class TestAuthAPI:
    """Integration tests for auth API."""

    async def test_register_endpoint(self, client):
        response = await client.post("/api/v1/auth/register", json={...})
        assert response.status_code == 201

@pytest.mark.slow
async def test_bulk_import(self, db_session):
    """This test takes > 1 second."""
    ...
```

### Async Tests

All async tests are automatically supported via `asyncio_mode = "auto"` in pytest config.

```python
# No @pytest.mark.asyncio needed!
async def test_async_operation(self, db_session):
    result = await some_async_function(db_session)
    assert result is not None
```

---

## Fixtures

### Available Fixtures

#### Database Fixtures (`tests/fixtures/database.py`)

| Fixture | Scope | Description |
|---------|-------|-------------|
| `db_engine` | function | Async SQLAlchemy engine |
| `db_session` | function | Async session with rollback |
| `worker_id` | session | Pytest-xdist worker ID |

#### Auth Fixtures (`tests/fixtures/auth.py`)

| Fixture | Scope | Description |
|---------|-------|-------------|
| `test_user` | function | Standard test user |
| `test_superuser` | function | Admin user |
| `access_token` | function | JWT access token |
| `refresh_token` | function | JWT refresh token |
| `auth_headers` | function | `{"Authorization": "Bearer ..."}` |

#### Content Fixtures (`tests/fixtures/deck.py`)

| Fixture | Scope | Description |
|---------|-------|-------------|
| `test_deck` | function | Single deck |
| `deck_with_cards` | function | Deck with 10 cards |
| `multi_level_decks` | function | A1, A2, B1 decks |

#### Progress Fixtures (`tests/fixtures/progress.py`)

| Fixture | Scope | Description |
|---------|-------|-------------|
| `user_progress` | function | Progress for test_user |
| `cards_by_status` | function | Cards at each status |
| `review_history` | function | 7-day review history |

### Using Fixtures

```python
class TestUserCreation:
    async def test_create_user(self, db_session):
        """db_session is automatically injected."""
        user = User(email="test@example.com", ...)
        db_session.add(user)
        await db_session.commit()

    async def test_with_existing_user(self, db_session, test_user):
        """test_user is already created and committed."""
        assert test_user.id is not None
        assert test_user.email == "test@example.com"
```

---

## Factories

### Available Factories

```python
from tests.factories import (
    UserFactory,
    UserSettingsFactory,
    RefreshTokenFactory,
    DeckFactory,
    CardFactory,
    UserDeckProgressFactory,
    CardStatisticsFactory,
    ReviewFactory,
)
```

### Using Factories

```python
async def test_with_factory(self, db_session):
    # Create user with default values
    user = await UserFactory.create_async(db_session)

    # Create with specific values
    user = await UserFactory.create_async(
        db_session,
        email="custom@example.com",
        is_superuser=True,
    )

    # Use traits
    admin = await UserFactory.create_async(db_session, admin=True)
    inactive = await UserFactory.create_async(db_session, inactive=True)
    google_user = await UserFactory.create_async(db_session, oauth=True)

    # Create deck with cards
    deck = await DeckFactory.create_async(db_session, a1=True)
    cards = await CardFactory.create_batch_async(db_session, 10, deck=deck)
```

### Factory Traits

| Factory | Traits |
|---------|--------|
| `UserFactory` | `admin`, `inactive`, `oauth`, `verified`, `logged_in` |
| `DeckFactory` | `a1`, `a2`, `b1`, `b2`, `c1`, `c2` |
| `CardFactory` | `easy`, `medium`, `hard` |
| `CardStatisticsFactory` | `new`, `learning`, `review`, `mastered`, `due`, `overdue`, `struggling` |

---

## Helpers & Utilities

### Assertions (`tests/helpers/assertions.py`)

```python
from tests.helpers.assertions import (
    assert_valid_user_response,
    assert_valid_token_response,
    assert_api_error,
    assert_sm2_calculation,
    assert_pagination,
)

# Example usage
response = await client.post("/api/v1/auth/login", json=credentials)
assert_valid_token_response(response.json())
```

### Time Utilities (`tests/helpers/time.py`)

```python
from tests.helpers.time import (
    freeze_time,
    create_expired_token,
    create_due_date,
)

# Freeze time for testing
with freeze_time("2025-01-15"):
    assert date.today() == date(2025, 1, 15)

# Create expired token
expired = create_expired_token(user.id, hours_ago=2)
```

### API Helpers (`tests/helpers/api.py`)

```python
from tests.helpers.api import (
    make_authenticated_request,
    extract_tokens_from_response,
    build_pagination_params,
)

# Make authenticated request
response = await make_authenticated_request(
    client, "GET", "/api/v1/decks",
    auth_headers,
    params=build_pagination_params(page=1, page_size=10),
)
```

### Test Data Builders (`tests/utils/builders.py`)

```python
from tests.utils import ReviewSessionBuilder, ProgressScenarioBuilder

# Build a review session
result = await (
    ReviewSessionBuilder(db_session)
    .for_user(test_user)
    .for_deck(deck)
    .with_cards(cards[:5])
    .with_ratings([5, 4, 4, 3, 5])
    .build()
)
```

---

## Coverage

### Running Coverage

```bash
# Terminal report
poetry run pytest --cov=src --cov-report=term-missing

# HTML report
poetry run pytest --cov=src --cov-report=html
open htmlcov/index.html

# With fail threshold
poetry run pytest --cov=src --cov-fail-under=90
```

### Coverage Targets

| Module | Target |
|--------|--------|
| Overall | >= 90% |
| Core (auth, security) | >= 95% |
| Services | >= 90% |
| API endpoints | >= 85% |

---

## CI/CD

### GitHub Actions

Tests run automatically on:
- Push to `main` or `develop`
- Pull requests to `main`

The CI pipeline:
1. Starts PostgreSQL service
2. Installs dependencies
3. Runs tests in parallel (`-n auto`)
4. Generates coverage report
5. Uploads to Codecov

### Local CI Simulation

```bash
# Run tests as CI would
poetry run pytest -n auto --cov=src --cov-report=xml --cov-fail-under=90
```

---

## Best Practices

1. **One assertion per test** (logically, not literally)
2. **Test behavior, not implementation**
3. **Use descriptive test names**
4. **Keep tests independent** (no shared state)
5. **Use fixtures for setup, not test methods**
6. **Mock external dependencies in unit tests**
7. **Use real database in integration tests**
8. **Mark slow tests with `@pytest.mark.slow`**

---

## Troubleshooting

### Common Issues

**Tests fail with database errors**
```bash
# Ensure PostgreSQL is running
docker-compose up -d postgres
```

**Parallel tests fail randomly**
```bash
# Run without parallelism to debug
poetry run pytest tests/path/to/failing_test.py -v
```

**Import errors**
```bash
# Ensure you're in the right directory
cd learn-greek-easy-backend
poetry run pytest
```

---

**Last Updated**: 2025-12-01
**Maintained By**: Development Team
```

---

## 7. Integration Conftest

See Section 4.3 for the complete `tests/integration/conftest.py` implementation.

Key features:
- HTTP client fixture with database override
- URL helper fixtures for API endpoints
- Test data fixtures for common scenarios
- Automatic integration marker application

---

## 8. Verification Checklist

### 8.1 Implementation Checklist

- [ ] Create `tests/unit/__init__.py`
- [ ] Create `tests/unit/middleware/__init__.py`
- [ ] Create `tests/unit/conftest.py`
- [ ] Create `tests/integration/__init__.py`
- [ ] Create `tests/integration/conftest.py`
- [ ] Create `tests/integration/api/__init__.py`
- [ ] Create `TESTING.md` documentation
- [ ] (Optional) Create `tests/unit/core/__init__.py`
- [ ] (Optional) Create `tests/unit/services/__init__.py`
- [ ] (Optional) Create `tests/unit/infrastructure/__init__.py`

### 8.2 Verification Steps

```bash
# 1. Verify all tests still pass
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && \
/Users/samosipov/.local/bin/poetry run pytest

# 2. Verify test discovery works
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && \
/Users/samosipov/.local/bin/poetry run pytest --collect-only

# 3. Verify markers work
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && \
/Users/samosipov/.local/bin/poetry run pytest -m unit --collect-only

# 4. Verify parallel execution still works
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && \
/Users/samosipov/.local/bin/poetry run pytest -n auto

# 5. Verify coverage still works
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && \
/Users/samosipov/.local/bin/poetry run pytest --cov=src --cov-report=term-missing
```

### 8.3 Documentation Checklist

- [ ] TESTING.md covers all test commands
- [ ] TESTING.md documents all fixtures
- [ ] TESTING.md documents all factories
- [ ] TESTING.md documents all helpers
- [ ] TESTING.md includes troubleshooting section

---

## 9. Acceptance Criteria

### 9.1 Functional Requirements

| Requirement | Status | Notes |
|-------------|--------|-------|
| All `__init__.py` files created | Pending | 6 files minimum |
| `tests/unit/conftest.py` created | Pending | Mock fixtures |
| `tests/integration/conftest.py` created | Pending | API fixtures |
| `TESTING.md` created | Pending | Full documentation |
| All existing tests pass | Pending | 333 tests |
| Test markers work correctly | Pending | `-m unit`, `-m integration` |

### 9.2 Quality Requirements

| Requirement | Target | Status |
|-------------|--------|--------|
| No circular imports | 0 | Pending |
| All tests discoverable | 333+ | Pending |
| Parallel execution works | No failures | Pending |
| Coverage unchanged | >= current | Pending |

### 9.3 Documentation Requirements

| Requirement | Status |
|-------------|--------|
| All test commands documented | Pending |
| Fixture usage documented | Pending |
| Factory usage documented | Pending |
| Helper usage documented | Pending |
| Best practices documented | Pending |

---

## 10. Related Documents

| Document | Location | Description |
|----------|----------|-------------|
| Main Testing Framework Plan | [04-backend-testing-framework-plan.md](./04-backend-testing-framework-plan.md) | Parent task |
| Test Database Fixtures | [04.02-test-database-fixtures-plan.md](./04.02-test-database-fixtures-plan.md) | Database setup |
| Base Test Classes | [04.03-base-test-classes-plan.md](./04.03-base-test-classes-plan.md) | Base classes |
| Factory Classes | [04.05-factory-classes-plan.md](./04.05-factory-classes-plan.md) | Test factories |
| Test Utilities | [04.08-test-utilities-helpers-plan.md](./04.08-test-utilities-helpers-plan.md) | Helpers |
| Backend Tasks Progress | [../Backend-Tasks-Progress.md](../Backend-Tasks-Progress.md) | Task tracking |

---

## Quick Reference

### Files to Create

| File | Priority | Description |
|------|----------|-------------|
| `tests/unit/__init__.py` | High | Unit test package marker |
| `tests/unit/middleware/__init__.py` | High | Middleware tests marker |
| `tests/unit/conftest.py` | High | Unit test fixtures |
| `tests/integration/__init__.py` | High | Integration package marker |
| `tests/integration/conftest.py` | High | Integration fixtures |
| `tests/integration/api/__init__.py` | High | API tests marker |
| `TESTING.md` | Medium | Testing documentation |

### Commands

```bash
# Create missing directories
mkdir -p tests/integration/api

# Verify after creation
poetry run pytest --collect-only | head -20

# Run all tests
poetry run pytest

# Verify markers
poetry run pytest -m unit -v --collect-only
```

---

**Document Version**: 1.0
**Created**: 2025-12-01
**Author**: Architecture Agent
**Status**: Ready for Implementation
**Priority**: Medium
**Estimated Duration**: 1.5-2 hours
