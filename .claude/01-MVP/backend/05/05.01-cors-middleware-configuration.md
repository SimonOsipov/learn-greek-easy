# Task 05.01: CORS Middleware Configuration - Technical Design Document

## Overview

**Feature**: CORS Middleware Configuration Enhancement
**Parent Task**: 05 - API Foundation & Middleware
**Architecture Pattern**: FastAPI CORSMiddleware with Pydantic Settings
**Estimated Duration**: 30-45 minutes
**Dependencies**: None (isolated configuration change)
**Priority**: High (blocks frontend access to custom headers)

### Objectives

1. Expose custom response headers to browser JavaScript (`X-Request-ID`, rate limit headers)
2. Add production-safe origin validation to prevent misconfigured wildcards
3. Extend configuration schema to support `expose_headers` via environment variables
4. Maintain backward compatibility with existing CORS_ORIGINS parsing logic
5. Document CORS configuration thoroughly for operations team

---

## Current Implementation Analysis

### Current State

**File**: `src/main.py` (lines 68-74)

```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins,
    allow_credentials=settings.cors_allow_credentials,
    allow_methods=settings.cors_allow_methods,
    allow_headers=settings.cors_allow_headers,
)
```

**File**: `src/config.py` (lines 155-201)

```python
# CORS Configuration
cors_origins_raw: str = Field(
    default="http://localhost:5173,http://localhost:3000",
    alias="cors_origins",
    description="Allowed CORS origins (comma-separated or JSON array)",
)
cors_allow_credentials: bool = Field(default=True, description="Allow credentials")
cors_allow_methods_raw: str = Field(
    default="GET,POST,PUT,DELETE,PATCH,OPTIONS",
    alias="cors_allow_methods",
    description="Allowed HTTP methods (comma-separated or JSON array)",
)
cors_allow_headers_raw: str = Field(
    default="*",
    alias="cors_allow_headers",
    description="Allowed headers (comma-separated or JSON array)",
)

@staticmethod
def _parse_list_from_string(value: str) -> List[str]:
    """Parse a list from either JSON array or comma-separated string."""
    value = value.strip()
    if value.startswith("["):
        try:
            parsed: List[str] = json.loads(value)
            return parsed
        except json.JSONDecodeError:
            pass
    return [item.strip() for item in value.split(",") if item.strip()]

@property
def cors_origins(self) -> List[str]:
    """Get CORS origins as a list."""
    return self._parse_list_from_string(self.cors_origins_raw)
```

### Identified Gaps

| Gap | Impact | Priority |
|-----|--------|----------|
| No `expose_headers` configuration | Frontend JavaScript cannot read `X-Request-ID`, `X-RateLimit-*` headers | High |
| No production origin validation | Risk of accidental wildcard in production | Medium |
| Missing configuration documentation | Operators may misconfigure CORS | Low |

### What Works Well

1. Flexible parsing supports both JSON arrays and comma-separated strings
2. Environment variable aliasing (`cors_origins` alias for `cors_origins_raw`)
3. Boolean credential setting properly handled
4. Existing properties follow consistent pattern

---

## Technical Design

### Data Model

#### Configuration Schema Additions

**File**: `src/config.py`

```python
# =========================================================================
# CORS (Enhanced)
# =========================================================================

# Existing fields remain unchanged...

cors_expose_headers_raw: str = Field(
    default="X-Request-ID,X-RateLimit-Limit,X-RateLimit-Remaining,X-RateLimit-Reset",
    alias="cors_expose_headers",
    description="Headers exposed to browser JavaScript (comma-separated or JSON array). "
                "These headers will be accessible via response.headers in fetch/XHR calls.",
)

@property
def cors_expose_headers(self) -> List[str]:
    """Get exposed headers as a list.

    Exposed headers are response headers that JavaScript code running
    in the browser is allowed to access. Without explicit exposure,
    browsers only allow access to simple response headers.

    Returns:
        List of header names to expose (e.g., ["X-Request-ID", "X-RateLimit-Limit"])
    """
    return self._parse_list_from_string(self.cors_expose_headers_raw)

def validate_cors_for_production(self) -> List[str]:
    """Validate CORS configuration for production safety.

    Checks for common misconfigurations that could compromise security:
    - Wildcard origins with credentials
    - Empty origin list
    - HTTP origins in production

    Returns:
        List of warning messages (empty if configuration is valid)
    """
    warnings: List[str] = []

    origins = self.cors_origins

    # Check for wildcard with credentials (security risk)
    if "*" in origins and self.cors_allow_credentials:
        warnings.append(
            "CORS_ORIGINS contains '*' with CORS_ALLOW_CREDENTIALS=true. "
            "This is not allowed by browsers and will fail silently."
        )

    # Check for empty origins in production
    if self.is_production and not origins:
        warnings.append(
            "CORS_ORIGINS is empty in production. "
            "No cross-origin requests will be allowed."
        )

    # Check for HTTP origins in production (should be HTTPS)
    if self.is_production:
        http_origins = [o for o in origins if o.startswith("http://")]
        if http_origins:
            warnings.append(
                f"CORS_ORIGINS contains HTTP origins in production: {http_origins}. "
                "Consider using HTTPS for security."
            )

    # Check for overly permissive patterns
    if self.is_production:
        for origin in origins:
            if origin == "*":
                warnings.append(
                    "CORS_ORIGINS contains wildcard '*' in production. "
                    "This allows any origin to make requests."
                )
                break

    return warnings
```

### Integration Points

#### Main Application Update

**File**: `src/main.py`

```python
# CORS middleware (enhanced with expose_headers)
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins,
    allow_credentials=settings.cors_allow_credentials,
    allow_methods=settings.cors_allow_methods,
    allow_headers=settings.cors_allow_headers,
    expose_headers=settings.cors_expose_headers,  # NEW
)
```

#### Startup Validation (Optional Enhancement)

**File**: `src/main.py` (in lifespan function)

```python
@asynccontextmanager
async def lifespan(app: FastAPI) -> AsyncGenerator[None, None]:
    """Application lifespan manager."""
    # Startup
    logger.info("Starting Learn Greek Easy API", extra={"version": settings.app_version})

    # Validate CORS configuration
    cors_warnings = settings.validate_cors_for_production()
    for warning in cors_warnings:
        logger.warning(f"CORS Configuration: {warning}")

    # ... rest of startup
```

### Headers to Expose

| Header | Purpose | Source |
|--------|---------|--------|
| `X-Request-ID` | Request correlation/tracing | RequestLoggingMiddleware (Task 05.02) |
| `X-RateLimit-Limit` | Maximum requests allowed | RateLimitingMiddleware (Task 05.04) |
| `X-RateLimit-Remaining` | Requests remaining in window | RateLimitingMiddleware (Task 05.04) |
| `X-RateLimit-Reset` | Unix timestamp when limit resets | RateLimitingMiddleware (Task 05.04) |

### Environment Variable Format

```bash
# .env.example additions

# Headers exposed to browser JavaScript (comma-separated or JSON array)
# These headers can be read by frontend code after fetch/XHR requests
# Default: X-Request-ID,X-RateLimit-Limit,X-RateLimit-Remaining,X-RateLimit-Reset
CORS_EXPOSE_HEADERS="X-Request-ID,X-RateLimit-Limit,X-RateLimit-Remaining,X-RateLimit-Reset"

# Alternative JSON array format:
# CORS_EXPOSE_HEADERS='["X-Request-ID", "X-RateLimit-Limit"]'
```

---

## Implementation Steps

### Step 1: Update Configuration Schema (10 minutes)

**File**: `src/config.py`

1. Add `cors_expose_headers_raw` field with alias `cors_expose_headers`
2. Add `cors_expose_headers` property using existing `_parse_list_from_string`
3. Add `validate_cors_for_production` method for safety checks

```python
# In the CORS section (after line 174)

cors_expose_headers_raw: str = Field(
    default="X-Request-ID,X-RateLimit-Limit,X-RateLimit-Remaining,X-RateLimit-Reset",
    alias="cors_expose_headers",
    description="Headers exposed to browser JavaScript (comma-separated or JSON array)",
)

@property
def cors_expose_headers(self) -> List[str]:
    """Get exposed headers as a list."""
    return self._parse_list_from_string(self.cors_expose_headers_raw)

def validate_cors_for_production(self) -> List[str]:
    """Validate CORS configuration for production safety."""
    warnings: List[str] = []
    origins = self.cors_origins

    if "*" in origins and self.cors_allow_credentials:
        warnings.append(
            "CORS_ORIGINS contains '*' with CORS_ALLOW_CREDENTIALS=true - "
            "browsers will reject this configuration"
        )

    if self.is_production and not origins:
        warnings.append("CORS_ORIGINS is empty in production")

    if self.is_production:
        http_origins = [o for o in origins if o.startswith("http://") and "localhost" not in o]
        if http_origins:
            warnings.append(f"Non-localhost HTTP origins in production: {http_origins}")

    return warnings
```

### Step 2: Update CORS Middleware Registration (5 minutes)

**File**: `src/main.py`

```python
# Lines 68-74 become:
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins,
    allow_credentials=settings.cors_allow_credentials,
    allow_methods=settings.cors_allow_methods,
    allow_headers=settings.cors_allow_headers,
    expose_headers=settings.cors_expose_headers,  # ADD THIS LINE
)
```

### Step 3: Add Startup Validation (5 minutes)

**File**: `src/main.py`

```python
# In lifespan function, after "Starting Learn Greek Easy API" log:
cors_warnings = settings.validate_cors_for_production()
for warning in cors_warnings:
    logger.warning(
        f"CORS configuration warning: {warning}",
        extra={"category": "security", "config": "cors"},
    )
```

### Step 4: Update Environment Example (5 minutes)

**File**: `learn-greek-easy-backend/.env.example`

```bash
# In CORS CONFIGURATION section (after line 93):

# Headers exposed to browser JavaScript (comma-separated or JSON array)
# Frontend code can read these headers from response.headers
# Required for: request tracing (X-Request-ID), rate limit display (X-RateLimit-*)
CORS_EXPOSE_HEADERS="X-Request-ID,X-RateLimit-Limit,X-RateLimit-Remaining,X-RateLimit-Reset"
```

### Step 5: Update Debug Endpoint (Optional, 5 minutes)

**File**: `src/main.py`

Enhance the `/debug/settings` endpoint to include `expose_headers`:

```python
# In debug_settings() function:
"cors": {
    "origins": settings.cors_origins,
    "credentials": settings.cors_allow_credentials,
    "expose_headers": settings.cors_expose_headers,  # ADD
    "methods": settings.cors_allow_methods,
    "headers": settings.cors_allow_headers,
},
```

---

## Testing Strategy

### Unit Tests

**File**: `tests/unit/test_config_cors.py`

```python
"""Unit tests for CORS configuration."""

import pytest
from unittest.mock import patch


class TestCorsExposeHeaders:
    """Tests for cors_expose_headers configuration."""

    def test_default_expose_headers(self):
        """Test default expose_headers value."""
        from src.config import Settings

        settings = Settings()

        assert "X-Request-ID" in settings.cors_expose_headers
        assert "X-RateLimit-Limit" in settings.cors_expose_headers
        assert "X-RateLimit-Remaining" in settings.cors_expose_headers
        assert "X-RateLimit-Reset" in settings.cors_expose_headers

    def test_expose_headers_from_comma_separated(self):
        """Test parsing expose_headers from comma-separated string."""
        from src.config import Settings

        with patch.dict("os.environ", {"CORS_EXPOSE_HEADERS": "X-Custom,X-Another"}):
            settings = Settings()

        assert settings.cors_expose_headers == ["X-Custom", "X-Another"]

    def test_expose_headers_from_json_array(self):
        """Test parsing expose_headers from JSON array."""
        from src.config import Settings

        with patch.dict("os.environ", {"CORS_EXPOSE_HEADERS": '["X-Custom", "X-Another"]'}):
            settings = Settings()

        assert settings.cors_expose_headers == ["X-Custom", "X-Another"]

    def test_expose_headers_empty_string(self):
        """Test expose_headers with empty string returns empty list."""
        from src.config import Settings

        with patch.dict("os.environ", {"CORS_EXPOSE_HEADERS": ""}):
            settings = Settings()

        assert settings.cors_expose_headers == []

    def test_expose_headers_whitespace_handling(self):
        """Test expose_headers strips whitespace from values."""
        from src.config import Settings

        with patch.dict("os.environ", {"CORS_EXPOSE_HEADERS": " X-Custom , X-Another "}):
            settings = Settings()

        assert settings.cors_expose_headers == ["X-Custom", "X-Another"]


class TestCorsValidation:
    """Tests for CORS production validation."""

    def test_warns_on_wildcard_with_credentials(self):
        """Test warning when wildcard origin used with credentials."""
        from src.config import Settings

        with patch.dict("os.environ", {
            "CORS_ORIGINS": "*",
            "CORS_ALLOW_CREDENTIALS": "true",
        }):
            settings = Settings()
            warnings = settings.validate_cors_for_production()

        assert any("wildcard" in w.lower() or "'*'" in w for w in warnings)

    def test_warns_on_empty_origins_in_production(self):
        """Test warning when origins empty in production."""
        from src.config import Settings

        with patch.dict("os.environ", {
            "CORS_ORIGINS": "",
            "APP_ENV": "production",
        }):
            settings = Settings()
            warnings = settings.validate_cors_for_production()

        assert any("empty" in w.lower() for w in warnings)

    def test_warns_on_http_origins_in_production(self):
        """Test warning when HTTP (non-localhost) origins in production."""
        from src.config import Settings

        with patch.dict("os.environ", {
            "CORS_ORIGINS": "http://example.com,https://secure.com",
            "APP_ENV": "production",
        }):
            settings = Settings()
            warnings = settings.validate_cors_for_production()

        assert any("http" in w.lower() for w in warnings)

    def test_no_warnings_for_valid_production_config(self):
        """Test no warnings for properly configured production."""
        from src.config import Settings

        with patch.dict("os.environ", {
            "CORS_ORIGINS": "https://frontend-production-1164.up.railway.app",
            "CORS_ALLOW_CREDENTIALS": "true",
            "APP_ENV": "production",
        }):
            settings = Settings()
            warnings = settings.validate_cors_for_production()

        assert len(warnings) == 0

    def test_allows_localhost_http_in_production(self):
        """Test localhost HTTP doesn't trigger warning (for local testing)."""
        from src.config import Settings

        with patch.dict("os.environ", {
            "CORS_ORIGINS": "http://localhost:5173,https://prod.example.com",
            "APP_ENV": "production",
        }):
            settings = Settings()
            warnings = settings.validate_cors_for_production()

        # Should not warn about localhost
        http_warnings = [w for w in warnings if "http" in w.lower() and "localhost" not in w.lower()]
        assert len(http_warnings) == 0


class TestCorsBackwardCompatibility:
    """Tests ensuring backward compatibility with existing CORS config."""

    def test_existing_cors_origins_still_works(self):
        """Test existing CORS_ORIGINS environment variable still parsed correctly."""
        from src.config import Settings

        with patch.dict("os.environ", {
            "CORS_ORIGINS": "http://localhost:5173,http://localhost:3000",
        }):
            settings = Settings()

        assert "http://localhost:5173" in settings.cors_origins
        assert "http://localhost:3000" in settings.cors_origins

    def test_existing_cors_methods_still_works(self):
        """Test existing CORS_ALLOW_METHODS environment variable still works."""
        from src.config import Settings

        with patch.dict("os.environ", {
            "CORS_ALLOW_METHODS": "GET,POST,PUT",
        }):
            settings = Settings()

        assert settings.cors_allow_methods == ["GET", "POST", "PUT"]

    def test_existing_cors_credentials_still_works(self):
        """Test existing CORS_ALLOW_CREDENTIALS environment variable still works."""
        from src.config import Settings

        with patch.dict("os.environ", {
            "CORS_ALLOW_CREDENTIALS": "false",
        }):
            settings = Settings()

        assert settings.cors_allow_credentials is False
```

### Integration Tests

**File**: `tests/integration/api/test_cors.py`

```python
"""Integration tests for CORS middleware."""

import pytest
from fastapi.testclient import TestClient


class TestCorsHeaders:
    """Integration tests for CORS header behavior."""

    def test_preflight_request_includes_expose_headers(self, client: TestClient):
        """Test OPTIONS request returns Access-Control-Expose-Headers."""
        response = client.options(
            "/api/v1/status",
            headers={
                "Origin": "http://localhost:5173",
                "Access-Control-Request-Method": "GET",
            },
        )

        # Preflight should succeed
        assert response.status_code == 200

        # Check expose headers are listed
        expose_headers = response.headers.get("Access-Control-Expose-Headers", "")
        assert "X-Request-ID" in expose_headers

    def test_actual_request_allows_exposed_header_access(self, client: TestClient):
        """Test actual request includes Access-Control-Expose-Headers."""
        response = client.get(
            "/api/v1/status",
            headers={"Origin": "http://localhost:5173"},
        )

        assert response.status_code == 200

        # Response should include expose headers directive
        expose_headers = response.headers.get("Access-Control-Expose-Headers", "")
        assert "X-Request-ID" in expose_headers
        assert "X-RateLimit-Limit" in expose_headers

    def test_cors_allows_configured_origins(self, client: TestClient):
        """Test CORS allows requests from configured origins."""
        response = client.get(
            "/api/v1/status",
            headers={"Origin": "http://localhost:5173"},
        )

        assert response.status_code == 200
        assert response.headers.get("Access-Control-Allow-Origin") == "http://localhost:5173"

    def test_cors_blocks_unconfigured_origins(self, client: TestClient):
        """Test CORS blocks requests from unconfigured origins."""
        response = client.get(
            "/api/v1/status",
            headers={"Origin": "http://malicious-site.com"},
        )

        # Request still succeeds (CORS is browser-enforced)
        # but Access-Control-Allow-Origin should not match
        allow_origin = response.headers.get("Access-Control-Allow-Origin")
        assert allow_origin != "http://malicious-site.com"
```

### Test Coverage Target

| Component | Target | Rationale |
|-----------|--------|-----------|
| `cors_expose_headers` property | 100% | Critical for frontend integration |
| `validate_cors_for_production` | 95% | Security validation |
| Backward compatibility | 100% | Prevent regressions |

---

## Success Criteria Checklist

### Configuration

- [x] `CORS_EXPOSE_HEADERS` environment variable is parsed correctly
- [x] Comma-separated format works: `X-Request-ID,X-RateLimit-Limit`
- [x] JSON array format works: `["X-Request-ID", "X-RateLimit-Limit"]`
- [x] Default value includes all four required headers
- [x] Empty string results in empty list (no exposed headers)
- [x] Whitespace is properly trimmed from header names

### Middleware Integration

- [x] `expose_headers` parameter added to CORSMiddleware registration
- [x] Preflight (OPTIONS) requests include `Access-Control-Expose-Headers`
- [x] Actual requests include `Access-Control-Expose-Headers`
- [x] Frontend JavaScript can read `X-Request-ID` from response headers

### Production Validation

- [x] Warning logged for wildcard origin with credentials
- [x] Warning logged for empty origins in production
- [x] Warning logged for HTTP (non-localhost) origins in production
- [x] No warnings for valid production configuration
- [x] Localhost HTTP origins allowed (for testing purposes)

### Backward Compatibility

- [x] Existing `CORS_ORIGINS` parsing unchanged
- [x] Existing `CORS_ALLOW_METHODS` parsing unchanged
- [x] Existing `CORS_ALLOW_HEADERS` parsing unchanged
- [x] Existing `CORS_ALLOW_CREDENTIALS` behavior unchanged
- [x] No breaking changes to existing .env files

### Documentation

- [x] `.env.example` updated with `CORS_EXPOSE_HEADERS`
- [x] Debug endpoint shows `expose_headers` configuration
- [x] Startup logs CORS validation warnings

### Testing

- [x] Unit tests for `cors_expose_headers` property (5+ test cases) - 13 unit tests
- [x] Unit tests for `validate_cors_for_production` (5+ test cases) - included
- [x] Integration tests for CORS header behavior (3+ test cases) - 5 integration tests
- [x] All existing CORS-related tests still pass
- [x] Test coverage >= 90% for new code

---

## Security Considerations

### Exposed Headers

**Risk**: Exposing too many headers could leak implementation details.

**Mitigation**:
- Default expose list is minimal and intentional
- Only operational headers exposed (tracing, rate limiting)
- No sensitive headers (authentication tokens, internal IDs) exposed
- Configuration is explicit - operators must opt-in to additional headers

### Origin Validation

**Risk**: Misconfigured origins could allow unauthorized cross-origin requests.

**Mitigation**:
- `validate_cors_for_production()` warns about risky configurations
- Warnings logged at startup for visibility
- Wildcard with credentials explicitly flagged (browser will reject anyway)
- HTTP origins in production flagged for review

### Production vs Development

| Concern | Development | Production |
|---------|-------------|------------|
| Wildcard origins | Allowed | Warned |
| HTTP origins | Allowed | Warned (except localhost) |
| Empty origins | Allowed | Warned |
| Credentials with wildcard | Warned | Warned |

---

## Deployment Considerations

### Environment Configuration

**Development** (no changes needed):
```bash
CORS_ORIGINS="http://localhost:5173,http://localhost:3000"
# CORS_EXPOSE_HEADERS uses default value
```

**Railway Production**:
```bash
CORS_ORIGINS="https://frontend-production-1164.up.railway.app"
CORS_EXPOSE_HEADERS="X-Request-ID,X-RateLimit-Limit,X-RateLimit-Remaining,X-RateLimit-Reset"
```

### Rollback Strategy

If issues arise:
1. Remove `expose_headers=settings.cors_expose_headers` from middleware registration
2. Redeploy
3. Frontend will lose ability to read custom headers (graceful degradation)

### Feature Flag (Not Required)

This change is purely additive and has no impact on existing functionality. No feature flag needed.

---

## References

- [FastAPI CORSMiddleware Documentation](https://fastapi.tiangolo.com/tutorial/cors/)
- [MDN: Access-Control-Expose-Headers](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Expose-Headers)
- [CORS Security Best Practices](https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/11-Client-side_Testing/07-Testing_Cross_Origin_Resource_Sharing)
- Parent document: `/Users/samosipov/Downloads/learn-greek-easy/.claude/01-MVP/backend/05/05-api-foundation-middleware-plan.md`
- Current config: `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/config.py`
- Current main: `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/main.py`

---

**Document Version**: 1.1
**Created**: 2025-12-05
**Completed**: 2025-12-05
**Author**: Architect Agent
**Status**: âœ… COMPLETED
