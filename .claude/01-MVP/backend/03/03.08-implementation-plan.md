# Task 03.08: Authentication Middleware - Implementation Plan

**Created**: 2025-11-29
**Status**: Ready for Implementation

---

## Implementation Sequence

### Step 1: Create Middleware Package

**File**: `src/middleware/__init__.py` (NEW)

```python
"""Middleware package for Learn Greek Easy backend."""

from src.middleware.auth import AuthLoggingMiddleware

__all__ = ["AuthLoggingMiddleware"]
```

### Step 2: Create Auth Logging Middleware

**File**: `src/middleware/auth.py` (NEW)

Core implementation with:
- `AuthLoggingMiddleware` class extending `BaseHTTPMiddleware`
- `dispatch()` method - main entry point
- `_should_log()` - filter auth endpoints
- `_get_client_ip()` - extract IP from headers
- `_log_request()` - log with appropriate level

### Step 3: Update Main Application

**File**: `src/main.py` (UPDATE)

- Add import: `from src.middleware.auth import AuthLoggingMiddleware`
- Register middleware: `app.add_middleware(AuthLoggingMiddleware)`

### Step 4: Create Test Package

**File**: `tests/unit/middleware/__init__.py` (NEW)

### Step 5: Create Unit Tests

**File**: `tests/unit/middleware/test_auth_middleware.py` (NEW)

Test classes:
- `TestPathFiltering` - auth vs non-auth endpoints
- `TestLogContent` - verify log fields
- `TestRequestTiming` - duration measurement
- `TestClientIPExtraction` - IP header parsing
- `TestLogLevel` - level based on status code
- `TestSensitivePaths` - sensitive path marking
- `TestFailedLoginWarning` - 401 on /login
- `TestMiddlewareIntegration` - end-to-end flow

### Step 6: Create Verification Script

**File**: `scripts/verify_auth_middleware.py` (NEW)

---

## Verification Commands

```bash
# Run unit tests
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && \
/Users/samosipov/.local/bin/poetry run pytest tests/unit/middleware/test_auth_middleware.py -v

# Check coverage
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && \
/Users/samosipov/.local/bin/poetry run pytest tests/unit/middleware/test_auth_middleware.py --cov=src/middleware --cov-report=term-missing
```

---

## Acceptance Criteria

- [ ] Middleware logs all auth endpoint requests
- [ ] Request timing included in logs (duration_ms)
- [ ] Client IP captured (direct, X-Forwarded-For, X-Real-IP)
- [ ] Log level based on status code (INFO/WARNING/ERROR)
- [ ] Sensitive paths marked
- [ ] Failed login warning logged
- [ ] Does not interfere with endpoint functionality
- [ ] 15+ unit tests passing
