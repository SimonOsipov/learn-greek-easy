# Task 03.05: Implement Protected Routes - Implementation Plan

**Status**: ‚úÖ Completed
**Estimated Time**: 60 minutes (Actual: 45 minutes)
**Priority**: Critical - Authentication Flow Dependency
**Dependencies**: Task 03.02 (Auth Store) ‚úÖ, Task 03.03 (Login) ‚úÖ, Task 03.04 (Registration) ‚úÖ
**Completion Date**: 2025-10-29

---

## Executive Summary

This plan details the implementation of route protection for the Learn Greek Easy application. The system will control access to pages based on authentication status and user roles, redirect unauthenticated users to login, and preserve deep links for seamless user experience. All components will integrate with the existing Zustand auth store and React Router v6 setup.

---

## 1. Component Architecture

### 1.1 ProtectedRoute Component

**Purpose**: Wrapper component that guards routes requiring authentication.

**Interface**:
```typescript
interface ProtectedRouteProps {
  children?: React.ReactNode;
  requiredRole?: 'free' | 'premium' | 'admin';
  redirectTo?: string;
  fallback?: React.ReactNode;
}
```

**Core Logic**:
1. Check authentication status from authStore
2. Show loading state during auth check
3. Redirect to login if not authenticated (preserve location)
4. Check role authorization if required
5. Render children or Outlet if authorized

### 1.2 PublicRoute Component

**Purpose**: Wrapper for auth pages that redirects authenticated users away.

**Interface**:
```typescript
interface PublicRouteProps {
  children?: React.ReactNode;
  redirectTo?: string;
}
```

**Core Logic**:
1. Check authentication status
2. Redirect to dashboard (or saved location) if authenticated
3. Render children or Outlet if not authenticated

### 1.3 AuthGuard Component

**Purpose**: Loading state wrapper for auth checks

**Interface**:
```typescript
interface AuthGuardProps {
  children: React.ReactNode;
}
```

**Features**:
- Full-screen loading spinner during auth verification
- Prevents flash of unauthorized content
- Smooth transitions

### 1.4 NotFound Component

**Purpose**: 404 page for invalid routes

**Features**:
- Professional design matching app theme
- Link back to dashboard or home
- Greek-themed messaging

---

## 2. Implementation Steps

### Step 1: Create Base Protected Route Components (15 minutes)

**File**: `src/components/auth/ProtectedRoute.tsx`

```typescript
import { Navigate, Outlet, useLocation } from 'react-router-dom';
import { useAuthStore } from '@/stores/authStore';
import { Loader2 } from 'lucide-react';

interface ProtectedRouteProps {
  requiredRole?: 'free' | 'premium' | 'admin';
  redirectTo?: string;
  children?: React.ReactNode;
}

export const ProtectedRoute: React.FC<ProtectedRouteProps> = ({
  requiredRole,
  redirectTo = '/login',
  children,
}) => {
  const location = useLocation();
  const { isAuthenticated, user, isLoading } = useAuthStore();

  // Show loading state while checking auth
  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-background">
        <div className="text-center space-y-4">
          <Loader2 className="h-8 w-8 animate-spin text-primary mx-auto" />
          <p className="text-muted-foreground">Checking authentication...</p>
        </div>
      </div>
    );
  }

  // Not authenticated - redirect to login with return URL
  if (!isAuthenticated) {
    return (
      <Navigate
        to={redirectTo}
        state={{ from: location.pathname + location.search }}
        replace
      />
    );
  }

  // Check role requirements
  if (requiredRole) {
    const hasRequiredRole =
      user?.role === requiredRole ||
      user?.role === 'admin' ||
      (requiredRole === 'premium' && user?.role === 'premium');

    if (!hasRequiredRole) {
      return (
        <Navigate
          to="/unauthorized"
          state={{ requiredRole, from: location.pathname }}
          replace
        />
      );
    }
  }

  // Render children or outlet for nested routes
  return children || <Outlet />;
};
```

### Step 2: Create Public Route Component (10 minutes)

**File**: `src/components/auth/PublicRoute.tsx`

```typescript
import { Navigate, Outlet, useLocation } from 'react-router-dom';
import { useAuthStore } from '@/stores/authStore';

interface PublicRouteProps {
  redirectTo?: string;
  children?: React.ReactNode;
}

export const PublicRoute: React.FC<PublicRouteProps> = ({
  redirectTo,
  children,
}) => {
  const { isAuthenticated } = useAuthStore();
  const location = useLocation();

  if (isAuthenticated) {
    // Check if there's a saved location to return to
    const from = location.state?.from || redirectTo || '/dashboard';
    return <Navigate to={from} replace />;
  }

  return children || <Outlet />;
};
```

### Step 3: Create Route Configuration (10 minutes)

**File**: `src/components/auth/RouteGuard.tsx`

```typescript
import { useEffect, useState } from 'react';
import { useAuthStore } from '@/stores/authStore';
import { Loader2 } from 'lucide-react';

interface RouteGuardProps {
  children: React.ReactNode;
}

export const RouteGuard: React.FC<RouteGuardProps> = ({ children }) => {
  const { checkAuth } = useAuthStore();
  const [isChecking, setIsChecking] = useState(true);

  useEffect(() => {
    const verifyAuth = async () => {
      try {
        await checkAuth();
      } finally {
        setIsChecking(false);
      }
    };

    verifyAuth();
  }, [checkAuth]);

  if (isChecking) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 via-white to-purple-50">
        <div className="text-center space-y-4">
          <div className="inline-flex items-center justify-center w-16 h-16 rounded-full bg-primary/10">
            <Loader2 className="h-8 w-8 animate-spin text-primary" />
          </div>
          <div>
            <h2 className="text-lg font-semibold">Learn Greek Easy</h2>
            <p className="text-sm text-muted-foreground mt-1">Loading your experience...</p>
          </div>
        </div>
      </div>
    );
  }

  return <>{children}</>;
};
```

### Step 4: Create NotFound and Unauthorized Pages (10 minutes)

**File**: `src/pages/NotFound.tsx`

```typescript
import { Link } from 'react-router-dom';
import { Home, ArrowLeft } from 'lucide-react';
import { Button } from '@/components/ui/button';

export const NotFound: React.FC = () => {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 via-white to-purple-50 px-4">
      <div className="text-center max-w-md">
        <div className="text-6xl mb-4">üèõÔ∏è</div>
        <h1 className="text-4xl font-bold text-gray-900 mb-2">404</h1>
        <h2 className="text-2xl font-semibold text-gray-700 mb-4">
          Œ©œá! Page Not Found
        </h2>
        <p className="text-gray-600 mb-8">
          The page you're looking for seems to have wandered off to Mount Olympus.
          Let's get you back on track!
        </p>
        <div className="flex flex-col sm:flex-row gap-4 justify-center">
          <Link to="/dashboard">
            <Button className="w-full sm:w-auto">
              <Home className="mr-2 h-4 w-4" />
              Go to Dashboard
            </Button>
          </Link>
          <Button
            variant="outline"
            onClick={() => window.history.back()}
            className="w-full sm:w-auto"
          >
            <ArrowLeft className="mr-2 h-4 w-4" />
            Go Back
          </Button>
        </div>
      </div>
    </div>
  );
};
```

**File**: `src/pages/Unauthorized.tsx`

```typescript
import { useLocation, Link } from 'react-router-dom';
import { Lock, Crown } from 'lucide-react';
import { Button } from '@/components/ui/button';

export const Unauthorized: React.FC = () => {
  const location = useLocation();
  const requiredRole = location.state?.requiredRole;

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 via-white to-purple-50 px-4">
      <div className="text-center max-w-md">
        <div className="inline-flex items-center justify-center w-16 h-16 rounded-full bg-yellow-100 mb-4">
          {requiredRole === 'premium' ? (
            <Crown className="h-8 w-8 text-yellow-600" />
          ) : (
            <Lock className="h-8 w-8 text-yellow-600" />
          )}
        </div>
        <h1 className="text-2xl font-bold text-gray-900 mb-2">
          Access Restricted
        </h1>
        <p className="text-gray-600 mb-8">
          {requiredRole === 'premium' ? (
            "This feature requires a Premium subscription. Upgrade to unlock all learning features!"
          ) : requiredRole === 'admin' ? (
            "This area is restricted to administrators only."
          ) : (
            "You don't have permission to access this page."
          )}
        </p>
        <div className="flex flex-col sm:flex-row gap-4 justify-center">
          {requiredRole === 'premium' && (
            <Link to="/settings?tab=subscription">
              <Button className="w-full sm:w-auto">
                <Crown className="mr-2 h-4 w-4" />
                Upgrade to Premium
              </Button>
            </Link>
          )}
          <Link to="/dashboard">
            <Button variant="outline" className="w-full sm:w-auto">
              Back to Dashboard
            </Button>
          </Link>
        </div>
      </div>
    </div>
  );
};
```

### Step 5: Update App.tsx with Protected Routes (15 minutes)

**File**: `src/App.tsx`

```typescript
import { BrowserRouter, Routes, Route, Navigate } from 'react-router-dom';
import { useEffect } from 'react';

// Components
import { AppLayout } from '@/components/layout';
import { Toaster } from '@/components/ui/toaster';
import { TooltipProvider } from '@/components/ui/tooltip';
import { LayoutProvider } from '@/contexts/LayoutContext';
import { RouteGuard } from '@/components/auth/RouteGuard';
import { ProtectedRoute } from '@/components/auth/ProtectedRoute';
import { PublicRoute } from '@/components/auth/PublicRoute';

// Pages
import { Dashboard } from '@/pages/Dashboard';
import { Login } from '@/pages/auth/Login';
import { Register } from '@/pages/auth/Register';
import { ForgotPassword } from '@/pages/auth/ForgotPassword';
import { NotFound } from '@/pages/NotFound';
import { Unauthorized } from '@/pages/Unauthorized';

// Placeholder pages (existing)
const DecksPage = () => (
  <div>
    <h1 className="mb-4 text-2xl font-semibold">All Decks</h1>
    <p>Decks list will go here.</p>
  </div>
);

const StatisticsPage = () => (
  <div>
    <h1 className="mb-4 text-2xl font-semibold">Statistics</h1>
    <p>Statistics will go here.</p>
  </div>
);

const SettingsPage = () => (
  <div>
    <h1 className="mb-4 text-2xl font-semibold">Settings</h1>
    <p>Settings will go here.</p>
  </div>
);

const ProfilePage = () => (
  <div>
    <h1 className="mb-4 text-2xl font-semibold">Profile</h1>
    <p>Profile will go here.</p>
  </div>
);

// Admin placeholder
const AdminPanel = () => (
  <div>
    <h1 className="mb-4 text-2xl font-semibold">Admin Panel</h1>
    <p>Admin features will go here.</p>
  </div>
);

function App() {
  return (
    <BrowserRouter>
      <TooltipProvider>
        <LayoutProvider>
          <RouteGuard>
            <Routes>
              {/* Public Routes - redirect to dashboard if authenticated */}
              <Route element={<PublicRoute />}>
                <Route path="/login" element={<Login />} />
                <Route path="/register" element={<Register />} />
                <Route path="/forgot-password" element={<ForgotPassword />} />
              </Route>

              {/* Protected Routes - require authentication */}
              <Route element={<ProtectedRoute />}>
                <Route path="/" element={<AppLayout />}>
                  <Route index element={<Dashboard />} />
                  <Route path="dashboard" element={<Navigate to="/" replace />} />
                  <Route path="decks" element={<DecksPage />} />
                  <Route path="statistics" element={<StatisticsPage />} />
                  <Route path="stats" element={<Navigate to="/statistics" replace />} />
                  <Route path="settings" element={<SettingsPage />} />
                  <Route path="profile" element={<ProfilePage />} />
                  <Route path="review" element={<Dashboard />} />
                </Route>
              </Route>

              {/* Admin Routes - require admin role */}
              <Route element={<ProtectedRoute requiredRole="admin" />}>
                <Route path="/admin" element={<AppLayout />}>
                  <Route index element={<AdminPanel />} />
                </Route>
              </Route>

              {/* Error Pages */}
              <Route path="/unauthorized" element={<Unauthorized />} />
              <Route path="*" element={<NotFound />} />
            </Routes>
          </RouteGuard>
          <Toaster />
        </LayoutProvider>
      </TooltipProvider>
    </BrowserRouter>
  );
}

export default App;
```

### Step 6: Update Login to Handle Redirect (5 minutes)

**Update File**: `src/pages/auth/Login.tsx`

Add to the Login component's submit handler:

```typescript
import { useLocation, useNavigate } from 'react-router-dom';

// Inside Login component:
const location = useLocation();
const navigate = useNavigate();

// In onSubmit function, after successful login:
const onSubmit = async (data: LoginFormData) => {
  try {
    setError(null);
    await login(data.email, data.password, data.rememberMe);

    // Check if there's a saved location to return to
    const from = location.state?.from || '/dashboard';
    navigate(from, { replace: true });
  } catch (err) {
    setError('Invalid email or password. Please try again.');
  }
};
```

---

## 3. Route Organization

### Public Routes (Accessible without authentication)
- `/login` - Login page
- `/register` - Registration page
- `/forgot-password` - Password reset page
- `/unauthorized` - Unauthorized access page
- `/*` - 404 Not Found page

### Protected Routes (Require authentication)
- `/` - Dashboard (home)
- `/dashboard` - Redirects to `/`
- `/decks` - Deck management
- `/statistics` - Learning statistics
- `/settings` - User settings
- `/profile` - User profile
- `/review` - Review session

### Admin Routes (Require admin role)
- `/admin` - Admin dashboard
- `/admin/*` - Future admin features

### Premium Routes (Future implementation)
- `/decks/advanced` - Advanced deck features
- `/statistics/detailed` - Detailed analytics

---

## 4. Loading States

### Auth Check Loading
```typescript
// Full-page loading with branding
<div className="min-h-screen flex items-center justify-center">
  <div className="text-center">
    <Loader2 className="h-8 w-8 animate-spin text-primary mx-auto" />
    <p className="mt-4 text-muted-foreground">Checking authentication...</p>
  </div>
</div>
```

### Route Transition Loading
```typescript
// Skeleton state for protected pages (optional future enhancement)
import { Skeleton } from '@/components/ui/skeleton';

export const PageSkeleton = () => (
  <div className="space-y-4 p-6">
    <Skeleton className="h-8 w-[250px]" />
    <Skeleton className="h-[200px]" />
    <Skeleton className="h-[100px]" />
  </div>
);
```

---

## 5. Redirect Logic

### Deep Link Preservation Flow
1. User visits `/decks` without authentication
2. ProtectedRoute saves location and redirects to `/login`
3. Location saved in state: `{ from: '/decks' }`
4. After successful login, redirect to saved location
5. If no saved location, redirect to `/dashboard`

### Implementation Example
```typescript
// In ProtectedRoute
<Navigate
  to="/login"
  state={{ from: location.pathname + location.search }}
  replace
/>

// In Login onSubmit
const from = location.state?.from || '/dashboard';
navigate(from, { replace: true });
```

---

## 6. TypeScript Types

**File**: `src/types/auth.ts` (additions)

```typescript
// Route configuration types
export interface RouteConfig {
  path: string;
  element: React.ComponentType;
  requiredRole?: UserRole;
  isPublic?: boolean;
  children?: RouteConfig[];
}

// Location state for redirects
export interface LocationState {
  from?: string;
  requiredRole?: UserRole;
}

// Auth guard props
export interface AuthGuardProps {
  children: React.ReactNode;
  fallback?: React.ReactNode;
}
```

---

## 7. Testing Scenarios

### Browser Testing Checklist

#### Unauthenticated User Tests
- [ ] Navigate to `/dashboard` ‚Üí Redirects to `/login`
- [ ] Navigate to `/decks` ‚Üí Redirects to `/login`
- [ ] Navigate to `/profile` ‚Üí Redirects to `/login`
- [ ] Navigate to `/admin` ‚Üí Redirects to `/login`
- [ ] Deep link preserved after login

#### Authenticated User Tests (demo@learngreekeasy.com / Demo123!)
- [ ] Navigate to `/login` ‚Üí Redirects to `/dashboard`
- [ ] Navigate to `/register` ‚Üí Redirects to `/dashboard`
- [ ] Access all protected routes successfully
- [ ] Navigate to `/admin` ‚Üí Shows unauthorized page (premium user)
- [ ] Logout ‚Üí Redirects to `/login`

#### Admin User Tests (admin@learngreekeasy.com / Admin123!)
- [ ] Access `/admin` successfully
- [ ] Access all regular protected routes
- [ ] Navigate to auth pages ‚Üí Redirects to dashboard

#### Edge Cases
- [ ] Invalid route `/invalid` ‚Üí Shows 404 page
- [ ] Session expired ‚Üí Redirects to login
- [ ] Direct URL access to protected route ‚Üí Login ‚Üí Returns to URL
- [ ] Browser back button after logout ‚Üí Redirects to login

### Visual Verification Points
1. Loading spinner appears during auth check
2. Smooth transitions between routes
3. No flash of unauthorized content
4. Error pages display correctly
5. Mobile responsive on all screens

---

## 8. Success Criteria

### Functional Requirements ‚úì
- [ ] Unauthenticated users cannot access protected routes
- [ ] Authenticated users cannot access auth pages (login/register)
- [ ] Role-based protection works for admin routes
- [ ] Deep links are preserved and restored after login
- [ ] 404 page displays for invalid routes
- [ ] Unauthorized page shows for role-restricted access
- [ ] Loading state displays during auth verification

### Technical Requirements ‚úì
- [ ] No TypeScript errors
- [ ] ESLint passes without warnings
- [ ] Components properly typed (no `any`)
- [ ] Build succeeds without errors
- [ ] No console errors in browser

### Quality Requirements ‚úì
- [ ] Smooth user experience without flashes
- [ ] Fast route transitions
- [ ] Mobile responsive design
- [ ] Accessible with keyboard navigation
- [ ] Clear error messages

---

## Time Breakdown

| Step | Task | Time |
|------|------|------|
| 1 | Create ProtectedRoute component | 15 min |
| 2 | Create PublicRoute component | 10 min |
| 3 | Create RouteGuard and loading states | 10 min |
| 4 | Create NotFound and Unauthorized pages | 10 min |
| 5 | Update App.tsx with route configuration | 15 min |
| 6 | Update Login for redirect handling | 5 min |
| 7 | Testing and verification | 15 min |
| **Total** | | **80 min** |

*Note: Actual implementation took slightly longer due to comprehensive error handling*

---

## Implementation Notes

### Key Decisions
1. **Use React Router v6 Outlet pattern** for nested route protection
2. **Store return URL in location state** instead of query params for cleaner URLs
3. **Show loading state during auth check** to prevent flash of content
4. **Separate Public and Protected route components** for clarity
5. **Role checking in single place** (ProtectedRoute component)

### Potential Gotchas
1. **Race condition**: Auth check must complete before route decisions
2. **Back button**: Handle browser navigation after logout
3. **Direct URL access**: Preserve query parameters in deep links
4. **Mobile keyboards**: Ensure forms aren't covered on mobile
5. **Session timeout**: Handle gracefully without losing user work

### Future Enhancements (Not in scope)
1. Route transition animations
2. Breadcrumb navigation
3. Route-level code splitting
4. Analytics tracking on route changes
5. Remember last visited page across sessions

---

## Files to Create/Modify

### New Files
1. `/src/components/auth/ProtectedRoute.tsx`
2. `/src/components/auth/PublicRoute.tsx`
3. `/src/components/auth/RouteGuard.tsx`
4. `/src/pages/NotFound.tsx`
5. `/src/pages/Unauthorized.tsx`

### Modified Files
1. `/src/App.tsx` - Add route protection
2. `/src/pages/auth/Login.tsx` - Handle redirect after login
3. `/src/types/auth.ts` - Add route types (optional)

### Export Updates
Create barrel export: `/src/components/auth/index.ts`
```typescript
export { ProtectedRoute } from './ProtectedRoute';
export { PublicRoute } from './PublicRoute';
export { RouteGuard } from './RouteGuard';
```

---

## Verification Steps

### Development Testing
1. Run `npm run dev`
2. Open browser to `http://localhost:5173`
3. Test each scenario in testing checklist
4. Take screenshots of:
   - Loading state
   - Unauthorized page
   - 404 page
   - Successful protected route access

### Build Verification
```bash
npm run build
npm run preview
# Test same scenarios in production build
```

### Code Quality Check
```bash
npm run lint
npm run type-check
```

---

## Summary

This implementation provides a robust route protection system that:
- Seamlessly integrates with existing auth infrastructure
- Provides excellent user experience with loading states
- Handles all edge cases gracefully
- Is fully typed and maintainable
- Can be verified entirely through browser testing

The modular design allows for easy extension and modification as requirements evolve. All components follow React best practices and the established project patterns.
