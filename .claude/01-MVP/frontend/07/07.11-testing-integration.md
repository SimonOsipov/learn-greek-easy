# Task 07.11: Add Component Testing Infrastructure

**Status**: ðŸ“‹ **PLANNED** (OPTIONAL)
**Parent Task**: [Task 07 - UI Components](../07-ui-components.md)
**Track**: B - Refactoring (Optional)
**Priority**: Low
**Estimated Duration**: 60 minutes
**Dependencies**: Task 07.10 (ErrorBoundary)
**Deliverable**: Vitest setup, test utilities, example tests

---

## Objective

Set up Vitest for component testing, create test utilities, and write example tests for key components to establish testing patterns.

---

## Installation

```bash
npm install -D vitest @testing-library/react @testing-library/jest-dom @testing-library/user-event jsdom
```

---

## Configuration Files

### 1. vite.config.ts Update

```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src')
    }
  },
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: './src/test/setup.ts',
    css: true
  }
});
```

---

### 2. Test Setup File

**File**: `/src/test/setup.ts`

```typescript
import { expect, afterEach } from 'vitest';
import { cleanup } from '@testing-library/react';
import * as matchers from '@testing-library/jest-dom/matchers';

// Extend Vitest matchers
expect.extend(matchers);

// Cleanup after each test
afterEach(() => {
  cleanup();
});
```

---

### 3. Test Utilities

**File**: `/src/test/utils.tsx`

```typescript
import { ReactElement } from 'react';
import { render, RenderOptions } from '@testing-library/react';
import { BrowserRouter } from 'react-router-dom';

// Wrapper with providers
function AllProviders({ children }: { children: React.ReactNode }) {
  return (
    <BrowserRouter>
      {children}
    </BrowserRouter>
  );
}

// Custom render function
export function renderWithProviders(
  ui: ReactElement,
  options?: Omit<RenderOptions, 'wrapper'>
) {
  return render(ui, { wrapper: AllProviders, ...options });
}

// Re-export everything from testing-library
export * from '@testing-library/react';
export { default as userEvent } from '@testing-library/user-event';
```

---

## Example Tests

### 1. Button Component Test

**File**: `/src/components/ui/__tests__/button.test.tsx`

```typescript
import { describe, it, expect, vi } from 'vitest';
import { renderWithProviders, screen } from '@/test/utils';
import userEvent from '@testing-library/user-event';
import { Button } from '../button';

describe('Button', () => {
  it('renders with text', () => {
    renderWithProviders(<Button>Click me</Button>);
    expect(screen.getByText('Click me')).toBeInTheDocument();
  });

  it('handles click events', async () => {
    const handleClick = vi.fn();
    const user = userEvent.setup();

    renderWithProviders(<Button onClick={handleClick}>Click me</Button>);

    await user.click(screen.getByText('Click me'));
    expect(handleClick).toHaveBeenCalledOnce();
  });

  it('is disabled when disabled prop is true', () => {
    renderWithProviders(<Button disabled>Click me</Button>);
    expect(screen.getByText('Click me')).toBeDisabled();
  });

  it('applies variant classes', () => {
    renderWithProviders(<Button variant="destructive">Delete</Button>);
    const button = screen.getByText('Delete');
    expect(button).toHaveClass('bg-red-500'); // Or whatever destructive class is
  });
});
```

---

### 2. FormField Component Test

**File**: `/src/components/forms/__tests__/FormField.test.tsx`

```typescript
import { describe, it, expect, vi } from 'vitest';
import { renderWithProviders, screen } from '@/test/utils';
import userEvent from '@testing-library/user-event';
import { FormField } from '../FormField';

describe('FormField', () => {
  it('renders label and input', () => {
    renderWithProviders(
      <FormField
        label="Email"
        name="email"
        value=""
        onChange={() => {}}
      />
    );

    expect(screen.getByLabelText('Email')).toBeInTheDocument();
  });

  it('displays error message', () => {
    renderWithProviders(
      <FormField
        label="Email"
        name="email"
        value=""
        onChange={() => {}}
        error="Email is required"
      />
    );

    expect(screen.getByText('Email is required')).toBeInTheDocument();
  });

  it('calls onChange when typing', async () => {
    const handleChange = vi.fn();
    const user = userEvent.setup();

    renderWithProviders(
      <FormField
        label="Email"
        name="email"
        value=""
        onChange={handleChange}
      />
    );

    const input = screen.getByLabelText('Email');
    await user.type(input, 'test@example.com');

    expect(handleChange).toHaveBeenCalled();
  });

  it('shows required indicator', () => {
    renderWithProviders(
      <FormField
        label="Email"
        name="email"
        value=""
        onChange={() => {}}
        required
      />
    );

    expect(screen.getByText('*')).toBeInTheDocument();
  });
});
```

---

### 3. ErrorBoundary Test

**File**: `/src/components/errors/__tests__/ErrorBoundary.test.tsx`

```typescript
import { describe, it, expect, vi } from 'vitest';
import { renderWithProviders, screen } from '@/test/utils';
import { ErrorBoundary } from '../ErrorBoundary';

// Component that throws error
function ThrowError() {
  throw new Error('Test error');
}

describe('ErrorBoundary', () => {
  // Suppress console errors in tests
  const consoleError = console.error;
  beforeAll(() => {
    console.error = vi.fn();
  });
  afterAll(() => {
    console.error = consoleError;
  });

  it('renders children when no error', () => {
    renderWithProviders(
      <ErrorBoundary>
        <div>Test content</div>
      </ErrorBoundary>
    );

    expect(screen.getByText('Test content')).toBeInTheDocument();
  });

  it('renders fallback when error occurs', () => {
    renderWithProviders(
      <ErrorBoundary>
        <ThrowError />
      </ErrorBoundary>
    );

    expect(screen.getByText(/something went wrong/i)).toBeInTheDocument();
  });

  it('calls onError callback', () => {
    const handleError = vi.fn();

    renderWithProviders(
      <ErrorBoundary onError={handleError}>
        <ThrowError />
      </ErrorBoundary>
    );

    expect(handleError).toHaveBeenCalled();
  });
});
```

---

## NPM Scripts

Update `package.json`:
```json
{
  "scripts": {
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest --coverage"
  }
}
```

---

## Testing Patterns Documentation

**File**: `/src/test/README.md`

```markdown
# Testing Guide

## Running Tests

```bash
npm test              # Run all tests
npm run test:ui       # Run with UI
npm run test:coverage # Run with coverage report
```

## Writing Tests

### Component Tests

Test user interactions and visual rendering:

```typescript
import { renderWithProviders, screen } from '@/test/utils';
import userEvent from '@testing-library/user-event';

test('button click', async () => {
  const user = userEvent.setup();
  const handleClick = vi.fn();

  renderWithProviders(<Button onClick={handleClick}>Click</Button>);

  await user.click(screen.getByText('Click'));
  expect(handleClick).toHaveBeenCalled();
});
```

### Form Tests

Test form validation and submission:

```typescript
test('form validation', async () => {
  renderWithProviders(<LoginForm />);

  const emailInput = screen.getByLabelText('Email');
  await user.type(emailInput, 'invalid-email');
  await user.tab(); // Trigger blur

  expect(screen.getByText('Invalid email format')).toBeInTheDocument();
});
```

### Hook Tests

Use `@testing-library/react-hooks` for custom hooks.
```

---

## Implementation Steps

1. Install testing dependencies (5 min)
2. Configure Vitest (10 min)
3. Create test utilities (10 min)
4. Write Button tests (10 min)
5. Write FormField tests (15 min)
6. Write ErrorBoundary tests (10 min)

---

## Success Criteria

- [ ] Vitest configured and running
- [ ] Test utilities created
- [ ] Example tests written for 3-5 components
- [ ] All tests passing
- [ ] NPM scripts configured
- [ ] Testing patterns documented
- [ ] CI/CD ready (if applicable)

---

## Time Breakdown

| Activity | Duration |
|----------|----------|
| Install dependencies | 5 min |
| Configure Vitest | 10 min |
| Create test utilities | 10 min |
| Write Button tests | 10 min |
| Write FormField tests | 15 min |
| Write ErrorBoundary tests | 10 min |
| **TOTAL** | **60 min** |

---

## Next Steps

After setup:
1. Add tests for all form components
2. Add tests for dialog components
3. Add integration tests for key user flows
4. Set up test coverage thresholds
5. Integrate with CI/CD pipeline
