# Task 10.02: Playwright E2E Setup

**Status**: ✅ **COMPLETED**
**Duration**: 90 minutes (1.5 hours)
**Dependencies**: None (can run in parallel with 10.01)
**Created**: 2025-11-08
**Completed**: 2025-11-08
**File**: [10.02-playwright-e2e-setup.md](./10.02-playwright-e2e-setup.md)

---

## Overview

### Description

Configure **Playwright** as the end-to-end (E2E) testing framework for automated browser testing. This subtask installs Playwright, configures cross-browser testing, sets up the E2E test directory structure, creates GitHub Actions CI/CD workflow, and validates the setup with a sample test.

### Why It's Important

E2E tests are critical for validating complete user journeys:
- **Real Browser Testing**: Tests run in actual browsers (Chromium, Firefox, WebKit)
- **User Journey Validation**: Verifies multi-page flows work end-to-end
- **Regression Prevention**: Catches integration bugs that unit tests miss
- **CI/CD Integration**: Automated tests prevent bad deployments

Playwright was already used for manual testing in Tasks 06-09 (Playwright MCP), so we're familiar with it.

### Success Criteria

1. **Playwright Installed**:
   - ✅ Playwright installed with all browsers (Chromium, Firefox, WebKit)
   - ✅ Playwright Test framework configured

2. **Configuration Complete**:
   - ✅ `playwright.config.ts` created with cross-browser, screenshot, retry settings
   - ✅ `tests/e2e/` directory structure created
   - ✅ Base URL configured for local dev server
   - ✅ Test artifacts configured (screenshots, videos, traces)

3. **CI/CD Integration**:
   - ✅ `.github/workflows/test.yml` created with separate unit/E2E jobs
   - ✅ Playwright installed in CI
   - ✅ Tests run on push to main and PRs
   - ✅ Coverage uploaded to Codecov (optional)

4. **Validation**:
   - ✅ Sample E2E test passes (`npm run test:e2e`)
   - ✅ Tests work in all browsers (Chromium, Firefox, WebKit)
   - ✅ Screenshots captured on failure
   - ✅ HTML report generates successfully

---

## Implementation Steps

### Step 1: Install Playwright (10 min)

```bash
cd learn-greek-easy-frontend

# Install Playwright (test runner + browsers)
npm install -D @playwright/test@^1.48.0

# Install browsers (Chromium, Firefox, WebKit)
npx playwright install

# Install system dependencies (Linux only)
# npx playwright install-deps
```

**Verify installation**:
```bash
npx playwright --version
# Expected: Version 1.48.0
```

**Package installed**:
- `@playwright/test`: Test runner and assertions library

**Browsers installed** (in `~/.cache/ms-playwright/`):
- Chromium (latest)
- Firefox (latest)
- WebKit (latest Safari engine)

---

### Step 2: Create Playwright Configuration (30 min)

#### File: `playwright.config.ts`

Create at project root: `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-frontend/playwright.config.ts`

```typescript
import { defineConfig, devices } from '@playwright/test';

/**
 * Playwright Configuration
 * See https://playwright.dev/docs/test-configuration
 */
export default defineConfig({
  // Test directory
  testDir: './tests/e2e',

  // Test file pattern
  testMatch: '**/*.spec.ts',

  // Timeout for each test (60 seconds)
  timeout: 60 * 1000,

  // Maximum time for expect() assertions (10 seconds)
  expect: {
    timeout: 10 * 1000,
  },

  // Fail fast: stop after first failure (useful for debugging)
  // fullyParallel: false,

  // Run tests in parallel (faster CI)
  fullyParallel: true,

  // Retry failed tests in CI (catch flaky tests)
  retries: process.env.CI ? 2 : 0,

  // Number of parallel workers
  workers: process.env.CI ? 1 : undefined, // CI: 1 worker, Local: auto

  // Reporter configuration
  reporter: [
    ['list'], // Console output
    ['html', { outputFolder: 'playwright-report' }], // HTML report
    ['json', { outputFile: 'playwright-report/results.json' }], // JSON for CI
  ],

  // Shared settings for all projects
  use: {
    // Base URL for navigation (e.g., page.goto('/'))
    baseURL: process.env.PLAYWRIGHT_BASE_URL || 'http://localhost:5173',

    // Collect trace on failure (for debugging)
    trace: 'on-first-retry',

    // Screenshot on failure
    screenshot: 'only-on-failure',

    // Video on failure
    video: 'retain-on-failure',

    // Browser context options
    viewport: { width: 1280, height: 720 },
    ignoreHTTPSErrors: true,
    locale: 'en-US',
    timezoneId: 'America/New_York',
  },

  // Test projects (browsers to run tests in)
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },

    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },

    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },

    // Mobile browsers (optional - uncomment if needed)
    // {
    //   name: 'Mobile Chrome',
    //   use: { ...devices['Pixel 5'] },
    // },
    // {
    //   name: 'Mobile Safari',
    //   use: { ...devices['iPhone 12'] },
    // },
  ],

  // Web server configuration (start dev server before tests)
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:5173',
    reuseExistingServer: !process.env.CI, // CI: always start fresh
    timeout: 120 * 1000, // 2 minutes to start
  },
});
```

**Configuration Breakdown**:
- **testDir**: E2E tests in `tests/e2e/` (separate from unit tests)
- **timeout**: 60s per test (E2E tests are slower than unit tests)
- **retries**: 2 retries in CI (catch flaky tests), 0 locally (fail fast)
- **workers**: 1 in CI (avoid resource contention), auto locally (parallel)
- **baseURL**: Local dev server at http://localhost:5173
- **trace**: Collect detailed trace on retry (for debugging)
- **screenshot/video**: Only on failure (reduce artifacts size)
- **projects**: Run tests in Chromium, Firefox, WebKit (cross-browser)
- **webServer**: Auto-start Vite dev server before tests

---

### Step 3: Create E2E Test Directory Structure (5 min)

```bash
# Create E2E test directory
mkdir -p tests/e2e

# Create helper directory for shared utilities
mkdir -p tests/e2e/helpers
```

**Directory Structure**:
```
tests/
├── e2e/
│   ├── helpers/
│   │   ├── auth-helpers.ts      # Login/logout helpers
│   │   ├── navigation-helpers.ts # Navigation utilities
│   │   └── test-data.ts         # Test fixtures
│   ├── auth.spec.ts             # Authentication E2E tests
│   ├── flashcard-review.spec.ts # Review session E2E tests
│   ├── deck-browsing.spec.ts    # Deck management E2E tests
│   └── sample.spec.ts           # Sample test (this subtask)
└── integration/                 # Integration tests (from 10.06+)
```

---

### Step 4: Create E2E Test Helpers (20 min)

#### File: `tests/e2e/helpers/auth-helpers.ts`

```typescript
/**
 * Authentication Helpers for E2E Tests
 */

import { Page } from '@playwright/test';

export interface TestUser {
  email: string;
  password: string;
  name: string;
}

// Test user credentials (mock user from localStorage)
export const TEST_USER: TestUser = {
  email: 'test@example.com',
  password: 'Test1234!',
  name: 'Test User',
};

/**
 * Login via UI
 * @param page - Playwright page object
 * @param user - User credentials (defaults to TEST_USER)
 */
export async function loginViaUI(
  page: Page,
  user: TestUser = TEST_USER
): Promise<void> {
  // Navigate to login page
  await page.goto('/login');

  // Fill login form
  await page.getByLabel(/email/i).fill(user.email);
  await page.getByLabel(/password/i).fill(user.password);

  // Submit form
  await page.getByRole('button', { name: /log in/i }).click();

  // Wait for redirect to dashboard
  await page.waitForURL('/dashboard');
}

/**
 * Login via localStorage (faster - bypass UI)
 * @param page - Playwright page object
 */
export async function loginViaLocalStorage(page: Page): Promise<void> {
  // Navigate to app (any route triggers auth check)
  await page.goto('/');

  // Inject auth token into localStorage
  await page.evaluate(() => {
    const mockAuthState = {
      state: {
        user: {
          id: 'user-1',
          email: 'test@example.com',
          name: 'Test User',
          role: 'free',
          preferences: { dailyGoal: 15 },
        },
        token: 'mock-token-123',
        isAuthenticated: true,
      },
      version: 0,
    };
    localStorage.setItem('auth-storage', JSON.stringify(mockAuthState));
  });

  // Reload to apply auth state
  await page.reload();
}

/**
 * Logout
 * @param page - Playwright page object
 */
export async function logout(page: Page): Promise<void> {
  // Open profile dropdown
  await page.getByRole('button', { name: /profile/i }).click();

  // Click logout
  await page.getByRole('menuitem', { name: /logout/i }).click();

  // Wait for redirect to login
  await page.waitForURL('/login');
}

/**
 * Check if user is logged in
 * @param page - Playwright page object
 * @returns True if logged in, false otherwise
 */
export async function isLoggedIn(page: Page): Promise<boolean> {
  const authStorage = await page.evaluate(() => {
    return localStorage.getItem('auth-storage');
  });

  if (!authStorage) return false;

  const authState = JSON.parse(authStorage);
  return authState.state?.isAuthenticated === true;
}
```

#### File: `tests/e2e/helpers/navigation-helpers.ts`

```typescript
/**
 * Navigation Helpers for E2E Tests
 */

import { Page, expect } from '@playwright/test';

/**
 * Navigate to a route and wait for it to load
 * @param page - Playwright page object
 * @param path - Route path (e.g., '/dashboard')
 */
export async function navigateTo(page: Page, path: string): Promise<void> {
  await page.goto(path);
  await page.waitForLoadState('networkidle');
}

/**
 * Wait for element to be visible
 * @param page - Playwright page object
 * @param selector - CSS selector or text
 */
export async function waitForElement(
  page: Page,
  selector: string
): Promise<void> {
  await page.waitForSelector(selector, { state: 'visible' });
}

/**
 * Check if page contains text
 * @param page - Playwright page object
 * @param text - Text to search for (case-insensitive)
 * @returns True if found, false otherwise
 */
export async function pageContainsText(
  page: Page,
  text: string | RegExp
): Promise<boolean> {
  try {
    await expect(page.getByText(text)).toBeVisible({ timeout: 5000 });
    return true;
  } catch {
    return false;
  }
}
```

---

### Step 5: Write Sample E2E Test (15 min)

#### File: `tests/e2e/sample.spec.ts`

```typescript
/**
 * Sample E2E Test - Validates Playwright Setup
 */

import { test, expect } from '@playwright/test';
import { loginViaLocalStorage } from './helpers/auth-helpers';

test.describe('Playwright Setup Validation', () => {
  test('should load homepage', async ({ page }) => {
    await page.goto('/');
    await expect(page).toHaveTitle(/Learn Greek Easy/i);
  });

  test('should navigate to login page', async ({ page }) => {
    await page.goto('/login');

    // Check heading
    await expect(page.getByRole('heading', { name: /log in/i })).toBeVisible();

    // Check form fields exist
    await expect(page.getByLabel(/email/i)).toBeVisible();
    await expect(page.getByLabel(/password/i)).toBeVisible();
    await expect(page.getByRole('button', { name: /log in/i })).toBeVisible();
  });

  test('should access dashboard when authenticated', async ({ page }) => {
    // Login via localStorage (faster than UI login)
    await loginViaLocalStorage(page);

    // Navigate to dashboard
    await page.goto('/dashboard');

    // Verify dashboard loaded
    await expect(page.getByRole('heading', { name: /dashboard/i })).toBeVisible();
  });

  test('should redirect to login when accessing protected route unauthenticated', async ({
    page,
  }) => {
    // Clear storage (ensure logged out)
    await page.context().clearCookies();
    await page.evaluate(() => localStorage.clear());

    // Try to access protected route
    await page.goto('/dashboard');

    // Should redirect to login
    await page.waitForURL('/login');
    await expect(page.getByRole('heading', { name: /log in/i })).toBeVisible();
  });
});
```

**Run test**:
```bash
npm run test:e2e
```

---

### Step 6: Update package.json Scripts (5 min)

Add E2E test scripts to `package.json`:

```json
{
  "scripts": {
    // ... existing scripts

    // E2E test scripts
    "test:e2e": "playwright test",
    "test:e2e:headed": "playwright test --headed",
    "test:e2e:ui": "playwright test --ui",
    "test:e2e:debug": "playwright test --debug",
    "test:e2e:chromium": "playwright test --project=chromium",
    "test:e2e:firefox": "playwright test --project=firefox",
    "test:e2e:webkit": "playwright test --project=webkit",
    "test:e2e:report": "playwright show-report playwright-report"
  }
}
```

**Script Descriptions**:
- `test:e2e`: Run E2E tests headless (CI mode)
- `test:e2e:headed`: Run with browser UI visible (debugging)
- `test:e2e:ui`: Open Playwright UI (visual test runner)
- `test:e2e:debug`: Run in debug mode with Playwright Inspector
- `test:e2e:chromium/firefox/webkit`: Run in specific browser
- `test:e2e:report`: Open HTML report

---

### Step 7: Create GitHub Actions CI/CD Workflow (30 min)

#### File: `.github/workflows/test.yml`

Create at: `/Users/samosipov/Downloads/learn-greek-easy/.github/workflows/test.yml`

```yaml
name: Test Suite

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # Job 1: Unit & Integration Tests
  unit-tests:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: learn-greek-easy-frontend/package-lock.json

      - name: Install dependencies
        working-directory: learn-greek-easy-frontend
        run: npm ci

      - name: Run type check
        working-directory: learn-greek-easy-frontend
        run: npm run type-check

      - name: Run linter
        working-directory: learn-greek-easy-frontend
        run: npm run lint

      - name: Run unit tests
        working-directory: learn-greek-easy-frontend
        run: npm run test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: learn-greek-easy-frontend/coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: true

  # Job 2: E2E Tests
  e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: learn-greek-easy-frontend/package-lock.json

      - name: Install dependencies
        working-directory: learn-greek-easy-frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: learn-greek-easy-frontend
        run: npx playwright install --with-deps

      - name: Run E2E tests
        working-directory: learn-greek-easy-frontend
        run: npm run test:e2e

      - name: Upload Playwright report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: learn-greek-easy-frontend/playwright-report/
          retention-days: 7

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-results
          path: learn-greek-easy-frontend/test-results/
          retention-days: 7
```

**Workflow Features**:
- **Parallel Jobs**: Unit tests and E2E tests run in parallel (faster)
- **Type Check + Lint**: Run before tests (fail fast)
- **Coverage Upload**: Send coverage to Codecov (optional)
- **Artifact Upload**: Save Playwright reports on failure
- **Branch Protection**: Only runs on main, develop, and PRs

---

### Step 8: Validate Setup (10 min)

#### Run E2E Tests Locally

```bash
# Run in headless mode (CI mode)
npm run test:e2e

# Run with browser UI visible (debugging)
npm run test:e2e:headed

# Open Playwright UI (visual test runner)
npm run test:e2e:ui

# Run specific browser
npm run test:e2e:chromium
```

**Expected Output**:
```
Running 4 tests using 3 workers

  ✓  [chromium] › sample.spec.ts:6:3 › should load homepage (1.2s)
  ✓  [chromium] › sample.spec.ts:11:3 › should navigate to login page (0.8s)
  ✓  [firefox] › sample.spec.ts:6:3 › should load homepage (1.1s)
  ✓  [webkit] › sample.spec.ts:6:3 › should load homepage (1.3s)

  4 passed (12 tests)
```

#### View HTML Report

```bash
npm run test:e2e:report
```

Opens browser with detailed test results, screenshots, and traces.

---

## Files Created/Modified

### Files Created (5 files)

1. `playwright.config.ts` - Playwright configuration (~120 lines)
2. `tests/e2e/sample.spec.ts` - Sample E2E test (~60 lines)
3. `tests/e2e/helpers/auth-helpers.ts` - Authentication utilities (~100 lines)
4. `tests/e2e/helpers/navigation-helpers.ts` - Navigation utilities (~50 lines)
5. `.github/workflows/test.yml` - CI/CD workflow (~100 lines)

### Files Modified (1 file)

1. `package.json` - Added E2E test scripts (~10 lines)

### Total Impact

- **New Files**: 5 files (~430 lines)
- **Modified Files**: 1 file (~10 lines)
- **Dependencies Added**: 1 package (@playwright/test)
- **Browsers Installed**: 3 (Chromium, Firefox, WebKit - ~500MB)

---

## Next Steps

After completing this subtask:

1. **Write utility tests**: Proceed to 10.03 (Core Utilities Testing)
2. **Write E2E tests**: Write E2E tests in 10.09 (Core E2E User Journeys)
3. **CI/CD**: Verify GitHub Actions workflow passes
4. **Team training**: Share Playwright best practices

---

## Notes

1. **Parallel vs Sequential**:
   - Local: Tests run in parallel (faster)
   - CI: 1 worker (avoid resource contention on shared runners)

2. **Retries**:
   - CI: 2 retries (catch flaky tests)
   - Local: 0 retries (fail fast for debugging)

3. **Trace Collection**:
   - Only collected on first retry (reduces artifact size)
   - View trace: `npx playwright show-trace trace.zip`

4. **WebServer Auto-Start**:
   - Playwright auto-starts Vite dev server
   - Waits up to 2 minutes for server to be ready
   - Reuses existing server locally (faster iterations)

5. **Cross-Browser Testing**:
   - All tests run in Chromium, Firefox, WebKit
   - Mobile emulation available (uncomment in config)
   - Can run specific browser: `npm run test:e2e:chromium`

---

**Document Version**: 1.0
**Created**: 2025-11-08
**Status**: Ready for Execution
