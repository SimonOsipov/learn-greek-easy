# PreCompact Hook Setup

This document explains how to set up the PreCompact hook for session continuity. The hook saves session state before context compaction, allowing Claude to restore context in long-running sessions (especially Ralph loops).

## Overview

```
Session running → Context fills up → PreCompact hook fires → Saves handoff.yaml → Compaction → Claude reads handoff.yaml → Continues with context
```

## Files to Create

All files go in `.claude/` directory (gitignored, local only).

### 1. Create hooks directory

```bash
mkdir -p .claude/hooks
```

### 2. Create `.claude/hooks/pre-compact.sh`

```bash
#!/bin/bash
# PreCompact hook - saves session state before compaction

HANDOFF_FILE=".claude/handoff.yaml"
TIMESTAMP=$(date -Iseconds)

cat > "$HANDOFF_FILE" << EOF
# Auto-generated by PreCompact hook at: $TIMESTAMP
# Claude: READ THIS FILE to restore session context

timestamp: "$TIMESTAMP"
trigger: "pre-compact"

# Session state (populated by Claude during work)
current_task: null
stage: null  # architecture|explore|qa-plan|execution|qa-verify
completed_tasks: []

progress: |
  Session was compacted. Check Vibe Kanban for task details.
  Project ID: 9cad311d-e4b4-4861-bf89-4fe6bad3ce8b

decisions: []
blockers: []

branch: null
pr_number: null

# IMPORTANT: After reading this file, query Vibe Kanban for full task context
EOF

echo "PreCompact: Saved handoff to $HANDOFF_FILE"
```

### 3. Make hook executable

```bash
chmod +x .claude/hooks/pre-compact.sh
```

### 4. Update `.claude/settings.json`

If file exists, merge with existing content. If not, create it:

```json
{
  "enabledPlugins": {
    "ralph-wiggum@claude-plugins-official": true
  },
  "hooks": {
    "PreCompact": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "bash .claude/hooks/pre-compact.sh"
          }
        ]
      }
    ]
  }
}
```

## Testing

### Manual test

```bash
# Run the hook manually
bash .claude/hooks/pre-compact.sh

# Check output
cat .claude/handoff.yaml
```

### Test via Claude Code

```bash
# Trigger compaction
/compact

# Check if handoff was created
cat .claude/handoff.yaml
```

## How It Works

1. **PreCompact hook** runs before compaction (automatic or manual `/compact`)
2. Hook creates/updates `.claude/handoff.yaml` with timestamp
3. After compaction, Claude reads `CLAUDE.md` which instructs to check handoff
4. Claude reads handoff and queries Vibe Kanban for full context
5. Session continues with restored context

## Handoff File Format

During work, Claude should update the handoff file with actual state:

```yaml
timestamp: "2025-01-10T15:30:00+00:00"
trigger: "manual"  # or "pre-compact"

current_task: "[AUTH-03] Implement logout endpoint"
stage: "execution"
completed_tasks:
  - "[AUTH-01] Setup Auth0 integration"
  - "[AUTH-02] Implement login flow"

progress: |
  Working on logout endpoint.
  - Created /api/v1/auth/logout route
  - Added token invalidation logic
  - Tests: 3/5 passing

decisions:
  - "Using Auth0 token revocation API"
  - "Storing revoked tokens in Redis for 24h"

blockers:
  - "Need to clarify refresh token handling"

branch: "feature/auth-implementation"
pr_number: 156
```

## Troubleshooting

| Issue | Solution |
|-------|----------|
| Hook not running | Check `chmod +x` on script |
| Handoff not created | Check `.claude/settings.json` has hooks section |
| Path errors | Ensure running from project root |

## Files Summary

| File | Purpose | Git Synced |
|------|---------|------------|
| `.claude/hooks/pre-compact.sh` | Hook script | No |
| `.claude/settings.json` | Hook configuration + plugins | No |
| `.claude/handoff.yaml` | Generated state file | No |
| `docs/precompact-hook-setup.md` | This documentation | Yes |
| `CLAUDE.md` | Instructions for Claude | Yes |
| `RALPH_PROMPT.md` | Ralph loop instructions | Yes |
