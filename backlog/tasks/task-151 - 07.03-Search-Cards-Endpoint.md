---
id: task-151
title: 07.03 Search Cards Endpoint
status: To Do
assignee: []
created_date: '2025-12-08 05:21'
updated_date: '2025-12-08 05:23'
labels:
  - backend
  - api
  - cards
  - task-07
dependencies: []
priority: high
---

## Description

<!-- SECTION:DESCRIPTION:BEGIN -->
# 07.03 Search Cards Endpoint

## Overview
Implement the GET /api/v1/cards/search endpoint for searching cards by text content with optional deck filtering.

## Technical Specification

### Files to Modify

1. **Modify**: `src/api/v1/cards.py` - Add search_cards endpoint
2. **Modify**: `src/schemas/card.py` - Add CardSearchResponse schema
3. **Modify**: `src/repositories/card.py` - Add search and count_search methods

### New Schema: CardSearchResponse

Add to `src/schemas/card.py`:

```python
class CardSearchResponse(BaseModel):
    """Schema for card search results."""
    total: int
    page: int
    page_size: int
    query: str
    deck_id: UUID | None
    cards: list[CardResponse]
```

### New Repository Methods

Add to `src/repositories/card.py`:

```python
from sqlalchemy import or_

async def search(
    self,
    query_text: str,
    deck_id: UUID | None = None,
    *,
    skip: int = 0,
    limit: int = 50,
) -> list[Card]:
    """Search cards by text in front_text, back_text, example_sentence.

    Args:
        query_text: Search query (case-insensitive)
        deck_id: Optional deck filter
        skip: Pagination offset
        limit: Max results

    Returns:
        List of matching cards ordered by order_index
    """
    query = select(Card).where(
        or_(
            Card.front_text.ilike(f"%{query_text}%"),
            Card.back_text.ilike(f"%{query_text}%"),
            Card.example_sentence.ilike(f"%{query_text}%"),
        )
    )

    if deck_id:
        query = query.where(Card.deck_id == deck_id)

    query = query.order_by(Card.order_index).offset(skip).limit(limit)
    result = await self.db.execute(query)
    return list(result.scalars().all())

async def count_search(
    self,
    query_text: str,
    deck_id: UUID | None = None,
) -> int:
    """Count cards matching search query."""
    query = select(func.count()).select_from(Card).where(
        or_(
            Card.front_text.ilike(f"%{query_text}%"),
            Card.back_text.ilike(f"%{query_text}%"),
            Card.example_sentence.ilike(f"%{query_text}%"),
        )
    )

    if deck_id:
        query = query.where(Card.deck_id == deck_id)

    result = await self.db.execute(query)
    return result.scalar_one()
```

### Endpoint Implementation

Add to `src/api/v1/cards.py` (BEFORE the /{card_id} route):

```python
@router.get(
    "/search",
    response_model=CardSearchResponse,
    summary="Search cards",
    description="Search cards by Greek or English text with optional deck filtering.",
    responses={
        200: {
            "description": "Search results with pagination",
            "content": {
                "application/json": {
                    "example": {
                        "total": 5,
                        "page": 1,
                        "page_size": 20,
                        "query": "morning",
                        "deck_id": None,
                        "cards": [...]
                    }
                }
            },
        },
        404: {"description": "Deck not found (if deck_id provided)"},
        422: {"description": "Validation error"},
    },
)
async def search_cards(
    q: str = Query(
        ...,
        min_length=1,
        max_length=100,
        description="Search query (searches front_text, back_text, example_sentence)",
    ),
    deck_id: Optional[UUID] = Query(
        default=None, description="Optional: limit search to specific deck"
    ),
    page: int = Query(default=1, ge=1, description="Page number (starting from 1)"),
    page_size: int = Query(default=20, ge=1, le=50, description="Items per page (max 50)"),
    db: AsyncSession = Depends(get_db),
) -> CardSearchResponse:
    """Search cards by text content.

    Performs case-insensitive partial matching on card text fields.
    Optionally filter by deck to narrow results.
    """
    # Validate deck exists if provided
    if deck_id:
        deck_repo = DeckRepository(db)
        deck = await deck_repo.get(deck_id)
        if deck is None:
            raise DeckNotFoundException(deck_id=str(deck_id))

    card_repo = CardRepository(db)
    skip = (page - 1) * page_size

    cards = await card_repo.search(query_text=q, deck_id=deck_id, skip=skip, limit=page_size)
    total = await card_repo.count_search(query_text=q, deck_id=deck_id)

    return CardSearchResponse(
        total=total,
        page=page,
        page_size=page_size,
        query=q,
        deck_id=deck_id,
        cards=[CardResponse.model_validate(card) for card in cards],
    )
```

### API Contract

**Endpoint**: GET /api/v1/cards/search

**Query Parameters**:
| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| q | string | Yes | - | Search query (min 1 char) |
| deck_id | UUID | No | null | Optional deck filter |
| page | int | No | 1 | Page number |
| page_size | int | No | 20 | Items per page (max: 50) |

**Response** (200 OK):
```json
{
  "total": 5,
  "page": 1,
  "page_size": 20,
  "query": "morning",
  "deck_id": null,
  "cards": [...]
}
```

### Route Ordering

IMPORTANT: The /search route must be defined BEFORE the /{card_id} route in the router file, otherwise FastAPI will try to parse "search" as a UUID.

## Verification Steps

1. Test search with matching query returns results
2. Test search with non-matching query returns empty list
3. Test search with deck_id filter works
4. Test search with invalid deck_id returns 404
5. Test pagination works correctly
6. Test empty query returns 422
7. Verify search is case-insensitive
<!-- SECTION:DESCRIPTION:END -->

## Implementation Plan

<!-- SECTION:PLAN:BEGIN -->
## Implementation Plan for 07.03 Search Cards Endpoint

### Prerequisites
- [ ] Verify `src/api/v1/cards.py` exists (currently does NOT exist - needs to be created as part of task 07.01 first, OR this task must create the router file)
- [ ] Understand existing search pattern from `src/api/v1/decks.py` (search_decks endpoint)
- [ ] Understand existing repository pattern from `src/repositories/deck.py` (search and count_search methods)

**DEPENDENCY NOTE**: This task (07.03) depends on task 07.01 which creates the Card Router. If 07.01 is not complete, this task must either:
1. Wait for 07.01 to complete first, OR
2. Include the router file creation as Step 1

---

### Step 1: Add CardSearchResponse Schema
**Goal**: Create the response schema for search results

**File to modify**: `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/schemas/card.py`

**Actions**:
1. Add import for `UUID` from `uuid` (already present)
2. Add new `CardSearchResponse` schema class after `CardStudyResultResponse`:

```python
class CardSearchResponse(BaseModel):
    """Schema for card search results."""
    total: int
    page: int
    page_size: int
    query: str
    deck_id: UUID | None
    cards: list[CardResponse]
```

**Verification**: Run `poetry run python -c "from src.schemas.card import CardSearchResponse; print('OK')"` to confirm import works

---

### Step 2: Add search() Method to CardRepository
**Goal**: Implement the search logic in the repository layer

**File to modify**: `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/repositories/card.py`

**Actions**:
1. Add import for `or_` from sqlalchemy (add to existing imports)
2. Add import for `func` from sqlalchemy (add to existing imports)
3. Add `search()` method following the pattern from `DeckRepository.search()`:

```python
async def search(
    self,
    query_text: str,
    deck_id: UUID | None = None,
    *,
    skip: int = 0,
    limit: int = 50,
) -> list[Card]:
    """Search cards by text in front_text, back_text, example_sentence.

    Args:
        query_text: Search query (case-insensitive)
        deck_id: Optional deck filter
        skip: Pagination offset
        limit: Max results

    Returns:
        List of matching cards ordered by order_index
    """
    search_pattern = f"%{query_text}%"
    query = select(Card).where(
        or_(
            Card.front_text.ilike(search_pattern),
            Card.back_text.ilike(search_pattern),
            Card.example_sentence.ilike(search_pattern),
        )
    )

    if deck_id:
        query = query.where(Card.deck_id == deck_id)

    query = query.order_by(Card.order_index).offset(skip).limit(limit)
    result = await self.db.execute(query)
    return list(result.scalars().all())
```

**Key differences from DeckRepository.search()**:
- Searches 3 fields instead of 2 (front_text, back_text, example_sentence)
- Has optional `deck_id` filter parameter
- Orders by `order_index` instead of `created_at`
- No `is_active` filter (cards don't have soft delete)

**Verification**: Write a quick test or use Python REPL to verify the query builds correctly

---

### Step 3: Add count_search() Method to CardRepository
**Goal**: Implement count for pagination total

**File to modify**: `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/repositories/card.py`

**Actions**:
1. Add `count_search()` method after `search()`:

```python
async def count_search(
    self,
    query_text: str,
    deck_id: UUID | None = None,
) -> int:
    """Count cards matching search query.

    Args:
        query_text: Search query (case-insensitive)
        deck_id: Optional deck filter

    Returns:
        Total count of matching cards
    """
    search_pattern = f"%{query_text}%"
    query = select(func.count()).select_from(Card).where(
        or_(
            Card.front_text.ilike(search_pattern),
            Card.back_text.ilike(search_pattern),
            Card.example_sentence.ilike(search_pattern),
        )
    )

    if deck_id:
        query = query.where(Card.deck_id == deck_id)

    result = await self.db.execute(query)
    return result.scalar_one()
```

**Verification**: Ensure the method follows the same pattern as `DeckRepository.count_search()`

---

### Step 4: Create/Update Cards Router with Search Endpoint
**Goal**: Add the `/search` endpoint to the cards router

**File to create/modify**: `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/api/v1/cards.py`

**IMPORTANT**: The `/search` route MUST be defined BEFORE any `/{card_id}` routes, otherwise FastAPI will try to parse "search" as a UUID and return a 422 error.

**Actions**:
1. If file doesn't exist (07.01 not done), create the router file with basic structure
2. Add necessary imports:
```python
from typing import Optional
from uuid import UUID

from fastapi import APIRouter, Depends, Query
from sqlalchemy.ext.asyncio import AsyncSession

from src.core.exceptions import DeckNotFoundException
from src.db.dependencies import get_db
from src.repositories.card import CardRepository
from src.repositories.deck import DeckRepository
from src.schemas.card import CardResponse, CardSearchResponse
```

3. Add the search endpoint (place BEFORE any /{card_id} route):

```python
@router.get(
    "/search",
    response_model=CardSearchResponse,
    summary="Search cards",
    description="Search cards by Greek or English text with optional deck filtering.",
    responses={
        200: {
            "description": "Search results with pagination",
            "content": {
                "application/json": {
                    "example": {
                        "total": 5,
                        "page": 1,
                        "page_size": 20,
                        "query": "morning",
                        "deck_id": None,
                        "cards": [...]
                    }
                }
            },
        },
        404: {"description": "Deck not found (if deck_id provided)"},
        422: {"description": "Validation error"},
    },
)
async def search_cards(
    q: str = Query(
        ...,
        min_length=1,
        max_length=100,
        description="Search query (searches front_text, back_text, example_sentence)",
    ),
    deck_id: Optional[UUID] = Query(
        default=None, description="Optional: limit search to specific deck"
    ),
    page: int = Query(default=1, ge=1, description="Page number (starting from 1)"),
    page_size: int = Query(default=20, ge=1, le=50, description="Items per page (max 50)"),
    db: AsyncSession = Depends(get_db),
) -> CardSearchResponse:
    """Search cards by text content.

    Performs case-insensitive partial matching on card text fields.
    Optionally filter by deck to narrow results.
    """
    # Validate deck exists if provided
    if deck_id:
        deck_repo = DeckRepository(db)
        deck = await deck_repo.get(deck_id)
        if deck is None:
            raise DeckNotFoundException(deck_id=str(deck_id))

    card_repo = CardRepository(db)
    skip = (page - 1) * page_size

    cards = await card_repo.search(query_text=q, deck_id=deck_id, skip=skip, limit=page_size)
    total = await card_repo.count_search(query_text=q, deck_id=deck_id)

    return CardSearchResponse(
        total=total,
        page=page,
        page_size=page_size,
        query=q,
        deck_id=deck_id,
        cards=[CardResponse.model_validate(card) for card in cards],
    )
```

**Verification**:
- Check route ordering in file (search must come before /{card_id})
- Verify imports are correct

---

### Step 5: Register Cards Router (if not already done)
**Goal**: Ensure the cards router is mounted in the v1 router

**File to modify**: `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/api/v1/router.py`

**Actions**:
1. Add import: `from src.api.v1.cards import router as card_router`
2. Add router registration:
```python
v1_router.include_router(
    card_router,
    prefix="/cards",
    tags=["Cards"],
)
```

**Note**: This may already be done as part of task 07.01. Verify before modifying.

**Verification**: Check that the import and include_router are present

---

### Step 6: Manual Testing
**Goal**: Verify the endpoint works correctly

**Actions**:
1. Start the development server:
```bash
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && \
/Users/samosipov/.local/bin/poetry run uvicorn src.main:app --reload
```

2. Test search with matching query:
```bash
curl "http://localhost:8000/api/v1/cards/search?q=morning"
```

3. Test search with non-matching query:
```bash
curl "http://localhost:8000/api/v1/cards/search?q=xyznonexistent"
```

4. Test search with deck_id filter:
```bash
curl "http://localhost:8000/api/v1/cards/search?q=hello&deck_id=<valid-deck-uuid>"
```

5. Test search with invalid deck_id (should return 404):
```bash
curl "http://localhost:8000/api/v1/cards/search?q=hello&deck_id=00000000-0000-0000-0000-000000000000"
```

6. Test pagination:
```bash
curl "http://localhost:8000/api/v1/cards/search?q=a&page=2&page_size=5"
```

7. Test empty query (should return 422):
```bash
curl "http://localhost:8000/api/v1/cards/search?q="
```

8. Verify case-insensitivity:
```bash
curl "http://localhost:8000/api/v1/cards/search?q=MORNING"
```

**Verification**: All test cases pass with expected responses

---

### Step 7: Write Unit Tests (Part of task 07.07, but outline here)
**Goal**: Document test cases for future implementation

**Test file**: `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/tests/unit/api/test_cards.py`

**Test cases to implement**:
1. `test_search_cards_success` - Search returns matching cards
2. `test_search_cards_empty_results` - Non-matching query returns empty list with total=0
3. `test_search_cards_with_deck_filter` - Search with deck_id filter works
4. `test_search_cards_invalid_deck` - Invalid deck_id returns 404
5. `test_search_cards_pagination` - Pagination works correctly
6. `test_search_cards_empty_query_validation` - Empty query returns 422
7. `test_search_cards_case_insensitive` - Search is case-insensitive
8. `test_search_cards_partial_match` - Partial text matches work

---

### Estimated Effort
- **Total steps**: 7 (6 implementation + 1 testing)
- **Complexity**: Medium
- **Time estimate**: 2-3 hours
- **Dependencies**: Task 07.01 (Card Router creation) should be completed first

---

### Files Summary

| Action | File Path |
|--------|-----------|
| Modify | `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/schemas/card.py` |
| Modify | `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/repositories/card.py` |
| Create/Modify | `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/api/v1/cards.py` |
| Modify (if needed) | `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/api/v1/router.py` |

### Reference Files (Patterns to Follow)

| Reference | File Path | Why |
|-----------|-----------|-----|
| Search endpoint pattern | `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/api/v1/decks.py` | `search_decks()` function (lines 172-248) |
| Repository search pattern | `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/repositories/deck.py` | `search()` and `count_search()` methods (lines 102-155) |
| Exception handling | `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/core/exceptions.py` | `DeckNotFoundException` (lines 127-132) |
<!-- SECTION:PLAN:END -->
