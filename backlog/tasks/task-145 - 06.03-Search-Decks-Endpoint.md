---
id: task-145
title: '[06.03] Search Decks Endpoint'
status: Done
assignee: []
created_date: '2025-12-07 14:10'
updated_date: '2025-12-07 20:11'
labels:
  - backend
  - deck-api
  - task-6
dependencies: []
priority: medium
---

## Description

<!-- SECTION:DESCRIPTION:BEGIN -->
# [06.03] Search Decks Endpoint

## Goal/Purpose

Implement the `GET /api/v1/decks/search` endpoint that allows users to search for decks by name or description. This endpoint enables users to find specific decks based on keywords, supporting pagination for large result sets.

## Dependencies

| Component | Location | Usage |
|-----------|----------|-------|
| DeckRepository | `src/repositories/deck.py` | `search()` method |
| Deck Schemas | `src/schemas/deck.py` | `DeckResponse`, new `DeckSearchResponse` |
| Deck Router | `src/api/v1/decks.py` | Add endpoint to existing router |

## Implementation Steps

### Step 1: Create DeckSearchResponse Schema

Add to `src/schemas/deck.py`:

```python
class DeckSearchResponse(BaseModel):
    """Schema for deck search results."""
    total: int
    page: int
    page_size: int
    query: str
    decks: list[DeckResponse]

    model_config = ConfigDict(from_attributes=True)
```

### Step 2: Implement Search Decks Endpoint

Add to `src/api/v1/decks.py` (IMPORTANT: place BEFORE the `/{deck_id}` route):

```python
from src.schemas.deck import DeckSearchResponse

@router.get(
    "/search",
    response_model=DeckSearchResponse,
    summary="Search decks",
    description="Search for decks by name or description.",
)
async def search_decks(
    q: str = Query(
        ...,  # Required parameter
        min_length=1,
        max_length=100,
        description="Search query (searches name and description)",
    ),
    page: int = Query(default=1, ge=1, description="Page number"),
    page_size: int = Query(default=20, ge=1, le=50, description="Items per page"),
    db: AsyncSession = Depends(get_db),
) -> DeckSearchResponse:
    """
    Search decks by name or description.

    - **q**: Search query (required, 1-100 characters)
    - **page**: Page number (starting from 1)
    - **page_size**: Number of items per page (max 50)

    The search is case-insensitive and matches partial text.
    Only active decks are returned.
    """
    repo = DeckRepository(db)

    # Calculate offset
    skip = (page - 1) * page_size

    # Search decks
    decks = await repo.search(query=q, skip=skip, limit=page_size)
    total = await repo.count_search(query=q)

    return DeckSearchResponse(
        total=total,
        page=page,
        page_size=page_size,
        query=q,
        decks=[DeckResponse.model_validate(deck) for deck in decks],
    )
```

### Step 3: Verify/Add Repository Methods

Ensure `src/repositories/deck.py` has search methods:

```python
async def search(
    self,
    query: str,
    skip: int = 0,
    limit: int = 20,
) -> list[Deck]:
    """
    Search decks by name or description.

    Uses case-insensitive partial matching (ILIKE).
    Only returns active decks.
    """
    search_pattern = f"%{query}%"
    stmt = (
        select(Deck)
        .where(
            Deck.is_active == True,
            or_(
                Deck.name.ilike(search_pattern),
                Deck.description.ilike(search_pattern),
            ),
        )
        .offset(skip)
        .limit(limit)
        .order_by(Deck.name)
    )
    result = await self.session.execute(stmt)
    return list(result.scalars().all())

async def count_search(self, query: str) -> int:
    """Count decks matching search query."""
    search_pattern = f"%{query}%"
    stmt = select(func.count(Deck.id)).where(
        Deck.is_active == True,
        or_(
            Deck.name.ilike(search_pattern),
            Deck.description.ilike(search_pattern),
        ),
    )
    result = await self.session.execute(stmt)
    return result.scalar() or 0
```

### Step 4: Route Order Consideration

**CRITICAL**: The `/search` endpoint must be defined BEFORE `/{deck_id}` to avoid route conflicts.

```python
# In src/api/v1/decks.py - endpoint order:

# 1. GET / (list decks)
# 2. GET /search (search decks) <- MUST BE BEFORE /{deck_id}
# 3. GET /{deck_id} (get single deck)
# 4. POST / (create deck) [admin]
# 5. PATCH /{deck_id} (update deck) [admin]
# 6. DELETE /{deck_id} (delete deck) [admin]
```

## Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `src/api/v1/decks.py` | MODIFY | Add search_decks endpoint |
| `src/schemas/deck.py` | MODIFY | Add DeckSearchResponse schema |
| `src/repositories/deck.py` | MODIFY | Add search and count_search methods if missing |

## API Specification

### GET /api/v1/decks/search

**Query Parameters**:
| Parameter | Type | Default | Constraints | Description |
|-----------|------|---------|-------------|-------------|
| `q` | string | required | min_length=1, max_length=100 | Search query |
| `page` | int | 1 | ge=1 | Page number |
| `page_size` | int | 20 | ge=1, le=50 | Items per page |

**Response** (200 OK):
```json
{
  "total": 5,
  "page": 1,
  "page_size": 20,
  "query": "vocabulary",
  "decks": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "name": "Greek A1 Vocabulary",
      "description": "Essential beginner vocabulary",
      "level": "A1",
      "is_active": true,
      "created_at": "2024-01-15T10:30:00Z",
      "updated_at": "2024-01-15T10:30:00Z"
    }
  ]
}
```

**Error Responses**:
- 422: Missing or empty `q` parameter
- 422: `q` exceeds 100 characters

## Acceptance Criteria
<!-- AC:BEGIN -->
- [x] #1 GET /api/v1/decks/search endpoint implemented
- [x] #2 Search is case-insensitive
- [x] #3 Search matches partial text in name and description
- [x] #4 Pagination works for search results
- [x] #5 Missing `q` parameter returns 422 validation error
- [x] #6 Empty `q` parameter returns 422 validation error
- [x] #7 DeckSearchResponse schema created with query field
- [x] #8 Only active decks are returned
- [x] #9 Response includes total count for pagination

## Testing Requirements

Manual verification:
```bash
# Search for decks
curl "http://localhost:8000/api/v1/decks/search?q=vocabulary"

# Case-insensitive search
curl "http://localhost:8000/api/v1/decks/search?q=GREEK"

# With pagination
curl "http://localhost:8000/api/v1/decks/search?q=a1&page=1&page_size=5"

# Missing query (should return 422)
curl "http://localhost:8000/api/v1/decks/search"

# Empty query (should return 422)
curl "http://localhost:8000/api/v1/decks/search?q="
```
<!-- AC:END -->

## Notes

- Search uses ILIKE for case-insensitive partial matching
- Maximum page_size is 50 (lower than list endpoint for performance)
- The query parameter is echoed back in the response for client convenience
- Route must be placed before `/{deck_id}` to avoid being interpreted as a UUID
<!-- SECTION:DESCRIPTION:END -->

## Implementation Notes

<!-- SECTION:NOTES:BEGIN -->
Started implementation on 2025-12-07

PR: https://github.com/SimonOsipov/learn-greek-easy/pull/21

Implementation complete - all 14 tests passing. Awaiting QA verification.

## QA Verification Report

### Summary
- **Verified By**: QA Agent
- **Date**: 2025-12-07
- **PR**: https://github.com/SimonOsipov/learn-greek-easy/pull/21
- **Status**: PASSED - All acceptance criteria verified

### Manual API Testing Results

| Test | Expected | Result |
|------|----------|--------|
| GET /api/v1/decks/search?q=vocabulary | Returns matching deck | PASS - Found 1 deck with "vocabulary" |
| GET /api/v1/decks/search?q=GREEK | Case-insensitive match | PASS - Found 2 decks |
| GET /api/v1/decks/search?q=greek&page=1&page_size=5 | Pagination works | PASS - Returns paginated results |
| GET /api/v1/decks/search (no q) | Returns 422 | PASS - HTTP 422 with VALIDATION_ERROR |
| GET /api/v1/decks/search?q= (empty q) | Returns 422 | PASS - HTTP 422 with string_too_short |
| GET /api/v1/decks/search?q=grammar | Searches description | PASS - Found deck with "grammar" in name |

### Integration Tests Results

- **Test File**: `tests/integration/api/test_decks.py`
- **Search Endpoint Tests**: 14 tests
- **All Tests**: 20 tests in file, all PASSED
- **Full Suite**: 793 tests passed, 2 skipped (Redis availability)

### Tests Covering Acceptance Criteria

| AC | Test | Status |
|----|------|--------|
| #1 GET /api/v1/decks/search implemented | test_search_decks_success | PASS |
| #2 Case-insensitive search | test_search_decks_case_insensitive | PASS |
| #3 Partial text matching | test_search_decks_partial_match_name, test_search_decks_partial_match_description | PASS |
| #4 Pagination works | test_search_decks_pagination | PASS |
| #5 Missing q returns 422 | test_search_decks_missing_query_returns_422 | PASS |
| #6 Empty q returns 422 | test_search_decks_empty_query_returns_422 | PASS |
| #7 DeckSearchResponse with query field | test_search_decks_response_includes_query | PASS |
| #8 Only active decks returned | test_search_decks_excludes_inactive | PASS |
| #9 Response includes total count | test_search_decks_response_includes_total_count | PASS |

### Code Review Verification

1. **Endpoint Implementation** (`src/api/v1/decks.py`)
   - Route `/search` correctly placed BEFORE `/{deck_id}` (line 102-178)
   - Uses `Query(...)` for required `q` parameter with min_length=1, max_length=100
   - Pagination parameters: page (default 1, ge=1), page_size (default 20, ge=1, le=50)
   - Returns `DeckSearchResponse` with total, page, page_size, query, and decks

2. **Schema** (`src/schemas/deck.py`)
   - `DeckSearchResponse` correctly defined (line 77-84)
   - Includes `query: str` field with description

3. **Repository** (`src/repositories/deck.py`)
   - `search()` method uses ILIKE for case-insensitive partial matching
   - `count_search()` method correctly counts matching active decks
   - Both filter by `is_active == True`

### Conclusion

All 9 acceptance criteria have been verified and pass. The implementation correctly:
- Provides a search endpoint at `/api/v1/decks/search`
- Performs case-insensitive partial matching on name and description
- Supports pagination with correct defaults
- Returns 422 validation errors for missing/empty query parameters
- Only returns active decks
- Includes total count and query echo in response

**Recommendation**: Approve PR and mark task as Done.
<!-- SECTION:NOTES:END -->
