---
id: task-145
title: '[06.03] Search Decks Endpoint'
status: To Do
assignee: []
created_date: '2025-12-07 14:10'
labels:
  - backend
  - deck-api
  - task-6
dependencies: []
priority: medium
---

## Description

<!-- SECTION:DESCRIPTION:BEGIN -->
# [06.03] Search Decks Endpoint

## Goal/Purpose

Implement the `GET /api/v1/decks/search` endpoint that allows users to search for decks by name or description. This endpoint enables users to find specific decks based on keywords, supporting pagination for large result sets.

## Dependencies

| Component | Location | Usage |
|-----------|----------|-------|
| DeckRepository | `src/repositories/deck.py` | `search()` method |
| Deck Schemas | `src/schemas/deck.py` | `DeckResponse`, new `DeckSearchResponse` |
| Deck Router | `src/api/v1/decks.py` | Add endpoint to existing router |

## Implementation Steps

### Step 1: Create DeckSearchResponse Schema

Add to `src/schemas/deck.py`:

```python
class DeckSearchResponse(BaseModel):
    """Schema for deck search results."""
    total: int
    page: int
    page_size: int
    query: str
    decks: list[DeckResponse]

    model_config = ConfigDict(from_attributes=True)
```

### Step 2: Implement Search Decks Endpoint

Add to `src/api/v1/decks.py` (IMPORTANT: place BEFORE the `/{deck_id}` route):

```python
from src.schemas.deck import DeckSearchResponse

@router.get(
    "/search",
    response_model=DeckSearchResponse,
    summary="Search decks",
    description="Search for decks by name or description.",
)
async def search_decks(
    q: str = Query(
        ...,  # Required parameter
        min_length=1,
        max_length=100,
        description="Search query (searches name and description)",
    ),
    page: int = Query(default=1, ge=1, description="Page number"),
    page_size: int = Query(default=20, ge=1, le=50, description="Items per page"),
    db: AsyncSession = Depends(get_db),
) -> DeckSearchResponse:
    """
    Search decks by name or description.

    - **q**: Search query (required, 1-100 characters)
    - **page**: Page number (starting from 1)
    - **page_size**: Number of items per page (max 50)

    The search is case-insensitive and matches partial text.
    Only active decks are returned.
    """
    repo = DeckRepository(db)

    # Calculate offset
    skip = (page - 1) * page_size

    # Search decks
    decks = await repo.search(query=q, skip=skip, limit=page_size)
    total = await repo.count_search(query=q)

    return DeckSearchResponse(
        total=total,
        page=page,
        page_size=page_size,
        query=q,
        decks=[DeckResponse.model_validate(deck) for deck in decks],
    )
```

### Step 3: Verify/Add Repository Methods

Ensure `src/repositories/deck.py` has search methods:

```python
async def search(
    self,
    query: str,
    skip: int = 0,
    limit: int = 20,
) -> list[Deck]:
    """
    Search decks by name or description.

    Uses case-insensitive partial matching (ILIKE).
    Only returns active decks.
    """
    search_pattern = f"%{query}%"
    stmt = (
        select(Deck)
        .where(
            Deck.is_active == True,
            or_(
                Deck.name.ilike(search_pattern),
                Deck.description.ilike(search_pattern),
            ),
        )
        .offset(skip)
        .limit(limit)
        .order_by(Deck.name)
    )
    result = await self.session.execute(stmt)
    return list(result.scalars().all())

async def count_search(self, query: str) -> int:
    """Count decks matching search query."""
    search_pattern = f"%{query}%"
    stmt = select(func.count(Deck.id)).where(
        Deck.is_active == True,
        or_(
            Deck.name.ilike(search_pattern),
            Deck.description.ilike(search_pattern),
        ),
    )
    result = await self.session.execute(stmt)
    return result.scalar() or 0
```

### Step 4: Route Order Consideration

**CRITICAL**: The `/search` endpoint must be defined BEFORE `/{deck_id}` to avoid route conflicts.

```python
# In src/api/v1/decks.py - endpoint order:

# 1. GET / (list decks)
# 2. GET /search (search decks) <- MUST BE BEFORE /{deck_id}
# 3. GET /{deck_id} (get single deck)
# 4. POST / (create deck) [admin]
# 5. PATCH /{deck_id} (update deck) [admin]
# 6. DELETE /{deck_id} (delete deck) [admin]
```

## Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `src/api/v1/decks.py` | MODIFY | Add search_decks endpoint |
| `src/schemas/deck.py` | MODIFY | Add DeckSearchResponse schema |
| `src/repositories/deck.py` | MODIFY | Add search and count_search methods if missing |

## API Specification

### GET /api/v1/decks/search

**Query Parameters**:
| Parameter | Type | Default | Constraints | Description |
|-----------|------|---------|-------------|-------------|
| `q` | string | required | min_length=1, max_length=100 | Search query |
| `page` | int | 1 | ge=1 | Page number |
| `page_size` | int | 20 | ge=1, le=50 | Items per page |

**Response** (200 OK):
```json
{
  "total": 5,
  "page": 1,
  "page_size": 20,
  "query": "vocabulary",
  "decks": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "name": "Greek A1 Vocabulary",
      "description": "Essential beginner vocabulary",
      "level": "A1",
      "is_active": true,
      "created_at": "2024-01-15T10:30:00Z",
      "updated_at": "2024-01-15T10:30:00Z"
    }
  ]
}
```

**Error Responses**:
- 422: Missing or empty `q` parameter
- 422: `q` exceeds 100 characters

## Acceptance Criteria

- [ ] GET /api/v1/decks/search endpoint implemented
- [ ] Search is case-insensitive
- [ ] Search matches partial text in name and description
- [ ] Pagination works for search results
- [ ] Missing `q` parameter returns 422 validation error
- [ ] Empty `q` parameter returns 422 validation error
- [ ] DeckSearchResponse schema created with query field
- [ ] Only active decks are returned
- [ ] Response includes total count for pagination

## Testing Requirements

Manual verification:
```bash
# Search for decks
curl "http://localhost:8000/api/v1/decks/search?q=vocabulary"

# Case-insensitive search
curl "http://localhost:8000/api/v1/decks/search?q=GREEK"

# With pagination
curl "http://localhost:8000/api/v1/decks/search?q=a1&page=1&page_size=5"

# Missing query (should return 422)
curl "http://localhost:8000/api/v1/decks/search"

# Empty query (should return 422)
curl "http://localhost:8000/api/v1/decks/search?q="
```

## Notes

- Search uses ILIKE for case-insensitive partial matching
- Maximum page_size is 50 (lower than list endpoint for performance)
- The query parameter is echoed back in the response for client convenience
- Route must be placed before `/{deck_id}` to avoid being interpreted as a UUID
<!-- SECTION:DESCRIPTION:END -->
