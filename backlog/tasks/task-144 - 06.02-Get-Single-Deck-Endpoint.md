---
id: task-144
title: '[06.02] Get Single Deck Endpoint'
status: Done
assignee: []
created_date: '2025-12-07 14:10'
updated_date: '2025-12-08 05:14'
labels:
  - backend
  - deck-api
  - task-6
dependencies: []
priority: high
ordinal: 5000
---

## Description

<!-- SECTION:DESCRIPTION:BEGIN -->
# [06.02] Get Single Deck Endpoint

## Goal/Purpose

Implement the `GET /api/v1/decks/{id}` endpoint that returns a single deck by its UUID, including the card count. This endpoint provides detailed deck information for users who want to view a specific deck before studying it.

## Dependencies

| Component | Location | Usage |
|-----------|----------|-------|
| DeckRepository | `src/repositories/deck.py` | `get_or_404()`, `count_cards()` |
| Deck Schemas | `src/schemas/deck.py` | `DeckResponse`, new `DeckDetailResponse` |
| Exceptions | `src/core/exceptions.py` | `DeckNotFoundException` |
| Deck Router | `src/api/v1/decks.py` | Add endpoint to existing router |

## Implementation Steps

### Step 1: Create DeckDetailResponse Schema

Add to `src/schemas/deck.py`:

```python
class DeckDetailResponse(DeckResponse):
    """Schema for deck detail with card count."""
    card_count: int

    model_config = ConfigDict(from_attributes=True)
```

### Step 2: Implement Get Deck Endpoint

Add to `src/api/v1/decks.py`:

```python
from src.core.exceptions import DeckNotFoundException
from src.schemas.deck import DeckDetailResponse

@router.get(
    "/{deck_id}",
    response_model=DeckDetailResponse,
    summary="Get deck by ID",
    description="Get a single deck by its UUID, including the card count.",
    responses={
        404: {"description": "Deck not found"},
    },
)
async def get_deck(
    deck_id: UUID,
    db: AsyncSession = Depends(get_db),
) -> DeckDetailResponse:
    """
    Get a specific deck by ID with card count.

    - **deck_id**: UUID of the deck to retrieve

    Returns 404 if deck doesn't exist or is inactive.
    """
    repo = DeckRepository(db)

    # Get deck or raise 404
    deck = await repo.get(deck_id)
    if deck is None or not deck.is_active:
        raise DeckNotFoundException(deck_id=str(deck_id))

    # Get card count
    card_count = await repo.count_cards(deck_id)

    # Build response
    deck_data = DeckResponse.model_validate(deck).model_dump()
    deck_data["card_count"] = card_count

    return DeckDetailResponse(**deck_data)
```

### Step 3: Ensure count_cards Method Exists

Verify `src/repositories/deck.py` has the `count_cards` method:

```python
async def count_cards(self, deck_id: UUID) -> int:
    """Count the number of cards in a deck."""
    from src.db.models import Card
    query = select(func.count(Card.id)).where(Card.deck_id == deck_id)
    result = await self.session.execute(query)
    return result.scalar() or 0
```

### Step 4: Ensure DeckNotFoundException Exists

Verify `src/core/exceptions.py` has:

```python
class DeckNotFoundException(HTTPException):
    """Raised when a deck is not found."""
    def __init__(self, deck_id: str):
        super().__init__(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"Deck with ID {deck_id} not found",
        )
```

## Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `src/api/v1/decks.py` | MODIFY | Add get_deck endpoint |
| `src/schemas/deck.py` | MODIFY | Add DeckDetailResponse schema |
| `src/repositories/deck.py` | VERIFY | Ensure count_cards method exists |
| `src/core/exceptions.py` | VERIFY | Ensure DeckNotFoundException exists |

## API Specification

### GET /api/v1/decks/{deck_id}

**Path Parameters**:
| Parameter | Type | Description |
|-----------|------|-------------|
| `deck_id` | UUID | Deck UUID |

**Response** (200 OK):
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "Greek A1 Vocabulary",
  "description": "Essential beginner vocabulary for Greek learners",
  "level": "A1",
  "is_active": true,
  "card_count": 50,
  "created_at": "2024-01-15T10:30:00Z",
  "updated_at": "2024-01-15T10:30:00Z"
}
```

**Error Responses**:
- 404: `{"detail": "Deck with ID {deck_id} not found"}`
- 422: Invalid UUID format (automatic FastAPI validation)

## Acceptance Criteria
<!-- AC:BEGIN -->
- [x] #1 GET /api/v1/decks/{id} endpoint implemented
- [x] #2 Returns deck with card_count field
- [x] #3 Returns 404 for non-existent deck
- [x] #4 Returns 404 for inactive deck (is_active=False)
- [x] #5 DeckDetailResponse schema created with card_count field
- [x] #6 Invalid UUID returns 422 validation error
- [x] #7 Response includes all deck fields plus card_count

## Testing Requirements

Manual verification:
```bash
# Get existing deck
curl http://localhost:8000/api/v1/decks/550e8400-e29b-41d4-a716-446655440000

# Non-existent deck (should return 404)
curl http://localhost:8000/api/v1/decks/00000000-0000-0000-0000-000000000000

# Invalid UUID (should return 422)
curl http://localhost:8000/api/v1/decks/not-a-uuid
```
<!-- AC:END -->

## Notes

- This is a public endpoint (no authentication required)
- Inactive decks should return 404 to public users
- The card_count is calculated via a separate count query
- The endpoint path `/{deck_id}` must be placed after `/search` to avoid route conflicts
<!-- SECTION:DESCRIPTION:END -->

## Implementation Plan

<!-- SECTION:PLAN:BEGIN -->
## Implementation Plan

### Prerequisites
- [x] DeckRepository exists at `src/repositories/deck.py`
- [x] `count_cards` method exists in DeckRepository (lines 86-100)
- [x] DeckNotFoundException exists in `src/core/exceptions.py` (lines 127-132)
- [x] Deck router exists at `src/api/v1/decks.py` with list endpoint pattern
- [x] DeckResponse schema exists in `src/schemas/deck.py`
- [x] BaseRepository has `get()` method (line 44-58 in base.py)

### Step 1: Add DeckDetailResponse Schema
**Goal**: Create a new response schema that extends DeckResponse with card_count field

**File to modify**: `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/schemas/deck.py`

**Actions**:
1. Add `DeckDetailResponse` class after `DeckResponse` (around line 55)
2. Inherit from `DeckResponse`
3. Add `card_count: int` field

**Code to add**:
```python
class DeckDetailResponse(DeckResponse):
    """Schema for single deck response with card count."""

    card_count: int = Field(..., ge=0, description="Number of cards in the deck")
```

**Verification**: Run `poetry run python -c "from src.schemas.deck import DeckDetailResponse; print('OK')"`

---

### Step 2: Add get_deck Endpoint to Router
**Goal**: Implement GET /api/v1/decks/{deck_id} endpoint

**File to modify**: `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/api/v1/decks.py`

**Actions**:
1. Add import for `UUID` from `uuid` module (line 7 area)
2. Add import for `DeckNotFoundException` from `src.core.exceptions`
3. Add import for `DeckDetailResponse` to the existing import from `src.schemas.deck`
4. Add new endpoint function after the existing `list_decks` function

**Imports to add**:
```python
from uuid import UUID
from src.core.exceptions import DeckNotFoundException
# Update existing import:
from src.schemas.deck import DeckDetailResponse, DeckListResponse, DeckResponse
```

**Endpoint code to add** (after `list_decks` function, around line 98):
```python
@router.get(
    "/{deck_id}",
    response_model=DeckDetailResponse,
    summary="Get deck by ID",
    description="Get a single deck by its UUID, including the card count.",
    responses={
        200: {
            "description": "Deck details with card count",
            "content": {
                "application/json": {
                    "example": {
                        "id": "550e8400-e29b-41d4-a716-446655440000",
                        "name": "Greek A1 Vocabulary",
                        "description": "Essential beginner vocabulary",
                        "level": "A1",
                        "is_active": True,
                        "card_count": 50,
                        "created_at": "2024-01-15T10:30:00Z",
                        "updated_at": "2024-01-15T10:30:00Z",
                    }
                }
            },
        },
        404: {"description": "Deck not found"},
    },
)
async def get_deck(
    deck_id: UUID,
    db: AsyncSession = Depends(get_db),
) -> DeckDetailResponse:
    """Get a specific deck by ID with card count.

    This is a public endpoint that returns deck details including
    the number of cards. Inactive decks return 404.

    Args:
        deck_id: UUID of the deck to retrieve
        db: Database session (injected)

    Returns:
        DeckDetailResponse with deck details and card count

    Raises:
        DeckNotFoundException: If deck doesn't exist or is inactive

    Example:
        GET /api/v1/decks/550e8400-e29b-41d4-a716-446655440000
    """
    repo = DeckRepository(db)

    # Get deck (returns None if not found)
    deck = await repo.get(deck_id)

    # Return 404 for non-existent or inactive decks
    if deck is None or not deck.is_active:
        raise DeckNotFoundException(deck_id=str(deck_id))

    # Get card count
    card_count = await repo.count_cards(deck_id)

    # Build response with card_count
    return DeckDetailResponse(
        id=deck.id,
        name=deck.name,
        description=deck.description,
        level=deck.level,
        is_active=deck.is_active,
        created_at=deck.created_at,
        updated_at=deck.updated_at,
        card_count=card_count,
    )
```

**Verification**:
- Run `poetry run python -c "from src.api.v1.decks import get_deck; print('OK')"`
- Check OpenAPI docs at http://localhost:8000/docs

---

### Step 3: Write Integration Tests
**Goal**: Create comprehensive tests for the new endpoint

**File to create**: `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/tests/integration/api/test_decks.py`

**Actions**:
1. Create new test file for deck API endpoints
2. Write tests for all acceptance criteria

**Test code**:
```python
"""Integration tests for deck endpoints."""

from uuid import uuid4

import pytest
from httpx import AsyncClient

from tests.fixtures.deck import DeckWithCards

class TestGetDeckEndpoint:
    """Test suite for GET /api/v1/decks/{deck_id} endpoint."""

    @pytest.mark.asyncio
    async def test_get_deck_success(
        self, client: AsyncClient, deck_with_cards: DeckWithCards
    ):
        """Test successful retrieval of a deck with card count."""
        deck = deck_with_cards.deck
        expected_card_count = len(deck_with_cards.cards)

        response = await client.get(f"/api/v1/decks/{deck.id}")

        assert response.status_code == 200
        data = response.json()
        assert data["id"] == str(deck.id)
        assert data["name"] == deck.name
        assert data["description"] == deck.description
        assert data["level"] == deck.level.value
        assert data["is_active"] is True
        assert data["card_count"] == expected_card_count
        assert "created_at" in data
        assert "updated_at" in data

    @pytest.mark.asyncio
    async def test_get_deck_not_found(self, client: AsyncClient):
        """Test 404 for non-existent deck."""
        non_existent_id = uuid4()

        response = await client.get(f"/api/v1/decks/{non_existent_id}")

        assert response.status_code == 404
        data = response.json()
        assert "not found" in data["detail"].lower()

    @pytest.mark.asyncio
    async def test_get_inactive_deck_returns_404(
        self, client: AsyncClient, inactive_deck
    ):
        """Test that inactive decks return 404."""
        response = await client.get(f"/api/v1/decks/{inactive_deck.id}")

        assert response.status_code == 404

    @pytest.mark.asyncio
    async def test_get_deck_invalid_uuid(self, client: AsyncClient):
        """Test 422 for invalid UUID format."""
        response = await client.get("/api/v1/decks/not-a-valid-uuid")

        assert response.status_code == 422

    @pytest.mark.asyncio
    async def test_get_empty_deck_card_count_zero(
        self, client: AsyncClient, empty_deck
    ):
        """Test that empty deck returns card_count of 0."""
        response = await client.get(f"/api/v1/decks/{empty_deck.id}")

        assert response.status_code == 200
        data = response.json()
        assert data["card_count"] == 0
```

**Verification**: Run `poetry run pytest tests/integration/api/test_decks.py -v`

---

### Step 4: Run All Tests and Verify
**Goal**: Ensure all tests pass and no regressions

**Actions**:
1. Run the full test suite: `poetry run pytest -n auto`
2. Run specific deck tests: `poetry run pytest tests/integration/api/test_decks.py -v`
3. Check code formatting: `poetry run black src/api/v1/decks.py src/schemas/deck.py`
4. Check linting: `poetry run ruff check src/api/v1/decks.py src/schemas/deck.py`

**Verification**: All tests pass, no linting errors

---

### Step 5: Manual API Verification
**Goal**: Verify endpoint works correctly via HTTP requests

**Actions**:
1. Start dev server: `poetry run uvicorn src.main:app --reload`
2. Create a test deck with cards in the database (if not exists)
3. Test the endpoint manually:

```bash
# Get existing deck (should return 200 with card_count)
curl -X GET http://localhost:8000/api/v1/decks/{valid-deck-id}

# Non-existent deck (should return 404)
curl -X GET http://localhost:8000/api/v1/decks/00000000-0000-0000-0000-000000000000

# Invalid UUID (should return 422)
curl -X GET http://localhost:8000/api/v1/decks/not-a-uuid
```

4. Verify OpenAPI docs show the new endpoint at `/docs`

---

### Estimated Effort
- **Total steps**: 5
- **Complexity**: Low
- **Estimated time**: 30-45 minutes

### Summary of Changes

| File | Action | Lines Changed |
|------|--------|---------------|
| `src/schemas/deck.py` | ADD | ~5 lines (DeckDetailResponse class) |
| `src/api/v1/decks.py` | ADD | ~60 lines (imports + get_deck endpoint) |
| `tests/integration/api/test_decks.py` | CREATE | ~70 lines (new test file) |

### Acceptance Criteria Mapping

| AC# | Description | Implementation |
|-----|-------------|----------------|
| 1 | GET /api/v1/decks/{id} endpoint implemented | Step 2 |
| 2 | Returns deck with card_count field | Step 1 (schema) + Step 2 (endpoint) |
| 3 | Returns 404 for non-existent deck | Step 2 (check deck is None) |
| 4 | Returns 404 for inactive deck | Step 2 (check not deck.is_active) |
| 5 | DeckDetailResponse schema created | Step 1 |
| 6 | Invalid UUID returns 422 | Automatic FastAPI/Pydantic validation |
| 7 | Response includes all deck fields plus card_count | Step 1 (inherits DeckResponse) + Step 2 |
<!-- SECTION:PLAN:END -->

## Implementation Notes

<!-- SECTION:NOTES:BEGIN -->
PR: https://github.com/SimonOsipov/learn-greek-easy/pull/19

Implementation complete - all 6 integration tests pass, all 757 total tests pass

## QA Verification Report

**Date**: 2025-12-07
**QA Agent**: Claude Opus 4.5
**Status**: PASSED

### Verification Environment
- Docker Compose dev environment (learn-greek-backend-dev)
- PostgreSQL with Alembic migrations applied
- Test data: 3 decks (2 active, 1 inactive), 3 cards in first deck

### Manual API Testing Results

| Test | Description | Expected | Actual | Status |
|------|-------------|----------|--------|--------|
| Test 1 | GET /api/v1/decks/{valid_id} | 200 with card_count | 200, card_count=3 | PASS |
| Test 2 | GET deck without cards | 200, card_count=0 | 200, card_count=0 | PASS |
| Test 3 | GET inactive deck | 404 NOT_FOUND | 404 NOT_FOUND | PASS |
| Test 4 | GET non-existent UUID | 404 NOT_FOUND | 404 NOT_FOUND | PASS |
| Test 5 | GET invalid UUID format | 422 VALIDATION_ERROR | 422 VALIDATION_ERROR | PASS |

### Integration Test Results

```
tests/integration/api/test_decks.py::TestGetDeckEndpoint::test_get_deck_success PASSED
tests/integration/api/test_decks.py::TestGetDeckEndpoint::test_get_deck_not_found PASSED
tests/integration/api/test_decks.py::TestGetDeckEndpoint::test_get_inactive_deck_returns_404 PASSED
tests/integration/api/test_decks.py::TestGetDeckEndpoint::test_get_deck_invalid_uuid PASSED
tests/integration/api/test_decks.py::TestGetDeckEndpoint::test_get_empty_deck_card_count_zero PASSED
tests/integration/api/test_decks.py::TestGetDeckEndpoint::test_get_deck_includes_all_fields PASSED

6 passed in 1.18s
```

### Full Test Suite
- **779 passed**, 2 skipped (Redis not available)
- All existing tests continue to pass

### Acceptance Criteria Verification

| AC# | Criterion | Status |
|-----|-----------|--------|
| 1 | GET /api/v1/decks/{id} endpoint implemented | PASS |
| 2 | Returns deck with card_count field | PASS |
| 3 | Returns 404 for non-existent deck | PASS |
| 4 | Returns 404 for inactive deck (is_active=False) | PASS |
| 5 | DeckDetailResponse schema created with card_count field | PASS |
| 6 | Invalid UUID returns 422 validation error | PASS |
| 7 | Response includes all deck fields plus card_count | PASS |

### Code Review Summary

**Files Modified**:
- `src/schemas/deck.py`: Added DeckDetailResponse class (5 lines)
- `src/api/v1/decks.py`: Added get_deck endpoint (76 lines)
- `tests/integration/api/test_decks.py`: Created new test file (109 lines)

**Implementation Quality**:
- Schema properly extends DeckResponse with card_count field
- Endpoint uses repository pattern correctly
- Proper error handling with DeckNotFoundException
- Good docstrings and OpenAPI documentation
- Comprehensive integration tests covering all scenarios

### OpenAPI Documentation
- Endpoint properly documented at `/api/v1/decks/{deck_id}`
- DeckDetailResponse schema includes all required fields
- Example responses provided
- Error responses (404, 422) documented

### Conclusion

All acceptance criteria have been met. The implementation is complete, well-tested, and follows project conventions. Ready to mark as Done.
<!-- SECTION:NOTES:END -->
