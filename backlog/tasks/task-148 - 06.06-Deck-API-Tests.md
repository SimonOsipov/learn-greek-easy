---
id: task-148
title: '[06.06] Deck API Tests'
status: To Do
assignee: []
created_date: '2025-12-07 14:11'
labels:
  - backend
  - deck-api
  - task-6
  - testing
dependencies: []
priority: medium
---

## Description

<!-- SECTION:DESCRIPTION:BEGIN -->
# [06.06] Deck API Tests

## Goal/Purpose

Write comprehensive unit and integration tests for all deck API endpoints. Tests should cover success cases, error cases, authentication/authorization, pagination, and filtering. Target test coverage >90% for the deck router.

## Dependencies

| Component | Location | Usage |
|-----------|----------|-------|
| Deck Router | `src/api/v1/decks.py` | Endpoints under test |
| Test Factories | `tests/factories/` | `DeckFactory`, `CardFactory`, `UserFactory` |
| Test Fixtures | `tests/fixtures/` | `db_session`, `client`, `auth_headers` |
| Pytest | `pyproject.toml` | Test framework |

## Files to Create

| File | Action | Description |
|------|--------|-------------|
| `tests/unit/api/test_decks.py` | CREATE | Unit tests for all endpoints |
| `tests/integration/api/test_decks.py` | CREATE | Integration tests |
| `tests/conftest.py` | MODIFY | Add auth fixtures if missing |

## Test Coverage Requirements

| Endpoint | Test Cases Required |
|----------|---------------------|
| GET /decks | Empty list, with data, pagination, level filter, excludes inactive, invalid params |
| GET /decks/{id} | Success, not found, inactive returns 404, invalid UUID |
| GET /decks/search | By name, by description, case insensitive, empty query, missing query, pagination |
| POST /decks | Success, unauthorized, forbidden, validation error |
| PATCH /decks/{id} | Success, partial update, not found, unauthorized, forbidden |
| DELETE /decks/{id} | Success (soft delete), not found, unauthorized, forbidden |

## Unit Test Structure

Create `tests/unit/api/test_decks.py` with these test classes:

### TestListDecks
- `test_list_decks_empty` - Empty database returns empty list
- `test_list_decks_with_data` - Returns decks when data exists
- `test_list_decks_pagination` - Pagination parameters work
- `test_list_decks_filter_by_level` - Level filter returns correct decks
- `test_list_decks_excludes_inactive` - Inactive decks not returned
- `test_list_decks_invalid_pagination` - Invalid params return 422

### TestGetDeck
- `test_get_deck_success` - Valid ID returns deck with card_count
- `test_get_deck_not_found` - Invalid ID returns 404
- `test_get_deck_inactive_returns_404` - Inactive deck returns 404
- `test_get_deck_invalid_uuid` - Invalid UUID returns 422

### TestSearchDecks
- `test_search_decks_by_name` - Search by name works
- `test_search_decks_by_description` - Search by description works
- `test_search_case_insensitive` - Case-insensitive search
- `test_search_empty_query` - Empty query returns 422
- `test_search_missing_query` - Missing query returns 422

### TestCreateDeck
- `test_create_deck_success` - Admin can create deck
- `test_create_deck_unauthorized` - No auth returns 401
- `test_create_deck_forbidden` - Non-admin returns 403
- `test_create_deck_validation_error` - Invalid data returns 422

### TestUpdateDeck
- `test_update_deck_success` - Admin can update deck
- `test_update_deck_partial` - Partial updates work
- `test_update_deck_not_found` - Non-existent deck returns 404
- `test_update_deck_unauthorized` - No auth returns 401

### TestDeleteDeck
- `test_delete_deck_success` - Admin can soft delete
- `test_delete_deck_not_found` - Non-existent deck returns 404
- `test_delete_deck_unauthorized` - No auth returns 401
- `test_delete_deck_forbidden` - Non-admin returns 403

## Integration Tests

Create `tests/integration/api/test_decks.py`:
- `test_deck_crud_flow` - Full create-read-update-delete flow
- `test_deck_search_integration` - Search with real database
- `test_deck_auth_flow` - Authentication flow for admin endpoints

## Required Test Fixtures

Add to `tests/conftest.py` if missing:

```python
@pytest.fixture
async def admin_auth_headers(db_session, client):
    admin = await UserFactory.create_async(db_session, is_superuser=True)
    response = await client.post("/api/v1/auth/login", json={"email": admin.email, "password": "testpassword"})
    return {"Authorization": f"Bearer {response.json()['access_token']}"}

@pytest.fixture
async def user_auth_headers(db_session, client):
    user = await UserFactory.create_async(db_session, is_superuser=False)
    response = await client.post("/api/v1/auth/login", json={"email": user.email, "password": "testpassword"})
    return {"Authorization": f"Bearer {response.json()['access_token']}"}
```

## Acceptance Criteria

- [ ] Unit tests created for all 6 endpoints
- [ ] Tests cover success cases
- [ ] Tests cover error cases (4xx responses)
- [ ] Tests cover pagination and filtering
- [ ] Tests cover authentication/authorization
- [ ] Integration tests for full CRUD flow
- [ ] Integration tests for search functionality
- [ ] Integration tests for auth flow
- [ ] All tests passing
- [ ] Test coverage >90% for deck router

## Running Tests

```bash
# Run all deck tests
cd /path/to/backend && poetry run pytest tests/unit/api/test_decks.py tests/integration/api/test_decks.py -v

# Run with coverage
poetry run pytest tests/unit/api/test_decks.py --cov=src/api/v1/decks --cov-report=term-missing

# Run specific test class
poetry run pytest tests/unit/api/test_decks.py::TestListDecks -v
```

## Notes

- Use existing test factories from `tests/factories/`
- Follow existing test patterns in the codebase
- Tests should be independent (no execution order dependency)
- Mark async tests with `@pytest.mark.asyncio`
<!-- SECTION:DESCRIPTION:END -->
