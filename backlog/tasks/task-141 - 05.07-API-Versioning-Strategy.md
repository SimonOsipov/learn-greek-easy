---
id: task-141
title: 05.07 API Versioning Strategy
status: Done
assignee: []
created_date: '2025-12-07 09:50'
updated_date: '2025-12-07 13:23'
labels:
  - backend
  - api
  - architecture
  - task-05
  - refactoring
dependencies: []
priority: low
---

## Description

<!-- SECTION:DESCRIPTION:BEGIN -->
## API Versioning Strategy (05.07)

### Overview
Implement a proper API versioning structure to ensure:
1. Consistent `/api/v1/` prefix usage across all endpoints
2. Centralized v1 router aggregation for easier management
3. Preparedness for future v2 API without breaking changes

### Current State Analysis
- `settings.api_v1_prefix` is defined as `/api/v1` in config.py
- Auth router has **hardcoded** `prefix="/api/v1/auth"` instead of using settings
- `src/api/v1/` directory exists but lacks unified router structure
- Main.py has TODO comments for future routes (deck, card, review, progress)
- Health router is mounted at root level (not versioned - correct for health checks)

### Technical Requirements

#### 1. Create Unified V1 Router (`src/api/v1/router.py`)
Create a central v1 router that aggregates all v1 endpoints:
```python
from fastapi import APIRouter
from src.api.v1.auth import router as auth_router

v1_router = APIRouter()
v1_router.include_router(auth_router, prefix="/auth", tags=["Authentication"])
# Future: v1_router.include_router(deck_router, prefix="/decks", tags=["Decks"])
```

#### 2. Refactor Auth Router
Remove hardcoded prefix from auth router - it should be mounted with prefix by parent router:
- Change from: `prefix="/api/v1/auth"`
- Change to: `prefix=""` (or no prefix)

#### 3. Update Main.py
Mount the unified v1 router with the versioned prefix:
```python
from src.api.v1.router import v1_router
app.include_router(v1_router, prefix=settings.api_v1_prefix)
```

#### 4. Document Future V2 Strategy
Add placeholder structure and documentation comment for v2:
- Create `src/api/v2/__init__.py` (empty, placeholder)
- Add comments in main.py showing how v2 would be added

### Files to Modify
1. `src/api/v1/router.py` - **CREATE** - Central v1 router
2. `src/api/v1/auth.py` - **MODIFY** - Remove hardcoded prefix
3. `src/api/v1/__init__.py` - **MODIFY** - Export v1_router
4. `src/main.py` - **MODIFY** - Use centralized v1 router
5. `src/api/v2/__init__.py` - **CREATE** - Placeholder for future v2

### Backward Compatibility
- All existing endpoints remain at same URLs
- `/api/v1/auth/*` endpoints continue working identically
- Health endpoints stay at `/health*` (not versioned)
- Root endpoint stays at `/`

### Testing Strategy
- Run existing tests to verify no regressions
- Verify auth endpoints respond at same URLs
- Check OpenAPI docs show correct paths
<!-- SECTION:DESCRIPTION:END -->

## Acceptance Criteria
<!-- AC:BEGIN -->
- [x] #1 All v1 endpoints use centralized v1_router
- [x] #2 Auth router no longer has hardcoded /api/v1 prefix
- [x] #3 v1_router is mounted with settings.api_v1_prefix in main.py
- [x] #4 All existing auth endpoints work at same URLs
- [x] #5 Health endpoints remain at /health* (unversioned)
- [x] #6 Placeholder v2 directory created for future use
- [x] #7 All existing tests pass
- [x] #8 OpenAPI docs show correct endpoint paths
<!-- AC:END -->

## Implementation Plan

<!-- SECTION:PLAN:BEGIN -->
## Implementation Plan

### Prerequisites
- [x] Review existing codebase structure
- [x] Understand current routing setup in main.py
- [x] Analyze auth router implementation

### Step 1: Create V1 Router Module
**Goal**: Create centralized v1 router that aggregates all v1 endpoints
**Actions**:
1. Create `src/api/v1/router.py`
2. Define `v1_router = APIRouter()`
3. Import and include auth_router with `/auth` prefix
4. Add docstring explaining versioning strategy
5. Add placeholder comments for future routers (deck, card, review, progress)

**Files to create**:
- `src/api/v1/router.py`

**Verification**: File exists with proper router definition

---

### Step 2: Refactor Auth Router
**Goal**: Remove hardcoded `/api/v1/auth` prefix from auth router
**Actions**:
1. Open `src/api/v1/auth.py`
2. Change `prefix="/api/v1/auth"` to `prefix=""`
3. Keep `tags=["Authentication"]` and `responses` intact

**Files to modify**:
- `src/api/v1/auth.py`

**Verification**: Auth router has no prefix (will be added by parent)

---

### Step 3: Update V1 Package Init
**Goal**: Export v1_router from the v1 package
**Actions**:
1. Open `src/api/v1/__init__.py`
2. Import and export `v1_router` from router module
3. Keep existing `auth_router` export for backward compatibility

**Files to modify**:
- `src/api/v1/__init__.py`

**Verification**: `from src.api.v1 import v1_router` works

---

### Step 4: Create V2 Placeholder
**Goal**: Set up structure for future v2 API
**Actions**:
1. Create `src/api/v2/` directory
2. Create `src/api/v2/__init__.py` with placeholder docstring
3. Document versioning strategy in the file

**Files to create**:
- `src/api/v2/__init__.py`

**Verification**: Directory and file exist

---

### Step 5: Update Main.py
**Goal**: Use centralized v1 router instead of individual routers
**Actions**:
1. Import `v1_router` from `src.api.v1`
2. Replace `app.include_router(auth_router)` with `app.include_router(v1_router, prefix=settings.api_v1_prefix)`
3. Remove TODO comments for individual routers (they'll go in v1/router.py)
4. Add comment showing how v2 would be added in future
5. Keep health_router mounted at root (not versioned)

**Files to modify**:
- `src/main.py`

**Verification**: Application starts without errors

---

### Step 6: Run Tests
**Goal**: Ensure no regressions
**Actions**:
1. Run full test suite: `poetry run pytest -n auto`
2. Verify all auth tests pass
3. Check for any path-related failures

**Verification**: All tests pass

---

### Step 7: Manual Verification
**Goal**: Verify endpoints work correctly
**Actions**:
1. Start dev server
2. Check `/api/v1/auth/me` returns 401 (unauthenticated)
3. Check `/health` works
4. Check `/docs` shows correct paths
5. Verify root endpoint `/` returns API info

**Verification**: All endpoints respond correctly

---

### Estimated Effort
- Total steps: 7
- Complexity: Low
- Estimated time: 30-45 minutes
<!-- SECTION:PLAN:END -->

## Implementation Notes

<!-- SECTION:NOTES:BEGIN -->
## Implementation Notes

PR: https://github.com/SimonOsipov/learn-greek-easy/pull/16

Branch: feature/task-141-api-versioning

Files changed:
- `src/api/v1/router.py` (NEW) - Centralized v1 router
- `src/api/v1/auth.py` - Removed hardcoded prefix
- `src/api/v1/__init__.py` - Export v1_router
- `src/api/v2/__init__.py` (NEW) - Placeholder for v2
- `src/main.py` - Use centralized router

All 772 tests pass locally.

## QA Verification

### CI/CD Results (PR #16)
- Alembic Migration Check: PASS
- Backend Lint & Format: PASS
- Backend Tests: PASS
- E2E Tests: PASS
- Frontend Lint & Format: PASS
- Unit & Integration Tests: PASS

### All Acceptance Criteria Met
1. ✅ All v1 endpoints use centralized v1_router
2. ✅ Auth router no longer has hardcoded /api/v1 prefix
3. ✅ v1_router is mounted with settings.api_v1_prefix in main.py
4. ✅ All existing auth endpoints work at same URLs
5. ✅ Health endpoints remain at /health* (unversioned)
6. ✅ Placeholder v2 directory created for future use
7. ✅ All existing tests pass (772 passed)
8. ✅ OpenAPI docs show correct endpoint paths
<!-- SECTION:NOTES:END -->
