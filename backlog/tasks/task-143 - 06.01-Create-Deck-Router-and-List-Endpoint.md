---
id: task-143
title: '[06.01] Create Deck Router and List Endpoint'
status: In Progress
assignee: []
created_date: '2025-12-07 14:10'
updated_date: '2025-12-07 14:25'
labels:
  - backend
  - deck-api
  - task-6
dependencies: []
priority: high
---

## Description

<!-- SECTION:DESCRIPTION:BEGIN -->
# [06.01] Create Deck Router and List Endpoint

## Goal/Purpose

Create the base router file for deck API endpoints and implement the `GET /api/v1/decks` endpoint with pagination and level filtering. This is the foundational task that establishes the deck router structure and the primary public endpoint for browsing decks.

## Dependencies

| Component | Location | Usage |
|-----------|----------|-------|
| DeckRepository | `src/repositories/deck.py` | `list_active()` method |
| Deck Schemas | `src/schemas/deck.py` | `DeckListResponse`, `DeckResponse` |
| Database | `src/db/dependencies.py` | `get_db` for session injection |
| Router | `src/api/v1/router.py` | Mount deck router at `/decks` |

## Implementation Steps

### Step 1: Create the Deck Router File

Create `src/api/v1/decks.py`:

```python
"""Deck API endpoints."""
from typing import Optional
from uuid import UUID

from fastapi import APIRouter, Depends, Query, status
from sqlalchemy.ext.asyncio import AsyncSession

from src.db.dependencies import get_db
from src.db.models import DeckLevel
from src.repositories.deck import DeckRepository
from src.schemas.deck import DeckListResponse, DeckResponse

router = APIRouter(
    tags=["Decks"],
    responses={
        422: {"description": "Validation error"},
    },
)
```

### Step 2: Implement List Decks Endpoint

Add the `GET /decks` endpoint:

```python
@router.get(
    "",
    response_model=DeckListResponse,
    summary="List active decks",
    description="Get a paginated list of all active decks with optional level filtering.",
)
async def list_decks(
    page: int = Query(default=1, ge=1, description="Page number"),
    page_size: int = Query(default=20, ge=1, le=100, description="Items per page"),
    level: Optional[DeckLevel] = Query(default=None, description="Filter by CEFR level"),
    db: AsyncSession = Depends(get_db),
) -> DeckListResponse:
    """
    List all active decks with pagination and optional filtering.

    - **page**: Page number (starting from 1)
    - **page_size**: Number of items per page (max 100)
    - **level**: Optional CEFR level filter (A1, A2, B1, B2, C1, C2)
    """
    repo = DeckRepository(db)

    # Calculate offset from page number
    skip = (page - 1) * page_size

    # Get decks and total count
    decks = await repo.list_active(skip=skip, limit=page_size, level=level)
    total = await repo.count_active(level=level)

    return DeckListResponse(
        total=total,
        page=page,
        page_size=page_size,
        decks=[DeckResponse.model_validate(deck) for deck in decks],
    )
```

### Step 3: Add count_active Method to DeckRepository (if missing)

Check `src/repositories/deck.py`. If `count_active` method doesn't exist, add it:

```python
async def count_active(self, level: Optional[DeckLevel] = None) -> int:
    """Count all active decks, optionally filtered by level."""
    query = select(func.count(Deck.id)).where(Deck.is_active == True)
    if level:
        query = query.where(Deck.level == level)
    result = await self.session.execute(query)
    return result.scalar() or 0
```

### Step 4: Register Router in v1_router

Modify `src/api/v1/router.py`:

```python
from fastapi import APIRouter

from src.api.v1.auth import router as auth_router
from src.api.v1.decks import router as deck_router  # ADD THIS

v1_router = APIRouter(prefix="/v1")

v1_router.include_router(auth_router, prefix="/auth", tags=["Authentication"])
v1_router.include_router(deck_router, prefix="/decks", tags=["Decks"])  # ADD THIS
```

### Step 5: Verify DeckListResponse Schema

Ensure `src/schemas/deck.py` has the DeckListResponse schema:

```python
class DeckListResponse(BaseModel):
    """Schema for paginated deck list response."""
    total: int
    page: int
    page_size: int
    decks: list[DeckResponse]
```

## Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `src/api/v1/decks.py` | CREATE | New deck router with list endpoint |
| `src/api/v1/router.py` | MODIFY | Register deck router |
| `src/repositories/deck.py` | MODIFY (if needed) | Add count_active method |
| `src/schemas/deck.py` | VERIFY | Ensure DeckListResponse exists |

## API Specification

### GET /api/v1/decks

**Query Parameters**:
| Parameter | Type | Default | Constraints | Description |
|-----------|------|---------|-------------|-------------|
| `page` | int | 1 | ge=1 | Page number |
| `page_size` | int | 20 | ge=1, le=100 | Items per page |
| `level` | DeckLevel | null | A1-C2 | Filter by CEFR level |

**Response** (200 OK):
```json
{
  "total": 42,
  "page": 1,
  "page_size": 20,
  "decks": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "name": "Greek A1 Vocabulary",
      "description": "Essential beginner vocabulary",
      "level": "A1",
      "is_active": true,
      "created_at": "2024-01-15T10:30:00Z",
      "updated_at": "2024-01-15T10:30:00Z"
    }
  ]
}
```

## Acceptance Criteria
<!-- AC:BEGIN -->
- [ ] #1 Router file `src/api/v1/decks.py` created with proper structure
- [ ] #2 GET /api/v1/decks endpoint implemented
- [ ] #3 Pagination works correctly (page, page_size query params)
- [ ] #4 Level filter works correctly (optional level query param)
- [ ] #5 Returns DeckListResponse with total count
- [ ] #6 Router registered in v1_router at `/decks` prefix
- [ ] #7 Only active decks are returned (is_active=True)
- [ ] #8 Invalid pagination params return 422 validation error

## Testing Requirements

Manual verification:
```bash
# List all decks
curl http://localhost:8000/api/v1/decks

# With pagination
curl "http://localhost:8000/api/v1/decks?page=2&page_size=10"

# With level filter
curl "http://localhost:8000/api/v1/decks?level=A1"

# Combined
curl "http://localhost:8000/api/v1/decks?page=1&page_size=5&level=B1"
```
<!-- AC:END -->

## Notes

- This is a public endpoint (no authentication required)
- Only returns active decks (`is_active=True`)
- Maximum page size is 100 to prevent performance issues
- Page numbering starts at 1 (not 0)
<!-- SECTION:DESCRIPTION:END -->

## Implementation Plan

<!-- SECTION:PLAN:BEGIN -->
## Implementation Plan

### Prerequisites Analysis

| Component | Status | Location | Notes |
|-----------|--------|----------|-------|
| DeckRepository | EXISTS | `src/repositories/deck.py` | Has `list_active()`, MISSING `count_active()` |
| DeckResponse schema | EXISTS | `src/schemas/deck.py` | Lines 45-54 |
| DeckListResponse schema | EXISTS | `src/schemas/deck.py` | Lines 62-68 |
| DeckLevel enum | EXISTS | `src/db/models.py` | Lines 41-49 (A1-C2) |
| get_db dependency | EXISTS | `src/db/dependencies.py` | Lines 13-52 |
| v1_router | EXISTS | `src/api/v1/router.py` | Has placeholder comments for decks |

### Step 1: Add count_active Method to DeckRepository

**Goal**: Add the missing `count_active()` method to support pagination total count.

**File**: `src/repositories/deck.py`

**Actions**:
1. Add import for `func` from sqlalchemy (already imported at line 5)
2. Add `count_active()` method after `list_active()` method (around line 48)

**Code to add** (after line 47, before `get_with_cards` method):

```python
async def count_active(self, level: DeckLevel | None = None) -> int:
    """Count all active decks, optionally filtered by level.

    Args:
        level: Optional CEFR level filter

    Returns:
        Total number of active decks matching criteria
    """
    query = select(func.count(Deck.id)).where(Deck.is_active.is_(True))
    if level is not None:
        query = query.where(Deck.level == level)
    result = await self.db.execute(query)
    return result.scalar() or 0
```

**Verification**:
- Run `poetry run pytest tests/unit/repositories/ -v` to ensure no regressions
- Check method signature matches `list_active()` pattern

---

### Step 2: Create Deck Router File

**Goal**: Create `src/api/v1/decks.py` with the list decks endpoint.

**File**: `src/api/v1/decks.py` (NEW FILE)

**Actions**:
1. Create file with imports following auth.py pattern
2. Create router instance with appropriate tags and responses
3. Implement `GET /` (list_decks) endpoint

**Full file content**:

```python
"""Deck API endpoints.

This module provides HTTP endpoints for deck operations including
listing decks with pagination and filtering.
"""

from typing import Optional

from fastapi import APIRouter, Depends, Query
from sqlalchemy.ext.asyncio import AsyncSession

from src.db.dependencies import get_db
from src.db.models import DeckLevel
from src.repositories.deck import DeckRepository
from src.schemas.deck import DeckListResponse, DeckResponse

router = APIRouter(
    # Note: prefix is set by parent router in v1/router.py
    # This router is mounted at /decks under the /api/v1 prefix
    tags=["Decks"],
    responses={
        422: {"description": "Validation error"},
    },
)

@router.get(
    "",
    response_model=DeckListResponse,
    summary="List active decks",
    description="Get a paginated list of all active decks with optional level filtering.",
    responses={
        200: {
            "description": "Paginated list of active decks",
            "content": {
                "application/json": {
                    "example": {
                        "total": 42,
                        "page": 1,
                        "page_size": 20,
                        "decks": [
                            {
                                "id": "550e8400-e29b-41d4-a716-446655440000",
                                "name": "Greek A1 Vocabulary",
                                "description": "Essential beginner vocabulary",
                                "level": "A1",
                                "is_active": True,
                                "created_at": "2024-01-15T10:30:00Z",
                                "updated_at": "2024-01-15T10:30:00Z",
                            }
                        ],
                    }
                }
            },
        },
    },
)
async def list_decks(
    page: int = Query(default=1, ge=1, description="Page number (starting from 1)"),
    page_size: int = Query(
        default=20, ge=1, le=100, description="Items per page (max 100)"
    ),
    level: Optional[DeckLevel] = Query(
        default=None, description="Filter by CEFR level (A1, A2, B1, B2, C1, C2)"
    ),
    db: AsyncSession = Depends(get_db),
) -> DeckListResponse:
    """List all active decks with pagination and optional filtering.

    This is a public endpoint that returns only active decks.
    Use the level parameter to filter by CEFR proficiency level.

    Args:
        page: Page number starting from 1
        page_size: Number of items per page (1-100)
        level: Optional CEFR level filter
        db: Database session (injected)

    Returns:
        DeckListResponse with total count and paginated deck list

    Example:
        GET /api/v1/decks?page=1&page_size=10&level=A1
    """
    repo = DeckRepository(db)

    # Calculate offset from page number
    skip = (page - 1) * page_size

    # Get decks and total count
    decks = await repo.list_active(skip=skip, limit=page_size, level=level)
    total = await repo.count_active(level=level)

    return DeckListResponse(
        total=total,
        page=page,
        page_size=page_size,
        decks=[DeckResponse.model_validate(deck) for deck in decks],
    )
```

**Verification**:
- File compiles without import errors
- Endpoint signature matches API specification

---

### Step 3: Register Deck Router in v1_router

**Goal**: Mount the deck router at `/decks` prefix.

**File**: `src/api/v1/router.py`

**Actions**:
1. Add import for deck router (after auth_router import, line 25)
2. Register deck router with include_router (after auth_router registration, around line 38)

**Changes**:

Line 25 (after existing import):
```python
from src.api.v1.auth import router as auth_router
from src.api.v1.decks import router as deck_router  # ADD THIS
```

After line 37 (after auth_router include):
```python
# =============================================================================
# Deck Routes
# =============================================================================
v1_router.include_router(
    deck_router,
    prefix="/decks",
    tags=["Decks"],
)
```

**Note**: Remove or update the placeholder comment at lines 44-45.

**Verification**:
- Application starts without errors
- `/api/v1/decks` route appears in OpenAPI docs

---

### Step 4: Manual API Testing

**Goal**: Verify the endpoint works correctly.

**Actions**:

1. Start the backend server:
```bash
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && \
/Users/samosipov/.local/bin/poetry run uvicorn src.main:app --reload
```

2. Test basic list:
```bash
curl http://localhost:8000/api/v1/decks
```

3. Test with pagination:
```bash
curl "http://localhost:8000/api/v1/decks?page=2&page_size=10"
```

4. Test with level filter:
```bash
curl "http://localhost:8000/api/v1/decks?level=A1"
```

5. Test combined parameters:
```bash
curl "http://localhost:8000/api/v1/decks?page=1&page_size=5&level=B1"
```

6. Test validation errors (should return 422):
```bash
curl "http://localhost:8000/api/v1/decks?page=0"      # page < 1
curl "http://localhost:8000/api/v1/decks?page_size=0" # page_size < 1
curl "http://localhost:8000/api/v1/decks?page_size=200" # page_size > 100
curl "http://localhost:8000/api/v1/decks?level=X1"    # invalid level
```

7. Verify OpenAPI documentation at: `http://localhost:8000/docs`

**Verification Checklist**:
- [ ] Empty response returns `{"total": 0, "page": 1, "page_size": 20, "decks": []}`
- [ ] Pagination calculates offset correctly: `skip = (page - 1) * page_size`
- [ ] Level filter only returns decks with matching level
- [ ] Invalid params return 422 with validation details
- [ ] Only active decks are returned (is_active=True)

---

### Step 5: Run Existing Tests

**Goal**: Ensure no regressions were introduced.

**Actions**:
```bash
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && \
/Users/samosipov/.local/bin/poetry run pytest -x -v
```

**Verification**:
- All existing tests pass
- No import errors in test collection

---

## Summary of Files

| File | Action | Description |
|------|--------|-------------|
| `src/repositories/deck.py` | MODIFY | Add `count_active()` method |
| `src/api/v1/decks.py` | CREATE | New deck router with list endpoint |
| `src/api/v1/router.py` | MODIFY | Register deck router at `/decks` |

## Estimated Effort

- **Total steps**: 5
- **Complexity**: Low-Medium
- **Estimated time**: 30-45 minutes

## Dependencies

This task has no blocking dependencies. All required components exist:
- DeckRepository with list_active() method
- Deck schemas (DeckResponse, DeckListResponse)
- Database dependencies (get_db)
- DeckLevel enum

## Notes

- This is a **public endpoint** - no authentication required
- Only returns **active decks** (is_active=True)
- Maximum page size is **100** to prevent performance issues
- Page numbering starts at **1** (not 0)
- Response format follows existing API patterns
<!-- SECTION:PLAN:END -->
