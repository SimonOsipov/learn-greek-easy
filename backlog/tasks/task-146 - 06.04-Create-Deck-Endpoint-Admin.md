---
id: task-146
title: '[06.04] Create Deck Endpoint (Admin)'
status: To Do
assignee: []
created_date: '2025-12-07 14:10'
labels:
  - backend
  - deck-api
  - task-6
dependencies: []
priority: medium
---

## Description

<!-- SECTION:DESCRIPTION:BEGIN -->
# [06.04] Create Deck Endpoint (Admin)

## Goal/Purpose

Implement the `POST /api/v1/decks` endpoint that allows administrators (superusers) to create new decks. This is an admin-only endpoint that requires authentication and superuser privileges.

## Dependencies

| Component | Location | Usage |
|-----------|----------|-------|
| DeckRepository | `src/repositories/deck.py` | `create()` method |
| Deck Schemas | `src/schemas/deck.py` | `DeckCreate`, `DeckResponse` |
| Auth Dependencies | `src/core/dependencies.py` | `get_current_superuser` |
| Deck Router | `src/api/v1/decks.py` | Add endpoint to existing router |

## Implementation Steps

### Step 1: Import Authentication Dependencies

Update imports in `src/api/v1/decks.py`:

```python
from src.core.dependencies import get_current_superuser
from src.db.models import User
from src.schemas.deck import DeckCreate
```

### Step 2: Implement Create Deck Endpoint

Add to `src/api/v1/decks.py`:

```python
@router.post(
    "",
    response_model=DeckResponse,
    status_code=status.HTTP_201_CREATED,
    summary="Create a new deck",
    description="Create a new deck. Requires admin privileges.",
    responses={
        401: {"description": "Not authenticated"},
        403: {"description": "Not authorized (requires superuser)"},
    },
)
async def create_deck(
    deck_data: DeckCreate,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_superuser),
) -> DeckResponse:
    """
    Create a new deck.

    Requires superuser privileges.

    - **name**: Deck name (required, max 255 characters)
    - **description**: Deck description (optional)
    - **level**: CEFR level (required: A1, A2, B1, B2, C1, C2)
    """
    repo = DeckRepository(db)

    # Create the deck
    deck = await repo.create(deck_data)

    # Commit the transaction
    await db.commit()
    await db.refresh(deck)

    return DeckResponse.model_validate(deck)
```

### Step 3: Verify DeckCreate Schema

Ensure `src/schemas/deck.py` has the DeckCreate schema:

```python
class DeckCreate(BaseModel):
    """Schema for creating a new deck."""
    name: str = Field(..., min_length=1, max_length=255)
    description: Optional[str] = Field(default=None, max_length=2000)
    level: DeckLevel

    model_config = ConfigDict(from_attributes=True)
```

### Step 4: Verify get_current_superuser Dependency

Ensure `src/core/dependencies.py` has:

```python
async def get_current_superuser(
    current_user: User = Depends(get_current_user),
) -> User:
    """Dependency that requires superuser privileges."""
    if not current_user.is_superuser:
        raise ForbiddenException()
    return current_user
```

### Step 5: Verify Repository Create Method

Ensure `src/repositories/deck.py` has:

```python
async def create(self, data: DeckCreate) -> Deck:
    """Create a new deck."""
    deck = Deck(
        name=data.name,
        description=data.description,
        level=data.level,
        is_active=True,  # Default to active
    )
    self.session.add(deck)
    return deck
```

## Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `src/api/v1/decks.py` | MODIFY | Add create_deck endpoint |
| `src/schemas/deck.py` | VERIFY | Ensure DeckCreate schema exists |
| `src/core/dependencies.py` | VERIFY | Ensure get_current_superuser exists |
| `src/repositories/deck.py` | VERIFY | Ensure create method exists |

## API Specification

### POST /api/v1/decks

**Authentication**: Required (Bearer token)
**Authorization**: Superuser only

**Request Headers**:
```
Authorization: Bearer <access_token>
Content-Type: application/json
```

**Request Body**:
```json
{
  "name": "Greek B1 Grammar",
  "description": "Intermediate grammar concepts for Greek learners",
  "level": "B1"
}
```

**Response** (201 Created):
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "Greek B1 Grammar",
  "description": "Intermediate grammar concepts for Greek learners",
  "level": "B1",
  "is_active": true,
  "created_at": "2024-01-15T10:30:00Z",
  "updated_at": "2024-01-15T10:30:00Z"
}
```

**Error Responses**:
- 401: `{"detail": "Not authenticated"}`
- 403: `{"detail": "Forbidden"}` (not a superuser)
- 422: Validation errors (missing name, invalid level, etc.)

## Acceptance Criteria

- [ ] POST /api/v1/decks endpoint implemented
- [ ] Returns 201 Created with created deck
- [ ] Returns 401 if not authenticated
- [ ] Returns 403 if authenticated but not superuser
- [ ] Validates DeckCreate schema (name required, valid level)
- [ ] Sets is_active=True by default
- [ ] Generates UUID for new deck
- [ ] Sets created_at and updated_at timestamps
- [ ] Commits transaction properly

## Testing Requirements

Manual verification:
```bash
# Get admin token first
TOKEN=$(curl -s -X POST "http://localhost:8000/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"email": "admin@example.com", "password": "adminpass"}' \
  | jq -r '.access_token')

# Create deck as admin
curl -X POST "http://localhost:8000/api/v1/decks" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test Deck",
    "description": "A test deck",
    "level": "A1"
  }'

# Without auth (should return 401)
curl -X POST "http://localhost:8000/api/v1/decks" \
  -H "Content-Type: application/json" \
  -d '{"name": "Test", "level": "A1"}'

# As non-admin (should return 403)
USER_TOKEN=$(curl -s -X POST "http://localhost:8000/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"email": "user@example.com", "password": "userpass"}' \
  | jq -r '.access_token')

curl -X POST "http://localhost:8000/api/v1/decks" \
  -H "Authorization: Bearer $USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name": "Test", "level": "A1"}'

# Invalid data (should return 422)
curl -X POST "http://localhost:8000/api/v1/decks" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"description": "Missing name"}'
```

## Notes

- Only superusers can create decks (regular authenticated users cannot)
- New decks are automatically set to `is_active=True`
- The description field is optional
- Level must be a valid CEFR level (A1, A2, B1, B2, C1, C2)
- UUID is auto-generated by the database
- Timestamps are auto-generated
<!-- SECTION:DESCRIPTION:END -->
