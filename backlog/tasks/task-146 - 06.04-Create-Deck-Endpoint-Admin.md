---
id: task-146
title: '[06.04] Create Deck Endpoint (Admin)'
status: In Progress
assignee: []
created_date: '2025-12-07 14:10'
updated_date: '2025-12-07 20:24'
labels:
  - backend
  - deck-api
  - task-6
dependencies: []
priority: medium
---

## Description

<!-- SECTION:DESCRIPTION:BEGIN -->
# [06.04] Create Deck Endpoint (Admin)

## Goal/Purpose

Implement the `POST /api/v1/decks` endpoint that allows administrators (superusers) to create new decks. This is an admin-only endpoint that requires authentication and superuser privileges.

## Dependencies

| Component | Location | Usage |
|-----------|----------|-------|
| DeckRepository | `src/repositories/deck.py` | `create()` method |
| Deck Schemas | `src/schemas/deck.py` | `DeckCreate`, `DeckResponse` |
| Auth Dependencies | `src/core/dependencies.py` | `get_current_superuser` |
| Deck Router | `src/api/v1/decks.py` | Add endpoint to existing router |

## Implementation Steps

### Step 1: Import Authentication Dependencies

Update imports in `src/api/v1/decks.py`:

```python
from src.core.dependencies import get_current_superuser
from src.db.models import User
from src.schemas.deck import DeckCreate
```

### Step 2: Implement Create Deck Endpoint

Add to `src/api/v1/decks.py`:

```python
@router.post(
    "",
    response_model=DeckResponse,
    status_code=status.HTTP_201_CREATED,
    summary="Create a new deck",
    description="Create a new deck. Requires admin privileges.",
    responses={
        401: {"description": "Not authenticated"},
        403: {"description": "Not authorized (requires superuser)"},
    },
)
async def create_deck(
    deck_data: DeckCreate,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_superuser),
) -> DeckResponse:
    """
    Create a new deck.

    Requires superuser privileges.

    - **name**: Deck name (required, max 255 characters)
    - **description**: Deck description (optional)
    - **level**: CEFR level (required: A1, A2, B1, B2, C1, C2)
    """
    repo = DeckRepository(db)

    # Create the deck
    deck = await repo.create(deck_data)

    # Commit the transaction
    await db.commit()
    await db.refresh(deck)

    return DeckResponse.model_validate(deck)
```

### Step 3: Verify DeckCreate Schema

Ensure `src/schemas/deck.py` has the DeckCreate schema:

```python
class DeckCreate(BaseModel):
    """Schema for creating a new deck."""
    name: str = Field(..., min_length=1, max_length=255)
    description: Optional[str] = Field(default=None, max_length=2000)
    level: DeckLevel

    model_config = ConfigDict(from_attributes=True)
```

### Step 4: Verify get_current_superuser Dependency

Ensure `src/core/dependencies.py` has:

```python
async def get_current_superuser(
    current_user: User = Depends(get_current_user),
) -> User:
    """Dependency that requires superuser privileges."""
    if not current_user.is_superuser:
        raise ForbiddenException()
    return current_user
```

### Step 5: Verify Repository Create Method

Ensure `src/repositories/deck.py` has:

```python
async def create(self, data: DeckCreate) -> Deck:
    """Create a new deck."""
    deck = Deck(
        name=data.name,
        description=data.description,
        level=data.level,
        is_active=True,  # Default to active
    )
    self.session.add(deck)
    return deck
```

## Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `src/api/v1/decks.py` | MODIFY | Add create_deck endpoint |
| `src/schemas/deck.py` | VERIFY | Ensure DeckCreate schema exists |
| `src/core/dependencies.py` | VERIFY | Ensure get_current_superuser exists |
| `src/repositories/deck.py` | VERIFY | Ensure create method exists |

## API Specification

### POST /api/v1/decks

**Authentication**: Required (Bearer token)
**Authorization**: Superuser only

**Request Headers**:
```
Authorization: Bearer <access_token>
Content-Type: application/json
```

**Request Body**:
```json
{
  "name": "Greek B1 Grammar",
  "description": "Intermediate grammar concepts for Greek learners",
  "level": "B1"
}
```

**Response** (201 Created):
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "Greek B1 Grammar",
  "description": "Intermediate grammar concepts for Greek learners",
  "level": "B1",
  "is_active": true,
  "created_at": "2024-01-15T10:30:00Z",
  "updated_at": "2024-01-15T10:30:00Z"
}
```

**Error Responses**:
- 401: `{"detail": "Not authenticated"}`
- 403: `{"detail": "Forbidden"}` (not a superuser)
- 422: Validation errors (missing name, invalid level, etc.)

## Acceptance Criteria
<!-- AC:BEGIN -->
- [ ] #1 POST /api/v1/decks endpoint implemented
- [ ] #2 Returns 201 Created with created deck
- [ ] #3 Returns 401 if not authenticated
- [ ] #4 Returns 403 if authenticated but not superuser
- [ ] #5 Validates DeckCreate schema (name required, valid level)
- [ ] #6 Sets is_active=True by default
- [ ] #7 Generates UUID for new deck
- [ ] #8 Sets created_at and updated_at timestamps
- [ ] #9 Commits transaction properly

## Testing Requirements

Manual verification:
```bash
# Get admin token first
TOKEN=$(curl -s -X POST "http://localhost:8000/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"email": "admin@example.com", "password": "adminpass"}' \
  | jq -r '.access_token')

# Create deck as admin
curl -X POST "http://localhost:8000/api/v1/decks" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test Deck",
    "description": "A test deck",
    "level": "A1"
  }'

# Without auth (should return 401)
curl -X POST "http://localhost:8000/api/v1/decks" \
  -H "Content-Type: application/json" \
  -d '{"name": "Test", "level": "A1"}'

# As non-admin (should return 403)
USER_TOKEN=$(curl -s -X POST "http://localhost:8000/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"email": "user@example.com", "password": "userpass"}' \
  | jq -r '.access_token')

curl -X POST "http://localhost:8000/api/v1/decks" \
  -H "Authorization: Bearer $USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name": "Test", "level": "A1"}'

# Invalid data (should return 422)
curl -X POST "http://localhost:8000/api/v1/decks" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"description": "Missing name"}'
```
<!-- AC:END -->

## Notes

- Only superusers can create decks (regular authenticated users cannot)
- New decks are automatically set to `is_active=True`
- The description field is optional
- Level must be a valid CEFR level (A1, A2, B1, B2, C1, C2)
- UUID is auto-generated by the database
- Timestamps are auto-generated
<!-- SECTION:DESCRIPTION:END -->

## Implementation Plan

<!-- SECTION:PLAN:BEGIN -->
## Implementation Plan

### Prerequisites
- [x] DeckRepository exists at `src/repositories/deck.py` with inherited `create()` method from BaseRepository
- [x] DeckCreate schema exists at `src/schemas/deck.py` (lines 30-33)
- [x] get_current_superuser dependency exists at `src/core/dependencies.py` (lines 105-134)
- [x] Deck router exists at `src/api/v1/decks.py` with existing endpoints

### Step 1: Update Imports in Deck Router

**Goal**: Add necessary imports for authentication and HTTP status codes

**File**: `src/api/v1/decks.py`

**Actions**:
1. Add `status` import from FastAPI: `from fastapi import APIRouter, Depends, Query, status`
2. Add User model import: `from src.db.models import DeckLevel, User`
3. Add superuser dependency: `from src.core.dependencies import get_current_superuser`
4. Add DeckCreate schema to imports: update line 17 to include `DeckCreate`

**Current imports to modify**:
```python
# Line 10: Add status
from fastapi import APIRouter, Depends, Query, status

# Line 15: Add User
from src.db.models import DeckLevel, User

# Add new import after line 16
from src.core.dependencies import get_current_superuser

# Line 17: Add DeckCreate
from src.schemas.deck import DeckCreate, DeckDetailResponse, DeckListResponse, DeckResponse, DeckSearchResponse
```

**Verification**: Run `poetry run python -c "from src.api.v1.decks import router"` to verify imports work

---

### Step 2: Implement Create Deck Endpoint

**Goal**: Add the POST /api/v1/decks endpoint with superuser authentication

**File**: `src/api/v1/decks.py`

**Location**: Add after line 99 (after `list_decks` function, before `search_decks`)

**Actions**:
Add the following endpoint implementation:

```python
@router.post(
    "",
    response_model=DeckResponse,
    status_code=status.HTTP_201_CREATED,
    summary="Create a new deck",
    description="Create a new deck. Requires superuser privileges.",
    responses={
        201: {
            "description": "Deck created successfully",
            "content": {
                "application/json": {
                    "example": {
                        "id": "550e8400-e29b-41d4-a716-446655440000",
                        "name": "Greek B1 Grammar",
                        "description": "Intermediate grammar concepts",
                        "level": "B1",
                        "is_active": True,
                        "created_at": "2024-01-15T10:30:00Z",
                        "updated_at": "2024-01-15T10:30:00Z",
                    }
                }
            },
        },
        401: {"description": "Not authenticated"},
        403: {"description": "Not authorized (requires superuser)"},
    },
)
async def create_deck(
    deck_data: DeckCreate,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_superuser),
) -> DeckResponse:
    """Create a new deck.

    Requires superuser privileges.

    Args:
        deck_data: Deck creation data (name, description, level)
        db: Database session (injected)
        current_user: Authenticated superuser (injected)

    Returns:
        DeckResponse: The created deck

    Raises:
        401: If not authenticated
        403: If authenticated but not superuser
        422: If validation fails
    """
    repo = DeckRepository(db)

    # Create the deck using BaseRepository.create()
    # Note: BaseRepository.create() uses flush, not commit
    deck = await repo.create(deck_data)

    # Commit the transaction
    await db.commit()
    await db.refresh(deck)

    return DeckResponse.model_validate(deck)
```

**Verification**: Check that endpoint appears in OpenAPI docs at `/docs`

---

### Step 3: Write Integration Tests

**Goal**: Create comprehensive tests for the create deck endpoint

**File**: `tests/integration/api/test_decks.py`

**Location**: Add new test class after existing test classes

**Actions**:
Add the following test class:

```python
class TestCreateDeckEndpoint:
    """Test suite for POST /api/v1/decks endpoint."""

    @pytest.mark.asyncio
    async def test_create_deck_success(
        self, client: AsyncClient, superuser_auth_headers: dict
    ):
        """Test superuser can create a deck successfully."""
        deck_data = {
            "name": "Test Deck Creation",
            "description": "A test deck created via API",
            "level": "A1",
        }

        response = await client.post(
            "/api/v1/decks",
            json=deck_data,
            headers=superuser_auth_headers,
        )

        assert response.status_code == 201
        data = response.json()
        assert data["name"] == deck_data["name"]
        assert data["description"] == deck_data["description"]
        assert data["level"] == deck_data["level"]
        assert data["is_active"] is True
        assert "id" in data
        assert "created_at" in data
        assert "updated_at" in data

    @pytest.mark.asyncio
    async def test_create_deck_without_description(
        self, client: AsyncClient, superuser_auth_headers: dict
    ):
        """Test creating a deck without optional description."""
        deck_data = {
            "name": "Deck Without Description",
            "level": "B1",
        }

        response = await client.post(
            "/api/v1/decks",
            json=deck_data,
            headers=superuser_auth_headers,
        )

        assert response.status_code == 201
        data = response.json()
        assert data["name"] == deck_data["name"]
        assert data["description"] is None
        assert data["level"] == deck_data["level"]

    @pytest.mark.asyncio
    async def test_create_deck_all_levels(
        self, client: AsyncClient, superuser_auth_headers: dict
    ):
        """Test creating decks with all valid CEFR levels."""
        levels = ["A1", "A2", "B1", "B2", "C1", "C2"]

        for level in levels:
            deck_data = {
                "name": f"Test {level} Deck",
                "level": level,
            }

            response = await client.post(
                "/api/v1/decks",
                json=deck_data,
                headers=superuser_auth_headers,
            )

            assert response.status_code == 201
            assert response.json()["level"] == level

    @pytest.mark.asyncio
    async def test_create_deck_unauthenticated_returns_401(
        self, client: AsyncClient
    ):
        """Test unauthenticated request returns 401."""
        deck_data = {
            "name": "Test Deck",
            "level": "A1",
        }

        response = await client.post("/api/v1/decks", json=deck_data)

        assert response.status_code == 401
        data = response.json()
        assert data["success"] is False

    @pytest.mark.asyncio
    async def test_create_deck_non_superuser_returns_403(
        self, client: AsyncClient, auth_headers: dict
    ):
        """Test regular user (non-superuser) returns 403."""
        deck_data = {
            "name": "Test Deck",
            "level": "A1",
        }

        response = await client.post(
            "/api/v1/decks",
            json=deck_data,
            headers=auth_headers,
        )

        assert response.status_code == 403
        data = response.json()
        assert data["success"] is False

    @pytest.mark.asyncio
    async def test_create_deck_missing_name_returns_422(
        self, client: AsyncClient, superuser_auth_headers: dict
    ):
        """Test missing required name field returns 422."""
        deck_data = {
            "description": "Missing name",
            "level": "A1",
        }

        response = await client.post(
            "/api/v1/decks",
            json=deck_data,
            headers=superuser_auth_headers,
        )

        assert response.status_code == 422
        data = response.json()
        assert data["success"] is False
        assert data["error"]["code"] == "VALIDATION_ERROR"

    @pytest.mark.asyncio
    async def test_create_deck_missing_level_returns_422(
        self, client: AsyncClient, superuser_auth_headers: dict
    ):
        """Test missing required level field returns 422."""
        deck_data = {
            "name": "Test Deck",
        }

        response = await client.post(
            "/api/v1/decks",
            json=deck_data,
            headers=superuser_auth_headers,
        )

        assert response.status_code == 422
        data = response.json()
        assert data["success"] is False
        assert data["error"]["code"] == "VALIDATION_ERROR"

    @pytest.mark.asyncio
    async def test_create_deck_invalid_level_returns_422(
        self, client: AsyncClient, superuser_auth_headers: dict
    ):
        """Test invalid level value returns 422."""
        deck_data = {
            "name": "Test Deck",
            "level": "INVALID",
        }

        response = await client.post(
            "/api/v1/decks",
            json=deck_data,
            headers=superuser_auth_headers,
        )

        assert response.status_code == 422
        data = response.json()
        assert data["success"] is False
        assert data["error"]["code"] == "VALIDATION_ERROR"

    @pytest.mark.asyncio
    async def test_create_deck_empty_name_returns_422(
        self, client: AsyncClient, superuser_auth_headers: dict
    ):
        """Test empty name string returns 422."""
        deck_data = {
            "name": "",
            "level": "A1",
        }

        response = await client.post(
            "/api/v1/decks",
            json=deck_data,
            headers=superuser_auth_headers,
        )

        assert response.status_code == 422
        data = response.json()
        assert data["success"] is False
        assert data["error"]["code"] == "VALIDATION_ERROR"

    @pytest.mark.asyncio
    async def test_create_deck_name_too_long_returns_422(
        self, client: AsyncClient, superuser_auth_headers: dict
    ):
        """Test name exceeding 255 characters returns 422."""
        deck_data = {
            "name": "A" * 256,
            "level": "A1",
        }

        response = await client.post(
            "/api/v1/decks",
            json=deck_data,
            headers=superuser_auth_headers,
        )

        assert response.status_code == 422
        data = response.json()
        assert data["success"] is False
        assert data["error"]["code"] == "VALIDATION_ERROR"

    @pytest.mark.asyncio
    async def test_created_deck_is_persisted(
        self, client: AsyncClient, superuser_auth_headers: dict
    ):
        """Test created deck can be retrieved via GET endpoint."""
        deck_data = {
            "name": "Persistence Test Deck",
            "description": "Testing persistence",
            "level": "B2",
        }

        # Create deck
        create_response = await client.post(
            "/api/v1/decks",
            json=deck_data,
            headers=superuser_auth_headers,
        )
        assert create_response.status_code == 201
        created_deck = create_response.json()
        deck_id = created_deck["id"]

        # Retrieve deck
        get_response = await client.get(f"/api/v1/decks/{deck_id}")
        assert get_response.status_code == 200

        retrieved_deck = get_response.json()
        assert retrieved_deck["id"] == deck_id
        assert retrieved_deck["name"] == deck_data["name"]
        assert retrieved_deck["description"] == deck_data["description"]
        assert retrieved_deck["level"] == deck_data["level"]
        assert retrieved_deck["card_count"] == 0  # New deck has no cards
```

**Verification**: Run `poetry run pytest tests/integration/api/test_decks.py::TestCreateDeckEndpoint -v`

---

### Step 4: Run All Tests and Verify

**Goal**: Ensure all tests pass and no regressions

**Actions**:
1. Run all deck tests: `poetry run pytest tests/integration/api/test_decks.py -v`
2. Run full test suite: `poetry run pytest -n auto`
3. Check linting: `poetry run black src/api/v1/decks.py tests/integration/api/test_decks.py`
4. Check typing: `poetry run mypy src/api/v1/decks.py`

**Verification**: All tests pass, no linting errors

---

### Step 5: Manual Verification

**Goal**: Test the endpoint manually using curl

**Actions**:
1. Start the development server: `poetry run uvicorn src.main:app --reload`
2. Create an admin user if needed
3. Get admin token:
   ```bash
   TOKEN=$(curl -s -X POST "http://localhost:8000/api/v1/auth/login" \
     -H "Content-Type: application/json" \
     -d '{"email": "admin@example.com", "password": "adminpassword"}' \
     | jq -r '.access_token')
   ```
4. Create a deck:
   ```bash
   curl -X POST "http://localhost:8000/api/v1/decks" \
     -H "Authorization: Bearer $TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"name": "Test Deck", "description": "Test description", "level": "A1"}'
   ```
5. Verify 401 without auth:
   ```bash
   curl -X POST "http://localhost:8000/api/v1/decks" \
     -H "Content-Type: application/json" \
     -d '{"name": "Test", "level": "A1"}'
   ```
6. Verify OpenAPI docs show the new endpoint at `/docs`

**Verification**: Endpoint works as expected, returns proper status codes

---

## Files to Modify

| File | Action | Description |
|------|--------|-------------|
| `src/api/v1/decks.py` | MODIFY | Add imports and create_deck endpoint |
| `tests/integration/api/test_decks.py` | MODIFY | Add TestCreateDeckEndpoint test class |

## Files to Verify (No Changes Needed)

| File | Status | Notes |
|------|--------|-------|
| `src/schemas/deck.py` | OK | DeckCreate schema already exists (lines 30-33) |
| `src/core/dependencies.py` | OK | get_current_superuser already exists (lines 105-134) |
| `src/repositories/deck.py` | OK | Inherits create() from BaseRepository |
| `src/repositories/base.py` | OK | create() method at lines 118-144 |

## Estimated Effort
- **Total steps**: 5
- **Complexity**: Low
- **Time estimate**: 30-45 minutes
- **Risk**: Low (following established patterns)

## Key Implementation Notes

1. **BaseRepository.create() Pattern**: The base repository `create()` method (line 118-144) handles:
   - Converting Pydantic schema to model via `model_dump(exclude_unset=True)`
   - Adding to session with `session.add()`
   - Flushing (not committing) with `await self.db.flush()`
   - The endpoint must call `await db.commit()` and `await db.refresh(deck)`

2. **is_active Default**: The Deck model (line 285-290 in models.py) has `is_active` defaulting to True, so we don't need to set it explicitly.

3. **UUID Generation**: The Deck model (line 267-270) has `server_default=func.uuid_generate_v4()`, so UUID is auto-generated.

4. **Timestamps**: TimestampMixin provides `created_at` and `updated_at` fields automatically.

5. **Existing Test Fixtures**: Use `superuser_auth_headers` fixture for admin tests and `auth_headers` for regular user tests (already available in conftest.py).

6. **Error Response Format**: The app uses custom error format `{success: false, error: {code, message}}` (see existing tests for examples).
<!-- SECTION:PLAN:END -->
