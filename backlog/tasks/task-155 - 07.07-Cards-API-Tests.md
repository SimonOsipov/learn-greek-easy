---
id: task-155
title: 07.07 Cards API Tests
status: To Do
assignee: []
created_date: '2025-12-08 05:21'
updated_date: '2025-12-08 05:24'
labels:
  - backend
  - testing
  - cards
  - task-07
dependencies: []
priority: medium
---

## Description

<!-- SECTION:DESCRIPTION:BEGIN -->
# 07.07 Cards API Tests

## Overview
Create comprehensive unit and integration tests for all Cards API endpoints.

## Files to Create

1. `tests/unit/api/test_cards.py` - Unit tests
2. `tests/integration/api/test_cards.py` - Integration tests

## Test Cases

### Unit Tests (test_cards.py)

#### TestListCards
- test_list_cards_success - Valid deck_id returns cards
- test_list_cards_pagination - Pagination works correctly
- test_list_cards_filter_by_difficulty - Difficulty filter works
- test_list_cards_invalid_deck - Invalid deck_id returns 404
- test_list_cards_missing_deck_id - Missing deck_id returns 422

#### TestGetCard
- test_get_card_success - Valid card_id returns card
- test_get_card_not_found - Non-existent card returns 404
- test_get_card_invalid_uuid - Invalid UUID returns 422

#### TestSearchCards
- test_search_cards_success - Search returns matching cards
- test_search_cards_with_deck_filter - Search with deck_id filter
- test_search_cards_empty_query - Empty query returns 422

#### TestCreateCard
- test_create_card_success - Admin can create card
- test_create_card_unauthorized - Unauthenticated returns 401
- test_create_card_forbidden - Non-admin returns 403
- test_create_card_invalid_deck - Invalid deck returns 404

#### TestBulkCreateCards
- test_bulk_create_success - Admin can bulk create
- test_bulk_create_too_many_cards - >100 cards returns 422

#### TestUpdateCard
- test_update_card_success - Admin can update card
- test_update_card_not_found - Non-existent card returns 404

#### TestDeleteCard
- test_delete_card_success - Admin can delete card
- test_delete_card_not_found - Non-existent card returns 404

### Integration Tests (test_cards_integration.py)

- test_card_crud_flow - Full create-read-update-delete flow
- test_card_search_integration - Search with real database
- test_bulk_create_integration - Bulk create with database

## Required Fixtures

Add to `tests/conftest.py`:

```python
@pytest.fixture
async def test_card(db_session, test_deck):
    from tests.factories.content import CardFactory
    return await CardFactory.create(session=db_session, deck_id=test_deck.id)

@pytest.fixture
async def test_deck_with_cards(db_session):
    from tests.factories.content import DeckFactory
    return await DeckFactory.create_with_cards(session=db_session, card_count=5)

@pytest.fixture
async def auth_headers_admin(async_client, test_admin_user):
    response = await async_client.post(
        "/api/v1/auth/login",
        json={"email": test_admin_user.email, "password": "testpassword"}
    )
    token = response.json()["access_token"]
    return {"Authorization": f"Bearer {token}"}
```

## Verification Steps

1. Run tests: `pytest tests/unit/api/test_cards.py -v`
2. Run integration tests: `pytest tests/integration/api/test_cards.py -v`
3. Check coverage: `pytest --cov=src/api/v1/cards`
4. Ensure all tests pass
5. Aim for >80% coverage
<!-- SECTION:DESCRIPTION:END -->

## Implementation Plan

<!-- SECTION:PLAN:BEGIN -->
## Implementation Plan for Cards API Tests

### Overview
This plan details the implementation of comprehensive unit and integration tests for the Cards API endpoints. The implementation follows existing patterns from `test_decks.py` and uses the established factory and fixture patterns.

### Prerequisites
- [ ] Verify Cards API (`src/api/v1/cards.py`) is implemented and registered in router
- [ ] Confirm CardRepository has all required methods (`get_by_deck`, `get_by_difficulty`, `bulk_create`, `search`, `count_by_deck`, `count_search`)
- [ ] Verify Card schemas exist (`CardCreate`, `CardUpdate`, `CardResponse`, `CardListResponse`, `CardSearchResponse`, `CardBulkCreateRequest`, `CardBulkCreateResponse`)
- [ ] Ensure `CardNotFoundException` is available in `src/core/exceptions.py` (already exists)

---

### Step 1: Create Card Fixtures (if not already sufficient)
**Goal**: Ensure all necessary card fixtures exist for testing

**Actions**:
1. Review existing fixtures in `tests/fixtures/deck.py`:
   - `test_card` - Single card fixture (exists)
   - `test_cards` - List of 5 cards (exists)
   - `deck_with_cards` - Deck with 5 cards (exists)
   - `cards_by_difficulty` - Cards grouped by difficulty (exists)
2. Add new fixtures to `tests/fixtures/deck.py` if needed:
   - `test_card_minimal` - Card without optional fields
   - `deck_with_many_cards_for_pagination` - 100+ cards for pagination testing

**Files to modify**:
- `tests/fixtures/deck.py` (add new fixtures if needed)

**Verification**: Run `pytest tests/fixtures/deck.py -v` to ensure fixtures work

---

### Step 2: Create Unit Tests File Structure
**Goal**: Set up the unit test file with proper organization

**Actions**:
1. Create `tests/unit/api/test_cards.py`
2. Import required dependencies:
   - `pytest`, `pytest.mark.asyncio`
   - `unittest.mock.AsyncMock`, `MagicMock`, `patch`
   - `uuid4`
   - `AsyncClient` from httpx
   - `Card`, `CardDifficulty`, `Deck`, `DeckLevel` from models
3. Set up test class structure following `test_decks.py` pattern

**Files to create**:
- `tests/unit/api/test_cards.py`

**Test Classes**:
```python
class TestListCardsUnit:
    """Unit tests for GET /api/v1/cards endpoint."""

class TestGetCardUnit:
    """Unit tests for GET /api/v1/cards/{id} endpoint."""

class TestSearchCardsUnit:
    """Unit tests for GET /api/v1/cards/search endpoint."""

class TestCreateCardUnit:
    """Unit tests for POST /api/v1/cards endpoint."""

class TestBulkCreateCardsUnit:
    """Unit tests for POST /api/v1/cards/bulk endpoint."""

class TestUpdateCardUnit:
    """Unit tests for PATCH /api/v1/cards/{id} endpoint."""

class TestDeleteCardUnit:
    """Unit tests for DELETE /api/v1/cards/{id} endpoint."""
```

---

### Step 3: Implement TestListCardsUnit Tests
**Goal**: Test list cards endpoint with mocked repository

**Actions**:
1. `test_list_cards_calls_repository_with_correct_params` - Verify skip/limit calculation
2. `test_list_cards_with_deck_filter_passes_to_repository` - Verify deck_id passed correctly
3. `test_list_cards_with_difficulty_filter_passes_to_repository` - Verify difficulty filter
4. `test_list_cards_returns_correct_response_structure` - Verify response schema
5. `test_list_cards_missing_deck_id_returns_422` - Required parameter validation
6. `test_list_cards_invalid_deck_id_returns_422` - UUID validation
7. `test_list_cards_invalid_page_returns_422` - Pagination validation
8. `test_list_cards_invalid_page_size_returns_422` - Page size bounds

**Implementation Pattern**:
```python
@pytest.mark.asyncio
async def test_list_cards_calls_repository_with_correct_params(self, client: AsyncClient):
    deck_id = uuid4()
    mock_card = MagicMock(spec=Card)
    # ... setup mock
    with patch("src.api.v1.cards.CardRepository") as mock_repo_class:
        mock_repo = AsyncMock()
        mock_repo.get_by_deck.return_value = [mock_card]
        mock_repo.count_by_deck.return_value = 1
        mock_repo_class.return_value = mock_repo

        response = await client.get(f"/api/v1/cards?deck_id={deck_id}&page=2&page_size=10")

        assert response.status_code == 200
        mock_repo.get_by_deck.assert_called_once()
```

---

### Step 4: Implement TestGetCardUnit Tests
**Goal**: Test get single card endpoint with mocked repository

**Actions**:
1. `test_get_card_calls_repository_with_card_id` - Verify repository call
2. `test_get_card_not_found_returns_404` - Non-existent card
3. `test_get_card_invalid_uuid_returns_422` - UUID validation

---

### Step 5: Implement TestSearchCardsUnit Tests
**Goal**: Test search cards endpoint with mocked repository

**Actions**:
1. `test_search_cards_calls_repository_with_query` - Verify search query passed
2. `test_search_cards_with_deck_filter` - Optional deck_id filter
3. `test_search_cards_missing_query_returns_422` - Required parameter
4. `test_search_cards_empty_query_returns_422` - Empty string validation

---

### Step 6: Implement TestCreateCardUnit Tests
**Goal**: Test create card endpoint authorization

**Actions**:
1. `test_create_card_unauthorized_returns_401` - No auth header
2. `test_create_card_non_superuser_returns_403` - Regular user forbidden
3. `test_create_card_missing_fields_returns_422` - Validation errors
4. `test_create_card_invalid_deck_returns_404` - Non-existent deck

---

### Step 7: Implement TestBulkCreateCardsUnit Tests
**Goal**: Test bulk create endpoint authorization and validation

**Actions**:
1. `test_bulk_create_unauthorized_returns_401` - No auth header
2. `test_bulk_create_non_superuser_returns_403` - Regular user forbidden
3. `test_bulk_create_too_many_cards_returns_422` - >100 cards limit
4. `test_bulk_create_empty_array_returns_422` - Empty cards array
5. `test_bulk_create_invalid_deck_returns_404` - Non-existent deck

---

### Step 8: Implement TestUpdateCardUnit and TestDeleteCardUnit Tests
**Goal**: Test update and delete card authorization

**Actions**:
1. Update tests: unauthorized, forbidden, not found, invalid UUID
2. Delete tests: unauthorized, forbidden, not found, invalid UUID

---

### Step 9: Create Integration Tests File Structure
**Goal**: Set up integration test file with real database

**Actions**:
1. Create `tests/integration/api/test_cards.py`
2. Import fixtures from `tests/fixtures/deck.py` and `tests/fixtures/auth.py`
3. Set up test class structure

**Files to create**:
- `tests/integration/api/test_cards.py`

**Test Classes**:
```python
class TestListCardsEndpoint:
    """Integration tests for GET /api/v1/cards endpoint."""

class TestGetCardEndpoint:
    """Integration tests for GET /api/v1/cards/{id} endpoint."""

class TestSearchCardsEndpoint:
    """Integration tests for GET /api/v1/cards/search endpoint."""

class TestCreateCardEndpoint:
    """Integration tests for POST /api/v1/cards endpoint."""

class TestBulkCreateCardsEndpoint:
    """Integration tests for POST /api/v1/cards/bulk endpoint."""

class TestUpdateCardEndpoint:
    """Integration tests for PATCH /api/v1/cards/{id} endpoint."""

class TestDeleteCardEndpoint:
    """Integration tests for DELETE /api/v1/cards/{id} endpoint."""

class TestCardCRUDFlow:
    """Integration tests for complete card CRUD operations."""
```

---

### Step 10: Implement TestListCardsEndpoint Integration Tests
**Goal**: Test list cards with real database

**Actions**:
1. `test_list_cards_success` - Valid deck_id returns cards
2. `test_list_cards_empty_deck` - Empty deck returns empty list
3. `test_list_cards_pagination_first_page` - First page works
4. `test_list_cards_pagination_second_page` - Second page has different cards
5. `test_list_cards_filter_by_difficulty` - Difficulty filter works
6. `test_list_cards_invalid_deck_returns_404` - Non-existent deck
7. `test_list_cards_missing_deck_id_returns_422` - Missing required param
8. `test_list_cards_response_fields` - All required fields present
9. `test_list_cards_ordered_by_order_index` - Cards in correct order

**Fixture Dependencies**:
- `deck_with_cards: DeckWithCards`
- `empty_deck: Deck`
- `cards_by_difficulty: dict[CardDifficulty, list[Card]]`

---

### Step 11: Implement TestGetCardEndpoint Integration Tests
**Goal**: Test get single card with real database

**Actions**:
1. `test_get_card_success` - Valid card_id returns card
2. `test_get_card_not_found` - Non-existent card returns 404
3. `test_get_card_invalid_uuid` - Invalid UUID returns 422
4. `test_get_card_includes_all_fields` - All required fields present

**Fixture Dependencies**:
- `test_card: Card`
- `deck_with_cards: DeckWithCards`

---

### Step 12: Implement TestSearchCardsEndpoint Integration Tests
**Goal**: Test search cards with real database

**Actions**:
1. `test_search_cards_success` - Search returns matching cards
2. `test_search_cards_case_insensitive` - Case-insensitive search
3. `test_search_cards_partial_match_front` - Partial match in front_text
4. `test_search_cards_partial_match_back` - Partial match in back_text
5. `test_search_cards_with_deck_filter` - Search within specific deck
6. `test_search_cards_pagination` - Pagination works
7. `test_search_cards_no_results` - No matches returns empty list
8. `test_search_cards_missing_query_returns_422` - Missing q parameter
9. `test_search_cards_empty_query_returns_422` - Empty query

**Fixture Dependencies**:
- `deck_with_cards: DeckWithCards`
- `multi_level_decks: MultiLevelDecks`

---

### Step 13: Implement TestCreateCardEndpoint Integration Tests
**Goal**: Test create card with real database

**Actions**:
1. `test_create_card_success` - Superuser can create card
2. `test_create_card_without_optional_fields` - Only required fields
3. `test_create_card_all_difficulties` - Test all difficulty levels
4. `test_create_card_unauthenticated_returns_401` - No auth
5. `test_create_card_non_superuser_returns_403` - Regular user
6. `test_create_card_invalid_deck_returns_404` - Non-existent deck
7. `test_create_card_missing_fields_returns_422` - Validation errors
8. `test_created_card_is_persisted` - Card can be retrieved after creation

**Fixture Dependencies**:
- `empty_deck: Deck`
- `auth_headers: dict`
- `superuser_auth_headers: dict`

---

### Step 14: Implement TestBulkCreateCardsEndpoint Integration Tests
**Goal**: Test bulk create with real database

**Actions**:
1. `test_bulk_create_success` - Superuser can bulk create
2. `test_bulk_create_multiple_cards` - Creates correct number of cards
3. `test_bulk_create_unauthenticated_returns_401` - No auth
4. `test_bulk_create_non_superuser_returns_403` - Regular user
5. `test_bulk_create_invalid_deck_returns_404` - Non-existent deck
6. `test_bulk_create_too_many_cards_returns_422` - >100 cards
7. `test_bulk_create_empty_array_returns_422` - Empty array
8. `test_bulk_create_cards_have_correct_deck_id` - All cards linked to deck

**Fixture Dependencies**:
- `empty_deck: Deck`
- `superuser_auth_headers: dict`

---

### Step 15: Implement TestUpdateCardEndpoint Integration Tests
**Goal**: Test update card with real database

**Actions**:
1. `test_update_card_front_text_only` - Partial update
2. `test_update_card_all_fields` - Full update
3. `test_update_card_difficulty` - Change difficulty
4. `test_update_card_unauthenticated_returns_401` - No auth
5. `test_update_card_non_superuser_returns_403` - Regular user
6. `test_update_card_not_found_returns_404` - Non-existent card
7. `test_update_card_invalid_uuid_returns_422` - Invalid UUID
8. `test_update_card_updated_at_changes` - Timestamp updated

**Fixture Dependencies**:
- `test_card: Card`
- `deck_with_cards: DeckWithCards`
- `superuser_auth_headers: dict`

---

### Step 16: Implement TestDeleteCardEndpoint Integration Tests
**Goal**: Test delete card with real database

**Actions**:
1. `test_delete_card_success` - Superuser can delete card
2. `test_delete_card_unauthenticated_returns_401` - No auth
3. `test_delete_card_non_superuser_returns_403` - Regular user
4. `test_delete_card_not_found_returns_404` - Non-existent card
5. `test_delete_card_invalid_uuid_returns_422` - Invalid UUID
6. `test_deleted_card_not_in_list` - Card removed from deck listing
7. `test_deleted_card_returns_404_on_get` - Card not retrievable

**Fixture Dependencies**:
- `test_card: Card`
- `deck_with_cards: DeckWithCards`
- `superuser_auth_headers: dict`

---

### Step 17: Implement TestCardCRUDFlow Integration Tests
**Goal**: Test complete card lifecycle

**Actions**:
1. `test_full_card_lifecycle` - Create, read, update, delete flow
2. `test_card_appears_in_deck_after_creation` - Card visible in deck listing
3. `test_card_auth_flow_for_admin_endpoints` - Auth consistency
4. `test_bulk_create_then_search` - Bulk create and search workflow

**Implementation**:
```python
@pytest.mark.asyncio
async def test_full_card_lifecycle(
    self, client: AsyncClient, superuser_auth_headers: dict, empty_deck: Deck
):
    """Test complete create-read-update-delete flow."""
    deck_id = str(empty_deck.id)

    # 1. CREATE
    card_data = {
        "deck_id": deck_id,
        "front_text": "Kalimera",
        "back_text": "Good morning",
        "difficulty": "easy",
    }
    create_response = await client.post(
        "/api/v1/cards", json=card_data, headers=superuser_auth_headers
    )
    assert create_response.status_code == 201
    card_id = create_response.json()["id"]

    # 2. READ
    get_response = await client.get(f"/api/v1/cards/{card_id}")
    assert get_response.status_code == 200
    assert get_response.json()["front_text"] == "Kalimera"

    # 3. UPDATE
    update_response = await client.patch(
        f"/api/v1/cards/{card_id}",
        json={"front_text": "Kalispera"},
        headers=superuser_auth_headers
    )
    assert update_response.status_code == 200
    assert update_response.json()["front_text"] == "Kalispera"

    # 4. DELETE
    delete_response = await client.delete(
        f"/api/v1/cards/{card_id}", headers=superuser_auth_headers
    )
    assert delete_response.status_code == 204

    # 5. VERIFY DELETION
    final_get = await client.get(f"/api/v1/cards/{card_id}")
    assert final_get.status_code == 404
```

---

### Step 18: Run Tests and Verify Coverage
**Goal**: Ensure all tests pass and coverage targets are met

**Actions**:
1. Run unit tests: `pytest tests/unit/api/test_cards.py -v`
2. Run integration tests: `pytest tests/integration/api/test_cards.py -v`
3. Check coverage: `pytest tests/unit/api/test_cards.py tests/integration/api/test_cards.py --cov=src/api/v1/cards --cov-report=term-missing`
4. Ensure >80% coverage on `src/api/v1/cards.py`
5. Fix any failing tests

**Verification**:
```bash
cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && \
/Users/samosipov/.local/bin/poetry run pytest tests/unit/api/test_cards.py tests/integration/api/test_cards.py -v --cov=src/api/v1/cards --cov-report=term-missing
```

---

### Estimated Effort
- **Total Steps**: 18
- **Unit Test Cases**: ~25-30 tests
- **Integration Test Cases**: ~45-50 tests
- **Complexity**: Medium-High
- **Estimated Time**: 4-6 hours

---

### Test File Summary

| File | Test Count | Purpose |
|------|------------|---------|
| `tests/unit/api/test_cards.py` | ~25-30 | Mocked repository tests for endpoint logic |
| `tests/integration/api/test_cards.py` | ~45-50 | Real database tests for full functionality |

### Coverage Targets

| Module | Target Coverage |
|--------|-----------------|
| `src/api/v1/cards.py` | >80% |
| Card endpoints overall | >85% |

### Dependencies on Other Tasks

This task depends on:
- Task 07.01-07.06 (Cards API implementation) being complete
- Card schemas (`CardListResponse`, `CardSearchResponse`, `CardBulkCreateRequest`, etc.) being implemented
- CardRepository methods (`search`, `count_by_deck`, `count_search`) being implemented
<!-- SECTION:PLAN:END -->
