---
id: task-152
title: 07.04 Create Card Endpoint (Admin)
status: In Progress
assignee: []
created_date: '2025-12-08 05:21'
updated_date: '2025-12-08 14:14'
labels:
  - backend
  - api
  - cards
  - task-07
dependencies: []
priority: high
ordinal: 1000
---

## Description

<!-- SECTION:DESCRIPTION:BEGIN -->
# 07.04 Create Card Endpoint (Admin)

## Overview
Implement the POST /api/v1/cards endpoint for creating a new card. This is an admin-only endpoint requiring superuser privileges.

## Technical Specification

### Files to Modify

1. **Modify**: `src/api/v1/cards.py` - Add create_card endpoint

### Endpoint Implementation

Add to `src/api/v1/cards.py`:

```python
from fastapi import status
from src.core.dependencies import get_current_superuser
from src.db.models import User
from src.schemas.card import CardCreate

@router.post(
    "",
    response_model=CardResponse,
    status_code=status.HTTP_201_CREATED,
    summary="Create a new card",
    description="Create a new card in a deck. Requires superuser privileges.",
    responses={
        201: {
            "description": "Card created successfully",
            "content": {
                "application/json": {
                    "example": {
                        "id": "660e8400-e29b-41d4-a716-446655440002",
                        "deck_id": "550e8400-e29b-41d4-a716-446655440000",
                        "front_text": "efharisto",
                        "back_text": "thank you",
                        "example_sentence": "Efharisto poly!",
                        "pronunciation": "efharisto",
                        "difficulty": "easy",
                        "order_index": 0,
                        "created_at": "2024-01-15T10:30:00Z",
                        "updated_at": "2024-01-15T10:30:00Z"
                    }
                }
            },
        },
        401: {"description": "Not authenticated"},
        403: {"description": "Not authorized (requires superuser)"},
        404: {"description": "Deck not found"},
        422: {"description": "Validation error"},
    },
)
async def create_card(
    card_data: CardCreate,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_superuser),
) -> CardResponse:
    """Create a new card.

    Requires superuser privileges.

    Args:
        card_data: Card creation data
        db: Database session (injected)
        current_user: Authenticated superuser (injected)

    Returns:
        CardResponse: The created card

    Raises:
        401: If not authenticated
        403: If authenticated but not superuser
        404: If deck doesn't exist
        422: If validation fails
    """
    # Validate deck exists
    deck_repo = DeckRepository(db)
    deck = await deck_repo.get(card_data.deck_id)
    if deck is None:
        raise DeckNotFoundException(deck_id=str(card_data.deck_id))

    # Create the card
    card_repo = CardRepository(db)
    card = await card_repo.create(card_data)

    # Commit the transaction
    await db.commit()
    await db.refresh(card)

    return CardResponse.model_validate(card)
```

### API Contract

**Endpoint**: POST /api/v1/cards

**Authentication**: Required (superuser)

**Request Body**:
```json
{
  "deck_id": "550e8400-e29b-41d4-a716-446655440000",
  "front_text": "efharisto",
  "back_text": "thank you",
  "example_sentence": "Efharisto poly!",
  "pronunciation": "efharisto",
  "difficulty": "easy",
  "order_index": 0
}
```

**Validation Rules** (from existing CardCreate schema):
- `deck_id`: Required, valid UUID
- `front_text`: Required, min 1 character
- `back_text`: Required, min 1 character
- `example_sentence`: Optional
- `pronunciation`: Optional, max 255 characters
- `difficulty`: Required, one of: easy, medium, hard
- `order_index`: Optional, defaults to 0, must be >= 0

**Response** (201 Created):
```json
{
  "id": "...",
  "deck_id": "...",
  "front_text": "efharisto",
  "back_text": "thank you",
  "example_sentence": "Efharisto poly!",
  "pronunciation": "efharisto",
  "difficulty": "easy",
  "order_index": 0,
  "created_at": "...",
  "updated_at": "..."
}
```

**Error Responses**:
- 401: Not authenticated
- 403: Not a superuser
- 404: Deck not found
- 422: Validation error

### Notes

- Use existing CardCreate schema from `src/schemas/card.py`
- Use `get_current_superuser` dependency for auth
- Validate deck exists before creating card
- Allow creating cards in inactive decks (admin privilege)
- Use BaseRepository.create() pattern

## Verify

1. Test admin can create card successfully
2. Test non-admin user gets 403
3. Test unauthenticated request gets 401
4. Test invalid deck_id returns 404
5. Test validation errors return 422
6. Verify created card has correct fields
7. Verify card is associated with correct deck
<!-- SECTION:DESCRIPTION:END -->

## Implementation Plan

<!-- SECTION:PLAN:BEGIN -->
## Implementation Plan for 07.04 Create Card Endpoint (Admin)

### Prerequisites
- [x] Existing `CardCreate` schema in `src/schemas/card.py`
- [x] Existing `CardResponse` schema in `src/schemas/card.py`
- [x] Existing `CardRepository` in `src/repositories/card.py` with `create()` from `BaseRepository`
- [x] Existing `get_current_superuser` dependency in `src/core/dependencies.py`
- [x] Existing `DeckNotFoundException` exception in `src/core/exceptions.py`

### Step 1: Add Required Imports to cards.py
**Goal**: Add necessary imports for authentication, status codes, and models

**Actions**:
1. Add `status` import from `fastapi`
2. Add `get_current_superuser` from `src/core/dependencies`
3. Add `User` from `src/db/models`
4. Add `CardCreate` to the existing schema imports

**Files to modify**:
- `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/api/v1/cards.py`

**Current imports to modify** (around lines 7-18):
```python
from fastapi import APIRouter, Depends, Query
# Add: status

from src.core.dependencies import get_current_superuser
# Add this import

from src.db.models import User
# Add User import (CardDifficulty already imported)

from src.schemas.card import CardCreate, CardListResponse, CardResponse, CardSearchResponse
# Add CardCreate to this line
```

**Verification**: File compiles without import errors

---

### Step 2: Implement create_card Endpoint
**Goal**: Add the POST endpoint for creating cards

**Actions**:
1. Add the `create_card` endpoint function after the existing list endpoint and BEFORE the search endpoint
2. Use `@router.post("")` decorator with `status_code=status.HTTP_201_CREATED`
3. Add `response_model=CardResponse`
4. Add comprehensive OpenAPI documentation in `responses` parameter
5. Implement deck existence validation using `DeckRepository.get()`
6. Create card using `CardRepository.create()`
7. Commit transaction and refresh object

**Implementation Location**:
- Insert AFTER line 124 (end of `list_cards` function)
- Insert BEFORE line 127 (start of `/search` endpoint)

**Code to add**:
```python
@router.post(
    "",
    response_model=CardResponse,
    status_code=status.HTTP_201_CREATED,
    summary="Create a new card",
    description="Create a new card in a deck. Requires superuser privileges.",
    responses={
        201: {
            "description": "Card created successfully",
            "content": {
                "application/json": {
                    "example": {
                        "id": "660e8400-e29b-41d4-a716-446655440002",
                        "deck_id": "550e8400-e29b-41d4-a716-446655440000",
                        "front_text": "efharisto",
                        "back_text": "thank you",
                        "example_sentence": "Efharisto poly!",
                        "pronunciation": "efharisto",
                        "difficulty": "easy",
                        "order_index": 0,
                        "created_at": "2024-01-15T10:30:00Z",
                        "updated_at": "2024-01-15T10:30:00Z"
                    }
                }
            },
        },
        401: {"description": "Not authenticated"},
        403: {"description": "Not authorized (requires superuser)"},
        404: {"description": "Deck not found"},
        422: {"description": "Validation error"},
    },
)
async def create_card(
    card_data: CardCreate,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_superuser),
) -> CardResponse:
    """Create a new card.

    Requires superuser privileges.

    Args:
        card_data: Card creation data
        db: Database session (injected)
        current_user: Authenticated superuser (injected)

    Returns:
        CardResponse: The created card

    Raises:
        401: If not authenticated
        403: If authenticated but not superuser
        404: If deck doesn't exist
        422: If validation fails
    """
    # Validate deck exists (allow inactive decks - admin privilege)
    deck_repo = DeckRepository(db)
    deck = await deck_repo.get(card_data.deck_id)
    if deck is None:
        raise DeckNotFoundException(deck_id=str(card_data.deck_id))

    # Create the card using BaseRepository.create() pattern
    card_repo = CardRepository(db)
    card = await card_repo.create(card_data)

    # Commit the transaction
    await db.commit()
    await db.refresh(card)

    return CardResponse.model_validate(card)
```

**Verification**:
- Endpoint appears in OpenAPI docs at `/docs`
- Endpoint is accessible at `POST /api/v1/cards`

---

### Step 3: Add Integration Tests
**Goal**: Add comprehensive tests for the create_card endpoint

**Actions**:
1. Create new test class `TestCreateCardEndpoint` in `tests/integration/api/test_cards.py`
2. Add tests following the existing pattern from `TestCreateDeckEndpoint`

**Files to modify**:
- `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/tests/integration/api/test_cards.py`

**Tests to add**:
```python
class TestCreateCardEndpoint:
    """Test suite for POST /api/v1/cards endpoint."""

    @pytest.fixture
    async def active_deck_for_create(self, db_session):
        """Create an active deck for card creation tests."""
        deck = Deck(
            id=uuid4(),
            name="Deck for Card Creation",
            description="Test deck",
            level=DeckLevel.A1,
            is_active=True,
        )
        db_session.add(deck)
        await db_session.commit()
        await db_session.refresh(deck)
        return deck

    @pytest.mark.asyncio
    async def test_create_card_success(
        self, client: AsyncClient, superuser_auth_headers: dict, active_deck_for_create
    ):
        """Test superuser can create a card successfully."""
        ...

    @pytest.mark.asyncio
    async def test_create_card_unauthenticated_returns_401(
        self, client: AsyncClient, active_deck_for_create
    ):
        """Test unauthenticated request returns 401."""
        ...

    @pytest.mark.asyncio
    async def test_create_card_non_superuser_returns_403(
        self, client: AsyncClient, auth_headers: dict, active_deck_for_create
    ):
        """Test regular user (non-superuser) returns 403."""
        ...

    @pytest.mark.asyncio
    async def test_create_card_deck_not_found_returns_404(
        self, client: AsyncClient, superuser_auth_headers: dict
    ):
        """Test invalid deck_id returns 404."""
        ...

    @pytest.mark.asyncio
    async def test_create_card_validation_error_returns_422(
        self, client: AsyncClient, superuser_auth_headers: dict, active_deck_for_create
    ):
        """Test validation errors return 422."""
        ...

    @pytest.mark.asyncio
    async def test_create_card_all_fields(
        self, client: AsyncClient, superuser_auth_headers: dict, active_deck_for_create
    ):
        """Test card creation with all optional fields."""
        ...

    @pytest.mark.asyncio
    async def test_create_card_in_inactive_deck_succeeds(
        self, client: AsyncClient, superuser_auth_headers: dict, db_session
    ):
        """Test admin can create cards in inactive decks."""
        ...

    @pytest.mark.asyncio
    async def test_created_card_is_persisted(
        self, client: AsyncClient, superuser_auth_headers: dict, active_deck_for_create
    ):
        """Test created card can be retrieved via GET endpoint."""
        ...
```

**Verification**: All tests pass when running `pytest tests/integration/api/test_cards.py -v`

---

### Step 4: Add Unit Tests (Optional but recommended)
**Goal**: Add unit tests for the create_card endpoint

**Files to modify**:
- `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/tests/unit/api/test_cards.py`

**Tests to add**:
- Test mocking deck repository returning None raises DeckNotFoundException
- Test mocking card repository create returns card
- Test response model validation

**Verification**: All unit tests pass

---

### Step 5: Final Verification
**Goal**: Ensure implementation is complete and correct

**Actions**:
1. Run linters: `poetry run black src/api/v1/cards.py`
2. Run type checking: `poetry run mypy src/api/v1/cards.py`
3. Run all card tests: `poetry run pytest tests/integration/api/test_cards.py tests/unit/api/test_cards.py -v`
4. Run full test suite: `poetry run pytest -n auto`
5. Manual testing via `/docs` endpoint

**Verification Checklist**:
- [ ] Admin can create card successfully (201)
- [ ] Non-admin user gets 403
- [ ] Unauthenticated request gets 401
- [ ] Invalid deck_id returns 404
- [ ] Validation errors return 422
- [ ] Created card has correct fields (id, deck_id, front_text, back_text, etc.)
- [ ] Card is associated with correct deck
- [ ] Card can be retrieved via GET /api/v1/cards/{card_id}

### Estimated Effort
- Total steps: 5
- Complexity: Low
- Estimated time: 30-45 minutes

### Key Patterns to Follow
Based on analysis of existing code:

1. **Import pattern** (from `decks.py`):
   - Use `status` from `fastapi` for HTTP status codes
   - Import `get_current_superuser` for admin auth
   - Import `User` model for type hints

2. **Endpoint pattern** (from `create_deck` in `decks.py`):
   - Use `status_code=status.HTTP_201_CREATED`
   - Include comprehensive `responses` dict for OpenAPI docs
   - Follow repository pattern: `repo.create()` -> `db.commit()` -> `db.refresh()`
   - Use `model_validate()` for response serialization

3. **Error handling pattern**:
   - Validate foreign key (deck) exists before creating card
   - Use `DeckNotFoundException` for missing deck
   - Auth errors (401/403) handled automatically by `get_current_superuser`

4. **Test patterns** (from `TestCreateDeckEndpoint`):
   - Use `superuser_auth_headers` fixture for admin tests
   - Use `auth_headers` fixture for non-admin tests
   - Test unauthenticated by not passing headers
   - Verify response status codes and JSON structure
<!-- SECTION:PLAN:END -->

## Implementation Notes

<!-- SECTION:NOTES:BEGIN -->
- Use existing CardCreate schema from `src/schemas/card.py`
- Use `get_current_superuser` dependency for auth
- Validate deck exists before creating card
- Allow creating cards in inactive decks (admin privilege)
- Use BaseRepository.create() pattern

## Verification Steps

1. Test admin can create card successfully
2. Test non-admin user gets 403
3. Test unauthenticated request gets 401
4. Test invalid deck_id returns 404
5. Test validation errors return 422
6. Verify created card has correct fields
7. Verify card is associated with correct deck
<!-- SECTION:DESCRIPTION:END -->
<!-- SECTION:NOTES:END -->
