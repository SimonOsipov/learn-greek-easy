---
id: task-154
title: 07.06 Bulk Create Cards Endpoint (Admin)
status: Done
assignee: []
created_date: '2025-12-08 05:21'
updated_date: '2025-12-08 16:44'
labels:
  - backend
  - api
  - cards
  - task-07
dependencies: []
priority: medium
---

## Description

<!-- SECTION:DESCRIPTION:BEGIN -->
# 07.06 Bulk Create Cards Endpoint (Admin)

## Overview
Implement POST /api/v1/cards/bulk endpoint for creating multiple cards in one request. This is an admin-only endpoint requiring superuser privileges.

## Technical Specification

### Files to Modify

1. **Modify**: `src/schemas/card.py` - Add bulk create schemas
2. **Modify**: `src/api/v1/cards.py` - Add bulk_create_cards endpoint

### New Schemas

Add to `src/schemas/card.py`:

```python
class CardBulkItemCreate(BaseModel):
    """Single card in bulk create (without deck_id)."""
    front_text: str = Field(..., min_length=1)
    back_text: str = Field(..., min_length=1)
    example_sentence: Optional[str] = None
    pronunciation: Optional[str] = Field(None, max_length=255)
    difficulty: CardDifficulty
    order_index: int = Field(default=0, ge=0)

class CardBulkCreateRequest(BaseModel):
    """Request body for bulk card creation."""
    deck_id: UUID
    cards: list[CardBulkItemCreate] = Field(
        ...,
        min_length=1,
        max_length=100,
        description="Array of cards to create (1-100)"
    )

class CardBulkCreateResponse(BaseModel):
    """Response for bulk card creation."""
    deck_id: UUID
    created_count: int
    cards: list[CardResponse]
```

### Endpoint Implementation

Add to `src/api/v1/cards.py` (AFTER the single create endpoint):

```python
from src.schemas.card import CardBulkCreateRequest, CardBulkCreateResponse

@router.post(
    "/bulk",
    response_model=CardBulkCreateResponse,
    status_code=status.HTTP_201_CREATED,
    summary="Bulk create cards",
    description="Create multiple cards in one request. Requires superuser privileges. Maximum 100 cards per request.",
    responses={
        201: {
            "description": "Cards created successfully",
            "content": {
                "application/json": {
                    "example": {
                        "deck_id": "550e8400-e29b-41d4-a716-446655440000",
                        "created_count": 2,
                        "cards": [
                            {
                                "id": "...",
                                "deck_id": "550e8400-e29b-41d4-a716-446655440000",
                                "front_text": "kalimera",
                                "back_text": "good morning",
                                "difficulty": "easy",
                                "order_index": 1
                            }
                        ]
                    }
                }
            },
        },
        401: {"description": "Not authenticated"},
        403: {"description": "Not authorized (requires superuser)"},
        404: {"description": "Deck not found"},
        422: {"description": "Validation error (empty array, >100 cards, invalid data)"},
    },
)
async def bulk_create_cards(
    request: CardBulkCreateRequest,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_superuser),
) -> CardBulkCreateResponse:
    """Create multiple cards in one request.

    Requires superuser privileges.

    This endpoint uses transactional semantics - if any card fails
    validation, the entire request is rejected (all-or-nothing).

    Args:
        request: Deck ID and array of cards to create
        db: Database session (injected)
        current_user: Authenticated superuser (injected)

    Returns:
        CardBulkCreateResponse: Created cards with count

    Raises:
        401: If not authenticated
        403: If authenticated but not superuser
        404: If deck doesn't exist
        422: If validation fails (empty array, >100 cards, invalid card data)
    """
    # Validate deck exists
    deck_repo = DeckRepository(db)
    deck = await deck_repo.get(request.deck_id)
    if deck is None:
        raise DeckNotFoundException(deck_id=str(request.deck_id))

    # Prepare cards data with deck_id
    cards_data = [
        {
            "deck_id": request.deck_id,
            **card.model_dump()
        }
        for card in request.cards
    ]

    # Bulk create using repository
    card_repo = CardRepository(db)
    created_cards = await card_repo.bulk_create(cards_data)

    # Commit the transaction
    await db.commit()

    # Refresh all cards to get generated fields
    for card in created_cards:
        await db.refresh(card)

    return CardBulkCreateResponse(
        deck_id=request.deck_id,
        created_count=len(created_cards),
        cards=[CardResponse.model_validate(card) for card in created_cards],
    )
```

### API Contract

**Endpoint**: POST /api/v1/cards/bulk

**Authentication**: Required (superuser)

**Request Body**:
```json
{
  "deck_id": "550e8400-e29b-41d4-a716-446655440000",
  "cards": [
    {
      "front_text": "kalimera",
      "back_text": "good morning",
      "difficulty": "easy",
      "order_index": 1
    },
    {
      "front_text": "kalispera",
      "back_text": "good evening",
      "difficulty": "easy",
      "order_index": 2
    }
  ]
}
```

**Validation Rules**:
- `deck_id`: Required, valid UUID, deck must exist
- `cards`: Required array, min 1 card, max 100 cards
- Each card follows CardBulkItemCreate validation

**Response** (201 Created):
```json
{
  "deck_id": "550e8400-e29b-41d4-a716-446655440000",
  "created_count": 2,
  "cards": [...]
}
```

**Error Responses**:
- 401: Not authenticated
- 403: Not a superuser
- 404: Deck not found
- 422: Validation error

### Route Ordering

IMPORTANT: The /bulk route must be defined BEFORE the /{card_id} routes, otherwise FastAPI will try to parse "bulk" as a UUID.

Recommended route order in cards.py:
1. GET / (list)
2. POST / (create single)
3. POST /bulk (bulk create)
4. GET /search (search)
5. GET /{card_id} (get single)
6. PATCH /{card_id} (update)
7. DELETE /{card_id} (delete)

### Implementation Notes

1. Uses existing `CardRepository.bulk_create()` method
2. All-or-nothing semantics (transaction rollback on failure)
3. Limited to 100 cards per request (DoS protection)
4. Each card gets its own UUID generated by database
5. Uses single transaction for efficiency

## Verification Steps

1. Test admin can bulk create cards
2. Test non-admin gets 403
3. Test invalid deck_id returns 404
4. Test empty cards array returns 422
5. Test >100 cards returns 422
6. Test invalid card in array rejects entire request
7. Verify all cards have correct deck_id
8. Verify created_count matches actual count
9. Test with various order_index values
<!-- SECTION:DESCRIPTION:END -->

## Implementation Plan

<!-- SECTION:PLAN:BEGIN -->
## Implementation Plan for 07.06 Bulk Create Cards Endpoint (Admin)

### Prerequisites
- [ ] Ensure task-153 (single card create endpoint) is complete or at least `cards.py` router exists
- [ ] Verify `CardRepository.bulk_create()` method exists (confirmed in `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/repositories/card.py`)
- [ ] Verify `DeckRepository` and `DeckNotFoundException` are available (confirmed)
- [ ] Verify `get_current_superuser` dependency exists (confirmed in `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/core/dependencies.py`)

---

### Step 1: Add Bulk Create Schemas to card.py
**Goal**: Define Pydantic schemas for bulk card creation request and response

**File to modify**: `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/schemas/card.py`

**Actions**:
1. Add `CardBulkItemCreate` schema (single card without deck_id):
   ```python
   class CardBulkItemCreate(BaseModel):
       """Single card in bulk create (without deck_id)."""
       front_text: str = Field(..., min_length=1)
       back_text: str = Field(..., min_length=1)
       example_sentence: Optional[str] = None
       pronunciation: Optional[str] = Field(None, max_length=255)
       difficulty: CardDifficulty
       order_index: int = Field(default=0, ge=0)
   ```

2. Add `CardBulkCreateRequest` schema (request body with deck_id and cards array):
   ```python
   class CardBulkCreateRequest(BaseModel):
       """Request body for bulk card creation."""
       deck_id: UUID
       cards: list[CardBulkItemCreate] = Field(
           ...,
           min_length=1,
           max_length=100,
           description="Array of cards to create (1-100)"
       )
   ```

3. Add `CardBulkCreateResponse` schema (response with created count):
   ```python
   class CardBulkCreateResponse(BaseModel):
       """Response for bulk card creation."""
       deck_id: UUID
       created_count: int
       cards: list[CardResponse]
   ```

**Verification**: Run `poetry run python -c "from src.schemas.card import CardBulkCreateRequest, CardBulkCreateResponse; print('OK')"`

---

### Step 2: Create or Update Cards Router (if not exists)
**Goal**: Add the bulk create endpoint to the cards router

**File to create/modify**: `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/api/v1/cards.py`

**Actions**:
1. If cards.py doesn't exist, create router following decks.py pattern:
   ```python
   from fastapi import APIRouter, Depends, status
   from uuid import UUID
   from sqlalchemy.ext.asyncio import AsyncSession

   from src.core.dependencies import get_current_superuser
   from src.core.exceptions import DeckNotFoundException
   from src.db.dependencies import get_db
   from src.db.models import User
   from src.repositories.card import CardRepository
   from src.repositories.deck import DeckRepository
   from src.schemas.card import (
       CardResponse,
       CardBulkCreateRequest,
       CardBulkCreateResponse,
   )

   router = APIRouter(
       tags=["Cards"],
       responses={
           422: {"description": "Validation error"},
       },
   )
   ```

2. Add the bulk create endpoint **BEFORE** any `/{card_id}` routes (critical for FastAPI route ordering):
   ```python
   @router.post(
       "/bulk",
       response_model=CardBulkCreateResponse,
       status_code=status.HTTP_201_CREATED,
       summary="Bulk create cards",
       description="Create multiple cards in one request. Requires superuser privileges. Maximum 100 cards per request.",
       responses={
           201: {"description": "Cards created successfully"},
           401: {"description": "Not authenticated"},
           403: {"description": "Not authorized (requires superuser)"},
           404: {"description": "Deck not found"},
           422: {"description": "Validation error (empty array, >100 cards, invalid data)"},
       },
   )
   async def bulk_create_cards(
       request: CardBulkCreateRequest,
       db: AsyncSession = Depends(get_db),
       current_user: User = Depends(get_current_superuser),
   ) -> CardBulkCreateResponse:
       ...
   ```

**Verification**: Router imports without errors

---

### Step 3: Implement Bulk Create Endpoint Logic
**Goal**: Complete the endpoint implementation with transaction handling

**File to modify**: `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/api/v1/cards.py`

**Actions**:
1. Implement the endpoint body:
   ```python
   async def bulk_create_cards(
       request: CardBulkCreateRequest,
       db: AsyncSession = Depends(get_db),
       current_user: User = Depends(get_current_superuser),
   ) -> CardBulkCreateResponse:
       """Create multiple cards in one request.

       Requires superuser privileges.

       This endpoint uses transactional semantics - if any card fails
       validation, the entire request is rejected (all-or-nothing).
       """
       # Validate deck exists
       deck_repo = DeckRepository(db)
       deck = await deck_repo.get(request.deck_id)
       if deck is None:
           raise DeckNotFoundException(deck_id=str(request.deck_id))

       # Prepare cards data with deck_id
       cards_data = [
           {
               "deck_id": request.deck_id,
               **card.model_dump()
           }
           for card in request.cards
       ]

       # Bulk create using repository
       card_repo = CardRepository(db)
       created_cards = await card_repo.bulk_create(cards_data)

       # Commit the transaction
       await db.commit()

       # Refresh all cards to get generated fields (id, timestamps)
       for card in created_cards:
           await db.refresh(card)

       return CardBulkCreateResponse(
           deck_id=request.deck_id,
           created_count=len(created_cards),
           cards=[CardResponse.model_validate(card) for card in created_cards],
       )
   ```

**Verification**: Manual testing with curl or API docs

---

### Step 4: Register Cards Router (if not already registered)
**Goal**: Mount the cards router in the v1 router

**File to modify**: `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/api/v1/router.py`

**Actions**:
1. Add import (if not exists):
   ```python
   from src.api.v1.cards import router as card_router
   ```

2. Add router registration (if not exists):
   ```python
   v1_router.include_router(
       card_router,
       prefix="/cards",
       tags=["Cards"],
   )
   ```

**Note**: The current router.py has placeholder comments for cards router - uncomment/add as needed.

**Verification**: Server starts without errors, `/api/v1/cards/bulk` endpoint is accessible

---

### Step 5: Verify Route Ordering in cards.py
**Goal**: Ensure `/bulk` route is defined before `/{card_id}` routes

**File to check**: `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/api/v1/cards.py`

**Actions**:
1. Review route order and ensure it follows this pattern:
   - `GET /` (list cards)
   - `POST /` (create single card)
   - `POST /bulk` (bulk create) <-- MUST be before /{card_id}
   - `GET /search` (search cards)
   - `GET /{card_id}` (get single)
   - `PATCH /{card_id}` (update)
   - `DELETE /{card_id}` (delete)

**Why**: FastAPI matches routes in definition order. If `/{card_id}` is defined first, "bulk" would be parsed as a UUID and fail.

**Verification**: Test that `POST /api/v1/cards/bulk` doesn't return 422 UUID validation error

---

### Step 6: Write Unit Tests
**Goal**: Test bulk create endpoint with various scenarios

**File to create**: `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/tests/integration/api/test_cards_bulk.py`

**Test Cases**:
1. `test_bulk_create_cards_success` - Admin creates 2 cards successfully
2. `test_bulk_create_cards_max_limit` - Create exactly 100 cards (boundary)
3. `test_bulk_create_cards_over_limit_returns_422` - 101 cards returns 422
4. `test_bulk_create_cards_empty_array_returns_422` - Empty cards array returns 422
5. `test_bulk_create_cards_invalid_deck_returns_404` - Non-existent deck returns 404
6. `test_bulk_create_cards_unauthorized_returns_401` - No auth returns 401
7. `test_bulk_create_cards_non_superuser_returns_403` - Regular user returns 403
8. `test_bulk_create_cards_invalid_card_data_returns_422` - Invalid card in array returns 422
9. `test_bulk_create_cards_all_have_correct_deck_id` - All created cards belong to correct deck
10. `test_bulk_create_cards_created_count_matches` - Response count matches array length
11. `test_bulk_create_cards_response_includes_all_fields` - Each card has id, timestamps, etc.
12. `test_bulk_create_cards_transaction_rollback` - On error, no cards are created

**Example test structure** (following existing patterns):
```python
class TestBulkCreateCardsEndpoint:
    @pytest.mark.asyncio
    async def test_bulk_create_cards_success(
        self, client: AsyncClient, superuser_auth_headers: dict, empty_deck: Deck
    ):
        cards_data = {
            "deck_id": str(empty_deck.id),
            "cards": [
                {
                    "front_text": "kalimera",
                    "back_text": "good morning",
                    "difficulty": "easy",
                    "order_index": 1
                },
                {
                    "front_text": "kalispera",
                    "back_text": "good evening",
                    "difficulty": "easy",
                    "order_index": 2
                }
            ]
        }

        response = await client.post(
            "/api/v1/cards/bulk",
            json=cards_data,
            headers=superuser_auth_headers,
        )

        assert response.status_code == 201
        data = response.json()
        assert data["deck_id"] == str(empty_deck.id)
        assert data["created_count"] == 2
        assert len(data["cards"]) == 2
```

**Verification**: `poetry run pytest tests/integration/api/test_cards_bulk.py -v`

---

### Step 7: Manual API Testing
**Goal**: Verify endpoint works correctly via API docs

**Actions**:
1. Start server: `poetry run uvicorn src.main:app --reload`
2. Open Swagger UI: `http://localhost:8000/docs`
3. Authenticate as superuser
4. Test `POST /api/v1/cards/bulk` with valid data
5. Verify error responses for invalid scenarios

**Test requests**:
- Valid bulk create (2 cards)
- Over 100 cards limit
- Empty cards array
- Invalid deck_id
- Without authentication
- With regular user (non-superuser)

---

### Step 8: Final Verification
**Goal**: Ensure all acceptance criteria are met

**Checklist**:
- [ ] Endpoint responds at `POST /api/v1/cards/bulk`
- [ ] Returns 201 with correct response schema on success
- [ ] Returns 401 when not authenticated
- [ ] Returns 403 when authenticated but not superuser
- [ ] Returns 404 when deck doesn't exist
- [ ] Returns 422 when cards array is empty
- [ ] Returns 422 when cards array exceeds 100
- [ ] Returns 422 when any card has invalid data
- [ ] All-or-nothing: no partial creates on validation failure
- [ ] All created cards have correct deck_id
- [ ] Response includes created_count matching actual count
- [ ] All tests pass

---

### Estimated Effort
- **Total steps**: 8
- **Complexity**: Medium
- **Time estimate**: 2-3 hours
- **Dependencies**: Task 07.04 (single card create) should be complete first for router to exist

### Files Summary

| Action | File Path |
|--------|-----------|
| Modify | `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/schemas/card.py` |
| Create/Modify | `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/api/v1/cards.py` |
| Modify | `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/api/v1/router.py` |
| Create | `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/tests/integration/api/test_cards_bulk.py` |

### Key Implementation Notes

1. **Route Ordering is Critical**: The `/bulk` endpoint MUST be defined before any `/{card_id}` routes, otherwise FastAPI will try to parse "bulk" as a UUID.

2. **Transaction Semantics**: The endpoint uses all-or-nothing semantics. If Pydantic validation passes but database insertion fails, the transaction rolls back.

3. **Limit of 100 Cards**: This is enforced at the schema level via `max_length=100` on the cards field. This prevents DoS attacks from very large payloads.

4. **Existing Repository Method**: `CardRepository.bulk_create()` already exists and handles the database insertion efficiently using `add_all()` and `flush()`.

5. **Refresh After Commit**: After committing, each card must be refreshed to get database-generated fields (id, created_at, updated_at).
<!-- SECTION:PLAN:END -->

## Implementation Notes

<!-- SECTION:NOTES:BEGIN -->
1. Uses existing `CardRepository.bulk_create()` method
2. All-or-nothing semantics (transaction rollback on failure)
3. Limited to 100 cards per request (DoS protection)
4. Each card gets its own UUID generated by database
5. Uses single transaction for efficiency

## Verification Steps

1. Test admin can bulk create cards
2. Test non-admin gets 403
3. Test invalid deck_id returns 404
4. Test empty cards array returns 422
5. Test >100 cards returns 422
6. Test invalid card in array rejects entire request
7. Verify all cards have correct deck_id
8. Verify created_count matches actual count
9. Test with various order_index values
<!-- SECTION:DESCRIPTION:END -->

Started implementation on 2025-12-08

PR: https://github.com/SimonOsipov/learn-greek-easy/pull/34

Implementation complete - all 20 tests pass, full test suite (932 tests) passes

## QA Verification Report

### Summary
- **Architecture Reference**: doc-26 (MVP Backend - 07: Cards API)
- **Status**: PASSED
- **Date**: 2025-12-08
- **PR**: https://github.com/SimonOsipov/learn-greek-easy/pull/34

### Code Review Findings

#### Route Ordering (CRITICAL)
- `/bulk` endpoint is at line 208, BEFORE `/{card_id}` routes (line 384+)
- Route order is correct:
  1. `GET ""` - List cards (line 39)
  2. `POST ""` - Create single card (line 136)
  3. `POST "/bulk"` - Bulk create cards (line 208)
  4. `GET "/search"` - Search cards (line 295)
  5. `GET "/{card_id}"` - Get single card (line 384)
  6. `PATCH "/{card_id}"` - Update card (line 439)
  7. `DELETE "/{card_id}"` - Delete card (line 514)

#### Schema Verification
File: `/src/schemas/card.py`
- `CardBulkItemCreate`: Lines 112-120 - Single card without deck_id
- `CardBulkCreateRequest`: Lines 123-132 - Request body with deck_id and cards array
  - `min_length=1` constraint enforced
  - `max_length=100` constraint enforced
- `CardBulkCreateResponse`: Lines 135-140 - Response with deck_id, created_count, cards

#### Endpoint Implementation
File: `/src/api/v1/cards.py` (lines 208-292)
- Uses `get_current_superuser` dependency for admin-only access
- Validates deck existence with `DeckNotFoundException`
- Uses `CardRepository.bulk_create()` for efficient batch insert
- Transaction committed after bulk create
- All cards refreshed to get generated fields (id, timestamps)

### Requirements Checklist

| # | Requirement | Status | Notes |
|---|-------------|--------|-------|
| 1 | POST /api/v1/cards/bulk endpoint exists | PASSED | Line 208 |
| 2 | Returns 201 Created on success | PASSED | Verified in tests |
| 3 | Returns deck_id, created_count, cards | PASSED | Schema enforces this |
| 4 | Requires superuser authentication | PASSED | get_current_superuser dependency |
| 5 | Returns 401 for unauthenticated | PASSED | Test: test_bulk_create_cards_unauthorized_returns_401 |
| 6 | Returns 403 for non-superuser | PASSED | Test: test_bulk_create_cards_non_superuser_returns_403 |
| 7 | Returns 404 for invalid deck_id | PASSED | Test: test_bulk_create_cards_invalid_deck_returns_404 |
| 8 | Returns 422 for empty cards array | PASSED | min_length=1 enforced |
| 9 | Returns 422 for >100 cards | PASSED | max_length=100 enforced |
| 10 | Returns 422 for invalid card data | PASSED | Test: test_bulk_create_cards_invalid_card_data_returns_422 |
| 11 | All cards get correct deck_id | PASSED | Test: test_bulk_create_cards_all_have_correct_deck_id |
| 12 | created_count matches actual count | PASSED | Test: test_bulk_create_cards_created_count_matches |
| 13 | Transaction semantics (all-or-nothing) | PASSED | Single commit after bulk_create |

### Test Results

```
Tests run: 20 bulk create tests
Tests passed: 20/20 (100%)
```

**Test file**: `/tests/integration/api/test_cards_bulk.py`

Tests cover:
- Basic success case (2 cards)
- All optional fields populated
- Over 100 cards limit (422)
- Empty cards array (422)
- Invalid deck_id (404)
- Unauthorized access (401)
- Non-superuser access (403)
- All cards have correct deck_id
- created_count accuracy
- Response includes all required fields
- Invalid card data in array (422)
- Invalid difficulty value (422)
- Negative order_index (422)
- Invalid deck_id format (422)
- Admin can create in inactive deck
- Cards are persisted (GET verification)
- All difficulty levels work
- Empty front_text (422)
- Empty back_text (422)
- Single card boundary case

### Full Cards API Test Suite

```
Total cards tests: 59
All passed: YES
```

### Verification Result: PASSED

All acceptance criteria from the task specification are met. The implementation is complete and all tests pass.
<!-- SECTION:NOTES:END -->
