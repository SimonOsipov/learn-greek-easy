---
id: task-154
title: 07.06 Bulk Create Cards Endpoint (Admin)
status: To Do
assignee: []
created_date: '2025-12-08 05:21'
labels:
  - backend
  - api
  - cards
  - task-07
dependencies: []
priority: medium
---

## Description

<!-- SECTION:DESCRIPTION:BEGIN -->
# 07.06 Bulk Create Cards Endpoint (Admin)

## Overview
Implement POST /api/v1/cards/bulk endpoint for creating multiple cards in one request. This is an admin-only endpoint requiring superuser privileges.

## Technical Specification

### Files to Modify

1. **Modify**: `src/schemas/card.py` - Add bulk create schemas
2. **Modify**: `src/api/v1/cards.py` - Add bulk_create_cards endpoint

### New Schemas

Add to `src/schemas/card.py`:

```python
class CardBulkItemCreate(BaseModel):
    """Single card in bulk create (without deck_id)."""
    front_text: str = Field(..., min_length=1)
    back_text: str = Field(..., min_length=1)
    example_sentence: Optional[str] = None
    pronunciation: Optional[str] = Field(None, max_length=255)
    difficulty: CardDifficulty
    order_index: int = Field(default=0, ge=0)

class CardBulkCreateRequest(BaseModel):
    """Request body for bulk card creation."""
    deck_id: UUID
    cards: list[CardBulkItemCreate] = Field(
        ...,
        min_length=1,
        max_length=100,
        description="Array of cards to create (1-100)"
    )

class CardBulkCreateResponse(BaseModel):
    """Response for bulk card creation."""
    deck_id: UUID
    created_count: int
    cards: list[CardResponse]
```

### Endpoint Implementation

Add to `src/api/v1/cards.py` (AFTER the single create endpoint):

```python
from src.schemas.card import CardBulkCreateRequest, CardBulkCreateResponse

@router.post(
    "/bulk",
    response_model=CardBulkCreateResponse,
    status_code=status.HTTP_201_CREATED,
    summary="Bulk create cards",
    description="Create multiple cards in one request. Requires superuser privileges. Maximum 100 cards per request.",
    responses={
        201: {
            "description": "Cards created successfully",
            "content": {
                "application/json": {
                    "example": {
                        "deck_id": "550e8400-e29b-41d4-a716-446655440000",
                        "created_count": 2,
                        "cards": [
                            {
                                "id": "...",
                                "deck_id": "550e8400-e29b-41d4-a716-446655440000",
                                "front_text": "kalimera",
                                "back_text": "good morning",
                                "difficulty": "easy",
                                "order_index": 1
                            }
                        ]
                    }
                }
            },
        },
        401: {"description": "Not authenticated"},
        403: {"description": "Not authorized (requires superuser)"},
        404: {"description": "Deck not found"},
        422: {"description": "Validation error (empty array, >100 cards, invalid data)"},
    },
)
async def bulk_create_cards(
    request: CardBulkCreateRequest,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_superuser),
) -> CardBulkCreateResponse:
    """Create multiple cards in one request.

    Requires superuser privileges.

    This endpoint uses transactional semantics - if any card fails
    validation, the entire request is rejected (all-or-nothing).

    Args:
        request: Deck ID and array of cards to create
        db: Database session (injected)
        current_user: Authenticated superuser (injected)

    Returns:
        CardBulkCreateResponse: Created cards with count

    Raises:
        401: If not authenticated
        403: If authenticated but not superuser
        404: If deck doesn't exist
        422: If validation fails (empty array, >100 cards, invalid card data)
    """
    # Validate deck exists
    deck_repo = DeckRepository(db)
    deck = await deck_repo.get(request.deck_id)
    if deck is None:
        raise DeckNotFoundException(deck_id=str(request.deck_id))

    # Prepare cards data with deck_id
    cards_data = [
        {
            "deck_id": request.deck_id,
            **card.model_dump()
        }
        for card in request.cards
    ]

    # Bulk create using repository
    card_repo = CardRepository(db)
    created_cards = await card_repo.bulk_create(cards_data)

    # Commit the transaction
    await db.commit()

    # Refresh all cards to get generated fields
    for card in created_cards:
        await db.refresh(card)

    return CardBulkCreateResponse(
        deck_id=request.deck_id,
        created_count=len(created_cards),
        cards=[CardResponse.model_validate(card) for card in created_cards],
    )
```

### API Contract

**Endpoint**: POST /api/v1/cards/bulk

**Authentication**: Required (superuser)

**Request Body**:
```json
{
  "deck_id": "550e8400-e29b-41d4-a716-446655440000",
  "cards": [
    {
      "front_text": "kalimera",
      "back_text": "good morning",
      "difficulty": "easy",
      "order_index": 1
    },
    {
      "front_text": "kalispera",
      "back_text": "good evening",
      "difficulty": "easy",
      "order_index": 2
    }
  ]
}
```

**Validation Rules**:
- `deck_id`: Required, valid UUID, deck must exist
- `cards`: Required array, min 1 card, max 100 cards
- Each card follows CardBulkItemCreate validation

**Response** (201 Created):
```json
{
  "deck_id": "550e8400-e29b-41d4-a716-446655440000",
  "created_count": 2,
  "cards": [...]
}
```

**Error Responses**:
- 401: Not authenticated
- 403: Not a superuser
- 404: Deck not found
- 422: Validation error

### Route Ordering

IMPORTANT: The /bulk route must be defined BEFORE the /{card_id} routes, otherwise FastAPI will try to parse "bulk" as a UUID.

Recommended route order in cards.py:
1. GET / (list)
2. POST / (create single)
3. POST /bulk (bulk create)
4. GET /search (search)
5. GET /{card_id} (get single)
6. PATCH /{card_id} (update)
7. DELETE /{card_id} (delete)

### Implementation Notes

1. Uses existing `CardRepository.bulk_create()` method
2. All-or-nothing semantics (transaction rollback on failure)
3. Limited to 100 cards per request (DoS protection)
4. Each card gets its own UUID generated by database
5. Uses single transaction for efficiency

## Verification Steps

1. Test admin can bulk create cards
2. Test non-admin gets 403
3. Test invalid deck_id returns 404
4. Test empty cards array returns 422
5. Test >100 cards returns 422
6. Test invalid card in array rejects entire request
7. Verify all cards have correct deck_id
8. Verify created_count matches actual count
9. Test with various order_index values
<!-- SECTION:DESCRIPTION:END -->
