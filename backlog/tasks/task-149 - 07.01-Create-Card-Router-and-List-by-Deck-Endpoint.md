---
id: task-149
title: 07.01 Create Card Router and List by Deck Endpoint
status: In Progress
assignee: []
created_date: '2025-12-08 05:21'
updated_date: '2025-12-08 05:48'
labels:
  - backend
  - api
  - cards
  - task-07
dependencies: []
priority: high
---

## Description

<!-- SECTION:DESCRIPTION:BEGIN -->
# 07.01 Create Card Router and List by Deck Endpoint

## Overview
Create the card router module and implement the GET /api/v1/cards endpoint for listing cards by deck with pagination and optional difficulty filtering.

## Technical Specification

### Files to Create/Modify

1. **Create**: `src/api/v1/cards.py` - New card router module
2. **Modify**: `src/api/v1/router.py` - Register card router
3. **Modify**: `src/schemas/card.py` - Add CardListResponse schema
4. **Modify**: `src/repositories/card.py` - Add count_by_deck method

### New Schema: CardListResponse

Add to `src/schemas/card.py`:

```python
class CardListResponse(BaseModel):
    """Schema for paginated card list by deck."""
    total: int
    page: int
    page_size: int
    deck_id: UUID
    cards: list[CardResponse]
```

### New Repository Method: count_by_deck

Add to `src/repositories/card.py`:

```python
async def count_by_deck(self, deck_id: UUID) -> int:
    """Count total cards in a deck."""
    query = select(func.count()).select_from(Card).where(Card.deck_id == deck_id)
    result = await self.db.execute(query)
    return result.scalar_one()
```

### Router Implementation

Create `src/api/v1/cards.py`:

```python
"""Card API endpoints."""

from typing import Optional
from uuid import UUID

from fastapi import APIRouter, Depends, Query
from sqlalchemy.ext.asyncio import AsyncSession

from src.core.exceptions import DeckNotFoundException
from src.db.dependencies import get_db
from src.db.models import CardDifficulty
from src.repositories.card import CardRepository
from src.repositories.deck import DeckRepository
from src.schemas.card import CardListResponse, CardResponse

router = APIRouter(
    tags=["Cards"],
    responses={
        422: {"description": "Validation error"},
    },
)

@router.get(
    "",
    response_model=CardListResponse,
    summary="List cards by deck",
    description="Get paginated list of cards for a specific deck with optional difficulty filtering.",
    responses={
        200: {"description": "Paginated list of cards"},
        404: {"description": "Deck not found"},
    },
)
async def list_cards(
    deck_id: UUID = Query(..., description="Deck UUID (required)"),
    difficulty: Optional[CardDifficulty] = Query(
        default=None, description="Filter by difficulty (easy, medium, hard)"
    ),
    page: int = Query(default=1, ge=1, description="Page number (starting from 1)"),
    page_size: int = Query(default=50, ge=1, le=100, description="Items per page (max 100)"),
    db: AsyncSession = Depends(get_db),
) -> CardListResponse:
    """List cards for a specific deck."""
    # Validate deck exists
    deck_repo = DeckRepository(db)
    deck = await deck_repo.get(deck_id)
    if deck is None or not deck.is_active:
        raise DeckNotFoundException(deck_id=str(deck_id))

    card_repo = CardRepository(db)
    skip = (page - 1) * page_size

    # Get cards with optional difficulty filter
    if difficulty:
        cards = await card_repo.get_by_difficulty(deck_id, difficulty)
        # Apply pagination manually for difficulty filter
        cards = cards[skip:skip + page_size]
        total = len(await card_repo.get_by_difficulty(deck_id, difficulty))
    else:
        cards = await card_repo.get_by_deck(deck_id, skip=skip, limit=page_size)
        total = await card_repo.count_by_deck(deck_id)

    return CardListResponse(
        total=total,
        page=page,
        page_size=page_size,
        deck_id=deck_id,
        cards=[CardResponse.model_validate(card) for card in cards],
    )
```

### Register Router

Update `src/api/v1/router.py`:

```python
from src.api.v1.cards import router as card_router

v1_router.include_router(
    card_router,
    prefix="/cards",
    tags=["Cards"],
)
```

### API Contract

**Endpoint**: GET /api/v1/cards

**Query Parameters**:
| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| deck_id | UUID | Yes | - | Filter by deck |
| difficulty | CardDifficulty | No | null | Filter by difficulty |
| page | int | No | 1 | Page number (min: 1) |
| page_size | int | No | 50 | Items per page (max: 100) |

**Response** (200 OK):
```json
{
  "total": 150,
  "page": 1,
  "page_size": 50,
  "deck_id": "550e8400-...",
  "cards": [...]
}
```

**Error Responses**:
- 404: Deck not found
- 422: Validation error

## Verification Steps

1. Run existing tests to ensure no regressions
2. Test endpoint with valid deck_id returns cards
3. Test endpoint with invalid deck_id returns 404
4. Test pagination works correctly
5. Test difficulty filter works
6. Verify response schema matches specification
<!-- SECTION:DESCRIPTION:END -->

## Implementation Plan

<!-- SECTION:PLAN:BEGIN -->
## Implementation Plan for 07.01 Create Card Router and List by Deck Endpoint

### Prerequisites
- [ ] Verify existing CardRepository methods in src/repositories/card.py
- [ ] Confirm CardResponse schema exists in src/schemas/card.py
- [ ] Ensure CardDifficulty enum is available in src/db/models.py
- [ ] Verify DeckNotFoundException exists in src/core/exceptions.py

---

### Step 1: Add count_by_deck Method to CardRepository

**Goal**: Add a method to count total cards in a deck for pagination purposes.

**File to modify**: learn-greek-easy-backend/src/repositories/card.py

**Actions**:
1. Import func from SQLAlchemy (already available)
2. Add count_by_deck async method that:
   - Takes deck_id as UUID parameter
   - Uses select(func.count()).select_from(Card).where(Card.deck_id == deck_id)
   - Returns result.scalar_one() as int
3. Follow the same pattern as DeckRepository.count_cards() method

**Verification**: Run pytest tests/unit/repositories/ -k card -v

---

### Step 2: Add CardListResponse Schema

**Goal**: Create the paginated response schema for listing cards by deck.

**File to modify**: learn-greek-easy-backend/src/schemas/card.py

**Actions**:
1. Add CardListResponse class after CardStudyResultResponse
2. Include fields: total (int), page (int), page_size (int), deck_id (UUID), cards (list of CardResponse)
3. Follow the same pattern as DeckListResponse in src/schemas/deck.py

**Verification**: Import check from src.schemas.card

---

### Step 3: Create Card Router Module

**Goal**: Create the new card router with the list cards endpoint.

**File to create**: learn-greek-easy-backend/src/api/v1/cards.py

**Actions**:
1. Create file with imports: APIRouter, Depends, Query from fastapi; AsyncSession; UUID; Optional
2. Import exceptions, dependencies, models, repositories, schemas
3. Create router with tags=["Cards"] and responses dict
4. Implement list_cards endpoint at GET "" with:
   - Query params: deck_id (required UUID), difficulty (optional CardDifficulty), page (default 1, ge 1), page_size (default 50, ge 1, le 100)
   - Validate deck exists and is active using DeckRepository
   - Raise DeckNotFoundException if deck not found or inactive
   - Calculate skip = (page - 1) * page_size
   - If difficulty filter: get_by_difficulty then slice for pagination
   - Else: get_by_deck with skip/limit, count_by_deck for total
   - Return CardListResponse with total, page, page_size, deck_id, cards list

**Reference**: Follow src/api/v1/decks.py pattern exactly

**Verification**: Check file has no syntax errors, imports resolve

---

### Step 4: Register Card Router in v1 Router

**Goal**: Mount the card router at /cards prefix under /api/v1.

**File to modify**: learn-greek-easy-backend/src/api/v1/router.py

**Actions**:
1. Add import: from src.api.v1.cards import router as card_router
2. Add router registration after deck router section:
   - v1_router.include_router(card_router, prefix="/cards", tags=["Cards"])
3. Add comment section header like existing routes

**Verification**: Start app, check /docs shows Cards endpoints

---

### Step 5: Manual API Testing

**Goal**: Verify the endpoint works correctly with various inputs.

**Test Cases**:
1. GET /api/v1/cards?deck_id=valid-uuid - returns cards
2. GET /api/v1/cards?deck_id=invalid-uuid - returns 404
3. GET /api/v1/cards?deck_id=uuid&page=2&page_size=10 - pagination works
4. GET /api/v1/cards?deck_id=uuid&difficulty=easy - filter works
5. GET /api/v1/cards?deck_id=uuid&page=0 - returns 422
6. GET /api/v1/cards (no deck_id) - returns 422

**Verification**: All responses match expected status codes and schemas

---

### Step 6: Run Existing Tests

**Goal**: Ensure no regressions in existing functionality.

**Command**: cd learn-greek-easy-backend && poetry run pytest -n auto

**Verification**: All tests pass, no import errors

---

### Estimated Effort
- Total steps: 6
- Complexity: Low-Medium
- Estimated time: 1-2 hours

### Risk Areas
- Pagination with difficulty filter uses manual slicing (acceptable for MVP)
- Deck validation must check is_active field

### Files Summary
| File | Action | Purpose |
|------|--------|---------|
| src/repositories/card.py | Modify | Add count_by_deck method |
| src/schemas/card.py | Modify | Add CardListResponse schema |
| src/api/v1/cards.py | Create | New card router with list endpoint |
| src/api/v1/router.py | Modify | Register card router |
<!-- SECTION:PLAN:END -->
