---
id: task-149
title: 07.01 Create Card Router and List by Deck Endpoint
status: To Do
assignee: []
created_date: '2025-12-08 05:21'
labels:
  - backend
  - api
  - cards
  - task-07
dependencies: []
priority: high
---

## Description

<!-- SECTION:DESCRIPTION:BEGIN -->
# 07.01 Create Card Router and List by Deck Endpoint

## Overview
Create the card router module and implement the GET /api/v1/cards endpoint for listing cards by deck with pagination and optional difficulty filtering.

## Technical Specification

### Files to Create/Modify

1. **Create**: `src/api/v1/cards.py` - New card router module
2. **Modify**: `src/api/v1/router.py` - Register card router
3. **Modify**: `src/schemas/card.py` - Add CardListResponse schema
4. **Modify**: `src/repositories/card.py` - Add count_by_deck method

### New Schema: CardListResponse

Add to `src/schemas/card.py`:

```python
class CardListResponse(BaseModel):
    """Schema for paginated card list by deck."""
    total: int
    page: int
    page_size: int
    deck_id: UUID
    cards: list[CardResponse]
```

### New Repository Method: count_by_deck

Add to `src/repositories/card.py`:

```python
async def count_by_deck(self, deck_id: UUID) -> int:
    """Count total cards in a deck."""
    query = select(func.count()).select_from(Card).where(Card.deck_id == deck_id)
    result = await self.db.execute(query)
    return result.scalar_one()
```

### Router Implementation

Create `src/api/v1/cards.py`:

```python
"""Card API endpoints."""

from typing import Optional
from uuid import UUID

from fastapi import APIRouter, Depends, Query
from sqlalchemy.ext.asyncio import AsyncSession

from src.core.exceptions import DeckNotFoundException
from src.db.dependencies import get_db
from src.db.models import CardDifficulty
from src.repositories.card import CardRepository
from src.repositories.deck import DeckRepository
from src.schemas.card import CardListResponse, CardResponse

router = APIRouter(
    tags=["Cards"],
    responses={
        422: {"description": "Validation error"},
    },
)

@router.get(
    "",
    response_model=CardListResponse,
    summary="List cards by deck",
    description="Get paginated list of cards for a specific deck with optional difficulty filtering.",
    responses={
        200: {"description": "Paginated list of cards"},
        404: {"description": "Deck not found"},
    },
)
async def list_cards(
    deck_id: UUID = Query(..., description="Deck UUID (required)"),
    difficulty: Optional[CardDifficulty] = Query(
        default=None, description="Filter by difficulty (easy, medium, hard)"
    ),
    page: int = Query(default=1, ge=1, description="Page number (starting from 1)"),
    page_size: int = Query(default=50, ge=1, le=100, description="Items per page (max 100)"),
    db: AsyncSession = Depends(get_db),
) -> CardListResponse:
    """List cards for a specific deck."""
    # Validate deck exists
    deck_repo = DeckRepository(db)
    deck = await deck_repo.get(deck_id)
    if deck is None or not deck.is_active:
        raise DeckNotFoundException(deck_id=str(deck_id))

    card_repo = CardRepository(db)
    skip = (page - 1) * page_size

    # Get cards with optional difficulty filter
    if difficulty:
        cards = await card_repo.get_by_difficulty(deck_id, difficulty)
        # Apply pagination manually for difficulty filter
        cards = cards[skip:skip + page_size]
        total = len(await card_repo.get_by_difficulty(deck_id, difficulty))
    else:
        cards = await card_repo.get_by_deck(deck_id, skip=skip, limit=page_size)
        total = await card_repo.count_by_deck(deck_id)

    return CardListResponse(
        total=total,
        page=page,
        page_size=page_size,
        deck_id=deck_id,
        cards=[CardResponse.model_validate(card) for card in cards],
    )
```

### Register Router

Update `src/api/v1/router.py`:

```python
from src.api.v1.cards import router as card_router

v1_router.include_router(
    card_router,
    prefix="/cards",
    tags=["Cards"],
)
```

### API Contract

**Endpoint**: GET /api/v1/cards

**Query Parameters**:
| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| deck_id | UUID | Yes | - | Filter by deck |
| difficulty | CardDifficulty | No | null | Filter by difficulty |
| page | int | No | 1 | Page number (min: 1) |
| page_size | int | No | 50 | Items per page (max: 100) |

**Response** (200 OK):
```json
{
  "total": 150,
  "page": 1,
  "page_size": 50,
  "deck_id": "550e8400-...",
  "cards": [...]
}
```

**Error Responses**:
- 404: Deck not found
- 422: Validation error

## Verification Steps

1. Run existing tests to ensure no regressions
2. Test endpoint with valid deck_id returns cards
3. Test endpoint with invalid deck_id returns 404
4. Test pagination works correctly
5. Test difficulty filter works
6. Verify response schema matches specification
<!-- SECTION:DESCRIPTION:END -->
