---
id: task-153
title: 07.05 Update and Delete Card Endpoints (Admin)
status: To Do
assignee: []
created_date: '2025-12-08 05:21'
labels:
  - backend
  - api
  - cards
  - task-07
dependencies: []
priority: high
---

## Description

<!-- SECTION:DESCRIPTION:BEGIN -->
# 07.05 Update and Delete Card Endpoints (Admin)

## Overview
Implement PATCH /api/v1/cards/{id} for updating cards and DELETE /api/v1/cards/{id} for deleting cards. Both are admin-only endpoints.

## Technical Specification

### Files to Modify

1. **Modify**: `src/api/v1/cards.py` - Add update_card and delete_card endpoints

### Update Endpoint Implementation

Add to `src/api/v1/cards.py`:

```python
from fastapi import Response
from src.schemas.card import CardUpdate

@router.patch(
    "/{card_id}",
    response_model=CardResponse,
    summary="Update a card",
    description="Update an existing card. Requires superuser privileges.",
    responses={
        200: {
            "description": "Card updated successfully",
            "content": {
                "application/json": {
                    "example": {
                        "id": "660e8400-e29b-41d4-a716-446655440001",
                        "deck_id": "550e8400-e29b-41d4-a716-446655440000",
                        "front_text": "Updated Greek text",
                        "back_text": "Updated English text",
                        "example_sentence": "Updated example",
                        "pronunciation": "updated",
                        "difficulty": "hard",
                        "order_index": 5,
                        "created_at": "2024-01-15T10:30:00Z",
                        "updated_at": "2024-01-16T14:00:00Z"
                    }
                }
            },
        },
        401: {"description": "Not authenticated"},
        403: {"description": "Not authorized (requires superuser)"},
        404: {"description": "Card not found"},
        422: {"description": "Validation error"},
    },
)
async def update_card(
    card_id: UUID,
    card_data: CardUpdate,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_superuser),
) -> CardResponse:
    """Update an existing card.

    Requires superuser privileges.
    Only provided fields will be updated (partial update).
    Note: deck_id cannot be changed.

    Args:
        card_id: UUID of the card to update
        card_data: Fields to update (all optional)
        db: Database session (injected)
        current_user: Authenticated superuser (injected)

    Returns:
        CardResponse: The updated card

    Raises:
        401: If not authenticated
        403: If authenticated but not superuser
        404: If card doesn't exist
        422: If validation fails
    """
    repo = CardRepository(db)

    # Get existing card
    card = await repo.get(card_id)
    if card is None:
        raise CardNotFoundException(card_id=str(card_id))

    # Update card
    updated_card = await repo.update(card, card_data)

    # Commit the transaction
    await db.commit()
    await db.refresh(updated_card)

    return CardResponse.model_validate(updated_card)
```

### Delete Endpoint Implementation

Add to `src/api/v1/cards.py`:

```python
@router.delete(
    "/{card_id}",
    status_code=status.HTTP_204_NO_CONTENT,
    summary="Delete a card",
    description="Delete a card. Requires superuser privileges. This is a hard delete.",
    responses={
        204: {"description": "Card deleted successfully"},
        401: {"description": "Not authenticated"},
        403: {"description": "Not authorized (requires superuser)"},
        404: {"description": "Card not found"},
    },
)
async def delete_card(
    card_id: UUID,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_superuser),
) -> Response:
    """Delete a card.

    Requires superuser privileges.

    WARNING: This is a HARD DELETE. The card and all associated
    statistics/reviews will be permanently removed.

    Args:
        card_id: UUID of the card to delete
        db: Database session (injected)
        current_user: Authenticated superuser (injected)

    Returns:
        Empty response with 204 status

    Raises:
        401: If not authenticated
        403: If authenticated but not superuser
        404: If card doesn't exist
    """
    repo = CardRepository(db)

    # Get existing card
    card = await repo.get(card_id)
    if card is None:
        raise CardNotFoundException(card_id=str(card_id))

    # Hard delete the card
    await repo.delete(card)

    # Commit the transaction
    await db.commit()

    return Response(status_code=status.HTTP_204_NO_CONTENT)
```

### API Contracts

#### PATCH /api/v1/cards/{card_id}

**Authentication**: Required (superuser)

**Path Parameters**:
| Parameter | Type | Description |
|-----------|------|-------------|
| card_id | UUID | Card UUID |

**Request Body** (all fields optional):
```json
{
  "front_text": "Updated Greek text",
  "back_text": "Updated English text",
  "example_sentence": "Updated example",
  "pronunciation": "updated",
  "difficulty": "hard",
  "order_index": 5
}
```

**Validation Rules** (from existing CardUpdate schema):
- `front_text`: If provided, min 1 character
- `back_text`: If provided, min 1 character
- `pronunciation`: If provided, max 255 characters
- `order_index`: If provided, must be >= 0
- Note: `deck_id` is NOT in CardUpdate schema (cannot be changed)

**Response** (200 OK): Full CardResponse

#### DELETE /api/v1/cards/{card_id}

**Authentication**: Required (superuser)

**Path Parameters**:
| Parameter | Type | Description |
|-----------|------|-------------|
| card_id | UUID | Card UUID |

**Response** (204 No Content): Empty response

### Implementation Notes

1. **Update**: Uses existing CardUpdate schema (excludes deck_id)
2. **Delete**: Hard delete (not soft delete like decks)
3. **Cascade**: Deleting card cascades to card_statistics and reviews via FK
4. Both endpoints use `get_current_superuser` dependency

### Route Ordering

Ensure PATCH and DELETE routes are defined AFTER the /search route to avoid path conflicts.

## Verification Steps

### Update Endpoint
1. Test admin can update card fields
2. Test partial update (single field) works
3. Test non-admin gets 403
4. Test non-existent card returns 404
5. Test validation errors return 422
6. Verify updated_at timestamp changes

### Delete Endpoint
1. Test admin can delete card
2. Test non-admin gets 403
3. Test non-existent card returns 404
4. Verify card is removed from database
5. Verify related statistics/reviews are cascade deleted
<!-- SECTION:DESCRIPTION:END -->
