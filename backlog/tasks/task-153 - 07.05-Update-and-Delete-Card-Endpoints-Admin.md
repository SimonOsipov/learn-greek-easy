---
id: task-153
title: 07.05 Update and Delete Card Endpoints (Admin)
status: Done
assignee: []
created_date: '2025-12-08 05:21'
updated_date: '2025-12-08 14:51'

labels:
  - backend
  - api
  - cards
  - task-07
dependencies: []
priority: high
---

## Description

<!-- SECTION:DESCRIPTION:BEGIN -->
# 07.05 Update and Delete Card Endpoints (Admin)

## Overview
Implement PATCH /api/v1/cards/{id} for updating cards and DELETE /api/v1/cards/{id} for deleting cards. Both are admin-only endpoints.

## Technical Specification

### Files to Modify

1. **Modify**: `src/api/v1/cards.py` - Add update_card and delete_card endpoints

### Update Endpoint Implementation

Add to `src/api/v1/cards.py`:

```python
from fastapi import Response
from src.schemas.card import CardUpdate

@router.patch(
    "/{card_id}",
    response_model=CardResponse,
    summary="Update a card",
    description="Update an existing card. Requires superuser privileges.",
    responses={
        200: {
            "description": "Card updated successfully",
            "content": {
                "application/json": {
                    "example": {
                        "id": "660e8400-e29b-41d4-a716-446655440001",
                        "deck_id": "550e8400-e29b-41d4-a716-446655440000",
                        "front_text": "Updated Greek text",
                        "back_text": "Updated English text",
                        "example_sentence": "Updated example",
                        "pronunciation": "updated",
                        "difficulty": "hard",
                        "order_index": 5,
                        "created_at": "2024-01-15T10:30:00Z",
                        "updated_at": "2024-01-16T14:00:00Z"
                    }
                }
            },
        },
        401: {"description": "Not authenticated"},
        403: {"description": "Not authorized (requires superuser)"},
        404: {"description": "Card not found"},
        422: {"description": "Validation error"},
    },
)
async def update_card(
    card_id: UUID,
    card_data: CardUpdate,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_superuser),
) -> CardResponse:
    """Update an existing card.

    Requires superuser privileges.
    Only provided fields will be updated (partial update).
    Note: deck_id cannot be changed.

    Args:
        card_id: UUID of the card to update
        card_data: Fields to update (all optional)
        db: Database session (injected)
        current_user: Authenticated superuser (injected)

    Returns:
        CardResponse: The updated card

    Raises:
        401: If not authenticated
        403: If authenticated but not superuser
        404: If card doesn't exist
        422: If validation fails
    """
    repo = CardRepository(db)

    # Get existing card
    card = await repo.get(card_id)
    if card is None:
        raise CardNotFoundException(card_id=str(card_id))

    # Update card
    updated_card = await repo.update(card, card_data)

    # Commit the transaction
    await db.commit()
    await db.refresh(updated_card)

    return CardResponse.model_validate(updated_card)
```

### Delete Endpoint Implementation

Add to `src/api/v1/cards.py`:

```python
@router.delete(
    "/{card_id}",
    status_code=status.HTTP_204_NO_CONTENT,
    summary="Delete a card",
    description="Delete a card. Requires superuser privileges. This is a hard delete.",
    responses={
        204: {"description": "Card deleted successfully"},
        401: {"description": "Not authenticated"},
        403: {"description": "Not authorized (requires superuser)"},
        404: {"description": "Card not found"},
    },
)
async def delete_card(
    card_id: UUID,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_superuser),
) -> Response:
    """Delete a card.

    Requires superuser privileges.

    WARNING: This is a HARD DELETE. The card and all associated
    statistics/reviews will be permanently removed.

    Args:
        card_id: UUID of the card to delete
        db: Database session (injected)
        current_user: Authenticated superuser (injected)

    Returns:
        Empty response with 204 status

    Raises:
        401: If not authenticated
        403: If authenticated but not superuser
        404: If card doesn't exist
    """
    repo = CardRepository(db)

    # Get existing card
    card = await repo.get(card_id)
    if card is None:
        raise CardNotFoundException(card_id=str(card_id))

    # Hard delete the card
    await repo.delete(card)

    # Commit the transaction
    await db.commit()

    return Response(status_code=status.HTTP_204_NO_CONTENT)
```

### API Contracts

#### PATCH /api/v1/cards/{card_id}

**Authentication**: Required (superuser)

**Path Parameters**:
| Parameter | Type | Description |
|-----------|------|-------------|
| card_id | UUID | Card UUID |

**Request Body** (all fields optional):
```json
{
  "front_text": "Updated Greek text",
  "back_text": "Updated English text",
  "example_sentence": "Updated example",
  "pronunciation": "updated",
  "difficulty": "hard",
  "order_index": 5
}
```

**Validation Rules** (from existing CardUpdate schema):
- `front_text`: If provided, min 1 character
- `back_text`: If provided, min 1 character
- `pronunciation`: If provided, max 255 characters
- `order_index`: If provided, must be >= 0
- Note: `deck_id` is NOT in CardUpdate schema (cannot be changed)

**Response** (200 OK): Full CardResponse

#### DELETE /api/v1/cards/{card_id}

**Authentication**: Required (superuser)

**Path Parameters**:
| Parameter | Type | Description |
|-----------|------|-------------|
| card_id | UUID | Card UUID |

**Response** (204 No Content): Empty response

### Implementation Notes

1. **Update**: Uses existing CardUpdate schema (excludes deck_id)
2. **Delete**: Hard delete (not soft delete like decks)
3. **Cascade**: Deleting card cascades to card_statistics and reviews via FK
4. Both endpoints use `get_current_superuser` dependency

### Route Ordering

Ensure PATCH and DELETE routes are defined AFTER the /search route to avoid path conflicts.

## Verification Steps

### Update Endpoint
1. Test admin can update card fields
2. Test partial update (single field) works
3. Test non-admin gets 403
4. Test non-existent card returns 404
5. Test validation errors return 422
6. Verify updated_at timestamp changes

### Delete Endpoint
1. Test admin can delete card
2. Test non-admin gets 403
3. Test non-existent card returns 404
4. Verify card is removed from database
5. Verify related statistics/reviews are cascade deleted
<!-- SECTION:DESCRIPTION:END -->

## Implementation Plan

<!-- SECTION:PLAN:BEGIN -->
## Implementation Plan for 07.05 Update and Delete Card Endpoints (Admin)

### Prerequisites
- [ ] Verify task-149 (Create Card Router) is completed - cards.py router file must exist
- [ ] Verify task-152 (Create Card Endpoint) is completed - CardCreate already works
- [ ] Confirm CardUpdate schema exists in src/schemas/card.py (already exists)
- [ ] Confirm CardNotFoundException exists in src/core/exceptions.py (already exists)
- [ ] Confirm BaseRepository.update() and BaseRepository.delete() methods exist (already exist)

### Step 1: Review Existing Card Router Structure
**Goal**: Understand the current state of cards.py router and ensure proper route ordering

**Actions**:
1. Open src/api/v1/cards.py
2. Verify the router is properly set up with tags and responses
3. Identify where PATCH and DELETE routes should be added (AFTER /search route to avoid path conflicts)

**Files to review**:
- src/api/v1/cards.py - Current router file

**Verification**: Router file exists and has proper structure

---

### Step 2: Add Required Imports
**Goal**: Ensure all necessary imports are present in cards.py

**Actions**:
1. Verify these imports exist (add if missing):
   - from fastapi import Response, status
   - from src.schemas.card import CardUpdate
   - from src.core.exceptions import CardNotFoundException

**Files to modify**:
- src/api/v1/cards.py

**Verification**: No import errors when running the application

---

### Step 3: Implement PATCH /api/v1/cards/{card_id} Endpoint
**Goal**: Create the update card endpoint with proper authentication and validation

**Actions**:
1. Add the update_card endpoint to src/api/v1/cards.py with:
   - Route decorator: @router.patch("/{card_id}", response_model=CardResponse, ...)
   - OpenAPI documentation (summary, description, responses)
   - Path parameter: card_id: UUID
   - Body: card_data: CardUpdate
   - Dependencies: get_db, get_current_superuser
2. Implement endpoint logic:
   - Create CardRepository(db) instance
   - Fetch card using repo.get(card_id)
   - Return 404 using CardNotFoundException if not found
   - Update card using repo.update(card, card_data)
   - Commit transaction and refresh
   - Return CardResponse.model_validate(updated_card)

**Key Code Pattern** (from decks.py):
- Get existing object: card = await repo.get(card_id)
- Check None: if card is None: raise CardNotFoundException(card_id=str(card_id))
- Update: updated_card = await repo.update(card, card_data)
- Commit and refresh: await db.commit(); await db.refresh(updated_card)
- Return: CardResponse.model_validate(updated_card)

**Files to modify**:
- src/api/v1/cards.py

**Verification**:
- Endpoint responds at PATCH /api/v1/cards/{card_id}
- Returns 200 with updated card data for valid requests
- Returns 401 for unauthenticated requests
- Returns 403 for non-superuser requests
- Returns 404 for non-existent card_id

---

### Step 4: Implement DELETE /api/v1/cards/{card_id} Endpoint
**Goal**: Create the delete card endpoint with proper authentication (hard delete)

**Actions**:
1. Add the delete_card endpoint to src/api/v1/cards.py with:
   - Route decorator: @router.delete("/{card_id}", status_code=status.HTTP_204_NO_CONTENT, ...)
   - OpenAPI documentation (summary, description, responses)
   - Path parameter: card_id: UUID
   - Dependencies: get_db, get_current_superuser
2. Implement endpoint logic:
   - Create CardRepository(db) instance
   - Fetch card using repo.get(card_id)
   - Return 404 using CardNotFoundException if not found
   - Delete card using repo.delete(card) - THIS IS HARD DELETE, NOT SOFT DELETE
   - Commit transaction
   - Return empty Response(status_code=status.HTTP_204_NO_CONTENT)

**Key Difference from Decks**: Decks use soft delete (is_active=False), but Cards use HARD DELETE (physically removed from database). The card_statistics and reviews are cascade deleted via FK.

**Files to modify**:
- src/api/v1/cards.py

**Verification**:
- Endpoint responds at DELETE /api/v1/cards/{card_id}
- Returns 204 with empty body for successful delete
- Returns 401 for unauthenticated requests
- Returns 403 for non-superuser requests
- Returns 404 for non-existent card_id
- Card is physically removed from database

---

### Step 5: Verify Route Ordering
**Goal**: Ensure PATCH and DELETE routes are ordered correctly to avoid path conflicts

**Actions**:
1. Review the order of routes in src/api/v1/cards.py
2. Ensure routes are in this order:
   - GET / (list cards)
   - POST / (create card)
   - GET /search (search cards) - MUST be before /{card_id}
   - GET /{card_id} (get single card)
   - PATCH /{card_id} (update card) - NEW
   - DELETE /{card_id} (delete card) - NEW

**Files to review**:
- src/api/v1/cards.py

**Verification**:
- /search endpoint still works correctly
- No route conflicts occur

---

### Step 6: Test Update Endpoint Manually
**Goal**: Verify update endpoint works as expected

**Test Cases**:
1. Admin can update card fields - Expected: 200 OK with updated card
2. Partial update (single field) works - Verify other fields remain unchanged
3. Non-admin gets 403 - Use regular user token
4. Non-existent card returns 404 - Use random UUID
5. Validation errors return 422 - Send front_text: "" (empty string)
6. updated_at timestamp changes - Verify updated_at is updated after PATCH

---

### Step 7: Test Delete Endpoint Manually
**Goal**: Verify delete endpoint works as expected

**Test Cases**:
1. Admin can delete card - Expected: 204 No Content
2. Non-admin gets 403 - Use regular user token
3. Non-existent card returns 404 - Use random UUID
4. Card is removed from database - Verify GET returns 404 after delete
5. Related statistics/reviews are cascade deleted - Verify no orphaned records

---

### Step 8: Run Existing Tests
**Goal**: Ensure new endpoints do not break existing functionality

**Actions**:
1. Run all backend tests:
   cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend
   /Users/samosipov/.local/bin/poetry run pytest -n auto
2. Verify all tests pass

**Verification**: All existing tests pass

---

### Step 9: Final Code Review
**Goal**: Ensure code quality and consistency

**Checklist**:
- [ ] Code follows existing patterns from decks.py
- [ ] Docstrings are comprehensive with Args, Returns, Raises sections
- [ ] OpenAPI responses documentation is complete
- [ ] Exception handling uses CardNotFoundException
- [ ] Transaction management: flush in repo, commit in endpoint
- [ ] Type hints are correct
- [ ] No unused imports

---

## Summary of Files to Modify

| File | Action | Description |
|------|--------|-------------|
| src/api/v1/cards.py | Modify | Add PATCH and DELETE endpoints |

## Key Implementation Notes

1. Update uses existing CardUpdate schema - excludes deck_id (cards cannot be moved between decks)
2. Delete is a HARD DELETE - unlike decks which use soft delete (is_active=False), cards are physically removed
3. Cascade behavior - deleting a card cascades to card_statistics and reviews tables via FK constraints
4. Both endpoints require superuser - use get_current_superuser dependency
5. Follow decks.py patterns - use same transaction pattern (flush in repo, commit in endpoint, refresh after commit)

## Estimated Effort
- Total steps: 9
- Complexity: Low
- Estimated time: 1-2 hours (including manual testing)

## Dependencies
- Requires task-149 (Card Router) to be completed first
- Tests will be added in task-155 (Cards API Tests)
<!-- SECTION:PLAN:END -->

## Implementation Notes

<!-- SECTION:NOTES:BEGIN -->
1. **Update**: Uses existing CardUpdate schema (excludes deck_id)
2. **Delete**: Hard delete (not soft delete like decks)
3. **Cascade**: Deleting card cascades to card_statistics and reviews via FK
4. Both endpoints use `get_current_superuser` dependency

### Route Ordering

Ensure PATCH and DELETE routes are defined AFTER the /search route to avoid path conflicts.

## Verification Steps

### Update Endpoint
1. Test admin can update card fields
2. Test partial update (single field) works
3. Test non-admin gets 403
4. Test non-existent card returns 404
5. Test validation errors return 422
6. Verify updated_at timestamp changes

### Delete Endpoint
1. Test admin can delete card
2. Test non-admin gets 403
3. Test non-existent card returns 404
4. Verify card is removed from database
5. Verify related statistics/reviews are cascade deleted
<!-- SECTION:DESCRIPTION:END -->

Started implementation on 2025-12-08. Creating feature branch and implementing PATCH/DELETE endpoints.

Implementation complete. PR: https://github.com/SimonOsipov/learn-greek-easy/pull/33

Changes made to src/api/v1/cards.py:

- Added Response import from fastapi

- Added CardUpdate import from schemas

- Added PATCH /{card_id} endpoint for updating cards

- Added DELETE /{card_id} endpoint for hard-deleting cards

- Both endpoints require superuser authentication

- All 932 existing tests pass

## QA Verification Report

### Summary
- **PR**: https://github.com/SimonOsipov/learn-greek-easy/pull/33
- **Status**: PASSED
- **Date**: 2025-12-08
- **Verified by**: QA Agent

### Requirements Checklist

#### PATCH Endpoint (Update Card)
| Requirement | Status | Location |
|-------------|--------|----------|
| PATCH endpoint at /{card_id} | PASSED | Line 350 |
| Uses get_current_superuser dependency | PASSED | Line 385 |
| OpenAPI documentation (summary, description, responses) | PASSED | Lines 350-379 |
| CardNotFoundException for 404 errors | PASSED | Line 413 |
| Transaction management (commit in endpoint) | PASSED | Lines 419-420 |
| Uses CardUpdate schema (excludes deck_id) | PASSED | Line 383, Schema lines 39-47 |
| Returns 200 with CardResponse | PASSED | Line 352, 422 |

#### DELETE Endpoint (Delete Card)
| Requirement | Status | Location |
|-------------|--------|----------|
| DELETE endpoint at /{card_id} | PASSED | Line 425 |
| Uses get_current_superuser dependency | PASSED | Line 440 |
| OpenAPI documentation (summary, description, responses) | PASSED | Lines 425-435 |
| CardNotFoundException for 404 errors | PASSED | Line 467 |
| Transaction management (commit in endpoint) | PASSED | Line 472 |
| HARD DELETE (not soft delete) | PASSED | Line 470 (repo.delete) |
| Returns 204 No Content | PASSED | Lines 427, 475 |

#### Route Ordering
| Requirement | Status | Notes |
|-------------|--------|-------|
| Routes after /search to avoid conflicts | PASSED | Line 291 comment, correct order |

#### Error Responses
| Response | Status | Notes |
|----------|--------|-------|
| 401 Unauthorized | PASSED | get_current_superuser raises 401 |
| 403 Forbidden | PASSED | get_current_superuser raises 403 for non-superuser |
| 404 Not Found | PASSED | CardNotFoundException |
| 422 Validation Error | PASSED | Pydantic validation |

### Test Results
- **All 932 tests passed**
- Note: Coverage at 85.49% (below 90% threshold is pre-existing, not related to this task)
- Tests for PATCH/DELETE planned in task-155 (Cards API Tests)

### Code Quality
- Follows existing patterns from decks.py
- Comprehensive docstrings with Args, Returns, Raises sections
- Complete OpenAPI responses documentation
- Correct type hints
- No unused imports

### Verification Result: PASSED
All requirements from task-153 have been implemented correctly. The PATCH and DELETE endpoints are functional and follow the established patterns.
<!-- SECTION:NOTES:END -->
