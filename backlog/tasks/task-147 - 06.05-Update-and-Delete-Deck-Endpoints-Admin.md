---
id: task-147
title: '[06.05] Update and Delete Deck Endpoints (Admin)'
status: In Progress
assignee: []
created_date: '2025-12-07 14:10'
updated_date: '2025-12-07 20:50'
labels:
  - backend
  - deck-api
  - task-6
dependencies: []
priority: medium
---

## Description

<!-- SECTION:DESCRIPTION:BEGIN -->
# [06.05] Update and Delete Deck Endpoints (Admin)

## Goal/Purpose

Implement the `PATCH /api/v1/decks/{id}` and `DELETE /api/v1/decks/{id}` endpoints for administrators to update and soft-delete decks. Both endpoints require superuser privileges.

## Dependencies

| Component | Location | Usage |
|-----------|----------|-------|
| DeckRepository | `src/repositories/deck.py` | `get()`, `update()` methods |
| Deck Schemas | `src/schemas/deck.py` | `DeckUpdate`, `DeckResponse` |
| Auth Dependencies | `src/core/dependencies.py` | `get_current_superuser` |
| Exceptions | `src/core/exceptions.py` | `DeckNotFoundException` |
| Deck Router | `src/api/v1/decks.py` | Add endpoints to existing router |

## Implementation Steps

### Step 1: Verify DeckUpdate Schema

Ensure `src/schemas/deck.py` has the DeckUpdate schema (all fields optional):

```python
class DeckUpdate(BaseModel):
    """Schema for updating a deck. All fields optional."""
    name: Optional[str] = Field(default=None, min_length=1, max_length=255)
    description: Optional[str] = Field(default=None, max_length=2000)
    level: Optional[DeckLevel] = None
    is_active: Optional[bool] = None

    model_config = ConfigDict(from_attributes=True)
```

### Step 2: Implement Update Deck Endpoint

Add to `src/api/v1/decks.py`:

```python
@router.patch(
    "/{deck_id}",
    response_model=DeckResponse,
    summary="Update a deck",
    description="Update an existing deck. Requires admin privileges.",
    responses={
        401: {"description": "Not authenticated"},
        403: {"description": "Not authorized (requires superuser)"},
        404: {"description": "Deck not found"},
    },
)
async def update_deck(
    deck_id: UUID,
    deck_data: DeckUpdate,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_superuser),
) -> DeckResponse:
    """
    Update an existing deck.

    Requires superuser privileges.
    Only provided fields will be updated (partial update).

    - **deck_id**: UUID of the deck to update
    - **name**: New deck name (optional)
    - **description**: New description (optional)
    - **level**: New CEFR level (optional)
    - **is_active**: Set active status (optional)
    """
    repo = DeckRepository(db)

    # Get existing deck (include inactive for admins)
    deck = await repo.get(deck_id)
    if deck is None:
        raise DeckNotFoundException(deck_id=str(deck_id))

    # Get update data, excluding unset fields
    update_data = deck_data.model_dump(exclude_unset=True)

    # Update only provided fields
    for field, value in update_data.items():
        setattr(deck, field, value)

    # Commit changes
    await db.commit()
    await db.refresh(deck)

    return DeckResponse.model_validate(deck)
```

### Step 3: Implement Delete Deck Endpoint

Add to `src/api/v1/decks.py`:

```python
from fastapi import Response

@router.delete(
    "/{deck_id}",
    status_code=status.HTTP_204_NO_CONTENT,
    summary="Delete a deck",
    description="Soft delete a deck by setting is_active to False. Requires admin privileges.",
    responses={
        401: {"description": "Not authenticated"},
        403: {"description": "Not authorized (requires superuser)"},
        404: {"description": "Deck not found"},
    },
)
async def delete_deck(
    deck_id: UUID,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_superuser),
) -> Response:
    """
    Soft delete a deck.

    Requires superuser privileges.

    This does NOT physically delete the deck from the database.
    Instead, it sets is_active=False, making the deck invisible
    to public endpoints while preserving the data.

    - **deck_id**: UUID of the deck to delete
    """
    repo = DeckRepository(db)

    # Get existing deck (include inactive for admins)
    deck = await repo.get(deck_id)
    if deck is None:
        raise DeckNotFoundException(deck_id=str(deck_id))

    # Soft delete by setting is_active to False
    deck.is_active = False

    # Commit changes
    await db.commit()

    return Response(status_code=status.HTTP_204_NO_CONTENT)
```

### Step 4: Import Response Class

Add to imports in `src/api/v1/decks.py`:

```python
from fastapi import Response
from src.schemas.deck import DeckUpdate
```

## Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `src/api/v1/decks.py` | MODIFY | Add update_deck and delete_deck endpoints |
| `src/schemas/deck.py` | VERIFY | Ensure DeckUpdate schema exists |

## API Specification

### PATCH /api/v1/decks/{deck_id}

**Authentication**: Required (Bearer token)
**Authorization**: Superuser only

**Path Parameters**:
| Parameter | Type | Description |
|-----------|------|-------------|
| `deck_id` | UUID | Deck UUID |

**Request Headers**:
```
Authorization: Bearer <access_token>
Content-Type: application/json
```

**Request Body** (all fields optional):
```json
{
  "name": "Updated Deck Name",
  "description": "Updated description",
  "level": "B2",
  "is_active": false
}
```

**Response** (200 OK):
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "Updated Deck Name",
  "description": "Updated description",
  "level": "B2",
  "is_active": false,
  "created_at": "2024-01-15T10:30:00Z",
  "updated_at": "2024-01-16T14:00:00Z"
}
```

**Error Responses**:
- 401: Not authenticated
- 403: Not a superuser
- 404: Deck not found
- 422: Validation error

### DELETE /api/v1/decks/{deck_id}

**Authentication**: Required (Bearer token)
**Authorization**: Superuser only

**Path Parameters**:
| Parameter | Type | Description |
|-----------|------|-------------|
| `deck_id` | UUID | Deck UUID |

**Request Headers**:
```
Authorization: Bearer <access_token>
```

**Response** (204 No Content): Empty response body

**Error Responses**:
- 401: Not authenticated
- 403: Not a superuser
- 404: Deck not found

## Acceptance Criteria
<!-- AC:BEGIN -->
### Update Endpoint (PATCH)
- [ ] #1 PATCH /api/v1/decks/{id} endpoint implemented
- [ ] #2 Returns 200 with updated deck data
- [ ] #3 Partial updates work (only provided fields are updated)
- [ ] #4 Can update name, description, level, and is_active
- [ ] #5 Returns 401 if not authenticated
- [ ] #6 Returns 403 if not superuser
- [ ] #7 Returns 404 if deck doesn't exist
- [ ] #8 Admins can update inactive decks
- [ ] #9 Updated_at timestamp is updated

### Delete Endpoint (DELETE)
- [ ] #10 DELETE /api/v1/decks/{id} endpoint implemented
- [ ] #11 Returns 204 No Content on success
- [ ] #12 Performs soft delete (sets is_active=False)
- [ ] #13 Does NOT physically delete from database
- [ ] #14 Returns 401 if not authenticated
- [ ] #15 Returns 403 if not superuser
- [ ] #16 Returns 404 if deck doesn't exist
- [ ] #17 Can delete already-inactive decks (idempotent)

## Testing Requirements

Manual verification:
```bash
# Get admin token
TOKEN=$(curl -s -X POST "http://localhost:8000/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"email": "admin@example.com", "password": "adminpass"}' \
  | jq -r '.access_token')

# Update deck (partial)
curl -X PATCH "http://localhost:8000/api/v1/decks/550e8400-e29b-41d4-a716-446655440000" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name": "New Name"}'

# Update multiple fields
curl -X PATCH "http://localhost:8000/api/v1/decks/550e8400-e29b-41d4-a716-446655440000" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name": "New Name", "level": "B2", "is_active": false}'

# Delete deck
curl -X DELETE "http://localhost:8000/api/v1/decks/550e8400-e29b-41d4-a716-446655440000" \
  -H "Authorization: Bearer $TOKEN" \
  -v  # -v to see 204 status

# Update non-existent (should return 404)
curl -X PATCH "http://localhost:8000/api/v1/decks/00000000-0000-0000-0000-000000000000" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name": "New Name"}'

# Without auth (should return 401)
curl -X PATCH "http://localhost:8000/api/v1/decks/550e8400-e29b-41d4-a716-446655440000" \
  -H "Content-Type: application/json" \
  -d '{"name": "New Name"}'
```
<!-- AC:END -->



## Notes

- DELETE uses soft delete (sets `is_active=False`) to preserve data integrity
- Physical deletion is NOT supported through this API
- Admins can see and modify inactive decks (unlike public endpoints)
- The PATCH endpoint uses `exclude_unset=True` to support partial updates
- Both endpoints share the same authentication pattern
- Updated decks will have their `updated_at` timestamp automatically updated
<!-- SECTION:DESCRIPTION:END -->
