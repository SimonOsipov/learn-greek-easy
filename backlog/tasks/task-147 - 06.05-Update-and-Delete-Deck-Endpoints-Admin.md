---
id: task-147
title: '[06.05] Update and Delete Deck Endpoints (Admin)'
status: In Progress
assignee: []
created_date: '2025-12-07 14:10'
updated_date: '2025-12-07 20:55'
labels:
  - backend
  - deck-api
  - task-6
dependencies: []
priority: medium
---

## Description

<!-- SECTION:DESCRIPTION:BEGIN -->
# [06.05] Update and Delete Deck Endpoints (Admin)

## Goal/Purpose

Implement the `PATCH /api/v1/decks/{id}` and `DELETE /api/v1/decks/{id}` endpoints for administrators to update and soft-delete decks. Both endpoints require superuser privileges.

## Dependencies

| Component | Location | Usage |
|-----------|----------|-------|
| DeckRepository | `src/repositories/deck.py` | `get()`, `update()` methods |
| Deck Schemas | `src/schemas/deck.py` | `DeckUpdate`, `DeckResponse` |
| Auth Dependencies | `src/core/dependencies.py` | `get_current_superuser` |
| Exceptions | `src/core/exceptions.py` | `DeckNotFoundException` |
| Deck Router | `src/api/v1/decks.py` | Add endpoints to existing router |

## Implementation Steps

### Step 1: Verify DeckUpdate Schema

Ensure `src/schemas/deck.py` has the DeckUpdate schema (all fields optional):

```python
class DeckUpdate(BaseModel):
    """Schema for updating a deck. All fields optional."""
    name: Optional[str] = Field(default=None, min_length=1, max_length=255)
    description: Optional[str] = Field(default=None, max_length=2000)
    level: Optional[DeckLevel] = None
    is_active: Optional[bool] = None

    model_config = ConfigDict(from_attributes=True)
```

### Step 2: Implement Update Deck Endpoint

Add to `src/api/v1/decks.py`:

```python
@router.patch(
    "/{deck_id}",
    response_model=DeckResponse,
    summary="Update a deck",
    description="Update an existing deck. Requires admin privileges.",
    responses={
        401: {"description": "Not authenticated"},
        403: {"description": "Not authorized (requires superuser)"},
        404: {"description": "Deck not found"},
    },
)
async def update_deck(
    deck_id: UUID,
    deck_data: DeckUpdate,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_superuser),
) -> DeckResponse:
    """
    Update an existing deck.

    Requires superuser privileges.
    Only provided fields will be updated (partial update).

    - **deck_id**: UUID of the deck to update
    - **name**: New deck name (optional)
    - **description**: New description (optional)
    - **level**: New CEFR level (optional)
    - **is_active**: Set active status (optional)
    """
    repo = DeckRepository(db)

    # Get existing deck (include inactive for admins)
    deck = await repo.get(deck_id)
    if deck is None:
        raise DeckNotFoundException(deck_id=str(deck_id))

    # Get update data, excluding unset fields
    update_data = deck_data.model_dump(exclude_unset=True)

    # Update only provided fields
    for field, value in update_data.items():
        setattr(deck, field, value)

    # Commit changes
    await db.commit()
    await db.refresh(deck)

    return DeckResponse.model_validate(deck)
```

### Step 3: Implement Delete Deck Endpoint

Add to `src/api/v1/decks.py`:

```python
from fastapi import Response

@router.delete(
    "/{deck_id}",
    status_code=status.HTTP_204_NO_CONTENT,
    summary="Delete a deck",
    description="Soft delete a deck by setting is_active to False. Requires admin privileges.",
    responses={
        401: {"description": "Not authenticated"},
        403: {"description": "Not authorized (requires superuser)"},
        404: {"description": "Deck not found"},
    },
)
async def delete_deck(
    deck_id: UUID,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_superuser),
) -> Response:
    """
    Soft delete a deck.

    Requires superuser privileges.

    This does NOT physically delete the deck from the database.
    Instead, it sets is_active=False, making the deck invisible
    to public endpoints while preserving the data.

    - **deck_id**: UUID of the deck to delete
    """
    repo = DeckRepository(db)

    # Get existing deck (include inactive for admins)
    deck = await repo.get(deck_id)
    if deck is None:
        raise DeckNotFoundException(deck_id=str(deck_id))

    # Soft delete by setting is_active to False
    deck.is_active = False

    # Commit changes
    await db.commit()

    return Response(status_code=status.HTTP_204_NO_CONTENT)
```

### Step 4: Import Response Class

Add to imports in `src/api/v1/decks.py`:

```python
from fastapi import Response
from src.schemas.deck import DeckUpdate
```

## Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `src/api/v1/decks.py` | MODIFY | Add update_deck and delete_deck endpoints |
| `src/schemas/deck.py` | VERIFY | Ensure DeckUpdate schema exists |

## API Specification

### PATCH /api/v1/decks/{deck_id}

**Authentication**: Required (Bearer token)
**Authorization**: Superuser only

**Path Parameters**:
| Parameter | Type | Description |
|-----------|------|-------------|
| `deck_id` | UUID | Deck UUID |

**Request Headers**:
```
Authorization: Bearer <access_token>
Content-Type: application/json
```

**Request Body** (all fields optional):
```json
{
  "name": "Updated Deck Name",
  "description": "Updated description",
  "level": "B2",
  "is_active": false
}
```

**Response** (200 OK):
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "Updated Deck Name",
  "description": "Updated description",
  "level": "B2",
  "is_active": false,
  "created_at": "2024-01-15T10:30:00Z",
  "updated_at": "2024-01-16T14:00:00Z"
}
```

**Error Responses**:
- 401: Not authenticated
- 403: Not a superuser
- 404: Deck not found
- 422: Validation error

### DELETE /api/v1/decks/{deck_id}

**Authentication**: Required (Bearer token)
**Authorization**: Superuser only

**Path Parameters**:
| Parameter | Type | Description |
|-----------|------|-------------|
| `deck_id` | UUID | Deck UUID |

**Request Headers**:
```
Authorization: Bearer <access_token>
```

**Response** (204 No Content): Empty response body

**Error Responses**:
- 401: Not authenticated
- 403: Not a superuser
- 404: Deck not found

## Acceptance Criteria
<!-- AC:BEGIN -->
### Update Endpoint (PATCH)
- [ ] #1 PATCH /api/v1/decks/{id} endpoint implemented
- [ ] #2 Returns 200 with updated deck data
- [ ] #3 Partial updates work (only provided fields are updated)
- [ ] #4 Can update name, description, level, and is_active
- [ ] #5 Returns 401 if not authenticated
- [ ] #6 Returns 403 if not superuser
- [ ] #7 Returns 404 if deck doesn't exist
- [ ] #8 Admins can update inactive decks
- [ ] #9 Updated_at timestamp is updated

### Delete Endpoint (DELETE)
- [ ] #10 DELETE /api/v1/decks/{id} endpoint implemented
- [ ] #11 Returns 204 No Content on success
- [ ] #12 Performs soft delete (sets is_active=False)
- [ ] #13 Does NOT physically delete from database
- [ ] #14 Returns 401 if not authenticated
- [ ] #15 Returns 403 if not superuser
- [ ] #16 Returns 404 if deck doesn't exist
- [ ] #17 Can delete already-inactive decks (idempotent)

## Testing Requirements

Manual verification:
```bash
# Get admin token
TOKEN=$(curl -s -X POST "http://localhost:8000/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"email": "admin@example.com", "password": "adminpass"}' \
  | jq -r '.access_token')

# Update deck (partial)
curl -X PATCH "http://localhost:8000/api/v1/decks/550e8400-e29b-41d4-a716-446655440000" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name": "New Name"}'

# Update multiple fields
curl -X PATCH "http://localhost:8000/api/v1/decks/550e8400-e29b-41d4-a716-446655440000" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name": "New Name", "level": "B2", "is_active": false}'

# Delete deck
curl -X DELETE "http://localhost:8000/api/v1/decks/550e8400-e29b-41d4-a716-446655440000" \
  -H "Authorization: Bearer $TOKEN" \
  -v  # -v to see 204 status

# Update non-existent (should return 404)
curl -X PATCH "http://localhost:8000/api/v1/decks/00000000-0000-0000-0000-000000000000" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name": "New Name"}'

# Without auth (should return 401)
curl -X PATCH "http://localhost:8000/api/v1/decks/550e8400-e29b-41d4-a716-446655440000" \
  -H "Content-Type: application/json" \
  -d '{"name": "New Name"}'
```
<!-- AC:END -->

## Notes

- DELETE uses soft delete (sets `is_active=False`) to preserve data integrity
- Physical deletion is NOT supported through this API
- Admins can see and modify inactive decks (unlike public endpoints)
- The PATCH endpoint uses `exclude_unset=True` to support partial updates
- Both endpoints share the same authentication pattern
- Updated decks will have their `updated_at` timestamp automatically updated
<!-- SECTION:DESCRIPTION:END -->

## Implementation Plan

<!-- SECTION:PLAN:BEGIN -->
## Implementation Plan for [06.05] Update and Delete Deck Endpoints (Admin)

### Prerequisites
- [x] DeckUpdate schema exists in `src/schemas/deck.py` (lines 36-42) - VERIFIED
- [x] BaseRepository has `get()` and `update()` methods (lines 44-58, 146-180) - VERIFIED
- [x] `get_current_superuser` dependency exists (lines 105-134) - VERIFIED
- [x] `DeckNotFoundException` exists (lines 127-132) - VERIFIED
- [x] Existing deck router pattern in `src/api/v1/decks.py` - VERIFIED

All prerequisites are already in place. No schema or dependency changes needed.

---

### Step 1: Add DeckUpdate Import to decks.py

**Goal**: Import the DeckUpdate schema which is already defined but not imported in decks.py

**File**: `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/api/v1/decks.py`

**Actions**:
1. Add `DeckUpdate` to the imports from `src.schemas.deck` (line 18-24)
2. Add `Response` to the imports from `fastapi` (line 10)

**Current imports (line 18-24)**:
```python
from src.schemas.deck import (
    DeckCreate,
    DeckDetailResponse,
    DeckListResponse,
    DeckResponse,
    DeckSearchResponse,
)
```

**New imports**:
```python
from fastapi import APIRouter, Depends, Query, Response, status
from src.schemas.deck import (
    DeckCreate,
    DeckDetailResponse,
    DeckListResponse,
    DeckResponse,
    DeckSearchResponse,
    DeckUpdate,
)
```

**Verification**: Code compiles without import errors

---

### Step 2: Implement PATCH /api/v1/decks/{deck_id} Endpoint

**Goal**: Create the update deck endpoint with superuser authentication

**File**: `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/api/v1/decks.py`

**Actions**:
1. Add the `update_deck` function after the `get_deck` function (after line 320)
2. Follow the existing pattern from `create_deck` (lines 109-168) for:
   - Using `get_current_superuser` dependency
   - Response model and status code
   - OpenAPI documentation with responses
   - Repository pattern usage

**Implementation** (add after line 320):
```python
@router.patch(
    "/{deck_id}",
    response_model=DeckResponse,
    summary="Update a deck",
    description="Update an existing deck. Requires superuser privileges.",
    responses={
        200: {
            "description": "Deck updated successfully",
            "content": {
                "application/json": {
                    "example": {
                        "id": "550e8400-e29b-41d4-a716-446655440000",
                        "name": "Updated Greek B1 Grammar",
                        "description": "Updated description",
                        "level": "B1",
                        "is_active": True,
                        "created_at": "2024-01-15T10:30:00Z",
                        "updated_at": "2024-01-16T14:00:00Z",
                    }
                }
            },
        },
        401: {"description": "Not authenticated"},
        403: {"description": "Not authorized (requires superuser)"},
        404: {"description": "Deck not found"},
    },
)
async def update_deck(
    deck_id: UUID,
    deck_data: DeckUpdate,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_superuser),
) -> DeckResponse:
    """Update an existing deck.

    Requires superuser privileges.
    Only provided fields will be updated (partial update).

    Args:
        deck_id: UUID of the deck to update
        deck_data: Fields to update (all optional)
        db: Database session (injected)
        current_user: Authenticated superuser (injected)

    Returns:
        DeckResponse: The updated deck

    Raises:
        401: If not authenticated
        403: If authenticated but not superuser
        404: If deck doesn't exist
        422: If validation fails
    """
    repo = DeckRepository(db)

    # Get existing deck (include inactive - admins can update any deck)
    deck = await repo.get(deck_id)
    if deck is None:
        raise DeckNotFoundException(deck_id=str(deck_id))

    # Update using BaseRepository.update() pattern
    updated_deck = await repo.update(deck, deck_data)

    # Commit the transaction
    await db.commit()
    await db.refresh(updated_deck)

    return DeckResponse.model_validate(updated_deck)
```

**Key Design Decisions**:
- Uses `repo.get()` without active check (admins can update inactive decks)
- Uses `BaseRepository.update()` which handles `exclude_unset=True` for partial updates
- Follows same commit/refresh pattern as `create_deck`
- Returns `DeckResponse` (not `DeckDetailResponse`) since we don't need card_count for updates

**Verification**:
- Endpoint appears in OpenAPI docs at /docs
- Returns 200 with updated deck data
- Returns 401/403/404 appropriately

---

### Step 3: Implement DELETE /api/v1/decks/{deck_id} Endpoint

**Goal**: Create the soft-delete deck endpoint with superuser authentication

**File**: `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/src/api/v1/decks.py`

**Actions**:
1. Add the `delete_deck` function after the `update_deck` function
2. Implement soft delete by setting `is_active=False`
3. Return 204 No Content on success

**Implementation** (add after update_deck):
```python
@router.delete(
    "/{deck_id}",
    status_code=status.HTTP_204_NO_CONTENT,
    summary="Delete a deck",
    description="Soft delete a deck by setting is_active to False. Requires superuser privileges.",
    responses={
        204: {"description": "Deck deleted successfully"},
        401: {"description": "Not authenticated"},
        403: {"description": "Not authorized (requires superuser)"},
        404: {"description": "Deck not found"},
    },
)
async def delete_deck(
    deck_id: UUID,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_superuser),
) -> Response:
    """Soft delete a deck.

    Requires superuser privileges.

    This does NOT physically delete the deck from the database.
    Instead, it sets is_active=False, making the deck invisible
    to public endpoints while preserving the data.

    Note: Deleting an already-inactive deck is idempotent (returns 204).

    Args:
        deck_id: UUID of the deck to delete
        db: Database session (injected)
        current_user: Authenticated superuser (injected)

    Returns:
        Empty response with 204 status

    Raises:
        401: If not authenticated
        403: If authenticated but not superuser
        404: If deck doesn't exist
    """
    repo = DeckRepository(db)

    # Get existing deck (don't filter by is_active - allow re-deleting)
    deck = await repo.get(deck_id)
    if deck is None:
        raise DeckNotFoundException(deck_id=str(deck_id))

    # Soft delete by setting is_active to False
    deck.is_active = False

    # Commit changes
    await db.commit()

    return Response(status_code=status.HTTP_204_NO_CONTENT)
```

**Key Design Decisions**:
- Soft delete only (sets `is_active=False`), NOT physical delete
- Idempotent: deleting an already-inactive deck succeeds (returns 204)
- Returns `Response` with 204 status (no body)
- Does NOT use `repo.delete()` which would physically delete

**Verification**:
- Endpoint appears in OpenAPI docs
- Returns 204 No Content on success
- Deck still exists in DB with `is_active=False`
- Returns 401/403/404 appropriately

---

### Step 4: Write Integration Tests for Update Endpoint

**Goal**: Create comprehensive tests for PATCH endpoint

**File**: `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/tests/integration/api/test_decks.py`

**Actions**:
1. Add a new test class `TestUpdateDeckEndpoint` after `TestGetDeckEndpoint`
2. Follow existing test patterns (see `TestCreateDeckEndpoint` for reference)

**Test Cases to Implement**:
```python
class TestUpdateDeckEndpoint:
    """Test suite for PATCH /api/v1/decks/{deck_id} endpoint."""

    # Success cases
    async def test_update_deck_name_only(...)
    async def test_update_deck_all_fields(...)
    async def test_update_deck_description_to_null(...)
    async def test_update_deck_level(...)
    async def test_update_deck_is_active(...)
    async def test_update_inactive_deck(...)  # Admin can update inactive decks
    async def test_update_deck_updated_at_changes(...)

    # Auth/Permission cases
    async def test_update_deck_unauthenticated_returns_401(...)
    async def test_update_deck_non_superuser_returns_403(...)

    # Error cases
    async def test_update_deck_not_found_returns_404(...)
    async def test_update_deck_invalid_uuid_returns_422(...)
    async def test_update_deck_invalid_level_returns_422(...)
    async def test_update_deck_empty_name_returns_422(...)
    async def test_update_deck_name_too_long_returns_422(...)
```

**Verification**: All tests pass with `poetry run pytest tests/integration/api/test_decks.py -v`

---

### Step 5: Write Integration Tests for Delete Endpoint

**Goal**: Create comprehensive tests for DELETE endpoint

**File**: `/Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend/tests/integration/api/test_decks.py`

**Actions**:
1. Add a new test class `TestDeleteDeckEndpoint` after `TestUpdateDeckEndpoint`
2. Follow existing test patterns

**Test Cases to Implement**:
```python
class TestDeleteDeckEndpoint:
    """Test suite for DELETE /api/v1/decks/{deck_id} endpoint."""

    # Success cases
    async def test_delete_deck_success(...)
    async def test_delete_deck_returns_204(...)
    async def test_delete_deck_soft_deletes(...)  # Verify is_active=False, deck still in DB
    async def test_delete_already_inactive_deck_idempotent(...)  # Returns 204

    # Auth/Permission cases
    async def test_delete_deck_unauthenticated_returns_401(...)
    async def test_delete_deck_non_superuser_returns_403(...)

    # Error cases
    async def test_delete_deck_not_found_returns_404(...)
    async def test_delete_deck_invalid_uuid_returns_422(...)

    # Behavior verification
    async def test_deleted_deck_not_visible_in_list(...)
    async def test_deleted_deck_not_visible_in_search(...)
    async def test_deleted_deck_returns_404_on_get(...)
```

**Verification**: All tests pass with `poetry run pytest tests/integration/api/test_decks.py -v`

---

### Step 6: Final Verification

**Goal**: Ensure all acceptance criteria are met

**Actions**:
1. Run full test suite:
   ```bash
   cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && \
   /Users/samosipov/.local/bin/poetry run pytest tests/integration/api/test_decks.py -v
   ```

2. Start dev server and manually test:
   ```bash
   cd /Users/samosipov/Downloads/learn-greek-easy/learn-greek-easy-backend && \
   /Users/samosipov/.local/bin/poetry run uvicorn src.main:app --reload
   ```

3. Manual API verification (see Testing Requirements in task description)

4. Verify OpenAPI documentation at http://localhost:8000/docs

**Acceptance Criteria Checklist**:
- [ ] PATCH /api/v1/decks/{id} endpoint implemented
- [ ] Returns 200 with updated deck data
- [ ] Partial updates work (only provided fields are updated)
- [ ] Can update name, description, level, and is_active
- [ ] Returns 401 if not authenticated
- [ ] Returns 403 if not superuser
- [ ] Returns 404 if deck doesn't exist
- [ ] Admins can update inactive decks
- [ ] Updated_at timestamp is updated
- [ ] DELETE /api/v1/decks/{id} endpoint implemented
- [ ] Returns 204 No Content on success
- [ ] Performs soft delete (sets is_active=False)
- [ ] Does NOT physically delete from database
- [ ] Returns 401 if not authenticated
- [ ] Returns 403 if not superuser
- [ ] Returns 404 if deck doesn't exist
- [ ] Can delete already-inactive decks (idempotent)

---

### Estimated Effort
- **Total steps**: 6
- **Complexity**: Low-Medium
- **Estimated time**: 1-2 hours

### Files to Modify

| File | Action | Description |
|------|--------|-------------|
| `src/api/v1/decks.py` | MODIFY | Add PATCH and DELETE endpoints (~80 lines) |
| `tests/integration/api/test_decks.py` | MODIFY | Add test classes for new endpoints (~150 lines) |

### Dependencies
- No new packages required
- No database migrations needed
- Uses existing schemas, repositories, and dependencies
<!-- SECTION:PLAN:END -->

## Implementation Notes

<!-- SECTION:NOTES:BEGIN -->
PR: https://github.com/SimonOsipov/learn-greek-easy/pull/23

Implementation complete: PATCH and DELETE endpoints added with 26 new integration tests. All tests passing.
<!-- SECTION:NOTES:END -->
