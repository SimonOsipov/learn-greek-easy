# Local Development Caddyfile
# Use this for testing the production Caddy setup locally with docker-compose.yml
# The regular Caddyfile uses dynamic DNS which only works on Railway
#
# This file is automatically mounted by docker-compose.yml

:{$PORT:80}

root * /srv
encode gzip

# Logging for debugging
log {
    output stdout
    format json
    level INFO
}

# Health check
handle /health {
    respond "healthy" 200
}

# API proxy to backend (static upstream for local Docker network)
handle /api/* {
    reverse_proxy backend:8000 {
        # Buffer request body to prevent streaming race condition
        request_buffers 1MB

        # Allow retries for mutating methods
        lb_retry_match {
            method POST PUT PATCH DELETE
        }

        lb_try_duration 5s
        lb_retries 3

        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}

        transport http {
            read_timeout 120s
            write_timeout 120s
            keepalive 30s
            keepalive_idle_conns 10
        }
    }
}

handle /docs {
    reverse_proxy backend:8000 {
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

handle /docs/* {
    reverse_proxy backend:8000 {
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

handle /redoc {
    reverse_proxy backend:8000 {
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

handle /redoc/* {
    reverse_proxy backend:8000 {
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

handle /openapi.json {
    reverse_proxy backend:8000 {
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

# Static assets with long-term caching
@static path *.js *.css *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot
handle @static {
    header Cache-Control "public, max-age=31536000, immutable"
    file_server
}

# SPA fallback - serve index.html for all other routes
handle {
    try_files {path} /index.html
    file_server
}

# Security headers (applied globally)
header {
    X-Frame-Options "SAMEORIGIN"
    X-Content-Type-Options "nosniff"
    X-XSS-Protection "1; mode=block"
    Referrer-Policy "no-referrer-when-downgrade"
}
