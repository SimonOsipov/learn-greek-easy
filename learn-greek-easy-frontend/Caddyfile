:{$PORT:80}

root * /srv
encode gzip

# Logging for debugging
log {
    output stdout
    format json
    level INFO
}

# Health check
handle /health {
    respond "healthy" 200
}

# API proxy to backend with dynamic DNS resolution for Railway
# Uses dynamic A record lookup with 5s refresh to handle backend IP changes
handle /api/* {
    reverse_proxy {
        dynamic a {$BACKEND_HOST:backend.railway.internal} {$BACKEND_PORT:8080} {
            refresh 5s
        }

        # Load balancer retries - user never sees 502 from stale IPs
        lb_try_duration 5s
        lb_retries 3

        # Passive health checks (active health checks don't work with dynamic upstreams)
        fail_duration 10s
        max_fails 1
        unhealthy_status 502 503 504
        unhealthy_latency 10s

        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}

        transport http {
            read_timeout 120s
            write_timeout 120s
        }
    }
}

handle /docs {
    reverse_proxy {
        dynamic a {$BACKEND_HOST:backend.railway.internal} {$BACKEND_PORT:8080} {
            refresh 5s
        }

        # Load balancer retries
        lb_try_duration 5s
        lb_retries 3

        # Passive health checks
        fail_duration 10s
        max_fails 1
        unhealthy_status 502 503 504
        unhealthy_latency 10s

        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

handle /docs/* {
    reverse_proxy {
        dynamic a {$BACKEND_HOST:backend.railway.internal} {$BACKEND_PORT:8080} {
            refresh 5s
        }

        # Load balancer retries
        lb_try_duration 5s
        lb_retries 3

        # Passive health checks
        fail_duration 10s
        max_fails 1
        unhealthy_status 502 503 504
        unhealthy_latency 10s

        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

handle /redoc {
    reverse_proxy {
        dynamic a {$BACKEND_HOST:backend.railway.internal} {$BACKEND_PORT:8080} {
            refresh 5s
        }

        # Load balancer retries
        lb_try_duration 5s
        lb_retries 3

        # Passive health checks
        fail_duration 10s
        max_fails 1
        unhealthy_status 502 503 504
        unhealthy_latency 10s

        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

handle /redoc/* {
    reverse_proxy {
        dynamic a {$BACKEND_HOST:backend.railway.internal} {$BACKEND_PORT:8080} {
            refresh 5s
        }

        # Load balancer retries
        lb_try_duration 5s
        lb_retries 3

        # Passive health checks
        fail_duration 10s
        max_fails 1
        unhealthy_status 502 503 504
        unhealthy_latency 10s

        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

handle /openapi.json {
    reverse_proxy {
        dynamic a {$BACKEND_HOST:backend.railway.internal} {$BACKEND_PORT:8080} {
            refresh 5s
        }

        # Load balancer retries
        lb_try_duration 5s
        lb_retries 3

        # Passive health checks
        fail_duration 10s
        max_fails 1
        unhealthy_status 502 503 504
        unhealthy_latency 10s

        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

# Static assets with long-term caching
@static path *.js *.css *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot
handle @static {
    header Cache-Control "public, max-age=31536000, immutable"
    file_server
}

# SPA fallback - serve index.html for all other routes
handle {
    try_files {path} /index.html
    file_server
}

# Security headers (applied globally)
header {
    X-Frame-Options "SAMEORIGIN"
    X-Content-Type-Options "nosniff"
    X-XSS-Protection "1; mode=block"
    Referrer-Policy "no-referrer-when-downgrade"
}
