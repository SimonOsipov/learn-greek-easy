#!/usr/bin/env node
/**
 * Accessibility Results Parser Script
 *
 * This script parses accessibility-report.json generated by accessibility-test.cjs
 * and generates a markdown comment for PR reviews.
 *
 * Usage:
 *   node scripts/parse-accessibility-results.cjs
 *
 * Expected input:
 *   accessibility-report.json in the current directory
 *
 * Environment variables:
 *   GITHUB_SERVER_URL - GitHub server URL (e.g., https://github.com)
 *   GITHUB_REPOSITORY - Repository name (e.g., owner/repo)
 *   GITHUB_RUN_ID - Workflow run ID for artifact link
 *
 * Output files:
 *   accessibility-comment.md - Markdown formatted PR comment
 *
 * Exit codes:
 *   0 - Always exits 0 (errors generate error markdown)
 */

const fs = require('fs');
const path = require('path');

// ============================================================================
// Configuration
// ============================================================================

const REPORT_FILE = path.join(process.cwd(), 'accessibility-report.json');
const OUTPUT_FILE = path.join(process.cwd(), 'accessibility-comment.md');

// Environment variables for artifact link
const GITHUB_SERVER_URL = process.env.GITHUB_SERVER_URL || 'https://github.com';
const GITHUB_REPOSITORY = process.env.GITHUB_REPOSITORY || '';
const GITHUB_RUN_ID = process.env.GITHUB_RUN_ID || '';

// Impact level configuration
const IMPACT_CONFIG = {
  critical: { icon: '\uD83D\uDD34', label: 'Critical', order: 0 },
  serious: { icon: '\uD83D\uDFE0', label: 'Serious', order: 1 },
  moderate: { icon: '\uD83D\uDFE1', label: 'Moderate', order: 2 },
  minor: { icon: '\u26AA', label: 'Minor', order: 3 },
};

// Maximum elements to show per violation
const MAX_ELEMENTS_PER_VIOLATION = 5;

// Maximum HTML length before truncation
const MAX_HTML_LENGTH = 100;

// ============================================================================
// Main Function
// ============================================================================

function main() {
  console.log('='.repeat(60));
  console.log('ACCESSIBILITY RESULTS PARSER');
  console.log('='.repeat(60));
  console.log('');

  try {
    // Check if report file exists
    if (!fs.existsSync(REPORT_FILE)) {
      throw new Error(`Report file not found: ${REPORT_FILE}`);
    }

    // Read and parse the report
    const content = fs.readFileSync(REPORT_FILE, 'utf-8');
    let report;

    try {
      report = JSON.parse(content);
    } catch (parseError) {
      throw new Error(`Failed to parse JSON: ${parseError.message}`);
    }

    // Validate report structure
    if (!report || typeof report !== 'object') {
      throw new Error('Invalid report structure: expected an object');
    }

    // Generate markdown
    const markdown = generateMarkdown(report);

    // Write output
    fs.writeFileSync(OUTPUT_FILE, markdown);
    console.log(`Markdown comment written to: ${OUTPUT_FILE}`);
    console.log('');
    console.log('Parsing completed successfully!');
  } catch (error) {
    console.error(`Error: ${error.message}`);

    // Write error markdown (always exit 0)
    const errorMarkdown = generateErrorMarkdown(error.message);
    fs.writeFileSync(OUTPUT_FILE, errorMarkdown);
    console.log(`Error markdown written to: ${OUTPUT_FILE}`);
  }

  // Always exit 0 - let the CI job handle the comment posting
  process.exit(0);
}

// ============================================================================
// Markdown Generation
// ============================================================================

function generateMarkdown(report) {
  const summary = report.summary || {};
  const pages = report.pages || [];

  // Calculate totals
  const criticalCount = summary.critical || 0;
  const seriousCount = summary.serious || 0;
  const moderateCount = summary.moderate || 0;
  const minorCount = summary.minor || 0;
  const totalViolations = summary.total_violations || 0;

  // Determine pass/fail status
  const hasBlockingViolations = criticalCount > 0 || seriousCount > 0;

  let md = `## Accessibility Report\n\n`;

  // Status badge
  if (totalViolations === 0) {
    md += `\u2705 **All accessibility checks passed!**\n\n`;
    md += `No WCAG 2.1 AA violations detected across ${pages.length} page(s).\n\n`;
  } else if (hasBlockingViolations) {
    md += `\u274C **Accessibility issues found that require attention**\n\n`;
  } else {
    md += `\u26A0\uFE0F **Minor accessibility issues found**\n\n`;
  }

  // Summary table
  md += `### Summary\n\n`;
  md += `| Severity | Count |\n`;
  md += `|----------|-------|\n`;
  md += `| ${IMPACT_CONFIG.critical.icon} Critical | ${criticalCount} |\n`;
  md += `| ${IMPACT_CONFIG.serious.icon} Serious | ${seriousCount} |\n`;
  md += `| ${IMPACT_CONFIG.moderate.icon} Moderate | ${moderateCount} |\n`;
  md += `| ${IMPACT_CONFIG.minor.icon} Minor | ${minorCount} |\n`;
  md += `| **Total** | **${totalViolations}** |\n\n`;

  // If no violations, add artifact link and exit early
  if (totalViolations === 0) {
    md += generateArtifactLink();
    md += generateFooter();
    return md;
  }

  // Group violations by impact level across all pages
  const violationsByImpact = groupViolationsByImpact(pages);

  // Generate sections for each impact level (in order: critical, serious, moderate, minor)
  const impactOrder = ['critical', 'serious', 'moderate', 'minor'];

  for (const impact of impactOrder) {
    const violations = violationsByImpact[impact] || [];
    if (violations.length === 0) continue;

    const config = IMPACT_CONFIG[impact];
    const isExpanded = impact === 'critical' || impact === 'serious';

    md += generateViolationSection(config, violations, isExpanded);
  }

  // Add artifact link
  md += generateArtifactLink();

  // Footer
  md += generateFooter();

  return md;
}

function groupViolationsByImpact(pages) {
  const grouped = {
    critical: [],
    serious: [],
    moderate: [],
    minor: [],
  };

  for (const page of pages) {
    if (page.error || !page.violations) continue;

    for (const violation of page.violations) {
      const impact = violation.impact || 'minor';
      if (grouped[impact]) {
        grouped[impact].push({
          ...violation,
          pageName: page.name,
          pageUrl: page.url,
        });
      }
    }
  }

  return grouped;
}

function generateViolationSection(config, violations, isExpanded) {
  const openAttr = isExpanded ? ' open' : '';

  let md = `<details${openAttr}>\n`;
  md += `<summary><strong>${config.icon} ${config.label} (${violations.length})</strong></summary>\n\n`;

  for (const violation of violations) {
    md += generateViolationEntry(violation);
  }

  md += `</details>\n\n`;
  return md;
}

function generateViolationEntry(violation) {
  let md = `#### ${violation.id}\n\n`;

  // Page where violation was found
  md += `**Page:** ${violation.pageName}\n\n`;

  // Description (using help field which is more concise)
  md += `**Issue:** ${violation.help || violation.description}\n\n`;

  // Element count
  const elementCount = violation.nodes_count || (violation.elements ? violation.elements.length : 0);
  md += `**Affected elements:** ${elementCount}\n\n`;

  // Show element selectors
  if (violation.elements && violation.elements.length > 0) {
    const elementsToShow = violation.elements.slice(0, MAX_ELEMENTS_PER_VIOLATION);
    const remainingCount = elementCount - elementsToShow.length;

    for (const element of elementsToShow) {
      // Get selector from target array
      const selector = Array.isArray(element.target) ? element.target.join(' > ') : (element.target || 'unknown');

      // Truncate HTML if too long
      const html = truncateHtml(element.html);

      md += `<details>\n`;
      md += `<summary><code>${escapeHtml(selector)}</code></summary>\n\n`;
      md += `\`\`\`html\n${html}\n\`\`\`\n`;
      if (element.failureSummary) {
        md += `\n${element.failureSummary}\n`;
      }
      md += `</details>\n\n`;
    }

    if (remainingCount > 0) {
      md += `*...and ${remainingCount} more element(s)*\n\n`;
    }
  }

  // Help URL for remediation guidance
  if (violation.helpUrl) {
    md += `[Learn more about this issue](${violation.helpUrl})\n\n`;
  }

  md += `---\n\n`;
  return md;
}

function truncateHtml(html) {
  if (!html) return '';
  if (html.length <= MAX_HTML_LENGTH) return html;
  return html.substring(0, MAX_HTML_LENGTH) + '...';
}

function escapeHtml(text) {
  if (!text) return '';
  return text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

function generateArtifactLink() {
  if (!GITHUB_REPOSITORY || !GITHUB_RUN_ID) {
    return '';
  }

  const artifactUrl = `${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}`;
  return `### Artifacts\n\n[View Full Accessibility Report](${artifactUrl})\n\n`;
}

function generateFooter() {
  return `---\n*Generated by axe-core accessibility testing*\n`;
}

function generateErrorMarkdown(errorMessage) {
  let md = `## Accessibility Report\n\n`;
  md += `\u26A0\uFE0F **Accessibility results are not available.**\n\n`;
  md += `**Error:** ${errorMessage}\n\n`;
  md += `Please check the workflow logs for more details.\n\n`;

  if (GITHUB_REPOSITORY && GITHUB_RUN_ID) {
    const logsUrl = `${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}`;
    md += `[View Workflow Logs](${logsUrl})\n\n`;
  }

  md += generateFooter();
  return md;
}

// ============================================================================
// Run
// ============================================================================

main();
