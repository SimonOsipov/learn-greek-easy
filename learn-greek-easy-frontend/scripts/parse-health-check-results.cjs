#!/usr/bin/env node
/**
 * Health Check Results Parser Script
 *
 * This script parses health-check-results.json generated by preview-health-check.sh
 * and generates a markdown comment for PR reviews.
 *
 * Usage:
 *   node scripts/parse-health-check-results.cjs
 *
 * Expected input:
 *   health-check-results.json in HEALTH_CHECK_REPORT_PATH (default: ./health-data/health-check-results.json)
 *
 * Environment variables:
 *   HEALTH_CHECK_REPORT_PATH - Path to health check JSON report (default: ./health-data/health-check-results.json)
 *   GITHUB_SERVER_URL - GitHub server URL (e.g., https://github.com)
 *   GITHUB_REPOSITORY - Repository name (e.g., owner/repo)
 *   GITHUB_RUN_ID - Workflow run ID for artifact link
 *
 * Output files:
 *   health-check-comment.md - Markdown formatted PR comment
 *
 * Exit codes:
 *   0 - Always exits 0 (errors generate error markdown)
 */

const fs = require('fs');
const path = require('path');

// ============================================================================
// Configuration
// ============================================================================

const REPORT_PATH = process.env.HEALTH_CHECK_REPORT_PATH || path.join(process.cwd(), 'health-data', 'health-check-results.json');
const OUTPUT_FILE = path.join(process.cwd(), 'health-check-comment.md');

// Environment variables for artifact link
const GITHUB_SERVER_URL = process.env.GITHUB_SERVER_URL || 'https://github.com';
const GITHUB_REPOSITORY = process.env.GITHUB_REPOSITORY || '';
const GITHUB_RUN_ID = process.env.GITHUB_RUN_ID || '';

// ============================================================================
// Main Function
// ============================================================================

function main() {
  console.log('='.repeat(60));
  console.log('HEALTH CHECK RESULTS PARSER');
  console.log('='.repeat(60));
  console.log('');
  console.log(`Report path: ${REPORT_PATH}`);

  try {
    // Check if report file exists
    if (!fs.existsSync(REPORT_PATH)) {
      throw new Error(`Report file not found: ${REPORT_PATH}`);
    }

    // Read and parse the report
    const content = fs.readFileSync(REPORT_PATH, 'utf-8');
    let report;

    try {
      report = JSON.parse(content);
    } catch (parseError) {
      throw new Error(`Failed to parse JSON: ${parseError.message}`);
    }

    // Validate report structure
    if (!report || typeof report !== 'object') {
      throw new Error('Invalid report structure: expected an object');
    }

    // Generate markdown
    const markdown = generateMarkdown(report);

    // Write output
    fs.writeFileSync(OUTPUT_FILE, markdown);
    console.log('');
    console.log(`Markdown comment written to: ${OUTPUT_FILE}`);
    console.log('');
    console.log('Parsing completed successfully!');
  } catch (error) {
    console.error(`Error: ${error.message}`);

    // Write error markdown (always exit 0)
    const errorMarkdown = generateErrorMarkdown(error.message);
    fs.writeFileSync(OUTPUT_FILE, errorMarkdown);
    console.log(`Error markdown written to: ${OUTPUT_FILE}`);
  }

  // Always exit 0 - let the CI job handle the comment posting
  process.exit(0);
}

// ============================================================================
// Markdown Generation
// ============================================================================

/**
 * Generate the complete markdown comment.
 *
 * @param {Object} report - Parsed health check report
 * @returns {string} Markdown content
 */
function generateMarkdown(report) {
  const summary = report.summary || {};
  const endpoints = report.endpoints || [];
  const thresholds = report.thresholds || { slow_response_ms: 500 };

  // Extract summary counts
  const totalCount = summary.total || endpoints.length;
  const passedCount = summary.passed || 0;
  const failedCount = summary.failed || 0;
  const slowCount = summary.slow || 0;

  // Determine overall status
  const status = getOverallStatus(failedCount, slowCount);

  let md = `## Health Check Report\n\n`;

  // Status badge
  if (status === 'pass') {
    md += `\u2705 **All health checks passed!**\n\n`;
  } else if (status === 'warning') {
    md += `\u26A0\uFE0F **Health checks passed with slow responses**\n\n`;
  } else {
    md += `\u274C **Health check failures detected**\n\n`;
  }

  // Summary table
  md += `### Summary\n\n`;
  md += `| Metric | Count |\n`;
  md += `|--------|-------|\n`;
  md += `| Total | ${totalCount} |\n`;
  md += `| \u2705 Passed | ${passedCount} |\n`;
  md += `| \u274C Failed | ${failedCount} |\n`;
  md += `| \u26A0\uFE0F Slow (>${thresholds.slow_response_ms}ms) | ${slowCount} |\n\n`;

  // Endpoint details table
  if (endpoints.length > 0) {
    md += `### Endpoint Details\n\n`;
    md += `| Endpoint | Status | Response Time | Result |\n`;
    md += `|----------|--------|---------------|--------|\n`;

    for (const endpoint of endpoints) {
      const name = endpoint.name || 'Unknown';
      const statusCode = endpoint.status_code || 0;
      const responseTime = endpoint.response_time_ms || 0;
      const passed = endpoint.passed || false;
      const slow = endpoint.slow || false;

      const resultIcon = getResultIcon(passed, slow);
      const timeDisplay = formatResponseTime(responseTime);

      md += `| ${name} | ${statusCode} | ${timeDisplay} | ${resultIcon} |\n`;
    }

    md += `\n`;
  }

  // Failed endpoints section (collapsible)
  const failedEndpoints = endpoints.filter((e) => !e.passed);
  if (failedEndpoints.length > 0) {
    md += generateFailedSection(failedEndpoints);
  }

  // Slow endpoints section (collapsible)
  const slowEndpoints = endpoints.filter((e) => e.passed && e.slow);
  if (slowEndpoints.length > 0) {
    md += generateSlowSection(slowEndpoints, thresholds.slow_response_ms);
  }

  // Artifact link
  md += generateArtifactLink();

  // Footer
  md += generateFooter();

  return md;
}

/**
 * Get the overall status based on failures and slow responses.
 *
 * @param {number} failedCount - Number of failed endpoints
 * @param {number} slowCount - Number of slow endpoints
 * @returns {'pass'|'warning'|'fail'} Overall status
 */
function getOverallStatus(failedCount, slowCount) {
  if (failedCount > 0) {
    return 'fail';
  }
  if (slowCount > 0) {
    return 'warning';
  }
  return 'pass';
}

/**
 * Get the result icon for an endpoint.
 *
 * @param {boolean} passed - Whether the endpoint passed
 * @param {boolean} slow - Whether the endpoint was slow
 * @returns {string} Result icon
 */
function getResultIcon(passed, slow) {
  if (!passed) {
    return '\u274C'; // Red X
  }
  if (slow) {
    return '\u26A0\uFE0F'; // Warning
  }
  return '\u2705'; // Green check
}

/**
 * Format response time for display.
 *
 * @param {number} ms - Response time in milliseconds
 * @returns {string} Formatted response time
 */
function formatResponseTime(ms) {
  if (ms === 0 || ms === undefined || ms === null) {
    return 'N/A';
  }
  if (ms >= 1000) {
    return `${(ms / 1000).toFixed(2)}s`;
  }
  return `${ms}ms`;
}

/**
 * Generate the failed endpoints section.
 *
 * @param {Array} failedEndpoints - Array of failed endpoint objects
 * @returns {string} Markdown content
 */
function generateFailedSection(failedEndpoints) {
  let md = `<details open>\n`;
  md += `<summary><strong>\u274C Failed Endpoints (${failedEndpoints.length})</strong></summary>\n\n`;

  for (const endpoint of failedEndpoints) {
    const name = endpoint.name || 'Unknown';
    const url = endpoint.url || '';
    const statusCode = endpoint.status_code || 0;
    const expectedStatus = endpoint.expected_status || 200;
    const responseTime = endpoint.response_time_ms || 0;

    md += `#### ${name}\n\n`;
    md += `- **URL:** \`${url}\`\n`;
    md += `- **Status Code:** ${statusCode} (expected ${expectedStatus})\n`;
    md += `- **Response Time:** ${formatResponseTime(responseTime)}\n\n`;
  }

  md += `</details>\n\n`;
  return md;
}

/**
 * Generate the slow endpoints section.
 *
 * @param {Array} slowEndpoints - Array of slow endpoint objects
 * @param {number} threshold - Slow threshold in milliseconds
 * @returns {string} Markdown content
 */
function generateSlowSection(slowEndpoints, threshold) {
  let md = `<details>\n`;
  md += `<summary><strong>\u26A0\uFE0F Slow Endpoints (${slowEndpoints.length})</strong></summary>\n\n`;
  md += `Endpoints with response time exceeding ${threshold}ms:\n\n`;

  md += `| Endpoint | Response Time |\n`;
  md += `|----------|---------------|\n`;

  for (const endpoint of slowEndpoints) {
    const name = endpoint.name || 'Unknown';
    const responseTime = endpoint.response_time_ms || 0;
    md += `| ${name} | ${formatResponseTime(responseTime)} |\n`;
  }

  md += `\n</details>\n\n`;
  return md;
}

/**
 * Generate the artifact link section.
 *
 * @returns {string} Markdown content
 */
function generateArtifactLink() {
  if (!GITHUB_REPOSITORY || !GITHUB_RUN_ID) {
    return '';
  }

  const artifactUrl = `${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}`;
  return `### Artifacts\n\n[View Health Check Results](${artifactUrl})\n\n`;
}

/**
 * Generate the footer section.
 *
 * @returns {string} Markdown content
 */
function generateFooter() {
  return `---\n*Generated by preview health check*\n`;
}

/**
 * Generate error markdown when parsing fails.
 *
 * @param {string} errorMessage - The error message
 * @returns {string} Markdown content
 */
function generateErrorMarkdown(errorMessage) {
  let md = `## Health Check Report\n\n`;
  md += `\u26A0\uFE0F **Health check results are not available.**\n\n`;
  md += `**Error:** ${errorMessage}\n\n`;
  md += `Please check the workflow logs for more details.\n\n`;

  if (GITHUB_REPOSITORY && GITHUB_RUN_ID) {
    const logsUrl = `${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}`;
    md += `[View Workflow Logs](${logsUrl})\n\n`;
  }

  md += generateFooter();
  return md;
}

// ============================================================================
// Run
// ============================================================================

main();
